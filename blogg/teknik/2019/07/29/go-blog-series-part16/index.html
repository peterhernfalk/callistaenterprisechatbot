<!DOCTYPE html>
<html lang="sv-se">
<head>
    <meta charset="utf-8">

    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="description" content="Callista Enterprise - seniora IT-arkitekter och systemutvecklare inom Java, öppen källkod, agil utveckling och systemintegration">
    <!--<meta name="viewport" content="width=device-width, initial-scale=1">-->
    <meta name="viewport" content="initial-scale=1.0001, minimum-scale=1.0001, maximum-scale=1.0001, user-scalable=no"/>

    <link rel="icon" href="../../../../../../images/icons/callista_favicon.svg" type="image/x-icon" />
    <link rel="shortcut icon" href="../../../../../../images/icons/callista_favicon.svg" type="image/x-icon" />
    <link rel="apple-touch-icon" href="../../../../../../images/icons/callista_favicon_160x160.png">

    <title>Go Microservices blog series, part 16 - It's 2019, time for a code overhaul! | Callista</title>

    <link rel="stylesheet" href="../../../../../../css/style.css%3Fv=1.css">
    <link rel="alternate" type="application/rss+xml" title="RSS Feed for callistaenterprise.se" href="../../../../../../feed.xml" />

    <!--[if lte IE 8]>
    <style>* { display: none !important; }</style>
    <meta http-equiv="refresh" content="0; url=/oldie/"/>
    <![endif]-->

    <script type="text/javascript" src="https://use.typekit.net/kig5egm.js"></script>
    <script type="text/javascript">
        try {
            Typekit.load({ async: true });
        } catch (e) {
        }
    </script>

    <!-- Facebook Pixel Code -->
    <script>
    !function(f,b,e,v,n,t,s)
    {if(f.fbq)return;n=f.fbq=function(){n.callMethod?
    n.callMethod.apply(n,arguments):n.queue.push(arguments)};
    if(!f._fbq)f._fbq=n;n.push=n;n.loaded=!0;n.version='2.0';
    n.queue=[];t=b.createElement(e);t.async=!0;
    t.src=v;s=b.getElementsByTagName(e)[0];
    s.parentNode.insertBefore(t,s)}(window,document,'script',
    'https://connect.facebook.net/en_US/fbevents.js');
     fbq('init', '804675599711872');
     fbq('track', 'PageView');
    </script>
    <noscript>
     <img height="1" width="1" src="https://www.facebook.com/tr?id=804675599711872&ev=PageView&noscript=1"/>
    </noscript>
    <!-- End Facebook Pixel Code -->

</head>
<body>

    <header class="ce-header" data-scroll="0">
    <nav>
        <img alt="menubg" class="ce-menu-icon" style="z-index:3; top: 0px; width: 50px; height: 100%;" src="../../../../../../images/icons/menu_background.png">
        <a class="ce-logotype" href="../../../../../../index.html" style="z-index: 2;">
            <img alt="Callista" style="max-width: 100%; height: auto;" src="../../../../../../images/logotype/callista_small2.svg">
        </a>
        <table>
            <tr>
                <td>
            <ul id="menu-primary" class="ce-menu-primary">
                
                    
                            <li><a href="../../../../../../om/index.html">Om oss</a></li>
                    
                
                    
                            <li><a href="../../../../../../erbjudanden.html">Erbjudanden</a></li>
                    
                
                    
                            <li><a href="../../../../../../event.html">Event</a></li>
                    
                
                    
                        
                            <li><a class="ce-active" href="../../../../../../blogg.html">Blogg</a></li>
                        
                    
                
                    
                            <li><a href="../../../../../../om/jobb/index.html">Jobba hos oss</a></li>
                    
                
            </ul>
                </td>

                <td>
            <ul class="ce-menu-secondary">
                
                <li><a href="../../../../../../english/index.html">English</a></li>
                
            </ul>
                </td>
            </tr>
        </table>
            <a id="menu" class="ce-menu-icon" href="index.html#" style="z-index: 4;">
                <img alt="Visa meny" src="../../../../../../images/icons/menu.png">
            </a>
            <a class="ce-search-icon" href="index.html#">
                <img alt="Sök" src="../../../../../../images/icons/search.png">
            </a>

        </table>
    </nav>
</header>


    <div class="ce-main">
        <section class="ce-start lazyImg">
    <article>
        <h1>Blogg</h1>
        <p class="ce-ingress">
            Här finns tekniska artiklar, presentationer och nyheter om arkitektur och systemutveckling. Håll dig uppdaterad, följ oss på <a class="ce-active" href="http://twitter.com/callistaent">Twitter</a>
        </p>
    </article>
</section>

<section class="ce-section">
    <div class="ce-content">
        
        

        
        

        <article class="ce-blog">
            <header>
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    <img alt="Callista medarbetare Erik Lupander" src="../../../../../../assets/medarbetare/eriklupander_mini.png">
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    <h2>
        <a href="index.html">Go Microservices blog series, part 16 - It's 2019, time for a code overhaul!</a>
        
        
    </h2>
    <h3>
        <time datetime="2019-07-29T00:00:00+00:00">
            29 July 2019
        </time>
        //
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        

        
        
        <a href="../../../../../../om/medarbetare/eriklupander/index.html">Erik Lupander</a>
        

        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
    </h3>
    
</header>




<p>What was a given three years ago when I started working on the material used in this blog series has in many ways changed or evolved and I’ve also learnt a lot on the way. I’ve come to realize that the Go code and how the microservices are built and deployed were long due a substantial overhaul. Read on for a primer on go modules, go-chi, testify and other Go-related stuff I’ve come to really like and adopt.</p>

<h1 id="contents">Contents</h1>
<ol>
  <li>Introduction</li>
  <li>Go project structure</li>
  <li>Go modules</li>
  <li>Dependency injection</li>
  <li>Configuration of our microservices</li>
  <li>HTTP routing with Chi</li>
  <li>Unit-testing</li>
  <li>Summary</li>
</ol>

<h1 id="1-introduction">1. Introduction</h1>
<p>In this and an upcoming part of the <a href="../../../../2017/02/17/go-blog-series-part1.html">blog series</a>, we’ll do a major overhaul of both our Go code and how we write, build and deploy our microservices to Docker Swarm.</p>

<p>In this blog post, we’ll update our core Go-based microservices to use more idiomatic coding style, go modules, a new project structure, revamped configuration, a new HTTP router and revised unit-testing.</p>

<p>Just a quick recap on the make-believe system landscape consisting of five discrete microservices deployed on Docker in swarm mode:</p>

<p><img src="../../../../../../assets/blogg/goblog/part16-overview.png" alt="overview" /></p>

<p>There’s also a whole bunch of supporting services (database, message broker, monitoring tools) omitted from the figure that we’ll revisit in Part 17.</p>

<h3 id="11-source-code">1.1 Source code</h3>

<p>The finished source code can be cloned from github:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&gt; git clone https://github.com/callistaenterprise/goblog.git
&gt; git checkout P16
</code></pre></div></div>

<h1 id="2-go-project-structure">2. Go project structure</h1>

<p>When I started coding Go back in late 2015, most examples and tutorials I read typically put the <em>main.go</em> file in the root of the source tree and then introduced various packages for things like “model”, “service” etc.</p>

<p>Example:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>- main.go
- service/handlers.go
- service/handlers_test.go
- model/account.go
</code></pre></div></div>

<p>However, I never really felt fully comfortable with that approach, so when I sometime later discovered <a href="https://github.com/golang-standards/project-layout">golang-standards/project-layout</a>, I’ve gradually adopted that layout for new projects as well as updating some existing ones.</p>

<p>After updating the microservices with the golang-standards project layout, the code is structured like this:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>- cmd/[servicename]/main.go
- internal/app/service/handlers.go
- internal/app/service/handlers_test.go
- internal/app/model/account.go
</code></pre></div></div>

<p>Note the <em>[servicename]</em> placeholder which will be replaced per-service, for example <em>cmd/accountservice/main.go</em>.</p>

<p>By standardizing where to find the <em>main.go</em> file, it makes it easier to write clean build scripts as well as adding additional executables related to the microservice at hand - migrations for example.</p>

<p>The root folder for each microservice is now much cleaner, typically having only a <a href="https://en.wikipedia.org/wiki/Makefile">Makefile</a> and the new go.mod and go.sum files from go modules. (more on those later)</p>

<p>The new layout also affects build scripts, Dockerfiles etc which will be revisited later as well.</p>

<p><em>(Please note that I’m not following all the recommendations in the standard project layout to the letter)</em></p>

<h1 id="3-go-modules">3. Go modules</h1>

<p>The first major change to the codebase is making all our microservices as well as the <em>common</em> code into <a href="https://github.com/golang/go/wiki/Modules">go modules</a>. Go modules was introduced in Go 1.11 as the official dependency management tool and I personally am quite happy with it given its relative simplicity and useful toolset.</p>

<p>Using go modules also has the upside of <em>not</em> forcing your codebase to live beneath a GOPATH anymore, so now one can just clone the source of this blog series to any folder and start building it.</p>

<p>Adding go module support is quite easy. With the <em>accountservice</em> as an example:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&gt; cd accountservice
&gt; export GO111MODULE=on
&gt; go mod init github.com/callistaenterprise/goblog/accountservice
&gt; go build
</code></pre></div></div>

<p>That’s all there is to it. By the way, in Go 1.13 go modules are supposed to be turned on by default, so no more need to set the GO111MODULE env var.</p>

<p>The commands above should have created two files in the root of the <em>accountservice</em> directory: <em>go.mod</em> and <em>go.sum</em>.</p>

<p>go.mod:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>module github.com/callistaenterprise/goblog/accountservice

go 1.12

require (
	github.com/callistaenterprise/goblog/common v0.0.0-20190713133714-ded5832e931e
	github.com/gorilla/mux v1.7.3
	github.com/graphql-go/graphql v0.7.8
	github.com/graphql-go/graphql-go-handler v0.2.3
	github.com/graphql-go/handler v0.2.3 // indirect
	github.com/myesui/uuid v1.0.0 // indirect
	github.com/opentracing/opentracing-go v1.1.0
	github.com/prometheus/client_golang v1.0.0
	github.com/sirupsen/logrus v1.4.2
	github.com/smartystreets/goconvey v0.0.0-20190710185942-9d28bd7c0945
	github.com/spf13/viper v1.4.0
	github.com/stretchr/testify v1.3.0
	gopkg.in/h2non/gock.v1 v1.0.15
)
</code></pre></div></div>

<p>The go.mod file has been generated by the go tools. It starts by specifying the unique identifier of your module, which by convention usually is the absolute path to it’s source-control repository and possibly subfolder.</p>

<p>The neat thing here is that the go tools have scanned your source code and generated the <em>require</em> block listing all direct (e.g. libraries you explicitly have imports for in your code) and also <em>indirect</em> dependencies, i.e. dependencies of your direct dependencies.</p>

<p>For example, we can see that the UUID generator library <em>github.com/myesui/uuid v1.0.0</em> is declared as an indirect dependency. We can ask the go tools which dependency that’s pulling in that indirect dependency.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&gt; go mod why github.com/myesui/uuid v1.0.0
  # github.com/myesui/uuid
  github.com/callistaenterprise/goblog/accountservice/internal/pkg/model
  github.com/callistaenterprise/goblog/common/model
  github.com/twinj/uuid
  github.com/twinj/uuid.test
  github.com/myesui/uuid
</code></pre></div></div>

<p>The listing above shows us that the <em>model</em> package of our accountservice is importing our <em>common/model</em> package, which in it’s turn is pulling in github.com/twinj/uuid and so on.</p>

<h1 id="31-the-replace-directive">3.1 The replace directive</h1>
<p>Note the <em>github.com/callistaenterprise/goblog/common/model</em>. While we have the <em>common</em> folder in the root of our checked-out code, we’re actually pulling in the code for <em>github.com/callistaenterprise/goblog/common/model</em> directly from the latest published commit on the master branch from github.</p>

<p>This means that any local changes performed in <em>/common</em> <strong>won’t affect</strong> a locally built accountservice <em>before</em> the changes to common has been pushed to github.</p>

<p>If that sounds rather inconvenient when developing - it is. Luckily, the go modules tools allows us to declare an override for how dependencies are resolved using the <a href="https://github.com/golang/go/wiki/Modules#when-should-i-use-the-replace-directive">replace</a> directive.</p>

<p>For local development, one can add this one-liner to <em>go.mod</em> in order to resolve the common module from a relative path on our local file-system instead:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>module github.com/callistaenterprise/goblog/accountservice
    
go 1.12
    
replace github.com/callistaenterprise/goblog/common =&gt; ../common
    
require (
    github.com/callistaenterprise/goblog/common v0.0.0-20190713133714-ded5832e931e
    ....
)
</code></pre></div></div>

<p>This is not meant to be an in-depth explanation of Go modules. Just a quick introduction and one of the more prominent changes in the overhaul of the code and infrastructure tools for the blog series!</p>

<h1 id="4-dependency-injection">4. Dependency injection</h1>
<p>In hindsight, I adopted some bad patterns when I first started to code Go. I relied too much on exported variables or package-scoped state instead of proper encapsulation into structs and definition of behaviour using interfaces.</p>

<p>Now, <em>main.go</em> is responsible for creating the core struct(s) that provides the various functionalities our services require. Here’s an example from the <em>dataservice</em> where the DB client is injected into a Handler struct, which in its turn is passed with a configuration struct as arguments to a NewServer <a href="http://www.golangpatterns.info/object-oriented/constructors">constructor function</a>:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>func main() {
    ...
    cfg := cmd.DefaultConfiguration()
	arg.MustParse(cfg)

	gormclient := dbclient.NewGormClient(cfg) // create DB client
	handler := service.NewHandler(gormclient) // create Handler struct with HTTP handler funcs
	
	server := service.NewServer(handler, cfg) // create HTTP server with handler and config injected
	server.SetupRoutes()
	...
}
</code></pre></div></div>

<p>A quick look at the <em>Handler</em> struct and its companion constructor function, which encapsulates the actual business logic in its methods and whatever dependencies or state the application needs to fulfill its business requirements. In the case of the <em>dataservice</em> to orchestrate calls to the database using the <em>IGormClient</em>.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>type Handler struct {
    dbClient  dbclient.IGormClient
    myIP      string
    isHealthy bool
}

func NewHandler(dbClient dbclient.IGormClient) *Handler {
	myIP, err := util.ResolveIPFromHostsFile()
	if err != nil {
		myIP = util.GetIP()
	}
	return &amp;Handler{dbClient: dbClient, myIP: myIP, isHealthy: true}
}
</code></pre></div></div>

<p>The most common pattern of constructor functions is to return a <em>pointer</em> to the created struct. Note also how we can embed some code into the constructor function to look-up our own IP.</p>

<p><em>GetAccount</em> hasn’t changed much, the main difference being that it’s now a method on the Handler struct and that the <em>dbClient</em> embedded in the struct is used instead of a package-scoped one.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>func (h *Handler) GetAccount(w http.ResponseWriter, r *http.Request) {

	// Read the 'accountId' path parameter
	var accountID = chi.URLParam(r, "accountId")
	account, err := h.dbClient.QueryAccount(r.Context(), accountID)
	...
}
</code></pre></div></div>

<p>We’ll look at how this change facilitates easier unit-testing in section 7.</p>

<h1 id="5-configuration-of-our-microservices">5. Configuration of our microservices</h1>

<p>Given <a href="https://12factor.net/config">12-factor</a> and the general shift towards the use of environment variables as configuration injected as “secrets” into the runtime docker container, I’ve decided to stop using Spring Cloud Config or any other config-server.</p>

<p>My last projects (Go or Java-based projects) runs in production on either OpenShift, Docker Swarm or Kubernetes. In all instances, we’ve been using env vars injected as “secrets” as configuration, either by the built-in support in K8S / OpenShift, or through HashiCorps <a href="https://www.hashicorp.com/products/vault/">Vault</a>.</p>

<p>While my own experience may be anecdotal, I do think it works quite well and thus I’m migrating all the microservices in this blog series to use env vars as configuration.</p>

<p>Just as a recap, the old method used command-line flags hard-coded into our Dockerfile(s) in order to pass the “bootstrap” config to the service, e.g. where to find the config server that held the actual config parameters, e.g:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ENTRYPOINT ["./accountservice", "-configServerUrl=http://configserver:8888", "-profile=test", "-configBranch=P16"]
</code></pre></div></div>

<p>The new solution will be based on the excellent <a href="https://github.com/alexflint/go-arg">go-arg</a> library that does exactly what I want in just a few lines of code. I want:</p>

<ul>
  <li>Precedence: Command-line flags &gt; Env vars &gt; Default values.</li>
  <li>Struct-based configuration: Instead of populating a <strong>global</strong> <em>viper</em>-based store with whatever key-value pairs we read from our config-server, we’ll instead use a Go struct that is automatically populated by <em>go-arg</em> from flags, env vars and defaults, which we then can pass as an argument into constructor functions whenever configuration values are required. We create several domain-specific structs with related fields tailored for <em>each</em> microservice, and then compose them together to form the full config. This removes configuration as a global state, which may introduce unwanted side-effects such as harder testing.</li>
</ul>

<p>Example from our <em>accountservice</em>:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>// Config is our root config struct. Note usage of go-arg struct tags. 
// The env part is optional, allows explicit mapping of env var to struct field.
// Otherwise, the library automatically maps "SNAKE_CASE" env vars to struct fields in "PascalCase".
type Config struct {
	ZipkinServerUrl string `arg:"env:ZIPKIN_SERVER_URL"`
	ServerConfig
	AmqpConfig
}

// HTTP config for our service
type ServerConfig struct {
	Port string `arg:"env:SERVER_PORT"`
	Name string `arg:"env:SERVICE_NAME"`
}

// AMQP / RabbitMQ connection URL
type AmqpConfig struct {
	ServerUrl string `arg:"env:AMQP_SERVER_URL"`
}

// DefaultConfiguration specifies default values and returns a pointer to a struct populated with our defaults.
func DefaultConfiguration() *Config {
	return &amp;Config{
		ZipkinServerUrl: "http://zipkin:9411",
		ServerConfig: ServerConfig{
			Name: "accountservice",
			Port: "6767",
		},
		AmqpConfig: AmqpConfig{
			ServerUrl: "amqp://guest:guest@rabbitmq:5672/",
		},
	}
}    
</code></pre></div></div>

<p>Then, in our <em>main.go</em>, all the viper stuff is now gone and replaced by these few lines:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>func main() {
	logrus.SetFormatter(&amp;logrus.JSONFormatter{})
	logrus.Infof("Starting %v\n", appName)

	// Initialize config struct and populate it froms env vars and flags.
	cfg := cmd.DefaultConfiguration()
	arg.MustParse(cfg)

	initializeTracing(cfg)
	.... truncated for brevity...
}

func initializeTracing(cfg *cmd.Config) {
    // Note how we pass the cfg as argument and use the field on the struct now rather that viper.GetString("...")
	tracing.InitTracing(cfg.ZipkinServerUrl, appName)
}
</code></pre></div></div>

<p>Passing configuration is a breeze now. Our Dockerfile should <em>never</em> use command-line args directly, e.g we’re down to:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ENTRYPOINT ["./accountservice"]
</code></pre></div></div>

<p>For running locally, we can use command-line args to override defaults or env vars:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&gt; ./bin/accountservice --port=1337 --environment=loadtest
</code></pre></div></div>

<p>When using docker compose for testing locally or in test environments, we typically have separate compose files for each environment. One example:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>services:
  accountservice:
    image: someprefix/accountservice
    environment:
      ENVIRONMENT: "test"
      AMQP_SERVER_URL: amqp://user:password@rabbitmq:5672/
    ...
</code></pre></div></div>

<p>For staging/production, the env vars are typically injected from “secrets” by your container orchestrator or some other mechanism. This is not in scope for this blog post.</p>

<h1 id="6-using-go-chi-as-http-router">6. Using go-chi as HTTP router</h1>
<p>There’s nothing wrong with <a href="https://www.gorillatoolkit.org/">gorilla</a> which was my router of choice when I originally wrote the HTTP code for the microservices in this blog post. However, lately I’ve grown <em>really</em> fond of <a href="https://github.com/go-chi/chi">go-chi</a> due to it’s fluent DSL which makes it very easy to compose middlewares (compatible with <a href="https://golang.org/pkg/net/http/#Handler">http.Handler</a>) and declare routes, including setting up sub-routers.</p>

<p>Here’s some example routes using go-chi from the blog series, see inlined comments:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>// Server is a struct that encapsulates HTTP config, the router instance 
// and the handler struct having the actual handler methods
type Server struct {
	cfg *cmd.Config
	r   *chi.Mux
	h   *Handler
}

// SetupRoutes creates a new chi router and then uses the fluent DSL to set up our routes, 
// including middlewares
func (s *Server) SetupRoutes() {
	s.r = chi.NewRouter()
	
	// Setup global middlewares (i.e. HTTP filters), note that order of declaration matters!
	// These are recommended ones from go-chi
	s.r.Use(middleware.RequestID)
	s.r.Use(middleware.RealIP)
	s.r.Use(middleware.Logger)
	s.r.Use(middleware.Recoverer)
	s.r.Use(middleware.Timeout(time.Minute))

	// Sub-router for /accounts
	// Note use of With(...) for adding middlewares for Zipkin tracing and Prometheus monitoring
	s.r.Route("/accounts", func(r chi.Router) {
	    r.With(Trace("GetAccount")).
			With(Monitor(s.cfg.Name, "GetAccount", "GET /accounts/{accountId}")).
			Get("/{accountId}", s.h.GetAccount) // LOOK HERE!
			
		... other routes omitted for brevity ...
	})
	...
}
</code></pre></div></div>

<p>The <em>Get(“/{accountId}”, s.h.GetAccount)</em> is where the GET <em>/accounts/{accountId}</em> route is attached to its handler method <em>GetAccount(w http.ResponseWriter, r *http.Request)</em> on the new <em>Handler</em> struct we looked at in section 4.</p>

<p>The _Trace(..) middleware we’ve defined ourselves:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>func Trace(opName string) func(http.Handler) http.Handler {

    // Returns function having the correct middleware signature
	return func(next http.Handler) http.Handler {
	    
	    // Returns the actual middleware "worker" function. 
	    // Note how opName from the partent scope is embedded in the returned func.
		return http.HandlerFunc(func(rw http.ResponseWriter, req *http.Request) {
			span := tracing.StartHTTPTrace(req, opName)
			defer span.Finish()
			ctx := tracing.UpdateContext(req.Context(), span)
			next.ServeHTTP(rw, req.WithContext(ctx))
		})
	}
}
</code></pre></div></div>

<p>go-chi middlewares accepts functions having the <em>func(http.Handler) http.Handler</em> signature. Since we need some custom state in this middleware (the opName in this particular case), we need to perform some function wrapping to embed the opName into the returned middleware.</p>

<p>The separation of the <em>routes</em> from the <em>handlers</em> makes it much easier to unit-test the router, which brings us to our next change; how we unit-test.</p>

<h1 id="7-unit-testing">7. Unit-testing</h1>
<p>Before this update, I used <a href="https://github.com/smartystreets/goconvey">goconvey</a> for all my unit test. While I still think Goconvey is awesome for BDD-style tests, for plain unit-tests I think a more “basic” approach using just plain go-style testing and the <a href="https://godoc.org/github.com/stretchr/testify/assert">stretchr/testify/assert</a> module provides a slightly better developer experience.</p>

<h3 id="71-mocking">7.1 Mocking</h3>
<p>For mocking outgoing HTTP requests (from the accountservice to the other services, for example), I’m still into <a href="https://github.com/h2non/gock">gock</a>.</p>

<p>For mocking out dependencies injected into our structs (such as <em>service.Handler</em>), I’ve come to really appreciate mocks generated by <a href="https://github.com/golang/mock">gomock</a> for a given interface as they provide type-safe mocking of methods and a clean DSL for setting up various expectations, side-effects and return values.</p>

<p>First, one needs to install mockgen:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>go get github.com/golang/mock/gomock
go install github.com/golang/mock/mockgen
</code></pre></div></div>

<p>After that generating a mock for a given interface is just a simple one-liner. Example from the <em>dataservice</em> where a mock is generated for all interfaces in <em>cockroachdb.go</em>, i.e. the IGormClient:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>mockgen -source internal/pkg/dbclient/cockroachdb.go -destination internal/pkg/dbclient/mock_dbclient/mock_dbclient.go -package mock_dbclient
</code></pre></div></div>

<p>Setting up the behaviour of a mock in a unit test is then really simple.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>mockRepo := mock_dbclient.NewMockIGormClient(ctrl)
mockRepo.EXPECT().
    QueryAccount(gomock.Any(), "123").
    Return(model.AccountData{ID: "123", Name: "Person_123"}, nil).
    Times(1)
</code></pre></div></div>

<p>In this example, we tell the mock to expect a single call to the QueryAccount method with anything as the first parameter and the string “123” as the second one. If such an invocation is received by the mock, the specified <em>AccountData</em> struct and <em>nil</em> error is returned.</p>

<h3 id="72-test-setup">7.2 Test setup</h3>
<p>Since we’ve moved to a struct- and “dependency injection” based architecture for our go services, it’s actually much easier to set up the tests.</p>

<p>Here’s an example unit-test of the <em>dataservice</em>, beginning with a simple setup() function:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>// Run this first in each test, poor substitute for a proper @Before func
func setup(mockRepo dbclient.IGormClient) *Server {
	tracing.SetTracer(opentracing.NoopTracer{})
	h := NewHandler(mockRepo)
	s := NewServer(h, cmd.DefaultConfiguration())
	s.SetupRoutes()
	return s
}
</code></pre></div></div>

<p>Note how we create a <em>service.Handler</em> instance with our MockIGormClient as argument, and how the handler then is passed to the NewServer constructor function along with the default config.</p>

<h3 id="73-test-and-assert">7.3 Test and assert</h3>
<p>Here’s the actual “happy path” unit test for the <em>QueryAccount</em> method:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>func TestQueryAccount(t *testing.T) {
	ctrl := gomock.NewController(t)
	defer ctrl.Finish()
	mockRepo := mock_dbclient.NewMockIGormClient(ctrl)
	mockRepo.EXPECT().QueryAccount(gomock.Any(), "123").Return(model.AccountData{ID: "123", Name: "Person_123"}, nil).Times(1)

	s := setup(mockRepo)

	req := httptest.NewRequest("GET", "/accounts/123", nil)
	resp := httptest.NewRecorder()

	s.r.ServeHTTP(resp, req)

	account := model.AccountData{}
	_ = json.Unmarshal(resp.Body.Bytes(), &amp;account)

	assert.Equal(t, 200, resp.Code)
	assert.Equal(t, "123", account.ID)
	assert.Equal(t, "Person_123", account.Name)
}
</code></pre></div></div>

<p>Some notable changes to how the test (and most other tests in the blog series) is written:</p>

<ul>
  <li>The <em>TestQueryAccount</em> is a bit cleaner without the GoConvey Given-When-Then constructs.</li>
  <li>Note how we set up the mocked IGormClient with the <em>mockRepo.EXPECT().QueryAccount(…)</em> call.</li>
  <li>The invocation of the router using the httptest request and response objects happens directly on the <em>r *Router</em> dependency we injected into our server with the ServeHTTP method.</li>
  <li>We’re still using the exact same <a href="https://golang.org/pkg/net/http/httptest/">httptest</a> request and response.</li>
  <li>Finally, note how we’ve replaced the GoConvey <em>So(actual, verb, expected)</em> asserts with the slightly more plain asserts from <a href="https://godoc.org/github.com/stretchr/testify/assert">stretchr/testify/assert</a>. While the GoConvey “So” approach is just fine, the assert module probably feels more familiar to people like me who’s used JUnit for the last decade or two…</li>
</ul>

<p>Another popular approach to testing in Go is <a href="https://github.com/golang/go/wiki/TableDrivenTests">table-driven tests</a>. I’m personally a bit divided on table-driven testing, but I’m planning on using TDT when I get to integration testing in Part 18.</p>

<h1 id="8-summary">8. Summary</h1>
<p>In this installment of the <a href="../../../../2017/02/17/go-blog-series-part1.html">blog series</a>, we’ve refactored most of the codebase to better comply with idiomatic go coding styles, go modules, 12-factor configuration and cleaner tests.</p>

<p>In the next part, I’ll continue the overhaul by introducing Makefiles and Docker compose / Docker stack for building and deploying.</p>

<p>Please help spread the word! Feel free to share this blog post using your favorite social media platform, there’s some icons below to get you started.</p>

<p>Until next time,</p>

<p>// Erik</p>









            <div class="ce-blog-thanks">
              Tack för att du läser Callistas blogg. <br>
              Hjälp oss att nå ut med information genom att dela nyheter och artiklar i ditt nätverk.<br>
            </div>

            


    
<div class="ce-blog-share">
    <a class="ce-blog-share-element social-twitter" href="https://twitter.com/intent/tweet?text=Go Blog Series Part16&url=https://callistaenterprise.se/blogg/teknik/2019/07/29/go-blog-series-part16/&via=callistaent&hashtags=" target="_blank" title="Share this post on Twitter"></a>
    <a class="ce-blog-share-element social-facebook" href="https://www.facebook.com/sharer/sharer.php?t=Go Blog Series Part16&u=https://callistaenterprise.se/blogg/teknik/2019/07/29/go-blog-series-part16/" target="_blank" title="Share this post on Facebook"></a>
    <a class="ce-blog-share-element social-linkedin" href="http://www.linkedin.com/shareArticle?mini=true&title=Go Blog Series Part16&url=https://callistaenterprise.se/blogg/teknik/2019/07/29/go-blog-series-part16/&source=http%3a%2f%2fzhangwenli.com" target="_blank" title="Share this post on LinkedIn"></a>
</div>
    
        </article>
    </div>
</section>


<section class="ce-section">
    <heading>
        <h1>Kommentarer</h1>
    </heading>
    <div class="ce-content">
        <div id="disqus_thread"></div>
        <script src="../../../../../../js/disqus.js"></script>
    </div>
</section>


    </div>

    <footer class="ce-footer">
    <div class="ce-wrapper">
        <nav class="ce-menu-footer-primary">
            <h2><a href="../../../../../../index.html">Callista</a></h2>
            <ul>
                
                <li><a href="../../../../../../om/index.html">Om oss</a></li>
                
                <li><a href="../../../../../../erbjudanden.html">Erbjudanden</a></li>
                
                <li><a href="../../../../../../event.html">Event</a></li>
                
                <li><a href="../../../../../../blogg.html">Blogg</a></li>
                
                <li><a href="../../../../../../om/jobb/index.html">Jobba hos oss</a></li>
                

                
                    
                        <li><a href="../../../../../../english/index.html">English</a></li>
                    
                
            </ul>
        </nav>
        <div class="ce-addresses">
            <div class="ce-address">
                <h2>Stockholm</h2>
                <address>
                    Drottninggatan 55<br>
                    111 21 Stockholm<br>
                    Tel:
                    <a href="tel:+468212142">
                        +46 8 21 21 42
                    </a>
                </address>
            </div>
            <div class="ce-address">
                <h2>Göteborg</h2>
                <address>
                    Fabriksgatan 13<br>
                    412 50 Göteborg<br>
                    Tel:
                    <a href="tel:+4631201918">
                        +46 31 20 19 18
                    </a>
                </address>
            </div>
        </div>
        <div class="ce-social">
            <h2>Följ oss</h2>
            <ul>
                <li>
                    <a href="http://twitter.com/callistaent">
                        <img alt="Twitters logotype" src="../../../../../../images/icons/twitter.png">
                        <span>@callistaent</span>
                    </a>
                </li>
            </ul>
        </div>
        <small>&copy; 2021 Callista Enterprise AB</small>
        <hr style="margin: 1em 0 2em 0">
        <div class="ce-footer-images">
          <div class="ce-footer-image">
            <a class="ce-raddabarnen" href="http://www.raddabarnen.se/foretag">
                <img alt="Callista är Rädda Barnens företagsvän 2021" src="../../../../../../images/logotype/rb_vanforetag_2021_large-sv.png">
            </a>
          </div>
        </div>
        <br>
        <div class="ce-footer-images">
          <div class="ce-footer-image">
            <a class="ce-di-gasell" href="http://www.di.se/gasell/">
              <img alt="Callista utsett till DI Gasell tre år i rad" src="../../../../../../images/logotype/di_gasell_180x194.png">
            </a>
          </div>
        </div>
    </div>
</footer>


    <script src="../../../../../../js/lib/jquery.min.js"></script>
    <script src="../../../../../../js/lib/owl.carousel.min.js"></script>
    <script src="../../../../../../js/lib/prismjs.min.js"></script>
    <script src="../../../../../../js/app.js"></script>
    <script src="../../../../../../js/analytics.js"></script>
    <script src="../../../../../../js/jobinterestsubmit.js"></script>

</body>
</html>
