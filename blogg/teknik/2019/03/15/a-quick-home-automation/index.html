<!DOCTYPE html>
<html lang="sv-se">
<head>
    <meta charset="utf-8">

    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="description" content="Callista Enterprise - seniora IT-arkitekter och systemutvecklare inom Java, öppen källkod, agil utveckling och systemintegration">
    <!--<meta name="viewport" content="width=device-width, initial-scale=1">-->
    <meta name="viewport" content="initial-scale=1.0001, minimum-scale=1.0001, maximum-scale=1.0001, user-scalable=no"/>

    <link rel="icon" href="../../../../../../images/icons/callista_favicon.svg" type="image/x-icon" />
    <link rel="shortcut icon" href="../../../../../../images/icons/callista_favicon.svg" type="image/x-icon" />
    <link rel="apple-touch-icon" href="../../../../../../images/icons/callista_favicon_160x160.png">

    <title>Home automation with Golang and IKEA Trådfri | Callista</title>

    <link rel="stylesheet" href="../../../../../../css/style.css%3Fv=1.css">
    <link rel="alternate" type="application/rss+xml" title="RSS Feed for callistaenterprise.se" href="../../../../../../feed.xml" />

    <!--[if lte IE 8]>
    <style>* { display: none !important; }</style>
    <meta http-equiv="refresh" content="0; url=/oldie/"/>
    <![endif]-->

    <script type="text/javascript" src="https://use.typekit.net/kig5egm.js"></script>
    <script type="text/javascript">
        try {
            Typekit.load({ async: true });
        } catch (e) {
        }
    </script>

    <!-- Facebook Pixel Code -->
    <script>
    !function(f,b,e,v,n,t,s)
    {if(f.fbq)return;n=f.fbq=function(){n.callMethod?
    n.callMethod.apply(n,arguments):n.queue.push(arguments)};
    if(!f._fbq)f._fbq=n;n.push=n;n.loaded=!0;n.version='2.0';
    n.queue=[];t=b.createElement(e);t.async=!0;
    t.src=v;s=b.getElementsByTagName(e)[0];
    s.parentNode.insertBefore(t,s)}(window,document,'script',
    'https://connect.facebook.net/en_US/fbevents.js');
     fbq('init', '804675599711872');
     fbq('track', 'PageView');
    </script>
    <noscript>
     <img height="1" width="1" src="https://www.facebook.com/tr?id=804675599711872&ev=PageView&noscript=1"/>
    </noscript>
    <!-- End Facebook Pixel Code -->

</head>
<body>

    <header class="ce-header" data-scroll="0">
    <nav>
        <img alt="menubg" class="ce-menu-icon" style="z-index:3; top: 0px; width: 50px; height: 100%;" src="../../../../../../images/icons/menu_background.png">
        <a class="ce-logotype" href="../../../../../../index.html" style="z-index: 2;">
            <img alt="Callista" style="max-width: 100%; height: auto;" src="../../../../../../images/logotype/callista_small2.svg">
        </a>
        <table>
            <tr>
                <td>
            <ul id="menu-primary" class="ce-menu-primary">
                
                    
                            <li><a href="../../../../../../om/index.html">Om oss</a></li>
                    
                
                    
                            <li><a href="../../../../../../erbjudanden.html">Erbjudanden</a></li>
                    
                
                    
                            <li><a href="../../../../../../event.html">Event</a></li>
                    
                
                    
                        
                            <li><a class="ce-active" href="../../../../../../blogg.html">Blogg</a></li>
                        
                    
                
                    
                            <li><a href="../../../../../../om/jobb/index.html">Jobba hos oss</a></li>
                    
                
            </ul>
                </td>

                <td>
            <ul class="ce-menu-secondary">
                
                <li><a href="../../../../../../english/index.html">English</a></li>
                
            </ul>
                </td>
            </tr>
        </table>
            <a id="menu" class="ce-menu-icon" href="index.html#" style="z-index: 4;">
                <img alt="Visa meny" src="../../../../../../images/icons/menu.png">
            </a>
            <a class="ce-search-icon" href="index.html#">
                <img alt="Sök" src="../../../../../../images/icons/search.png">
            </a>

        </table>
    </nav>
</header>


    <div class="ce-main">
        <section class="ce-start lazyImg">
    <article>
        <h1>Blogg</h1>
        <p class="ce-ingress">
            Här finns tekniska artiklar, presentationer och nyheter om arkitektur och systemutveckling. Håll dig uppdaterad, följ oss på <a class="ce-active" href="http://twitter.com/callistaent">Twitter</a>
        </p>
    </article>
</section>

<section class="ce-section">
    <div class="ce-content">
        
        

        
        

        <article class="ce-blog">
            <header>
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    <img alt="Callista medarbetare Erik Lupander" src="../../../../../../assets/medarbetare/eriklupander_mini.png">
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    <h2>
        <a href="index.html">Home automation with Golang and IKEA Trådfri</a>
        
        
    </h2>
    <h3>
        <time datetime="2019-03-15T00:00:00+00:00">
            15 March 2019
        </time>
        //
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        

        
        
        <a href="../../../../../../om/medarbetare/eriklupander/index.html">Erik Lupander</a>
        

        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
    </h3>
    
</header>




<p>Sometimes, you just need to leave all that microservice and enterprise stuff behind and do some old-fashioned coding just for fun. This blog post describes how I - just for the fun of it - wrote a <a href="https://github.com/golang/go">Golang</a> program that can control IKEA Trådfri home automation using CoAP over DTLS.</p>

<p><em>Important note: I am in no way whatsoever affiliated with IKEA or take any responsibility if this stuff breaks your IKEA stuff… ;)</em></p>

<h1 id="contents">Contents</h1>
<ol>
  <li>Overview</li>
  <li>DTLS 1.2</li>
  <li>The CoAP protocol</li>
  <li>The Trådfri API</li>
  <li>Running</li>
  <li>Summary</li>
</ol>

<h1 id="1-overview">1. Overview</h1>
<p>The objective of this blog-post is to write a native Go application that can talk to the IKEA Trådfri gateway in order to query/control lights and other devices. There already exists quite a few 3rd party applications that performs exactly this feat such as <a href="https://libcoap.net/">coap-client</a>, <a href="https://github.com/ggravlingen/pytradfri">pytradfri</a> and other more general-purpose CoAP-clients with DTLS support such as <a href="https://www.eclipse.org/californium/">Eclipse Californium</a>. I’ve drawn inspiration from several of these libraries, but wanted to see if I could do something similar using a pure Go implementation.</p>

<p>This blog post does not aim to be an advertising campaign for IKEA produts, but in order to put this venture into leisure-coding into some kind of context, I’ll describe the home-automation setup briefly:</p>

<h3 id="11-the-ikea-trådfri-products">1.1 The IKEA trådfri products</h3>
<p>The trådfri series provides a number of products for home automation including the following:</p>

<ul>
  <li>Light bulbs of various capabilties (dimming, CIE 1931 color, cold/warm etc.)</li>
  <li>Light panels</li>
  <li>Power plugs (on/off)</li>
  <li>Motion sensors</li>
  <li>Electric blinders</li>
  <li>Accessories such as remote control, dimming controls</li>
  <li>The gateway</li>
</ul>

<p>My personal setup currently consists of three light bulbs, one power plug, a remote and (most importantly for this blog post) their Gateway.</p>

<p><img src="../../../../../../assets/blogg/tradfri/tradfri-1.png" alt="overview" /></p>

<p>The Raspberry Pi 3 is the unit running the Go program this blog post is about. It works just as well on my dev Mac so it should be possible to run it on any OS/arch Golang supports.</p>

<h3 id="12-integrating-with-the-gateway">1.2 Integrating with the Gateway</h3>
<p>Most (if not all?) mobile phones lacks the necessary radio (IEEE 802.15.4) to speak directly to bulbs etc over Zigbee. The gateway is thus a key component as it provides the interface from your WiFi network to the bulbs etc on the <a href="https://zigbee.org">zigbee</a> mesh network. Using a phone with Trådfri isn’t strictly necessary as the remote control can be used without WiFi, but I guess most users will use either the iOS or Android app to set things up.</p>

<p>Trådfri also supports integration with Apple HomeKit and Amazon Alexa, but that integration is not in scope for this blog post.</p>

<p>The objective of this blog post is to develop a standalone program using Go that can talk to the Gateway and both query the state of bulbs etc as well as controlling groups or individual devices. Communication from our Go program to the Gateway is based on the CoAP protocol running over DTLS 1.2, with CoAP payloads and identifiers based on <a href="https://en.wikipedia.org/wiki/OMA_LWM2M">LWM2M</a>. I’ll get back to CoAP and DTLS a few sections down.</p>

<h3 id="13-the-tradfri-go-application">1.3 The tradfri-go application</h3>
<p>When starting this little venture, I set up the following objectives for the program:</p>

<ul>
  <li>Use Go-native implementations of DTLS and CoAP, e.g. no CGo or proxying through OpenSSL etc.</li>
  <li>Provide a simple RESTful API to query the state of the devices</li>
  <li>Provde a simple RESTful API to control on/off, dimming, color etc</li>
  <li>Stretch goal 1: Create a simple web-based GUI that uses the RESTful endpoints.</li>
  <li>Stretch goal 2: Continuously query and store the state of the bulbs etc in a time-series database for future use as training data for a neural network, potentially providing autonomous operation of my bulbs etc in a sensible manner.</li>
  <li>Deployment on a Raspberry Pi 3</li>
</ul>

<p>The source code for the program can be found here:</p>

<p><a href="https://github.com/eriklupander/tradfri-go">https://github.com/eriklupander/tradfri-go</a></p>

<h1 id="2-dtls-12">2. DTLS 1.2</h1>
<p><a href="https://en.wikipedia.org/wiki/Datagram_Transport_Layer_Security">DTLS</a> is short for “Datagram Transport Layer Security”, i.e. TLS over UDP. 1.0 and 1.2 of DTLS respectively maps closely to normal TLS 1.0 and 1.2, with a few differences to accomondate the differences between TCP and UDP transports.</p>

<p>I’ve based my tradfri-go application on the <a href="https://github.com/bocajim/dtls">DTLS</a> library from <a href="https://github.com/bocajim">Jim W</a> which has support for PSK authentication. However, due to an issue in the DTLS handshake code of Jim’s library when authenticating with the Trådfri Gateway, I’ve forked it with a little fix <a href="https://github.com/eriklupander/dtls">here</a> for now.</p>

<h3 id="21-psk-authentication">2.1 PSK authentication</h3>
<p>DTLS supports a number of authentication schemes including certificate-based solutions as well as “Pre-shared keys” (PSK), which is what the Trådfri series uses. The PSK of your Gateway is printed on the sticker on the underside of the gateway.</p>

<p>The PSK on the gateway is however only used for obtaining <em>another</em> key, an important piece of information I found <a href="https://github.com/ggravlingen/pytradfri/issues/90">here</a>. The printed PSK is used to do an initial authentication with the gateway, which returns the key used for all subsequently interactions with the Gateway:</p>

<p><img src="../../../../../../assets/blogg/tradfri/psk-exchange.png" alt="PSK exchange" /></p>

<h3 id="22-dtls-handshake">2.2 DTLS handshake</h3>
<p>The handshake in DTLS (and TLS) has the purpose of exchanging keys, specifying cipher to be used etc between client and server in order to establish a securely encrypted connection. The details of this is typically handled by your DTLS library of choice, but I guess a simple overview of a DTLS handshake with PSK authentication can be fun to include for educational purposes:</p>

<p><img src="../../../../../../assets/blogg/tradfri/dtls-handshake.png" alt="DTLS handshake" /></p>

<p>For more details, I suggest reading <a href="https://tools.ietf.org/html/rfc6347">RFC6347</a>. The most significant difference between TLS and DTLS is that DTLS introduces a few measures to handle the inherently unreliable UDP transport, e.g. message loss, reordering, fragmentation and retransmissions. DTLS also introduces the Cookie exchange to <a href="https://tools.ietf.org/html/rfc6347#section-4.2.1">prevent DoS attacks</a>.</p>

<p>Anyway - the <a href="https://github.com/bocajim/dtls">dtls</a> library handles all of this for us as long as we can supply the correct Client_id, PSK and IP to the gateway.</p>

<h3 id="23-usage-in-our-go-application">2.3 Usage in our Go application</h3>

<p>Here’s the tradfri-go code where the handshake is performed behind the scenes. I’ve defined a struct <em>DtlsClient</em> that encapsulates the dtls.Peer and the message counter:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>// DtlsClient provides an domain-agnostic CoAP-client with DTLS transport.
type DtlsClient struct {
	peer  *dtls.Peer
	msgID          uint16
    gatewayAddress string
    clientID       string
    psk            string
}

// NewDtlsClient acts as factory function, returns a pointer to a connected (or will panic) DtlsClient.
func NewDtlsClient(gatewayAddress, clientID, psk string) *DtlsClient {
	client := &amp;DtlsClient{
		gatewayAddress: gatewayAddress,
		clientID:       clientID,
		psk:            psk,
	}
	client.connect()
	return client
}
</code></pre></div></div>

<p>Here’s the handshake/connect code:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>func (dc *DtlsClient) connect() {
    dc.setupKeystore()
    
    listener, err := dtls.NewUdpListener(":0", time.Second*900)
    if err != nil {
        panic(err.Error())
    }

    peerParams := &amp;dtls.PeerParams{
        Addr:             dc.gatewayAddress,
        Identity:         dc.clientID,
        HandshakeTimeout: time.Second * 15}
    fmt.Printf("Connecting to peer at %v\n", dc.gatewayAddress)

    dc.peer, err = listener.AddPeerWithParams(peerParams)
    if err != nil {
        fmt.Printf("Unable to connect to Gateway at %v: %v\n", dc.gatewayAddress, err.Error())
        os.Exit(1)
    }
    dc.peer.UseQueue(true)
    fmt.Printf("DTLS connection established to %v\n", dc.gatewayAddress)
}
</code></pre></div></div>

<p>As one can see, the complexities of the DTLS handshake is fully handled behind the scenes. The returned <a href="https://godoc.org/github.com/bocajim/dtls#Peer">dtls.Peer</a> can then be used to write and read arbitrary <em>[]byte</em> just like any socket, i.e:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>// Write data over the socket
err = dc.peer.Write(data)
if err != nil {
    return coap.Message{}, err
}

// Wait for response
respData, err := dc.peer.Read(time.Second * 3)
if err != nil {
    return coap.Message{}, err
}
// do something with the response...
</code></pre></div></div>

<h1 id="3-coap---constrained-application-protocol">3. COAP - Constrained Application Protocol</h1>
<p>Defined in <a href="https://tools.ietf.org/html/rfc7252">RFC7252</a>, CoAP is a (quote from the RFC):</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>"specialized web transfer protocol for use with constrained 
nodes and constrained (e.g., low-power, lossy) networks."
</code></pre></div></div>

<p>It re-uses much of the well-known RESTful paradigm with verb-based methods (GET, POST, PUT, DELETE) and servers providing resources under a URL.</p>

<p>Message payloads can be anything you want, e.g. JSON, XML or some arbitrary binary format, and the content-type of payloads can be specified with headers just like in HTTP. It also borrows <a href="https://tools.ietf.org/html/rfc7252#section-12.1.2">response codes</a> very similar to HTTP, such as “<em>4.00 Bad Request</em>” and “<em>4.04 Not Found</em>”. The 2.XX response codes indicating a successful request has slightly different semantics compared to HTTP. For example, no “<em>2.00 OK</em>” exists.</p>

<p>The actual messages are encoded into a compact format to conserve resources such as bandwidth and CPU-cycles. Again - the gritty details of which info that goes into which bit is out-of-scope for this blog post, but as reference the format looks like this:</p>

<p><img src="../../../../../../assets/blogg/tradfri/tradfri-3.png" alt="coap header" />
<em>Source: Wikimedia Commons</em></p>

<h3 id="31-coap-in-go">3.1 CoAP in Go</h3>
<p>Writing a CoAP message serializer/deserializer may sound like fun, but perhaps not fun enough for me to do it given that there already exists a nice CoAP library for Go: <a href="https://github.com/dustin/go-coap">go-coap</a> by <a href="https://github.com/dustin">Dustin Sallings</a>.</p>

<p>Dustin’s library makes creating/parsing CoAP-messages a breeze. Here’s an example where I build a GET message:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>func (dc *DtlsClient) BuildGETMessage(path string) coap.Message {
	dc.msgID++
	req := coap.Message{
		Type:      coap.Confirmable,
		Code:      coap.GET,
		MessageID: dc.msgID,
	}
	req.SetPathString(path)
	return req
}
</code></pre></div></div>

<p>The <em>coap.Message</em> can then be serialized into a byte-array and written to the dtls.Peer and the response is as easily read and deserialized into a coap.Message.</p>

<p>I’ve wrapped the CoAP / Trådfri stuff into a struct <em>TradfriClient</em> that encapsulates the <em>DtlsClient</em>:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>type TradfriClient struct {
	dtlsclient *dtlscoap.DtlsClient
}

func NewTradfriClient(gatewayAddress, clientID, psk string) *TradfriClient {
	client := &amp;TradfriClient{}
	client.dtlsclient = dtlscoap.NewDtlsClient(gatewayAddress, clientID, psk)
	return client
}
</code></pre></div></div>

<p>Here’s the code that performs a GET for a given resource, for example the state of a bulb:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>func (tc *TradfriClient) GetDevice(id string) (model.Device, error) {
	device := &amp;model.Device{}

	resp, err := tc.Call(tc.dtlsclient.BuildGETMessage("/15001/" + id))
	if err != nil {
		return *device, err
	}
	err = json.Unmarshal(resp.Payload, &amp;device)
	if err != nil {
		return *device, err
	}
	return *device, nil
}
</code></pre></div></div>

<p>The <em>tc.Call</em> proxies to the <em>Call</em> method of the DtlsClient which writes and reads plain bytes to/from the peer:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>func (dc *DtlsClient) Call(req coap.Message) (coap.Message, error) {
    // Serialize msg struct into raw CoAP payload
	data, err := req.MarshalBinary()
	if err != nil {
		return coap.Message{}, err
	}
	
	// Write the payload into the peer (e.g. socket)
	err = dc.peer.Write(data)
	if err != nil {
		return coap.Message{}, err
	}

    // Wait for the response
	respData, err := dc.peer.Read(time.Second * 3)
	if err != nil {
		return coap.Message{}, err
	}

    // Deserialize the CoAP response into a coap.Message struct and return
	msg, err := coap.ParseMessage(respData)
	if err != nil {
		return coap.Message{}, err
	}
	return msg, nil
}
</code></pre></div></div>

<p>Now that we can write and read CoAP messages over DTLS to the IKEA Gateway, it’s time to explore the capabilties of the CoAP API of the IKEA trådfri gateway.</p>

<h1 id="4-the-trådfri-api">4. The Trådfri API</h1>
<p>The CoAP endpoints on the Trådfri Gateway are <em>not</em> an official API, though IKEA has stated an intent to someday make an API available for official use.</p>

<p>There are a number of unofficial resources describing the various CoAP endpoints and data structures that I’ve used to create this client:</p>

<ul>
  <li>https://gist.github.com/hardillb/4ce9fc493b792806e39f7fae4b7c28a7</li>
  <li>https://learn.pimoroni.com/tutorial/sandyj/controlling-ikea-tradfri-lights-from-your-pi</li>
  <li>https://bitsex.net/software/2017/coap-endpoints-on-ikea-tradfri/</li>
</ul>

<h3 id="41-resource-endpoints">4.1 Resource endpoints</h3>
<p>The kind people in the links above have deducted a few basic guidelines that the Trådfri API seems to be built upon:</p>

<ul>
  <li>
    <p>/15004 returns an array of identifiers for groups configured in your setup.</p>

    <p>[131073]</p>
  </li>
  <li>
    <p>/15004/131073 returns that group</p>

    <p>{“9001”:”TRADFRI group”,”9002”:1550335495,”9003”:131073,”5850”:0,”5851”:0,”9039”:196608,”9108”:0,”9018”:{“15002”:{“9003”:[65536,65537,65538,65539,65540]}}}</p>
  </li>
  <li>/15001/65536 is the remote control</li>
  <li>/15001/65537 is the power outlet</li>
  <li>
    <p>/15001/65538 is the first light bulb in my setup, here’s a sample response:</p>

    <p>{“9019”:1,”9001”:”Färgglad”,”9002”:1550336061,”9020”:1551635481,”9003”:65538,”9054”:0,”5750”:2,”3”:{“0”:”IKEA of Sweden”,”1”:”TRADFRI bulb E27 CWS opal 600lm”,”2”:””,”3”:”1.3.009”,”6”:1},”3311”:[{“5708”:42596,”5850”:1,”5851”:110,”5707”:5427,”5709”:30015,”5710”:26870,”5706”:”f1e0b5”,”9003”:0}]}</p>
  </li>
</ul>

<h3 id="42-message-payloads">4.2 Message payloads</h3>
<p>Let’s try to make some sense of the payload examples above. The CoAP messages largely follows OMA LWM2M, i.e. the “Open Mobile Alliance Lightweight Machine 2 Machine” standard. Their <a href="http://www.openmobilealliance.org/wp/OMNA/LwM2M/LwM2MRegistry.html">registry</a> provides some descriptions on various codes. For example, we can see that 5850 is <em>“an on/off actuator, which can be controlled, the setting of which is a Boolean value where True is On and False is Off.”</em>.</p>

<p>However, a lot of those codes - especially those in the 9xxx range - doesn’t seem to be in a public registry, so some guessing, reading resources such as the links above and reverse-engineering the messages is required. Let’s break the device message down:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code> {
   "9019": 1,           // No idea
   "9001": "Färgglad",  // The name I gave this bulb in the Tradfri app
   "9002": 1550336061,  // Some unix timestamp
   "9020": 1551635481,  // Some unix timestamp
   "9003": 65538,       // Object id
   "9054": 0,           // No idea
   "5750": 2,           // Application Type
   "3": {               // Device type metadata?
     "0": "IKEA of Sweden",                     // Vendor name
     "1": "TRADFRI bulb E27 CWS opal 600lm",    // Device type name
     "2": "",                                   // No idea
     "3": "1.3.009",                            // Device type id?
     "6": 1                                     // No idea
   },
   "3311": [               // Device values
     {
       "5708": 42596,      // Something with color... ?
       "5850": 1,          // Device power on/off
       "5851": 110,        // Dimmer (0-255)
       "5707": 5427,       // Something with color... ?
       "5709": 30015,      // X color (CIE 1931)
       "5710": 26870,      // Y color (CIE 1931)
       "5706": "f1e0b5",   // Hex color 
       "9003": 0
     }
   ]
 }
</code></pre></div></div>

<p>If one were to build a user interface (a Web GUI for example) for viewing your IKEA Trådfri setup, I wouldn’t want the payload above exposed as-is for the client to use. I’d map the relevant stuff into a new JSON struct and pass that. In Go terms, a few structs like these could represent bulbs and power plugs:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>type DeviceMetadata struct {
	Id     int    `json:"id"`
	Name   string `json:"name"`
	Vendor string `json:"vendor"`
	Type   string `json:"type"`
}

type PowerPlugResponse struct {
	DeviceMetadata DeviceMetadata `json:"deviceMetadata"`
	Powered        bool           `json:"powered"`
}

type BulbResponse struct {
	DeviceMetadata DeviceMetadata `json:"deviceMetadata"`
	Dimmer         int            `json:"dimmer"`
	CIE_1931_X     int            `json:"xcolor"`
	CIE_1931_Y     int            `json:"ycolor"`
	RGB            string         `json:"rgbcolor"`
	Powered        bool           `json:"powered"`
}
</code></pre></div></div>

<p>For other device types such as the Power plug or the remote, other fields may be relevant so I’m doing a bit of composition so common stuff can go into the DeviceMetadata struct.</p>

<h1 id="5-running">5. Running</h1>
<p>Let’s get practical. The source code for this little program is on my <a href="https://github.com/eriklupander/tradfri-go">github page</a>.</p>

<p>Clone the source code and build using:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&gt; go build -o tradfri-go
</code></pre></div></div>

<p>or produce binaries for different platforms:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&gt; make release
  mkdir -p dist
  GO111MODULE=on go build -o dist/tradfri-go-darwin-amd64
  GO111MODULE=on;GOOS=linux;go build -o dist/tradfri-go-linux-amd64
  GO111MODULE=on;GOOS=windows;go build -o dist/tradfri-go-windows-amd64
  GO111MODULE=on;GOOS=linux GOARCH=arm GOARM=5;go build -o dist/tradfri-go-linux-arm5
</code></pre></div></div>

<p>Start by finding out the IP-address to your Gateway. It’s probably possible to do a quick port-scan or multicast to find it, but I chose to simply go into the admin GUI of my NetGear router and find the gateway there.</p>

<p>The deviceId looks like this: GW-A1D4A0D1FF45</p>

<p>Then, I recommend setting an environment variable with this IP, for example:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>export GATEWAY_IP=192.168.1.19
</code></pre></div></div>

<p>It’s also possible to pass the IP to the gateway to the “tradfri-go” executable using the –gateway_ip flag.</p>

<h3 id="51-auth-token-exchange">5.1 Auth token exchange</h3>
<p>This is a 1-time step required before you can run in server mode or play around in the client mode. It will exchange the pre-shared key printed underside your Gateway for a new one bound to the <em>client_id</em> you specify. All subsequent calls to the Gateway from <em>tradfri-go</em> will then use these credentials for the DTLS handshake.</p>

<p>Running the command below will perform the token exchange and store your settings to a <em>config.json</em> file.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>./tradfri-go --authenticate --client_id=MyCoolID --psk=TheKeyAtTheBottomOfYourGateway --gateway_ip=&lt;ip to your gateway&gt;
</code></pre></div></div>

<p>The new token is stored in the current directory in the file “config.json”, which contains your clientId, the new PSK and the Gateway IP you specified, e.g:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&gt; cat config.json
{
  "client_id": "MyCoolID",
  "gateway_address": "192.168.1.19:5684",
  "gateway_ip": "192.168.1.19",
  "pre_shared_key": "the generated psk goes here",
  "psk": "the generated psk goes here"
}
</code></pre></div></div>

<p>The program will try to read your gateway_ip, clientId and PSK from the <em>config.json</em> file for both client and server modes.</p>

<p>If you don’t feel like using <em>config.json</em>, you can either specify the configuration as command-line flags or using environment variables:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>./tradfri-go --server --client_id MyCoolID122 --psk mynewkey --gateway_ip=192.168.1.19
</code></pre></div></div>

<p>or</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&gt; export CLIENT_ID=MyCoolID1122
&gt; export PRE_SHARED_KEY=mynewkey
&gt; export GATEWAY_IP=192.168.1.19
&gt; ./tradfri-go --server
</code></pre></div></div>

<p>Configuration is resolved in the following order of precedence:</p>

<p>config.json -&gt; command-line arguments -&gt; environment variables</p>

<h3 id="52-client-mode">5.2 Client mode</h3>
<p>While my primary intent for tradfri-go is to run in its “server” mode, it also supports basic GET and PUT ops directly from the command-line that returns the raw JSON payload from the CoAP messages.</p>

<p>A few examples:</p>

<p>GET my bulb at /15001/65538:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>./tradfri-go --get /15001/65538
{"9019":1,"9001":"Färgglad","9002":1550336061,"9020":1551721891,"9003":65538,"9054":0,"5750":2,"3":{"0":"IKEA of Sweden","1":"TRADFRI bulb E27 CWS opal 600lm","2":"","3":"1.3.009","6":1},"3311":[{"5708":65279,"5850":1,"5851":100,"5707":53953,"5709":20316,"5710":8520,"5706":"8f2686","9003":0}]}
</code></pre></div></div>

<p>PUT that turns off the bulb at /15001/65538:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>./tradfri-go --put /15001/65538 --payload '{ "3311": [{ "5850": 0 }] }'
</code></pre></div></div>

<p>PUT that turns on the bulb at /15001/65538 and sets dimmer to 200:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>./tradfri-go --put /15001/65538 --payload '{ "3311": [{ "5850": 1, "5851": 200 }] }'
</code></pre></div></div>

<p>PUT that sets color of the bulb at /15001/65538 to purple and the dimmer to 100:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>./tradfri-go --put /15001/65538 --payload '{ "3311": [{ "5706": "8f2686", "5851": 100 }] }'
</code></pre></div></div>

<p><img src="../../../../../../assets/blogg/tradfri/purple.jpg" alt="it's purple" /></p>

<p>The colors possible to set on the bulbs varies. The colors are in the CIE 1931 color space whose x/y values <em>in theory</em> can be set using the 5709 and 5710 codes to values between 0 and 65535. You can’t set arbitrary values due to how the CIE 1931 (yes, it’s a standard from 1931!) works. Play around with the values, I havn’t broken my full-color “TRADFRI bulb E27 CWS opal 600lm” yet…</p>

<h3 id="53-server-mode">5.3 Server mode</h3>

<p>To start in the server mode, which provides the <a href="https://github.com/go-chi/chi">chi</a>-based HTTP REST API, just add the –server flag:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>./tradfri-go --server
Running in server mode on :8080
Connecting to peer at 192.168.1.19:5684
DTLS connection established to 192.168.1.19:5684
</code></pre></div></div>

<p>Now, you can use the simple RESTful API instead which returns more human-readable responses. Get a device:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&gt; curl http://localhost:8080/api/device/65538 | jq .
{
  "deviceMetadata": {
    "id": 65538,
    "name": "Färgglad",
    "vendor": "IKEA of Sweden",
    "type": "TRADFRI bulb E27 CWS opal 600lm"
  },
  "dimmer": 100,
  "xcolor": 30015,
  "ycolor": 26870,
  "rgbcolor": "f1e0b5",
  "powered": true
}
</code></pre></div></div>

<p>Get a group:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&gt; curl http://localhost:8080/api/groups/131073 | jq .
{
  "id": 131073,
  "power": 0,
  "created": "2019-02-16T17:44:55+01:00",
  "deviceList": [
    65536,
    65537,
    65538,
    65539,
    65540
  ]
}
</code></pre></div></div>

<p>We can PUT to the <em>/api/device/{deviceId}</em> endpoint to mutate the state of the bulb using three pre-defined settings:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&gt; curl -X PUT --data '{"rgbcolor":"f1e0b5","power":1,"dimmer":254}' http://localhost:8080/api/device/65538
</code></pre></div></div>

<p>Just like the client mode, the application will try to use clientId/PSK from <em>config.json</em> or using env vars.</p>

<p>I havn’t built a “complete” API, just a few ones as a proof of concept. See <a href="https://github.com/eriklupander/tradfri-go/blob/master/router/router.go">router.go</a>.</p>

<h1 id="6-summary">6. Summary</h1>

<p>In its current state, the tradfri-go program isn’t <em>that</em> usable, it’s mainly been an exercise up until now trying to get my head around CoAP, DTLS and how to interact with the Gateway.</p>

<p>I’d say that it could be a good foundation for building something more advanced such as custom GUI or that idea of continuously collecting the powered/dimmming/colors state of your bulbs and eventually combining that data with time-of-day, weekday, weather data and whatnot with the intent of training a neural network that could automate your lights, blinders etc. given historical data and various environmental circumstances.</p>

<p>It should also be possible to use the <em>github.com/eriklupander/tradfri-go/dtlscoap</em> package as an external dependency to build something different around it.</p>

<p>Anyway - my primary intent was to have a good time writing some “non-enterprisy” code while learning something new, so I’m quite happy with this excerise! And not to forget - making lights blink is always fun!</p>

<p>Please help spread the word! Feel free to share this blog post using your favorite social media platform, there’s some icons below to get you started.</p>

<p>Until next time!</p>

<p>// Erik</p>









            <div class="ce-blog-thanks">
              Tack för att du läser Callistas blogg. <br>
              Hjälp oss att nå ut med information genom att dela nyheter och artiklar i ditt nätverk.<br>
            </div>

            


    
<div class="ce-blog-share">
    <a class="ce-blog-share-element social-twitter" href="https://twitter.com/intent/tweet?text=A Quick Home Automation&url=https://callistaenterprise.se/blogg/teknik/2019/03/15/a-quick-home-automation/&via=callistaent&hashtags=" target="_blank" title="Share this post on Twitter"></a>
    <a class="ce-blog-share-element social-facebook" href="https://www.facebook.com/sharer/sharer.php?t=A Quick Home Automation&u=https://callistaenterprise.se/blogg/teknik/2019/03/15/a-quick-home-automation/" target="_blank" title="Share this post on Facebook"></a>
    <a class="ce-blog-share-element social-linkedin" href="http://www.linkedin.com/shareArticle?mini=true&title=A Quick Home Automation&url=https://callistaenterprise.se/blogg/teknik/2019/03/15/a-quick-home-automation/&source=http%3a%2f%2fzhangwenli.com" target="_blank" title="Share this post on LinkedIn"></a>
</div>
    
        </article>
    </div>
</section>


<section class="ce-section">
    <heading>
        <h1>Kommentarer</h1>
    </heading>
    <div class="ce-content">
        <div id="disqus_thread"></div>
        <script src="../../../../../../js/disqus.js"></script>
    </div>
</section>


    </div>

    <footer class="ce-footer">
    <div class="ce-wrapper">
        <nav class="ce-menu-footer-primary">
            <h2><a href="../../../../../../index.html">Callista</a></h2>
            <ul>
                
                <li><a href="../../../../../../om/index.html">Om oss</a></li>
                
                <li><a href="../../../../../../erbjudanden.html">Erbjudanden</a></li>
                
                <li><a href="../../../../../../event.html">Event</a></li>
                
                <li><a href="../../../../../../blogg.html">Blogg</a></li>
                
                <li><a href="../../../../../../om/jobb/index.html">Jobba hos oss</a></li>
                

                
                    
                        <li><a href="../../../../../../english/index.html">English</a></li>
                    
                
            </ul>
        </nav>
        <div class="ce-addresses">
            <div class="ce-address">
                <h2>Stockholm</h2>
                <address>
                    Drottninggatan 55<br>
                    111 21 Stockholm<br>
                    Tel:
                    <a href="tel:+468212142">
                        +46 8 21 21 42
                    </a>
                </address>
            </div>
            <div class="ce-address">
                <h2>Göteborg</h2>
                <address>
                    Fabriksgatan 13<br>
                    412 50 Göteborg<br>
                    Tel:
                    <a href="tel:+4631201918">
                        +46 31 20 19 18
                    </a>
                </address>
            </div>
        </div>
        <div class="ce-social">
            <h2>Följ oss</h2>
            <ul>
                <li>
                    <a href="http://twitter.com/callistaent">
                        <img alt="Twitters logotype" src="../../../../../../images/icons/twitter.png">
                        <span>@callistaent</span>
                    </a>
                </li>
            </ul>
        </div>
        <small>&copy; 2021 Callista Enterprise AB</small>
        <hr style="margin: 1em 0 2em 0">
        <div class="ce-footer-images">
          <div class="ce-footer-image">
            <a class="ce-raddabarnen" href="http://www.raddabarnen.se/foretag">
                <img alt="Callista är Rädda Barnens företagsvän 2021" src="../../../../../../images/logotype/rb_vanforetag_2021_large-sv.png">
            </a>
          </div>
        </div>
        <br>
        <div class="ce-footer-images">
          <div class="ce-footer-image">
            <a class="ce-di-gasell" href="http://www.di.se/gasell/">
              <img alt="Callista utsett till DI Gasell tre år i rad" src="../../../../../../images/logotype/di_gasell_180x194.png">
            </a>
          </div>
        </div>
    </div>
</footer>


    <script src="../../../../../../js/lib/jquery.min.js"></script>
    <script src="../../../../../../js/lib/owl.carousel.min.js"></script>
    <script src="../../../../../../js/lib/prismjs.min.js"></script>
    <script src="../../../../../../js/app.js"></script>
    <script src="../../../../../../js/analytics.js"></script>
    <script src="../../../../../../js/jobinterestsubmit.js"></script>

</body>
</html>
