<!DOCTYPE html>
<html lang="sv-se">
<head>
    <meta charset="utf-8">

    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="description" content="Callista Enterprise - seniora IT-arkitekter och systemutvecklare inom Java, öppen källkod, agil utveckling och systemintegration">
    <!--<meta name="viewport" content="width=device-width, initial-scale=1">-->
    <meta name="viewport" content="initial-scale=1.0001, minimum-scale=1.0001, maximum-scale=1.0001, user-scalable=no"/>

    <link rel="icon" href="../../../../../../images/icons/callista_favicon.svg" type="image/x-icon" />
    <link rel="shortcut icon" href="../../../../../../images/icons/callista_favicon.svg" type="image/x-icon" />
    <link rel="apple-touch-icon" href="../../../../../../images/icons/callista_favicon_160x160.png">

    <title>C10k: Lightweight Java servers for large scaled realtime WebSocket communication | Callista</title>

    <link rel="stylesheet" href="../../../../../../css/style.css%3Fv=1.css">
    <link rel="alternate" type="application/rss+xml" title="RSS Feed for callistaenterprise.se" href="../../../../../../feed.xml" />

    <!--[if lte IE 8]>
    <style>* { display: none !important; }</style>
    <meta http-equiv="refresh" content="0; url=/oldie/"/>
    <![endif]-->

    <script type="text/javascript" src="https://use.typekit.net/kig5egm.js"></script>
    <script type="text/javascript">
        try {
            Typekit.load({ async: true });
        } catch (e) {
        }
    </script>

    <!-- Facebook Pixel Code -->
    <script>
    !function(f,b,e,v,n,t,s)
    {if(f.fbq)return;n=f.fbq=function(){n.callMethod?
    n.callMethod.apply(n,arguments):n.queue.push(arguments)};
    if(!f._fbq)f._fbq=n;n.push=n;n.loaded=!0;n.version='2.0';
    n.queue=[];t=b.createElement(e);t.async=!0;
    t.src=v;s=b.getElementsByTagName(e)[0];
    s.parentNode.insertBefore(t,s)}(window,document,'script',
    'https://connect.facebook.net/en_US/fbevents.js');
     fbq('init', '804675599711872');
     fbq('track', 'PageView');
    </script>
    <noscript>
     <img height="1" width="1" src="https://www.facebook.com/tr?id=804675599711872&ev=PageView&noscript=1"/>
    </noscript>
    <!-- End Facebook Pixel Code -->

</head>
<body>

    <header class="ce-header" data-scroll="0">
    <nav>
        <img alt="menubg" class="ce-menu-icon" style="z-index:3; top: 0px; width: 50px; height: 100%;" src="../../../../../../images/icons/menu_background.png">
        <a class="ce-logotype" href="../../../../../../index.html" style="z-index: 2;">
            <img alt="Callista" style="max-width: 100%; height: auto;" src="../../../../../../images/logotype/callista_small2.svg">
        </a>
        <table>
            <tr>
                <td>
            <ul id="menu-primary" class="ce-menu-primary">
                
                    
                            <li><a href="../../../../../../om/index.html">Om oss</a></li>
                    
                
                    
                            <li><a href="../../../../../../erbjudanden.html">Erbjudanden</a></li>
                    
                
                    
                            <li><a href="../../../../../../event.html">Event</a></li>
                    
                
                    
                        
                            <li><a class="ce-active" href="../../../../../../blogg.html">Blogg</a></li>
                        
                    
                
                    
                            <li><a href="../../../../../../om/jobb/index.html">Jobba hos oss</a></li>
                    
                
            </ul>
                </td>

                <td>
            <ul class="ce-menu-secondary">
                
                <li><a href="../../../../../../english/index.html">English</a></li>
                
            </ul>
                </td>
            </tr>
        </table>
            <a id="menu" class="ce-menu-icon" href="index.html#" style="z-index: 4;">
                <img alt="Visa meny" src="../../../../../../images/icons/menu.png">
            </a>
            <a class="ce-search-icon" href="index.html#">
                <img alt="Sök" src="../../../../../../images/icons/search.png">
            </a>

        </table>
    </nav>
</header>


    <div class="ce-main">
        <section class="ce-start lazyImg">
    <article>
        <h1>Blogg</h1>
        <p class="ce-ingress">
            Här finns tekniska artiklar, presentationer och nyheter om arkitektur och systemutveckling. Håll dig uppdaterad, följ oss på <a class="ce-active" href="http://twitter.com/callistaent">Twitter</a>
        </p>
    </article>
</section>

<section class="ce-section">
    <div class="ce-content">
        
        

        
        

        <article class="ce-blog">
            <header>
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    <img alt="Callista medarbetare Magnus Larsson" src="../../../../../../assets/medarbetare/magnuslarsson_mini.png">
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    <h2>
        <a href="index.html">C10k: Lightweight Java servers for large scaled realtime WebSocket communication</a>
        
        
    </h2>
    <h3>
        <time datetime="2013-08-12T00:00:00+00:00">
            12 August 2013
        </time>
        //
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        

        
        
        <a href="../../../../../../om/medarbetare/magnuslarsson/index.html">Magnus Larsson</a>
        

        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
    </h3>
    
</header>




<p>According to my colleges that work with <a href="http://www.callistaenterprise.se/vadgorvi/enterprisefrontend.html">frontend technologies</a> many of our customers have today started to use HTML5 to build <a href="http://en.wikipedia.org/wiki/Single-page_application">single page web apps</a> but most of them have not yet switched from old school HTTP to <a href="http://www.websocket.org/index.html">WebSockets</a> when it comes to communicating with backend server applications.</p>

<p>WebSockets simplifies much of the complexity in HTTP for bi-directional communication required by single page web apps. With its support for full duplex communication over a single socket it enables both client initiated <a href="http://en.wikipedia.org/wiki/Request-response">request/response</a> and server initiated <a href="http://en.wikipedia.org/wiki/Push_technology">push</a> or <a href="http://en.wikipedia.org/wiki/Publish/subscribe">publish/subscribe</a> in a natural and simple way. Added to this the WebSocket protocol have a much lower overhead compared to the HTTP protocol resulting in lower latency. With its support for full duplex and low latency communication WebSocket opens up for true realtime communication, not feasible with HTTP.</p>

<p>With the growing support for <a href="http://caniuse.com/websockets">WebSocket in web browsers</a> it is now becoming more and more interesting to look into how to start to use WebSocket instead of HTTP.</p>

<p>In a previous <a href="https://callistaenterprise.se/blogg/teknik/2013/01/10/mule-esb-nio-http-transport-and-10000-websocket-clients/">blog post</a> we covered how WebSocket communication can be established with a number of servers using an intermediate integration platform, <a href="http://www.mulesoft.org/">Mule ESB</a>, like:</p>

<p><img src="../../../../../../assets/blogg/c10k-lightweight-java-servers-for-large-scaled-realtime-websocket-communication/ws-one-esb.png" alt="" /></p>

<p>In this blog we will focus on the case where we (at least for the time being) don’t want to invest in a WebSocket enabled integration platform or ESB but just want to WebSocket-enable a single Java based server application:</p>

<p><img src="../../../../../../assets/blogg/c10k-lightweight-java-servers-for-large-scaled-realtime-websocket-communication/ws-one-requrements1.png" alt="" /></p>

<p>The blog is divided in the following sections:</p>

<ul>
  <li>Requirements</li>
  <li>Meeting the requirements</li>
  <li>Source code</li>
  <li>A test run</li>
  <li>Summary</li>
  <li>Next step</li>
</ul>

<h2 id="requirements">Requirements</h2>
<p>Requirements for the scope of this blog entry are:</p>

<h3 id="1-realtime-low-latency-full-duplex-asynchronous-communication">1. Realtime (low latency) full duplex (asynchronous) communication</h3>
<p>Web apps must be able to send requests asynchronously allowing the user to do other things while the server process the request and also allow the server to send information to the web app without the web app asking for it in advance. To support remote mobile devices with potential limited bandwidth it is also important that the communication have minimal overhead built into the protocol to be able to communicate in realtime.</p>

<h3 id="2-support-for-both-client-initiated-requestresponse-and-server-initiated-publishsubscribe-exchanges">2. Support for both client initiated request/response and server initiated publish/subscribe exchanges</h3>
<p>Added to the traditional request/response model we also want to be able to notify users as soon as any interesting happens on the server side without having to wait for polling solutions or forcing the user to refresh the user interface to see if any interesting have happened since the previous refresh…</p>

<h3 id="3-large-number-of-concurrent-users">3. Large number of concurrent users</h3>
<p>Exposing enterprise applications to large user groups on their mobile devices is expected to raise requirements of handling much larger numbers of concurrent users on the server side then before.</p>

<h3 id="4-lightweight-and-embeddable-server-side-solutions">4. Lightweight and embeddable server side solutions</h3>
<p>Given that we don’t want to bring in a full fledged integration platform or ESB in between the server and its clients we need to ensure that the server application itself can be enhanced with communication capabilities that meets the requirements above without draining the server hardware or requiring extra server processes to be setup, managed and monitored separately from the application itself. Otherwise, in the end, that could easily lead to a solution that is equally complex as introducing a separate integration platform!</p>

<p>Added to these requirements we have defined the following constraints:</p>

<ol>
  <li>
    <p>Target application technology on the client side are HTML5 based single page web applications.</p>

    <p>It could actually be any type of WebSocket enabled technology on the client side, such as native iOS or Android apps, but we have limited this blog to HTML5 web apps.</p>
  </li>
  <li>
    <p>Server applications are expected to be based on Java SE. It should however be very interesting to cover other alternatives, such as <a href="http://nodejs.org/">node.js</a>, in a future blog.</p>
  </li>
</ol>

<h2 id="meeting-the-requirements">Meeting the requirements</h2>

<h3 id="1-realtime-low-latency-full-duplex-asynchronous-communication-1">1. Realtime (low latency) full duplex (asynchronous) communication</h3>
<p>Historically HTTP has been used with various success to meet these requirements, e.g. using AJAX, Reverse AJAX and Comet technologies. But HTTP was never designed for this purpose, HTTP is based on a half-duplex model initially targeted for fetching documents and added to that with a substantial communication overhead. WebSocket on the other hand is explicitly designed for full duplex communication with a very low overhead enabling realtime communication even over wireless connections with very limited bandwidth. WebSocket is clearly the technology for the future to meet this requirement!</p>

<blockquote>
  <p><strong>Decision #1:</strong> Use WebSocket for realtime full duplex communication.</p>
</blockquote>

<h3 id="2-support-for-both-client-initiated-requestresponse-and-server-initiated-publishsubscribe-exchanges-1">2. Support for both client initiated request/response and server initiated publish/subscribe exchanges</h3>
<p>WebSocket, with its fully asynchronous and duplex communication over a single socket, however neither understand nor support message exchange patterns such as request/response or publish/subscribe. An asynchronous version of the request/response model is however very simple to implement using WebSocket. One concern could be how to correlate incoming responses on the client side to the originating requests in the case where more than one request can submitted concurrently from one and the same client. Using some kind of correlation id in the message payload however solves the problem in most cases.</p>

<p>When it comes to the publish/subscribe model it becomes tricker since WebSocket have no understanding of critical concepts such as subscribers, publishers and topics. We clearly need a protocol on top of the WebSocket protocol to handle publish/subscribe!</p>

<p>A good thing is that WebSocket is prepared for these types of extensions with its support for subprotocols. Clients and servers can agree upon use of subprotocols during the connection phase (see the <a href="http://dev.w3.org/html5/websockets/#the-websocket-interface">WebSocket API</a>). Even tough we here have the opportunity to create our own publish/subscribe subprotocol we prefer to use something already existing and well established!</p>

<p>Commonly used open (i.e. not proprietary and vendor locked in) protocols for messaging are <a href="http://www.amqp.org/">AMQP</a>, <a href="http://stomp.github.io/">STOMP</a> and <a href="http://mqtt.org/">MQTT</a> (Facebook is for example using MQTT in its <a href="https://m.facebook.com/notes/facebook-engineering/building-facebook-messenger/10150259350998920">Facebook Messenger</a> application). Both STOMP and MQTT are available as subprotocols of WebSockets so lets focus on these two. STOMP is a simple text oriented messaging protocol (giving it its name) while MQTT is a more advanced binary protocol with more features and potentially higher performance due to its binary nature. Which one to prefer is hard to say and will depend on case specific requirements, STOMP being very simple and easy to learn while MQTT being more functional and potentially better performing but with a steeper learning curve. Let’s look into both!</p>

<blockquote>
  <p><strong>Decision #2:</strong> Complement the WebSocket protocol with the subprotocols STOMP and MQTT to support the publish/subscribe model.</p>
</blockquote>

<h3 id="3-large-number-of-concurrent-users-1">3. Large number of concurrent users</h3>
<p>When it comes to handling large number of users, e.g. thousands of concurrently connected user, it has historically been quite complex requiring lots of server hardware and carefully configured communication software. This is mostly depending on the fact that a blocking I/O model was used, locking a separate thread per connection or request. This quickly drain the server hardware resources when the number of concurrent requests rises. A much better approach to handle large number of concurrent users are a non blocking I/O model allowing one thread to handle many concurrent requests. For more background information see <a href="http://www.kegel.com/c10k.html">the C10K problem</a>.</p>

<p>The Java Runtime Environment supports non blocking I/O since J2SE 1.4 with a library called “New I/O” or “NIO”, later enhanced in Java SE 7 with “NIO.2”. But we also need a framework on top of it that handles WebSocket based on Java NIO.</p>

<blockquote>
  <p><strong>Decision #3:</strong> Base server solution on Java NIO.</p>
</blockquote>

<h3 id="4-lightweight-and-embeddable-server-side-solutions-1">4. Lightweight and embeddable server side solutions</h3>
<p>As described above we don’t want to bring in a complex and resource demanding solution on the server side. In that case we actually should take the integration platform/ESB path from the start enabling other server applications to benefit from it as well.</p>

<p>A number of Java based web servers and frameworks with support for WebSockets exists today. The two most widely used in my mind are the open source projects <a href="http://www.eclipse.org/jetty/">Jetty</a> and <a href="http://netty.io/">Netty</a>, both with support for non blocking I/O (using Java NIO) and both having a good track record and an active user community. Jetty being a full blown web server and servlet-container (+ much more) and Netty a lightweight framework optimized for supporting development of asynchronous event-driven network applications. For the purpose of this blog, i.e. setting up a embeddable lightweight but highly scalable Java server for asynchronous WebSocket communication, Netty became a natural choice.</p>

<p>Netty supports however neither of the messaging protocols STOMP and MQTT. Seems like we need a messaging product to complement Netty for the publish/subscribe part!</p>

<p><a href="http://activemq.apache.org/">Apache ActiveMQ</a> is on of the major Java based open source messaging product and it has support for both STOMP and MQTT over WebSockets (including Javascript API’s) so it seems like a good candidate for this blog. ActiveMQ are in most cases used as a full blown JMS Messaging Server (not so much lightweight) but it can be configured for a very slimmed down execution where it runs embedded inside a server application using the internal VM protocol instead of TCP. If not required you can also disable resource demanding features such as transactions, persistent messages and durable subscribers to make the configuration even more lightweight.</p>

<blockquote>
  <p><strong>Decision #4:</strong> Use Netty and ActiveMQ as embeddable frameworks in the server application.</p>
</blockquote>

<p>This leads to the following architecture:</p>

<p><img src="../../../../../../assets/blogg/c10k-lightweight-java-servers-for-large-scaled-realtime-websocket-communication/ws-one-architecture1.png" alt="" /></p>

<h2 id="source-code">Source code</h2>
<p>Well, that was a lot of theory! Let’s look into some code examples of how this can be implemented instead.</p>

<p>The full source code is available at github: <a href="https://github.com/callistaenterprise/websocket-labs/tree/master/ws-one">https://github.com/callistaenterprise/websocket-labs/tree/master/ws-one</a>.</p>

<p>The source code uses Maven as build tool so to get the code and build it simply perform:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ git clone https://github.com/callistaenterprise/websocket-labs.git
$ cd websocket-labs/ws-one/
$ git checkout -b my-branch ws-one-1.0.1
$ mvn package
</code></pre></div></div>

<p>After the Maven build is done a server application based on <a href="http://wrapper.tanukisoftware.com/doc/english/product-overview.html">Java Service Wrapper</a> is created under the folder <code class="language-plaintext highlighter-rouge">target/generated-resources/appassembler/jsw/ws-one-server</code>.</p>

<p>If you want to run the server application in the development environment without running it as a Java Service Wrapper simply perform:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ mvn -Pserver
</code></pre></div></div>

<p>After the server application print out a log message like:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>2013-08-09 07:18:10,193 | INFO | websocketlabs.wsone.http.file.HttpStaticFileServer | WS-One: - Developent URL: http://localhost:8081/target/classes/web/index.html
</code></pre></div></div>

<p>…you can visit the url <a href="http://localhost:8081/target/classes/web/index.html">http://localhost:8081/target/classes/web/index.html</a> in a WebWocket enabled web browser to see the web client. Try to send requests with the commands <code class="language-plaintext highlighter-rouge">status</code>, <code class="language-plaintext highlighter-rouge">on</code> and <code class="language-plaintext highlighter-rouge">off</code>. More about what happens in response to these requests is explained below, so read on!</p>

<h3 id="server">Server</h3>
<p>The server application is based on a simple Main-class demonstrating how Netty and ActiveMQ can be embedded in an existing Java application. The Main-class also creates a JMS publisher for the server application to use whenever it wants to push information to the WebSocket clients over STOMP and MQTT. Finally the Main-class also use Netty to provide a HTTP based static file server to host the HTML and Javascript files used by the web app  (in real life this typically should be handled by a dedicated web server like Apache or Nginx).</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// Start embedded ActiveMQ broker with vm and ws-transports</span>
<span class="n">runActiveMQBroker</span><span class="o">();</span>

<span class="c1">// Initiate a publisher</span>
<span class="nc">Publisher</span> <span class="n">publisher</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Publisher</span><span class="o">();</span>

<span class="c1">// Start Web Socket server</span>
<span class="n">runWebSocketServer</span><span class="o">(</span><span class="n">publisher</span><span class="o">);</span>

<span class="c1">// Start HTTP Static File server</span>
<span class="n">runHttpStaticFileServer</span><span class="o">();</span>
</code></pre></div></div>

<h4 id="embedding-activemq">Embedding ActiveMQ</h4>
<p>Initiating ActiveMQ with VM-transport for internal communication and WebSocket for external communication is as simple as:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">runActiveMQBroker</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
  <span class="nc">BrokerService</span> <span class="n">broker</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">BrokerService</span><span class="o">();</span>

  <span class="c1">// configure the broker</span>
  <span class="n">broker</span><span class="o">.</span><span class="na">addConnector</span><span class="o">(</span><span class="s">"ws://0.0.0.0:61614"</span><span class="o">);</span>

  <span class="c1">// start the broker</span>
  <span class="n">broker</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
<span class="o">}</span>
</code></pre></div></div>

<p><strong>Note #1:</strong> We don’t need to initiate the VM-transport, it is enabled by default.</p>

<p><strong>Note #2:</strong> Support for STOMP and MQTT over WebSocket comes out of the box with the WebSocket - transport.</p>

<h4 id="embedding-netty">Embedding Netty</h4>
<p>Initiating Netty is a bit more involved compared to ActiveMQ but follows a standard pattern that is very simple to reuse:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kt">void</span> <span class="nf">runWebSocketServer</span><span class="o">(</span><span class="kd">final</span> <span class="nc">Publisher</span> <span class="n">publisher</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>

  <span class="nc">EventLoopGroup</span> <span class="n">bossGroup</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">NioEventLoopGroup</span><span class="o">();</span>
  <span class="nc">EventLoopGroup</span> <span class="n">workerGroup</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">NioEventLoopGroup</span><span class="o">();</span>
  <span class="nc">ServerBootstrap</span> <span class="n">sb</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ServerBootstrap</span><span class="o">();</span>
  <span class="n">sb</span><span class="o">.</span><span class="na">group</span><span class="o">(</span><span class="n">bossGroup</span><span class="o">,</span> <span class="n">workerGroup</span><span class="o">)</span>
    <span class="o">.</span><span class="na">channel</span><span class="o">(</span><span class="nc">NioServerSocketChannel</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
    <span class="o">.</span><span class="na">childHandler</span><span class="o">(</span><span class="k">new</span> <span class="nc">ChannelInitializer</span><span class="o">&lt;</span><span class="nc">SocketChannel</span><span class="o">&gt;()</span> <span class="o">{</span>
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">initChannel</span><span class="o">(</span><span class="kd">final</span> <span class="nc">SocketChannel</span> <span class="n">ch</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
      <span class="n">ch</span><span class="o">.</span><span class="na">pipeline</span><span class="o">().</span><span class="na">addLast</span><span class="o">(</span>
        <span class="k">new</span> <span class="nf">HttpRequestDecoder</span><span class="o">(),</span>
        <span class="k">new</span> <span class="nf">HttpObjectAggregator</span><span class="o">(</span><span class="mi">65536</span><span class="o">),</span>
        <span class="k">new</span> <span class="nf">HttpResponseEncoder</span><span class="o">(),</span>
        <span class="k">new</span> <span class="nf">WebSocketServerProtocolHandler</span><span class="o">(</span><span class="no">DEFAULT_WEBSOCKET_BASE_URI</span><span class="o">),</span>
        <span class="k">new</span> <span class="nf">CustomTextFrameHandler</span><span class="o">(</span><span class="n">publisher</span><span class="o">));</span>
    <span class="o">}</span>
  <span class="o">});</span>

  <span class="kd">final</span> <span class="nc">Channel</span> <span class="n">ch</span> <span class="o">=</span> <span class="n">sb</span><span class="o">.</span><span class="na">bind</span><span class="o">(</span><span class="n">ws_port</span><span class="o">).</span><span class="na">sync</span><span class="o">().</span><span class="na">channel</span><span class="o">();</span>
  <span class="no">LOG</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">"WS-One: Web socket server started at port "</span> <span class="o">+</span> <span class="n">ws_port</span><span class="o">);</span>
<span class="o">}</span>
</code></pre></div></div>

<h3 id="notes-of-interest">Notes of interest</h3>
<ol>
  <li><code class="language-plaintext highlighter-rouge">channel(NioServerSocketChannel.class)</code> creates a Java NIO based channel.</li>
  <li><code class="language-plaintext highlighter-rouge">new WebSocketServerProtocolHandler(DEFAULT_WEBSOCKET_BASE_URI)</code> initiates WebSocket on the Java NIO based channel.</li>
  <li><code class="language-plaintext highlighter-rouge">new CustomTextFrameHandler(publisher)</code> adds an application specific request handler.</li>
</ol>

<p>The <code class="language-plaintext highlighter-rouge">CustomTextFrameHandler</code>-class picks up a WebSocket request as a string and hands it over to a request handler method, <code class="language-plaintext highlighter-rouge">requestHandler()</code>, that that is totally unaware of Netty. The request handler returns the response as a string and <code class="language-plaintext highlighter-rouge">CustomTextFrameHandler</code>-class writes the response back to the WebSocket client:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">CustomTextFrameHandler</span> <span class="kd">extends</span> <span class="nc">SimpleChannelInboundHandler</span><span class="o">&lt;</span><span class="nc">TextWebSocketFrame</span><span class="o">&gt;</span> <span class="o">{</span>

  <span class="nd">@Override</span>
  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">messageReceived</span><span class="o">(</span><span class="nc">ChannelHandlerContext</span> <span class="n">ctx</span><span class="o">,</span> <span class="nc">TextWebSocketFrame</span> <span class="n">frame</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
    <span class="nc">String</span> <span class="n">request</span> <span class="o">=</span> <span class="n">frame</span><span class="o">.</span><span class="na">text</span><span class="o">();</span>
    <span class="nc">String</span> <span class="n">response</span> <span class="o">=</span> <span class="n">requestHandler</span><span class="o">(</span><span class="n">request</span><span class="o">);</span>
    <span class="n">ctx</span><span class="o">.</span><span class="na">channel</span><span class="o">().</span><span class="na">write</span><span class="o">(</span><span class="k">new</span> <span class="nc">TextWebSocketFrame</span><span class="o">(</span><span class="n">response</span><span class="o">));</span>
  <span class="o">}</span>

  <span class="kd">public</span> <span class="nc">String</span> <span class="nf">requestHandler</span><span class="o">(</span><span class="nc">String</span> <span class="n">request</span><span class="o">)</span> <span class="o">{</span>
    <span class="o">...</span>
  <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p><strong>Note:</strong> We also clearly need some mechanism for configuration, like <a href="http://en.wikipedia.org/wiki/Dependency_injection">dependency injection</a> in Spring Framework, to separate the application logic in the request handler from the Netty-plumbing seen above but that has not been addressed in this blog.</p>

<h3 id="client">Client</h3>
<p>The client is a HTML5 based web app (as simple as possible). It has an input field for text based WebSocket requests and a number of read-only text areas for displaying:</p>

<ol>
  <li>Asynchronous WebSocket responses</li>
  <li>Asynchronous notifications from the server using STOMP over WebSocket</li>
  <li>Asynchronous notifications from the server using MQTT over WebSocket</li>
  <li>Log messages for tracking what is going on under the hood</li>
</ol>

<p><strong>Note:</strong> This test web app subscribes using both STOMP and MQTT, a real world web app of course use only one of the subprotocols.</p>

<p>After initialization the web page looks like:</p>

<p><img src="../../../../../../assets/blogg/c10k-lightweight-java-servers-for-large-scaled-realtime-websocket-communication/ws-one-web-app-startup.png" alt="" /></p>

<p>In the <strong>Log messages</strong> test area you can see how the communication is initiated for a WebSocket and adding a subscriber using both STOMP and MQTT.</p>

<p>The HTML page only contains layout:</p>

<pre class=" line-numbers"><code class="language-markup">&lt;!DOCTYPE html&gt;
&lt;html lang="en"&gt;
  &lt;head&gt;
    &lt;meta charset="utf-8"&gt;
    &lt;title&gt;Web Socket Example using STOMP and MQTT for notifications&lt;/title&gt;
    &lt;script src="js/stomp.js"&gt;&lt;/script&gt;
    &lt;script src="js/stomp_push.js"&gt;&lt;/script&gt;
    &lt;script src="js/mqttws31.js"&gt;&lt;/script&gt;
    &lt;script src="js/mqtt_push.js"&gt;&lt;/script&gt;
    &lt;script src="js/websocket.js"&gt;&lt;/script&gt;
    &lt;script src="js/app.js"&gt;&lt;/script&gt;
  &lt;/head&gt;
  &lt;body&gt;
    &lt;h1&gt;Web Socket Example using STOMP and MQTT for notifications&lt;/h1&gt;

    &lt;h2&gt;Enter a WebSocket request&lt;/h2&gt;
    &lt;form name="inputform"&gt;
      &lt;input type="text" name="message" id="message" placeholder="Enter text to be sent" autofocus&gt;
      &lt;input type="submit" value="Send Request"&gt;
    &lt;/form&gt;

    &lt;h2&gt;WebSocket response&lt;/h2&gt;
    &lt;textarea id="responseText" wrap="off" rows="7" cols="60" readonly&gt;&lt;/textarea&gt;

    &lt;h2&gt;STOMP notifications&lt;/h2&gt;
    &lt;textarea id="stompNotification" wrap="off" rows="7" cols="60" readonly&gt;&lt;/textarea&gt;

    &lt;h2&gt;MQTT notifications&lt;/h2&gt;
    &lt;textarea id="mqttNotification"  wrap="off" rows="7" cols="60" readonly&gt;&lt;/textarea&gt;

    &lt;h2&gt;Log messages&lt;/h2&gt;
    &lt;textarea id="debug" wrap="off" rows="7" cols="60" readonly&gt;&lt;/textarea&gt;
  &lt;/body&gt;
&lt;/html&gt;
</code></pre>

<p>The Javascript code is separated in a number of source files where <code class="language-plaintext highlighter-rouge">app.js</code> initiate the web app and the other three source files handles the communication, one source file per protocol:</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">App</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">socket</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nb">window</span><span class="p">.</span><span class="nx">WebSocket</span><span class="p">)</span> <span class="p">{</span>
      <span class="nb">window</span><span class="p">.</span><span class="nx">WebSocket</span> <span class="o">=</span> <span class="nb">window</span><span class="p">.</span><span class="nx">MozWebSocket</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="nb">window</span><span class="p">.</span><span class="nx">WebSocket</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">hostname</span> <span class="o">=</span> <span class="nx">location</span><span class="p">.</span><span class="nx">hostname</span>
      <span class="nx">socket</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Sock</span><span class="p">(</span><span class="dl">"</span><span class="s2">ws://</span><span class="dl">"</span> <span class="o">+</span> <span class="nx">hostname</span> <span class="o">+</span> <span class="dl">"</span><span class="s2">:8080/websocket</span><span class="dl">"</span><span class="p">,</span> <span class="nx">appendWebSocketTextArea</span><span class="p">,</span> <span class="nx">appendDebugTextArea</span><span class="p">);</span>
      <span class="k">new</span> <span class="nx">StompPush</span><span class="p">(</span><span class="dl">"</span><span class="s2">ws://</span><span class="dl">"</span> <span class="o">+</span> <span class="nx">hostname</span> <span class="o">+</span> <span class="dl">"</span><span class="s2">:61614/stomp</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">/topic/wsone.notify</span><span class="dl">"</span><span class="p">,</span> <span class="nx">appendStompNotificationTextArea</span><span class="p">,</span> <span class="nx">appendDebugTextArea</span><span class="p">);</span>
      <span class="k">new</span> <span class="nx">MqttPush</span><span class="p">(</span><span class="nx">hostname</span><span class="p">,</span> <span class="dl">"</span><span class="s2">61614</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">/wsone.notify</span><span class="dl">"</span><span class="p">,</span> <span class="nx">appendMqttNotificationTextArea</span><span class="p">,</span> <span class="nx">appendDebugTextArea</span><span class="p">);</span>

    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="nx">alert</span><span class="p">(</span><span class="dl">"</span><span class="s2">Your browser does not support Web Socket.</span><span class="dl">"</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="kd">function</span> <span class="nx">send</span><span class="p">(</span><span class="nx">event</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">socket</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="nx">event</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="nb">document</span><span class="p">.</span><span class="nx">forms</span><span class="p">.</span><span class="nx">inputform</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="dl">'</span><span class="s1">submit</span><span class="dl">'</span><span class="p">,</span> <span class="nx">send</span><span class="p">,</span> <span class="kc">false</span><span class="p">);</span>

    <span class="kd">function</span> <span class="nx">appendWebSocketTextArea</span><span class="p">(</span><span class="nx">newData</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">appendTextArea</span><span class="p">(</span><span class="nx">newData</span><span class="p">,</span> <span class="dl">'</span><span class="s1">responseText</span><span class="dl">'</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="kd">function</span> <span class="nx">appendStompNotificationTextArea</span><span class="p">(</span><span class="nx">newData</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">appendTextArea</span><span class="p">(</span><span class="nx">newData</span><span class="p">,</span> <span class="dl">'</span><span class="s1">stompNotification</span><span class="dl">'</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="kd">function</span> <span class="nx">appendMqttNotificationTextArea</span><span class="p">(</span><span class="nx">newData</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">appendTextArea</span><span class="p">(</span><span class="nx">newData</span><span class="p">,</span> <span class="dl">'</span><span class="s1">mqttNotification</span><span class="dl">'</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="kd">function</span> <span class="nx">appendDebugTextArea</span><span class="p">(</span><span class="nx">newData</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">appendTextArea</span><span class="p">(</span><span class="nx">newData</span><span class="p">,</span> <span class="dl">'</span><span class="s1">debug</span><span class="dl">'</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="kd">function</span> <span class="nx">appendTextArea</span><span class="p">(</span><span class="nx">newData</span><span class="p">,</span> <span class="nx">textAreaName</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">el</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="nx">textAreaName</span><span class="p">);</span>
      <span class="nx">el</span><span class="p">.</span><span class="nx">value</span> <span class="o">=</span> <span class="nx">getTs</span><span class="p">()</span> <span class="o">+</span> <span class="dl">"</span><span class="s2">: </span><span class="dl">"</span> <span class="o">+</span> <span class="nx">newData</span> <span class="o">+</span> <span class="dl">'</span><span class="se">\n</span><span class="dl">'</span> <span class="o">+</span> <span class="nx">el</span><span class="p">.</span><span class="nx">value</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="kd">function</span> <span class="nx">getTs</span><span class="p">()</span> <span class="p">{</span>

      <span class="kd">var</span> <span class="nx">ts</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">();</span>

      <span class="kd">var</span> <span class="nx">h</span> <span class="o">=</span> <span class="nx">ts</span><span class="p">.</span><span class="nx">getHours</span><span class="p">();</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">h</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">)</span> <span class="nx">h</span> <span class="o">=</span> <span class="dl">'</span><span class="s1">0</span><span class="dl">'</span> <span class="o">+</span> <span class="nx">h</span><span class="p">;</span>

      <span class="kd">var</span> <span class="nx">m</span> <span class="o">=</span> <span class="nx">ts</span><span class="p">.</span><span class="nx">getMinutes</span><span class="p">();</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">m</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">)</span> <span class="nx">m</span> <span class="o">=</span> <span class="dl">'</span><span class="s1">0</span><span class="dl">'</span> <span class="o">+</span> <span class="nx">m</span><span class="p">;</span>

      <span class="kd">var</span> <span class="nx">s</span> <span class="o">=</span> <span class="nx">ts</span><span class="p">.</span><span class="nx">getSeconds</span><span class="p">();</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">s</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">)</span> <span class="nx">s</span> <span class="o">=</span> <span class="dl">'</span><span class="s1">0</span><span class="dl">'</span> <span class="o">+</span> <span class="nx">s</span><span class="p">;</span>

      <span class="kd">var</span> <span class="nx">ms</span> <span class="o">=</span> <span class="nx">ts</span><span class="p">.</span><span class="nx">getMilliseconds</span><span class="p">();</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">ms</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">ms</span> <span class="o">=</span> <span class="dl">'</span><span class="s1">00</span><span class="dl">'</span> <span class="o">+</span> <span class="nx">ms</span><span class="p">;</span>
      <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">ms</span> <span class="o">&lt;</span> <span class="mi">100</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">ms</span> <span class="o">=</span> <span class="dl">'</span><span class="s1">0</span><span class="dl">'</span> <span class="o">+</span> <span class="nx">ms</span><span class="p">;</span>
      <span class="p">}</span>

      <span class="k">return</span> <span class="nx">h</span> <span class="o">+</span> <span class="dl">"</span><span class="s2">:</span><span class="dl">"</span> <span class="o">+</span> <span class="nx">m</span> <span class="o">+</span> <span class="dl">"</span><span class="s2">:</span><span class="dl">"</span> <span class="o">+</span> <span class="nx">s</span> <span class="o">+</span> <span class="dl">"</span><span class="s2">.</span><span class="dl">"</span> <span class="o">+</span> <span class="nx">ms</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span>
  <span class="nb">window</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="dl">'</span><span class="s1">load</span><span class="dl">'</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span> <span class="k">new</span> <span class="nx">App</span><span class="p">();</span> <span class="p">},</span> <span class="kc">false</span><span class="p">);</span>
<span class="p">})();</span>
</code></pre></div></div>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">function</span> <span class="nx">Sock</span> <span class="p">(</span><span class="nx">url</span><span class="p">,</span> <span class="nx">displayMessage</span><span class="p">,</span> <span class="nx">displayLog</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">socket</span><span class="p">;</span>

  <span class="c1">// this allows to display logs directly on the web page</span>
  <span class="kd">var</span> <span class="nx">log</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">str</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">displayLog</span><span class="p">(</span><span class="dl">"</span><span class="s2">WS-LOG: </span><span class="dl">"</span> <span class="o">+</span> <span class="nx">str</span><span class="p">);</span>
  <span class="p">};</span>
  <span class="kd">var</span> <span class="nx">logError</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">str</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">displayLog</span><span class="p">(</span><span class="dl">"</span><span class="s2">WS-ERROR: </span><span class="dl">"</span> <span class="o">+</span> <span class="nx">str</span><span class="p">);</span>
  <span class="p">};</span>

  <span class="nx">log</span><span class="p">(</span><span class="dl">"</span><span class="s2">Connects to WebSocket: </span><span class="dl">"</span> <span class="o">+</span> <span class="nx">url</span><span class="p">);</span>

  <span class="nx">socket</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">WebSocket</span><span class="p">(</span><span class="nx">url</span><span class="p">);</span>
  <span class="nx">socket</span><span class="p">.</span><span class="nx">onopen</span> <span class="o">=</span> <span class="nx">onopen</span><span class="p">;</span>
  <span class="nx">socket</span><span class="p">.</span><span class="nx">onmessage</span> <span class="o">=</span> <span class="nx">onmessage</span><span class="p">;</span>
  <span class="nx">socket</span><span class="p">.</span><span class="nx">onclose</span> <span class="o">=</span> <span class="nx">onclose</span><span class="p">;</span>
  <span class="nx">socket</span><span class="p">.</span><span class="nx">onerror</span> <span class="o">=</span> <span class="nx">onerror</span><span class="p">;</span>

  <span class="kd">function</span> <span class="nx">onopen</span><span class="p">(</span><span class="nx">event</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">log</span><span class="p">(</span><span class="dl">"</span><span class="s2">Connected to WebSocket</span><span class="dl">"</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="kd">function</span> <span class="nx">onmessage</span><span class="p">(</span><span class="nx">event</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">displayMessage</span><span class="p">(</span><span class="nx">event</span><span class="p">.</span><span class="nx">data</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="kd">function</span> <span class="nx">onclose</span><span class="p">(</span><span class="nx">event</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">log</span><span class="p">(</span><span class="dl">"</span><span class="s2">Web Socket closed</span><span class="dl">"</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="kd">function</span> <span class="nx">onerror</span><span class="p">(</span><span class="nx">event</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">logError</span><span class="p">(</span><span class="dl">"</span><span class="s2">ERROR: Web Socket problem: data = </span><span class="dl">"</span> <span class="o">+</span> <span class="nx">event</span><span class="p">.</span><span class="nx">data</span> <span class="o">+</span> <span class="dl">"</span><span class="s2">, name = </span><span class="dl">"</span> <span class="o">+</span> <span class="nx">event</span><span class="p">.</span><span class="nx">name</span> <span class="o">+</span> <span class="dl">"</span><span class="s2">, message = </span><span class="dl">"</span> <span class="o">+</span> <span class="nx">event</span><span class="p">.</span><span class="nx">message</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="k">this</span><span class="p">.</span><span class="nx">send</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">event</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">log</span><span class="p">(</span><span class="dl">"</span><span class="s2">Send Web Socket Request</span><span class="dl">"</span><span class="p">);</span>
    <span class="nx">event</span><span class="p">.</span><span class="nx">preventDefault</span><span class="p">();</span>
    <span class="k">if</span> <span class="p">(</span><span class="nb">window</span><span class="p">.</span><span class="nx">WebSocket</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">socket</span><span class="p">.</span><span class="nx">readyState</span> <span class="o">==</span> <span class="nx">WebSocket</span><span class="p">.</span><span class="nx">OPEN</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">socket</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="nx">event</span><span class="p">.</span><span class="nx">target</span><span class="p">.</span><span class="nx">message</span><span class="p">.</span><span class="nx">value</span><span class="p">);</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="nx">alert</span><span class="p">(</span><span class="dl">"</span><span class="s2">The socket is not open.</span><span class="dl">"</span><span class="p">);</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">function</span> <span class="nx">StompPush</span> <span class="p">(</span><span class="nx">url</span><span class="p">,</span> <span class="nx">topic</span><span class="p">,</span> <span class="nx">displayMessage</span><span class="p">,</span> <span class="nx">displayLog</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">client</span><span class="p">;</span>

  <span class="c1">// this allows to display logs directly on the web page</span>
  <span class="kd">var</span> <span class="nx">log</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">str</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">displayLog</span><span class="p">(</span><span class="dl">"</span><span class="s2">STOMP-LOG: </span><span class="dl">"</span> <span class="o">+</span> <span class="nx">str</span><span class="p">);</span>
  <span class="p">};</span>
  <span class="kd">var</span> <span class="nx">logError</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">str</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">displayLog</span><span class="p">(</span><span class="dl">"</span><span class="s2">STOMP-ERROR: </span><span class="dl">"</span> <span class="o">+</span> <span class="nx">str</span><span class="p">);</span>
  <span class="p">};</span>

  <span class="c1">// the client is notified when it is connected to the server.</span>
  <span class="kd">var</span> <span class="nx">onconnect</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">frame</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">log</span><span class="p">(</span><span class="dl">"</span><span class="s2">Connected to Stomp, subscribe to </span><span class="dl">"</span> <span class="o">+</span> <span class="nx">topic</span><span class="p">)</span>

    <span class="nx">client</span><span class="p">.</span><span class="nx">subscribe</span><span class="p">(</span><span class="nx">topic</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">message</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">displayMessage</span><span class="p">(</span><span class="nx">message</span><span class="p">.</span><span class="nx">body</span><span class="p">);</span>
    <span class="p">});</span>
  <span class="p">};</span>

  <span class="nx">log</span><span class="p">(</span><span class="dl">"</span><span class="s2">StompPush connects to: </span><span class="dl">"</span> <span class="o">+</span> <span class="nx">url</span><span class="p">);</span>
  <span class="nx">client</span> <span class="o">=</span> <span class="nx">Stomp</span><span class="p">.</span><span class="nx">client</span><span class="p">(</span><span class="nx">url</span><span class="p">);</span>

  <span class="nx">client</span><span class="p">.</span><span class="nx">debug</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">str</span><span class="p">)</span> <span class="p">{</span>
<span class="c1">// log(str);</span>
  <span class="p">};</span>

  <span class="nx">client</span><span class="p">.</span><span class="nx">connect</span><span class="p">(</span><span class="dl">""</span><span class="p">,</span> <span class="dl">""</span><span class="p">,</span> <span class="nx">onconnect</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">function</span> <span class="nx">MqttPush</span> <span class="p">(</span><span class="nx">host</span><span class="p">,</span> <span class="nx">port</span><span class="p">,</span> <span class="nx">topic</span><span class="p">,</span> <span class="nx">displayMessage</span><span class="p">,</span> <span class="nx">displayLog</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">client</span><span class="p">;</span>

  <span class="c1">// this allows to display logs directly on the web page</span>
  <span class="kd">var</span> <span class="nx">log</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">str</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">displayLog</span><span class="p">(</span><span class="dl">"</span><span class="s2">MQTT-LOG: </span><span class="dl">"</span> <span class="o">+</span> <span class="nx">str</span><span class="p">);</span>
  <span class="p">};</span>
  <span class="kd">var</span> <span class="nx">logError</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">str</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">displayLog</span><span class="p">(</span><span class="dl">"</span><span class="s2">MQTT-ERROR: </span><span class="dl">"</span> <span class="o">+</span> <span class="nx">str</span><span class="p">);</span>
  <span class="p">};</span>

  <span class="c1">// the client is notified when it is connected to the server.</span>
  <span class="kd">var</span> <span class="nx">onConnect</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">frame</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">log</span><span class="p">(</span><span class="dl">"</span><span class="s2">Connected to MQTT, subscribe to </span><span class="dl">"</span> <span class="o">+</span> <span class="nx">topic</span><span class="p">);</span>
    <span class="nx">client</span><span class="p">.</span><span class="nx">subscribe</span><span class="p">(</span><span class="nx">topic</span><span class="p">);</span>
  <span class="p">};</span>

  <span class="kd">var</span> <span class="nx">onMessageArrived</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">message</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">displayMessage</span><span class="p">(</span><span class="nx">message</span><span class="p">.</span><span class="nx">payloadString</span><span class="p">)</span>
  <span class="p">};</span>

  <span class="kd">var</span> <span class="nx">onConnectionLost</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">responseObject</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">responseObject</span><span class="p">.</span><span class="nx">errorCode</span> <span class="o">!==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">logError</span><span class="p">(</span><span class="nx">client</span><span class="p">.</span><span class="nx">clientId</span> <span class="o">+</span> <span class="dl">"</span><span class="s2">, Error code: </span><span class="dl">"</span> <span class="o">+</span> <span class="nx">responseObject</span><span class="p">.</span><span class="nx">errorCode</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="nx">logError</span><span class="p">(</span><span class="nx">client</span><span class="p">.</span><span class="nx">clientId</span> <span class="o">+</span> <span class="dl">"</span><span class="s2">, Unknown Error</span><span class="dl">"</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">};</span>

  <span class="kd">var</span> <span class="nx">onFailure</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">failure</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">logError</span><span class="p">(</span><span class="dl">"</span><span class="s2">Failure: </span><span class="dl">"</span> <span class="o">+</span> <span class="nx">failure</span><span class="p">.</span><span class="nx">errorMessage</span><span class="p">);</span>
  <span class="p">};</span>

  <span class="kd">var</span> <span class="nx">clientId</span> <span class="o">=</span> <span class="nx">generateClientId</span><span class="p">();</span>

  <span class="nx">log</span><span class="p">(</span><span class="dl">"</span><span class="s2">MqttPush connects to: </span><span class="dl">"</span> <span class="o">+</span> <span class="nx">host</span> <span class="o">+</span> <span class="dl">"</span><span class="s2">:</span><span class="dl">"</span> <span class="o">+</span> <span class="nx">port</span> <span class="o">+</span> <span class="dl">"</span><span class="s2"> (</span><span class="dl">"</span> <span class="o">+</span> <span class="nx">clientId</span> <span class="o">+</span> <span class="dl">"</span><span class="s2">)</span><span class="dl">"</span><span class="p">);</span>

  <span class="nx">client</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Messaging</span><span class="p">.</span><span class="nx">Client</span><span class="p">(</span><span class="nx">host</span><span class="p">,</span> <span class="nb">Number</span><span class="p">(</span><span class="nx">port</span><span class="p">),</span> <span class="nx">clientId</span><span class="p">);</span>

  <span class="nx">client</span><span class="p">.</span><span class="nx">onConnect</span> <span class="o">=</span> <span class="nx">onConnect</span><span class="p">;</span>
  <span class="nx">client</span><span class="p">.</span><span class="nx">onMessageArrived</span> <span class="o">=</span> <span class="nx">onMessageArrived</span><span class="p">;</span>
  <span class="nx">client</span><span class="p">.</span><span class="nx">onConnectionLost</span> <span class="o">=</span> <span class="nx">onConnectionLost</span><span class="p">;</span>

  <span class="nx">client</span><span class="p">.</span><span class="nx">connect</span><span class="p">({</span><span class="na">onSuccess</span><span class="p">:</span><span class="nx">onConnect</span><span class="p">,</span> <span class="na">onFailure</span><span class="p">:</span><span class="nx">onFailure</span><span class="p">});</span>

  <span class="kd">function</span> <span class="nx">generateClientId</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">floor</span><span class="p">((</span><span class="mi">1</span> <span class="o">+</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">random</span><span class="p">())</span> <span class="o">*</span> <span class="mh">0x10000000000</span><span class="p">).</span><span class="nx">toString</span><span class="p">(</span><span class="mi">16</span><span class="p">).</span><span class="nx">substring</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<h2 id="a-test-run">A test run</h2>
<p>That’s all the code we need to write!</p>

<p>Let’s deploy it to a small server (the smaller the better) to prove that the Java server solution really is lightweight!</p>

<p>The smallest server I can think of is the <a href="http://www.raspberrypi.org/faqs">Raspberry Pi</a>, a credit card sized computer at $35!</p>

<p>It is equipped with a single core 700 MHz 32 bit Arm processor, 512 MB memory and a SD card as disk device, i.e. it has hardware equivalent of a simple entry level smartphone. If our Java server runs on this tiny little server it has to be lightweight!</p>

<p>In the photo below we can see my Raspberry Pi (equipped with a WiFi adapter to the left and a SD-card to the right) on top of its battery pack, powered up and waiting for something useful to do…</p>

<p><img src="../../../../../../assets/blogg/c10k-lightweight-java-servers-for-large-scaled-realtime-websocket-communication/RaspberryPi.png" alt="" /></p>

<p>My Raspberry Pi runs <a href="http://www.raspbian.org/">Raspbian</a>, a Linux Debian dialect optimized for the Raspberry Pi hardware, with <a href="http://jdk8.java.net/download.html">Oracle’s Java SE</a>. Logging in to it over SSH reveals the following version information:</p>

<p><img src="../../../../../../assets/blogg/c10k-lightweight-java-servers-for-large-scaled-realtime-websocket-communication/RaspberryPi-ssh.png" alt="" /></p>

<p>Ok, so now we need a Java server application that can perform some useful work that we can control via WebSocket commands and monitor via WebSocket notifications. The Raspberry Pi comes with a set of <a href="http://learn.adafruit.com/adafruits-raspberry-pi-lesson-4-gpio-setup/overview">GPIO pins</a> that can be use for various thing, the easiest one probably <a href="https://projects.drogon.net/raspberry-pi/gpio-examples/tux-crossing/gpio-examples-1-a-single-led/">controlling a LED light</a>. So I wrote a very simple Java application that controls a LED light exposing three commands over a WebSocket: <code class="language-plaintext highlighter-rouge">on</code>, <code class="language-plaintext highlighter-rouge">off</code> and <code class="language-plaintext highlighter-rouge">status</code>. Each time a command is executed the result returned to the caller is also notified over WebSocket to connected STOMP and MQTT subscribers.</p>

<p><strong>Note:</strong> When the Java application runs on a non Raspberry Pi hardware (e.g. a PC or a Mac) the implementation of the commands are handled by a stub that only maintain the state (on/off) of the, in this case, imaginary LED light making it possible to run the server application on other hardware than a Raspberry Pi.</p>

<p>The source code for the request handler looks like:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="nc">String</span> <span class="nf">requestHandler</span><span class="o">(</span><span class="nc">String</span> <span class="n">clientHost</span><span class="o">,</span> <span class="nc">String</span> <span class="n">request</span><span class="o">)</span> <span class="o">{</span>
  <span class="nc">String</span> <span class="n">response</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
  <span class="k">try</span> <span class="o">{</span>
    <span class="nc">String</span> <span class="n">req</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="na">trim</span><span class="o">().</span><span class="na">toLowerCase</span><span class="o">();</span>

    <span class="nc">String</span> <span class="n">currentLedStatus</span> <span class="o">=</span> <span class="n">getLedStatus</span><span class="o">();</span>

    <span class="k">switch</span> <span class="o">(</span><span class="n">req</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">case</span> <span class="s">"status"</span><span class="o">:</span>
      <span class="n">response</span> <span class="o">=</span> <span class="s">"LED is "</span> <span class="o">+</span> <span class="n">currentLedStatus</span><span class="o">;</span>
      <span class="k">break</span><span class="o">;</span>

    <span class="k">case</span> <span class="s">"on"</span><span class="o">:</span>
    <span class="k">case</span> <span class="s">"off"</span><span class="o">:</span>
      <span class="n">rpi</span><span class="o">.</span><span class="na">setLedOn</span><span class="o">(</span><span class="n">req</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="s">"on"</span><span class="o">));</span>
      <span class="n">response</span> <span class="o">=</span> <span class="s">"LED is now "</span> <span class="o">+</span> <span class="n">getLedStatus</span><span class="o">()</span> <span class="o">+</span> <span class="s">" (was "</span> <span class="o">+</span> <span class="n">currentLedStatus</span> <span class="o">+</span> <span class="s">")"</span><span class="o">;</span>
      <span class="k">break</span><span class="o">;</span>

    <span class="k">default</span><span class="o">:</span>
      <span class="n">response</span> <span class="o">=</span> <span class="s">"ERROR. Unknown command: \""</span> <span class="o">+</span> <span class="n">request</span> <span class="o">+</span> <span class="s">"\", Usage: \"status|on|off\""</span><span class="o">;</span>
      <span class="k">break</span><span class="o">;</span>
    <span class="o">}</span>
  <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">Exception</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">response</span> <span class="o">=</span> <span class="s">"ERROR. Failed to process command: \""</span> <span class="o">+</span> <span class="n">request</span> <span class="o">+</span> <span class="s">"\". See log for error: "</span> <span class="o">+</span> <span class="n">ex</span><span class="o">.</span><span class="na">getMessage</span><span class="o">();</span>
    <span class="n">ex</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
  <span class="o">}</span>

  <span class="n">publisher</span><span class="o">.</span><span class="na">publish</span><span class="o">(</span><span class="s">"["</span> <span class="o">+</span> <span class="n">clientHost</span> <span class="o">+</span> <span class="s">"] - "</span> <span class="o">+</span> <span class="n">response</span><span class="o">);</span>

  <span class="k">return</span> <span class="n">response</span><span class="o">;</span>
<span class="o">}</span>

<span class="kd">private</span> <span class="nc">String</span> <span class="nf">getLedStatus</span><span class="o">()</span> <span class="o">{</span>
  <span class="k">return</span> <span class="o">(</span><span class="n">rpi</span><span class="o">.</span><span class="na">isLedOn</span><span class="o">())</span> <span class="o">?</span> <span class="s">"on"</span> <span class="o">:</span> <span class="s">"off"</span><span class="o">;</span>
<span class="o">}</span>
</code></pre></div></div>

<p>Using the web app above to send the commands <code class="language-plaintext highlighter-rouge">status</code> and <code class="language-plaintext highlighter-rouge">on</code> results in the following output on the HTML page:</p>

<p><img src="../../../../../../assets/blogg/c10k-lightweight-java-servers-for-large-scaled-realtime-websocket-communication/ws-one-web-app-test.png" alt="" /></p>

<p><strong>Note:</strong> messages are written in reverse order to the text areas to always have the latest message in the top of each text area.</p>

<p>…and of course the LED light (green) is turned on:</p>

<p><img src="../../../../../../assets/blogg/c10k-lightweight-java-servers-for-large-scaled-realtime-websocket-communication/RaspberryPi-led-light-on.png" alt="" /></p>

<p>As you can see from the log messages in the HTML page the server application response to the last <code class="language-plaintext highlighter-rouge">on</code> - command in 13 ms (response timestamp (23:12:44.487) - request timestemp (23:12:44.474)) and the two notifications (over STOMP and MQTT) are received 19 ms and 24 ms after the request was sent.</p>

<p>That is what I call realtime responses (at least in world or web browsers)!</p>

<p>Coming from a $35 server indicates that our solution indeed is lightweight!</p>

<p>Monitoring the server application from another device (an Android mobile in this example) shows how it is notified in realtime (sorry about the small font size):</p>

<p><img src="../../../../../../assets/blogg/c10k-lightweight-java-servers-for-large-scaled-realtime-websocket-communication/ws-one-web-app-on-android.png" alt="" /></p>

<p>Finally lets take a quick look using JConsole of what resources the server app requires:</p>

<p><img src="../../../../../../assets/blogg/c10k-lightweight-java-servers-for-large-scaled-realtime-websocket-communication/jconsole.png" alt="" /></p>

<p>I tried to put some manual load on the server application sending 4 reqs/sec and as you can see above the heap size is never exceeding 15 Mb, that is again what I call lightweight!</p>

<p>The CPU was working at 10% during my minimal 4 reqs/sec load test (after all, it’s only a single core 700 MHz Arm processor).</p>

<p>Now it should be very interesting to take on an appropriate load test  tool and perform some serious scalability tests with a couple of  thousands connected test clients but I have to leave that exercise to a  follow up blog.</p>

<h2 id="summary">Summary</h2>
<p>In this blog we have demonstrated how popular Java based open source products such as Netty and ActiveMQ can be embedded in an existing server application to enable it for full duplex communicating with modern HTML5 web apps using WebSocket, both for client initiated <a href="http://en.wikipedia.org/wiki/Request-response">request/response</a> and server initiated <a href="http://en.wikipedia.org/wiki/Publish/subscribe">publish/subscribe</a>. To support publish/subscribe over WebSocket we however need to use a protocol on top of WebSocket such as STOMP or MQTT as demonstrated. The proposed solution is straightforward to implement and provides a lightweight solution with low latency enabling realtime communication. The solution is based on the Java SE library for non blocking I/O, “<em>New I/O</em>”, that provides capabilities for handling large numbers of concurrently connected clients. An actual test that demonstrates the scalability capabilities of this solution however has to be left for a follow up blog.</p>

<h2 id="next-step">Next step</h2>
<p>There are a number of interesting follow up questions worth their own blog posts in the future:</p>

<ol>
  <li>Will this Java server solution scale?
    <ol>
      <li>Within a single server.</li>
      <li>Over many servers, also providing high availability.</li>
    </ol>
  </li>
  <li>How will <a href="https://blogs.oracle.com/arungupta/entry/websockets_and_java_ee_7">Java EE 7 and JSR 356</a> affect how we develop WebSocket enabled Java applications in the future?</li>
  <li>What if the server application is not written in Java, e.g. how can we achieve this using node.js?</li>
  <li>What if we not only want to enable a single server application with WebSocket communication but a whole system landscape without being forced to update each and every server application, e.g. how can a WebSocket enabled ESB help out in that case (partially addressed by a <a href="https://callistaenterprise.se/blogg/teknik/2013/01/10/mule-esb-nio-http-transport-and-10000-websocket-clients/">previous blog</a>)?</li>
  <li>Security aspects, as always…</li>
</ol>

<p>So stay tuned for follow up blog entries on these subjects!</p>









            <div class="ce-blog-thanks">
              Tack för att du läser Callistas blogg. <br>
              Hjälp oss att nå ut med information genom att dela nyheter och artiklar i ditt nätverk.<br>
            </div>

            


    
<div class="ce-blog-share">
    <a class="ce-blog-share-element social-twitter" href="https://twitter.com/intent/tweet?text=C10k Lightweight Java Servers For Large Scaled Realtime Websocket Communication&url=https://callistaenterprise.se/blogg/teknik/2013/08/12/c10k-lightweight-java-servers-for-large-scaled-realtime-websocket-communication/&via=callistaent&hashtags=" target="_blank" title="Share this post on Twitter"></a>
    <a class="ce-blog-share-element social-facebook" href="https://www.facebook.com/sharer/sharer.php?t=C10k Lightweight Java Servers For Large Scaled Realtime Websocket Communication&u=https://callistaenterprise.se/blogg/teknik/2013/08/12/c10k-lightweight-java-servers-for-large-scaled-realtime-websocket-communication/" target="_blank" title="Share this post on Facebook"></a>
    <a class="ce-blog-share-element social-linkedin" href="http://www.linkedin.com/shareArticle?mini=true&title=C10k Lightweight Java Servers For Large Scaled Realtime Websocket Communication&url=https://callistaenterprise.se/blogg/teknik/2013/08/12/c10k-lightweight-java-servers-for-large-scaled-realtime-websocket-communication/&source=http%3a%2f%2fzhangwenli.com" target="_blank" title="Share this post on LinkedIn"></a>
</div>
    
        </article>
    </div>
</section>


<section class="ce-section">
    <heading>
        <h1>Kommentarer</h1>
    </heading>
    <div class="ce-content">
        <div id="disqus_thread"></div>
        <script src="../../../../../../js/disqus.js"></script>
    </div>
</section>


    </div>

    <footer class="ce-footer">
    <div class="ce-wrapper">
        <nav class="ce-menu-footer-primary">
            <h2><a href="../../../../../../index.html">Callista</a></h2>
            <ul>
                
                <li><a href="../../../../../../om/index.html">Om oss</a></li>
                
                <li><a href="../../../../../../erbjudanden.html">Erbjudanden</a></li>
                
                <li><a href="../../../../../../event.html">Event</a></li>
                
                <li><a href="../../../../../../blogg.html">Blogg</a></li>
                
                <li><a href="../../../../../../om/jobb/index.html">Jobba hos oss</a></li>
                

                
                    
                        <li><a href="../../../../../../english/index.html">English</a></li>
                    
                
            </ul>
        </nav>
        <div class="ce-addresses">
            <div class="ce-address">
                <h2>Stockholm</h2>
                <address>
                    Drottninggatan 55<br>
                    111 21 Stockholm<br>
                    Tel:
                    <a href="tel:+468212142">
                        +46 8 21 21 42
                    </a>
                </address>
            </div>
            <div class="ce-address">
                <h2>Göteborg</h2>
                <address>
                    Fabriksgatan 13<br>
                    412 50 Göteborg<br>
                    Tel:
                    <a href="tel:+4631201918">
                        +46 31 20 19 18
                    </a>
                </address>
            </div>
        </div>
        <div class="ce-social">
            <h2>Följ oss</h2>
            <ul>
                <li>
                    <a href="http://twitter.com/callistaent">
                        <img alt="Twitters logotype" src="../../../../../../images/icons/twitter.png">
                        <span>@callistaent</span>
                    </a>
                </li>
            </ul>
        </div>
        <small>&copy; 2021 Callista Enterprise AB</small>
        <hr style="margin: 1em 0 2em 0">
        <div class="ce-footer-images">
          <div class="ce-footer-image">
            <a class="ce-raddabarnen" href="http://www.raddabarnen.se/foretag">
                <img alt="Callista är Rädda Barnens företagsvän 2021" src="../../../../../../images/logotype/rb_vanforetag_2021_large-sv.png">
            </a>
          </div>
        </div>
        <br>
        <div class="ce-footer-images">
          <div class="ce-footer-image">
            <a class="ce-di-gasell" href="http://www.di.se/gasell/">
              <img alt="Callista utsett till DI Gasell tre år i rad" src="../../../../../../images/logotype/di_gasell_180x194.png">
            </a>
          </div>
        </div>
    </div>
</footer>


    <script src="../../../../../../js/lib/jquery.min.js"></script>
    <script src="../../../../../../js/lib/owl.carousel.min.js"></script>
    <script src="../../../../../../js/lib/prismjs.min.js"></script>
    <script src="../../../../../../js/app.js"></script>
    <script src="../../../../../../js/analytics.js"></script>
    <script src="../../../../../../js/jobinterestsubmit.js"></script>

</body>
</html>
