<!DOCTYPE html>
<html lang="sv-se">
<head>
    <meta charset="utf-8">

    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="description" content="Callista Enterprise - seniora IT-arkitekter och systemutvecklare inom Java, öppen källkod, agil utveckling och systemintegration">
    <!--<meta name="viewport" content="width=device-width, initial-scale=1">-->
    <meta name="viewport" content="initial-scale=1.0001, minimum-scale=1.0001, maximum-scale=1.0001, user-scalable=no"/>

    <link rel="icon" href="../../../../../../images/icons/callista_favicon.svg" type="image/x-icon" />
    <link rel="shortcut icon" href="../../../../../../images/icons/callista_favicon.svg" type="image/x-icon" />
    <link rel="apple-touch-icon" href="../../../../../../images/icons/callista_favicon_160x160.png">

    <title>Building microservices with Spring Cloud and Netflix OSS, part 2 | Callista</title>

    <link rel="stylesheet" href="../../../../../../css/style.css%3Fv=1.css">
    <link rel="alternate" type="application/rss+xml" title="RSS Feed for callistaenterprise.se" href="../../../../../../feed.xml" />

    <!--[if lte IE 8]>
    <style>* { display: none !important; }</style>
    <meta http-equiv="refresh" content="0; url=/oldie/"/>
    <![endif]-->

    <script type="text/javascript" src="https://use.typekit.net/kig5egm.js"></script>
    <script type="text/javascript">
        try {
            Typekit.load({ async: true });
        } catch (e) {
        }
    </script>

    <!-- Facebook Pixel Code -->
    <script>
    !function(f,b,e,v,n,t,s)
    {if(f.fbq)return;n=f.fbq=function(){n.callMethod?
    n.callMethod.apply(n,arguments):n.queue.push(arguments)};
    if(!f._fbq)f._fbq=n;n.push=n;n.loaded=!0;n.version='2.0';
    n.queue=[];t=b.createElement(e);t.async=!0;
    t.src=v;s=b.getElementsByTagName(e)[0];
    s.parentNode.insertBefore(t,s)}(window,document,'script',
    'https://connect.facebook.net/en_US/fbevents.js');
     fbq('init', '804675599711872');
     fbq('track', 'PageView');
    </script>
    <noscript>
     <img height="1" width="1" src="https://www.facebook.com/tr?id=804675599711872&ev=PageView&noscript=1"/>
    </noscript>
    <!-- End Facebook Pixel Code -->

</head>
<body>

    <header class="ce-header" data-scroll="0">
    <nav>
        <img alt="menubg" class="ce-menu-icon" style="z-index:3; top: 0px; width: 50px; height: 100%;" src="../../../../../../images/icons/menu_background.png">
        <a class="ce-logotype" href="../../../../../../index.html" style="z-index: 2;">
            <img alt="Callista" style="max-width: 100%; height: auto;" src="../../../../../../images/logotype/callista_small2.svg">
        </a>
        <table>
            <tr>
                <td>
            <ul id="menu-primary" class="ce-menu-primary">
                
                    
                            <li><a href="../../../../../../om/index.html">Om oss</a></li>
                    
                
                    
                            <li><a href="../../../../../../erbjudanden.html">Erbjudanden</a></li>
                    
                
                    
                            <li><a href="../../../../../../event.html">Event</a></li>
                    
                
                    
                        
                            <li><a class="ce-active" href="../../../../../../blogg.html">Blogg</a></li>
                        
                    
                
                    
                            <li><a href="../../../../../../om/jobb/index.html">Jobba hos oss</a></li>
                    
                
            </ul>
                </td>

                <td>
            <ul class="ce-menu-secondary">
                
                <li><a href="../../../../../../english/index.html">English</a></li>
                
            </ul>
                </td>
            </tr>
        </table>
            <a id="menu" class="ce-menu-icon" href="index.html#" style="z-index: 4;">
                <img alt="Visa meny" src="../../../../../../images/icons/menu.png">
            </a>
            <a class="ce-search-icon" href="index.html#">
                <img alt="Sök" src="../../../../../../images/icons/search.png">
            </a>

        </table>
    </nav>
</header>


    <div class="ce-main">
        <section class="ce-start lazyImg">
    <article>
        <h1>Blogg</h1>
        <p class="ce-ingress">
            Här finns tekniska artiklar, presentationer och nyheter om arkitektur och systemutveckling. Håll dig uppdaterad, följ oss på <a class="ce-active" href="http://twitter.com/callistaent">Twitter</a>
        </p>
    </article>
</section>

<section class="ce-section">
    <div class="ce-content">
        
        

        
        

        <article class="ce-blog">
            <header>
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    <img alt="Callista medarbetare Magnus Larsson" src="../../../../../../assets/medarbetare/magnuslarsson_mini.png">
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    <h2>
        <a href="index.html">Building microservices with Spring Cloud and Netflix OSS, part 2</a>
        
        
    </h2>
    <h3>
        <time datetime="2015-04-15T00:00:00+00:00">
            15 April 2015
        </time>
        //
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        

        
        
        <a href="../../../../../../om/medarbetare/magnuslarsson/index.html">Magnus Larsson</a>
        

        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
    </h3>
    
</header>




<p>In <a href="../../10/building-microservices-with-spring-cloud-and-netflix-oss-part-1/index.html">Part 1</a> we used core components in <a href="http://projects.spring.io/spring-cloud/">Spring Cloud</a> and <a href="http://netflix.github.io">Netflix OSS</a>, i.e. <em>Eureka</em>, <em>Ribbon</em> and <em>Zuul</em>, to partially implement our <a href="../../../03/25/an-operations-model-for-microservices/index.html">operations model</a>, enabling separately deployed microservices to communicate with each other. In this blog post we will focus on fault handling in a microservice landscape, improving resilience using <em>Hystrix</em>, Netflix circuit breaker.</p>

<p></p>

<p>Now bad things will start to happen in the system landscape that we established in <a href="../../10/building-microservices-with-spring-cloud-and-netflix-oss-part-1/index.html">Part 1</a>. Some of the core services that the composite service depends on will suddenly not respond, jeopardizing the composite service if faults are not handled correctly.</p>

<p>In general we call this type of problem a <em>chain of failures</em>, where an error in one component can cause errors to occur in other components that depend on the failing component. This needs special attention in a microservice based system landscape where, potentially a large number of, separately deployed microservices communicate with each other. One common solution to this problem is to apply a <em>circuit breaker</em> pattern, for details see the book <a href="https://pragprog.com/book/mnee/release-it">Release It!</a> or read the blog post <a href="http://martinfowler.com/bliki/CircuitBreaker.html">Fowler - Circuit Breaker</a>. A <em>circuit breaker</em> typically applies state transitions like:</p>

<p><img src="../../../../../../assets/blogg/build-microservices-part-2/circuit-breaker.png" width="600" />
(<strong>Source:</strong> <a href="https://pragprog.com/book/mnee/release-it">Release It!</a>)</p>

<p>Enter <em>Netflix Hystrix</em> and some powerful annotations provided by <em>Spring Cloud</em>!</p>

<h2 id="1-spring-cloud-and-netflix-oss">1. Spring Cloud and Netflix OSS</h2>

<p>From the table presented in <a href="../../10/building-microservices-with-spring-cloud-and-netflix-oss-part-1/index.html">Part 1</a> we will cover: <em>Hystrix</em>, <em>Hystrix dashboard</em> and <em>Turbine</em>.</p>

<p><img src="../../../../../../assets/blogg/build-microservices-part-1/mapping-table.png" width="500" /></p>

<ul>
  <li>
    <p><strong>Netflix Hystrix</strong> - Circuit breaker
Netflix Hystrix provides circuit breaker capabilities to a service consumer. If a service doesn’t respond (e.g. due to a timeout or a communication error), Hystrix can redirect the call to an internal fallback method in the service consumer. If a service repeatedly fails to respond, Hystrix will open the circuit and fast fail (i.e. call the internal fallback method without trying to call the service) on every subsequent call until the service is available again. To determine wether the service is available again Hystrix allow some requests to try out the service even if the circuit is open. Hystrix executes embedded within its service consumer.</p>
  </li>
  <li>
    <p><strong>Netflix Hystrix dashboard and Netflix Turbine</strong> - Monitor Dashboard
Hystrix dashboard can be used to provide a graphical overview of circuit breakers and Turbine can, based on information in Eureka, provide the dashboard with information from all circuit breakers in a system landscape. A sample screenshot from Hystrix dashboard and Turbine in action:</p>
  </li>
</ul>

<p><img src="../../../../../../assets/blogg/build-microservices-part-2/hystrix-sample.png" alt="Hystrix" /></p>

<h2 id="2-the-system-landscape">2. The system landscape</h2>

<p>The system landscape from <a href="../../10/building-microservices-with-spring-cloud-and-netflix-oss-part-1/index.html">Part 1</a> is complemented with supporting infrastructure servers for <em>Hystrix dashboard</em> and <em>Turbine</em>. The service <em>product-composite</em> is also enhanced with a <em>Hystrix</em> based circuit breaker. The two new components are marked with a red line in the updated picture below:</p>

<p><img src="../../../../../../assets/blogg/build-microservices-part-2/system-landscape.png" alt="system-landscape" /></p>

<blockquote>
  <p>As in <a href="../../10/building-microservices-with-spring-cloud-and-netflix-oss-part-1/index.html">Part 1</a>, we emphasize the differences between microservices and monolithic applications by running each service in a separate microservice, i.e. in separate processes.</p>
</blockquote>

<h2 id="3-build-from-source">3. Build from source</h2>

<p>As in <a href="../../10/building-microservices-with-spring-cloud-and-netflix-oss-part-1/index.html">Part 1</a> we use Java SE 8, Git and Gradle. So, to access the source code and build it perform:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ git clone https://github.com/callistaenterprise/blog-microservices.git
$ cd blog-microservices
$ git checkout -b B2 M2.1
$ ./build-all.sh
</code></pre></div></div>

<blockquote>
  <p>If you are on <strong>Windows</strong> you can execute the corresponding bat-file <code class="language-plaintext highlighter-rouge">build-all.bat</code>!</p>
</blockquote>

<p>Two new source code components have been added since <a href="../../10/building-microservices-with-spring-cloud-and-netflix-oss-part-1/index.html">Part 1</a>: <em>monitor-dashboard</em> and <em>turbine</em>:</p>

<p><img src="../../../../../../assets/blogg/build-microservices-part-2/source-code.png" alt="source-code" /></p>

<p>The build should result in eight log messages that all says:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>BUILD SUCCESSFUL
</code></pre></div></div>

<h2 id="4-source-code-walkthrough">4. Source code walkthrough</h2>

<p>New from <a href="../../10/building-microservices-with-spring-cloud-and-netflix-oss-part-1/index.html">Part 1</a> is the use of Hystrix as a circuit breaker in the microservice product-composite, so we will focus on the additional source code required to put the circuit breaker in place.</p>

<h3 id="41-gradle-dependencies">4.1 Gradle dependencies</h3>

<p>We now have a couple of Hystrix-based starter dependencies to drag into our build files. Since Hysteric use <a href="https://www.rabbitmq.com">RabbitMQ</a> to communicate between circuit breakers and dashboards we also need to setup dependencies for that as well.</p>

<p>For a service consumer, that want to use Hystrix as a circuit breaker, we need to add:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    compile("org.springframework.cloud:spring-cloud-starter-hystrix:1.0.0.RELEASE")
    compile("org.springframework.cloud:spring-cloud-starter-bus-amqp:1.0.0.RELEASE")
    compile("org.springframework.cloud:spring-cloud-netflix-hystrix-amqp:1.0.0.RELEASE")
</code></pre></div></div>

<p>For a complete example see <a href="https://github.com/callistaenterprise/blog-microservices/blob/B2/microservices/composite/product-composite-service/build.gradle">product-composite-service/build.gradle</a>.</p>

<p>To be able to setup an Turbine server add the following dependency:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    compile('org.springframework.cloud:spring-cloud-starter-turbine-amqp:1.0.0.RELEASE')
</code></pre></div></div>

<p>For a complete example see <a href="https://github.com/callistaenterprise/blog-microservices/blob/B2/microservices/support/turbine/build.gradle">turbine/build.gradle</a>.</p>

<h3 id="42-infrastructure-servers">4.2. Infrastructure servers</h3>

<p>Set up a Turbine server by adding the annotation <code class="language-plaintext highlighter-rouge">@EnableTurbineAmqp</code> to a standard Spring Boot application:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>@SpringBootApplication
@EnableTurbineAmqp
@EnableDiscoveryClient
public class TurbineApplication {

    public static void main(String[] args) {
        SpringApplication.run(TurbineApplication.class, args);
    }

}
</code></pre></div></div>

<p>For a complete example see <a href="https://github.com/callistaenterprise/blog-microservices/blob/B2/microservices/support/turbine/src/main/java/se/callista/microservises/support/turbine/TurbineApplication.java">TurbineApplication.java</a>.</p>

<p>To setup a Hystrix Dashboard add the annotation <code class="language-plaintext highlighter-rouge">@EnableHystrixDashboard</code> instead. For a complete example see <a href="https://github.com/callistaenterprise/blog-microservices/blob/B2/microservices/support/monitor-dashboard/src/main/java/se/callista/microservises/support/monitordashboard/HystrixDashboardApplication.java">HystrixDashboardApplication.java</a>.</p>

<p>With these simple annotation you get a default server configuration that makes you get started. When needed, the default configurations can be overridden with specific settings.</p>

<h3 id="43-business-services">4.3 Business services</h3>

<p>To enable Hystrix, add a <code class="language-plaintext highlighter-rouge">@EnableCircuitBreaker</code>-annotation to your Spring Boot application. To actually put Hystrix in action, annotate the method that Hystrix shall monitor with <code class="language-plaintext highlighter-rouge">@HystrixCommand</code> where we also can specify a fallback-method, e.g.:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    @HystrixCommand(fallbackMethod = "defaultReviews")
    public ResponseEntity&lt;List&lt;Review&gt;&gt; getReviews(int productId) {
        ...
    }

    public ResponseEntity&lt;List&lt;Review&gt;&gt; defaultReviews(int productId) {
        ...
    }
</code></pre></div></div>

<p>The fallback method is used by Hystrix in case of an error (call to the service fails or a timeout occurs) or to fast fail if the circuit is open. For a complete example see <a href="https://github.com/callistaenterprise/blog-microservices/blob/B2/microservices/composite/product-composite-service/src/main/java/se/callista/microservices/composite/product/service/ProductCompositeIntegration.java">ProductCompositeIntegration.java</a>.</p>

<h2 id="5-start-up-the-system-landscape">5. Start up the system landscape</h2>

<blockquote>
  <p>As in <a href="../../10/building-microservices-with-spring-cloud-and-netflix-oss-part-1/index.html">Part 1</a>, we will start the microservices as java processes in our local development environment and you need to have the <a href="http://curl.haxx.se">cURL</a> and <a href="http://stedolan.github.io/jq/">jq</a> tools installed to be able to run some of the commands below.</p>
</blockquote>

<p>As already mentioned, Hystrix use RabbitMQ for internal communication so we need to have it installed and running before we can start up our system landscape. Follow the instructions at <a href="https://www.rabbitmq.com/download.html">Downloading and Installing</a>. Then start RabbitMQ use the <code class="language-plaintext highlighter-rouge">rabbitmq-server</code> program in the <code class="language-plaintext highlighter-rouge">sbin</code>-folder of your installation.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ ~/Applications/rabbitmq_server-3.4.3/sbin/rabbitmq-server

              RabbitMQ 3.4.3. Copyright (C) 2007-2014 GoPivotal, Inc.
  ##  ##      Licensed under the MPL.  See http://www.rabbitmq.com/
  ##  ##
  ##########  Logs: /Users/magnus/Applications/rabbitmq_server-3.4.3/sbin/../var/log/rabbitmq/rabbit@Magnus-MacBook-Pro.log
  ######  ##        /Users/magnus/Applications/rabbitmq_server-3.4.3/sbin/../var/log/rabbitmq/rabbit@Magnus-MacBook-Pro-sasl.log
  ##########
              Starting broker... completed with 6 plugins.
</code></pre></div></div>

<blockquote>
  <p>If you are on <strong>Windows</strong> use Windows Services to ensure that the RabbitMQ service is started!</p>
</blockquote>

<p>We are now ready to start up the system landscape. Each microservice is started using the command <code class="language-plaintext highlighter-rouge">./gradlew bootRun</code>.</p>

<p>First start the infrastructure microservices, e.g.:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ cd support/discovery-server;  ./gradlew bootRun
$ cd support/edge-server;       ./gradlew bootRun
$ cd support/monitor-dashboard; ./gradlew bootRun
$ cd support/turbine;           ./gradlew bootRun
</code></pre></div></div>

<p>Once they are started up, launch the business microservices:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ cd core/product-service;                ./gradlew bootRun
$ cd core/recommendation-service;         ./gradlew bootRun
$ cd core/review-service;                 ./gradlew bootRun
$ cd composite/product-composite-service; ./gradlew bootRun 
</code></pre></div></div>

<blockquote>
  <p>If you are on <strong>Windows</strong> you can execute the corresponding bat-file <code class="language-plaintext highlighter-rouge">start-all.bat</code>!</p>
</blockquote>

<p>Once the microservices are started up and registered with the service discovery server they should write the following in the log:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>DiscoveryClient ... - registration status: 204
</code></pre></div></div>

<p>As in <a href="../../10/building-microservices-with-spring-cloud-and-netflix-oss-part-1/index.html">Part 1</a>, we should be able to see our four business services and the edge-server in the service discovery web app (<a href="http://localhost:8761">http://localhost:8761</a>):</p>

<p><img src="../../../../../../assets/blogg/build-microservices-part-1/eureka.png" alt="Eureka" /></p>

<p>Finally ensure that the circuit breakers are operational, e.g. <em>closed</em>. Try a call to the composite service through the edge-server as in <a href="../../10/building-microservices-with-spring-cloud-and-netflix-oss-part-1/index.html">Part 1</a> (shortened for brevity:</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">$</span> <span class="nx">curl</span> <span class="o">-</span><span class="nx">s</span> <span class="nx">localhost</span><span class="p">:</span><span class="mi">8765</span><span class="o">/</span><span class="nx">productcomposite</span><span class="o">/</span><span class="nx">product</span><span class="o">/</span><span class="mi">1</span> <span class="o">|</span> <span class="nx">jq</span> <span class="p">.</span>
<span class="p">{</span>
    <span class="dl">"</span><span class="s2">name</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">name</span><span class="dl">"</span><span class="p">,</span>
    <span class="dl">"</span><span class="s2">productId</span><span class="dl">"</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
    <span class="dl">"</span><span class="s2">recommendations</span><span class="dl">"</span><span class="p">:</span> <span class="p">[</span>
        <span class="p">{</span>
            <span class="dl">"</span><span class="s2">author</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">Author 1</span><span class="dl">"</span><span class="p">,</span>
            <span class="dl">"</span><span class="s2">rate</span><span class="dl">"</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
            <span class="dl">"</span><span class="s2">recommendationId</span><span class="dl">"</span><span class="p">:</span> <span class="mi">0</span>
        <span class="p">},</span>
        <span class="p">...</span>
    <span class="p">],</span>
    <span class="dl">"</span><span class="s2">reviews</span><span class="dl">"</span><span class="p">:</span> <span class="p">[</span>
        <span class="p">{</span>
            <span class="dl">"</span><span class="s2">author</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">Author 1</span><span class="dl">"</span><span class="p">,</span>
            <span class="dl">"</span><span class="s2">reviewId</span><span class="dl">"</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
            <span class="dl">"</span><span class="s2">subject</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">Subject 1</span><span class="dl">"</span>
        <span class="p">},</span>
        <span class="p">...</span>
    <span class="p">],</span>
    <span class="dl">"</span><span class="s2">weight</span><span class="dl">"</span><span class="p">:</span> <span class="mi">123</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Go to the url <a href="http://localhost:7979">http://localhost:7979</a> in a web browser, enter the url <a href="http://localhost:8989/turbine.stream">http://localhost:8989/turbine.stream</a> and click on the “<em>Monitor Stream</em>” – button):</p>

<p><img src="../../../../../../assets/blogg/build-microservices-part-2/hystrix.png" alt="Hystrix" /></p>

<p>We can see that the composite service have three circuit breakers operational, one for each core service it depends on. They are all fine, i.e. <em>closed</em>. We are now ready to try out a negative test to see the circuit breaker in action!</p>

<h2 id="6-something-goes-wrong">6. Something goes wrong</h2>

<p>Stop the <code class="language-plaintext highlighter-rouge">review</code> microservice and retry the command above:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ curl -s localhost:8765/productcomposite/product/1 | jq .
{
    "name": "name",
    "productId": 1,
    "recommendations": [
        {
            "author": "Author 1",
            "rate": 1,
            "recommendationId": 0
        },
        ...
    ],
    "reviews": null,
    "weight": 123
}
</code></pre></div></div>

<p>The <strong>review</strong> - part of the response is now empty, but the rest of the reply remains intact! Look at the log of the <code class="language-plaintext highlighter-rouge">product-composite</code> services and you will find warnings:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>2015-04-02 15:13:36.344  INFO 29901 --- [eIntegration-10] s.c.m.c.p.s.ProductCompositeIntegration  : GetRecommendations...
2015-04-02 15:13:36.497  INFO 29901 --- [teIntegration-2] s.c.m.c.p.s.ProductCompositeIntegration  : GetReviews...
2015-04-02 15:13:36.498  WARN 29901 --- [teIntegration-2] s.c.m.composite.product.service.Util     : Failed to resolve serviceId 'review'. Fallback to URL 'http://localhost:8081/review'.
2015-04-02 15:13:36.500  WARN 29901 --- [teIntegration-2] s.c.m.c.p.s.ProductCompositeIntegration  : Using fallback method for review-service
</code></pre></div></div>

<p>I.e. the circuit breaker has detected a problem with the <code class="language-plaintext highlighter-rouge">review</code> service and routed the caller to the fallback method in the service consumer. In this case we simply return null but we could, for example, return data from a local cache to provide a best effort result when the <code class="language-plaintext highlighter-rouge">review</code> service is unavailable.</p>

<p>The circuit is still closed since the error is not that frequent:</p>

<p><img src="../../../../../../assets/blogg/build-microservices-part-2/circuit-closed-on-minor-error.png" alt="Hystrix" /></p>

<p>Let’s increase the error frequency over the limits where Hystrix will open the circuit and start to fast fail (we use Hystrix default values to keep the blog post short…). We use the <a href="http://httpd.apache.org/docs/2.4/programs/ab.html">Apache HTTP server benchmarking tool</a> for this:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ab -n 30 -c 5 localhost:8765/productcomposite/product/1
</code></pre></div></div>

<p>Now the circuit will be opened:</p>

<p><img src="../../../../../../assets/blogg/build-microservices-part-2/circuit-open-on-major-error.png" alt="Hystrix" /></p>

<p>…and subsequent calls will fast fail, i.e. the circuit breaker will redirect the caller directly to its fallback method without trying to get the reviews from the <code class="language-plaintext highlighter-rouge">review</code> service. The log will no longer contain a message that says <code class="language-plaintext highlighter-rouge">GetReviews...</code>:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>2015-04-02 15:14:03.930  INFO 29901 --- [teIntegration-5] s.c.m.c.p.s.ProductCompositeIntegration  : GetRecommendations...
2015-04-02 15:14:03.984  WARN 29901 --- [ XNIO-2 task-62] s.c.m.c.p.s.ProductCompositeIntegration  : Using fallback method for review-service
</code></pre></div></div>

<p>However, from time to time it will let some calls pass through to see if they succeeds, i.e. to see if the <code class="language-plaintext highlighter-rouge">review</code> service is available again. We can see that by repeating the curl call a number of times and look in the log of the <code class="language-plaintext highlighter-rouge">product-composite</code> service:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>2015-04-02 15:17:33.587  INFO 29901 --- [eIntegration-10] s.c.m.c.p.s.ProductCompositeIntegration  : GetRecommendations...
2015-04-02 15:17:33.769  INFO 29901 --- [eIntegration-10] s.c.m.c.p.s.ProductCompositeIntegration  : GetReviews...
2015-04-02 15:17:33.769  WARN 29901 --- [eIntegration-10] s.c.m.composite.product.service.Util     : Failed to resolve serviceId 'review'. Fallback to URL 'http://localhost:8081/review'.
2015-04-02 15:17:33.770  WARN 29901 --- [eIntegration-10] s.c.m.c.p.s.ProductCompositeIntegration  : Using fallback method for review-service
2015-04-02 15:17:34.431  INFO 29901 --- [eIntegration-10] s.c.m.c.p.s.ProductCompositeIntegration  : GetRecommendations...
2015-04-02 15:17:34.569  WARN 29901 --- [ XNIO-2 task-18] s.c.m.c.p.s.ProductCompositeIntegration  : Using fallback method for review-service
2015-04-02 15:17:35.209  INFO 29901 --- [eIntegration-10] s.c.m.c.p.s.ProductCompositeIntegration  : GetRecommendations...
2015-04-02 15:17:35.402  WARN 29901 --- [ XNIO-2 task-20] s.c.m.c.p.s.ProductCompositeIntegration  : Using fallback method for review-service
2015-04-02 15:17:36.043  INFO 29901 --- [eIntegration-10] s.c.m.c.p.s.ProductCompositeIntegration  : GetRecommendations...
2015-04-02 15:17:36.192  WARN 29901 --- [ XNIO-2 task-21] s.c.m.c.p.s.ProductCompositeIntegration  : Using fallback method for review-service
2015-04-02 15:17:36.874  INFO 29901 --- [eIntegration-10] s.c.m.c.p.s.ProductCompositeIntegration  : GetRecommendations...
2015-04-02 15:17:37.031  WARN 29901 --- [ XNIO-2 task-22] s.c.m.c.p.s.ProductCompositeIntegration  : Using fallback method for review-service
2015-04-02 15:17:41.148  INFO 29901 --- [eIntegration-10] s.c.m.c.p.s.ProductCompositeIntegration  : GetRecommendations...
2015-04-02 15:17:41.340  INFO 29901 --- [eIntegration-10] s.c.m.c.p.s.ProductCompositeIntegration  : GetReviews...
2015-04-02 15:17:41.340  WARN 29901 --- [eIntegration-10] s.c.m.composite.product.service.Util     : Failed to resolve serviceId 'review'. Fallback to URL 'http://localhost:8081/review'.
2015-04-02 15:17:41.341  WARN 29901 --- [eIntegration-10] s.c.m.c.p.s.ProductCompositeIntegration  : Using fallback method for review-service
</code></pre></div></div>

<p>As we can see from the log output, every fifth call is allowed to try to call the <code class="language-plaintext highlighter-rouge">review</code> service (still without success…).</p>

<p>Let’s start the <code class="language-plaintext highlighter-rouge">review</code> service again and try calling the composite service!</p>

<p><strong>Note:</strong> You might need to be a bit patient here (max 1 min), both the service discovery server (Eureka) and the dynamic router (Ribbon) must be made aware of that a <code class="language-plaintext highlighter-rouge">review</code> service instance is available again before the call succeeds.</p>

<p>Now we can see that the response is ok, i.e. the review part is back in the response, and the circuit is closed again:</p>

<p><img src="../../../../../../assets/blogg/build-microservices-part-2/circuit-closed-again.png" alt="Hystrix" /></p>

<h2 id="7-summary">7. Summary</h2>

<p>We have seen how <em>Netflix Hystrix</em> can be used as a <em>circuit breaker</em> to efficiently handle the problem with <em>chain of failures</em>, i.e. where a failing microservice potentially can cause a system outage of a large part of a microservice landscape due to propagating errors. Thanks to the annotations and starter dependencies available in Spring Cloud it is very easy to get started with Hystrix in a Spring environment. Finally the dashboard capabilities provided by Hystrix dashboard and Turbine makes it possible to monitor a large number of circuit breakers in a system landscape.</p>

<h2 id="8-next-step">8. Next step</h2>

<p>In the next blog post in the <a href="../../../05/20/blog-series-building-microservices.html">Blog Series - Building Microservices</a> we will look at how to use OAuth 2.0 to restrict access to microservices that expose an external API.</p>

<p>Stay tuned!</p>









            <div class="ce-blog-thanks">
              Tack för att du läser Callistas blogg. <br>
              Hjälp oss att nå ut med information genom att dela nyheter och artiklar i ditt nätverk.<br>
            </div>

            


    
<div class="ce-blog-share">
    <a class="ce-blog-share-element social-twitter" href="https://twitter.com/intent/tweet?text=Building Microservices With Spring Cloud And Netflix Oss Part 2&url=https://callistaenterprise.se/blogg/teknik/2015/04/15/building-microservices-with-spring-cloud-and-netflix-oss-part-2/&via=callistaent&hashtags=" target="_blank" title="Share this post on Twitter"></a>
    <a class="ce-blog-share-element social-facebook" href="https://www.facebook.com/sharer/sharer.php?t=Building Microservices With Spring Cloud And Netflix Oss Part 2&u=https://callistaenterprise.se/blogg/teknik/2015/04/15/building-microservices-with-spring-cloud-and-netflix-oss-part-2/" target="_blank" title="Share this post on Facebook"></a>
    <a class="ce-blog-share-element social-linkedin" href="http://www.linkedin.com/shareArticle?mini=true&title=Building Microservices With Spring Cloud And Netflix Oss Part 2&url=https://callistaenterprise.se/blogg/teknik/2015/04/15/building-microservices-with-spring-cloud-and-netflix-oss-part-2/&source=http%3a%2f%2fzhangwenli.com" target="_blank" title="Share this post on LinkedIn"></a>
</div>
    
        </article>
    </div>
</section>


<section class="ce-section">
    <heading>
        <h1>Kommentarer</h1>
    </heading>
    <div class="ce-content">
        <div id="disqus_thread"></div>
        <script src="../../../../../../js/disqus.js"></script>
    </div>
</section>


    </div>

    <footer class="ce-footer">
    <div class="ce-wrapper">
        <nav class="ce-menu-footer-primary">
            <h2><a href="../../../../../../index.html">Callista</a></h2>
            <ul>
                
                <li><a href="../../../../../../om/index.html">Om oss</a></li>
                
                <li><a href="../../../../../../erbjudanden.html">Erbjudanden</a></li>
                
                <li><a href="../../../../../../event.html">Event</a></li>
                
                <li><a href="../../../../../../blogg.html">Blogg</a></li>
                
                <li><a href="../../../../../../om/jobb/index.html">Jobba hos oss</a></li>
                

                
                    
                        <li><a href="../../../../../../english/index.html">English</a></li>
                    
                
            </ul>
        </nav>
        <div class="ce-addresses">
            <div class="ce-address">
                <h2>Stockholm</h2>
                <address>
                    Drottninggatan 55<br>
                    111 21 Stockholm<br>
                    Tel:
                    <a href="tel:+468212142">
                        +46 8 21 21 42
                    </a>
                </address>
            </div>
            <div class="ce-address">
                <h2>Göteborg</h2>
                <address>
                    Fabriksgatan 13<br>
                    412 50 Göteborg<br>
                    Tel:
                    <a href="tel:+4631201918">
                        +46 31 20 19 18
                    </a>
                </address>
            </div>
        </div>
        <div class="ce-social">
            <h2>Följ oss</h2>
            <ul>
                <li>
                    <a href="http://twitter.com/callistaent">
                        <img alt="Twitters logotype" src="../../../../../../images/icons/twitter.png">
                        <span>@callistaent</span>
                    </a>
                </li>
            </ul>
        </div>
        <small>&copy; 2021 Callista Enterprise AB</small>
        <hr style="margin: 1em 0 2em 0">
        <div class="ce-footer-images">
          <div class="ce-footer-image">
            <a class="ce-raddabarnen" href="http://www.raddabarnen.se/foretag">
                <img alt="Callista är Rädda Barnens företagsvän 2021" src="../../../../../../images/logotype/rb_vanforetag_2021_large-sv.png">
            </a>
          </div>
        </div>
        <br>
        <div class="ce-footer-images">
          <div class="ce-footer-image">
            <a class="ce-di-gasell" href="http://www.di.se/gasell/">
              <img alt="Callista utsett till DI Gasell tre år i rad" src="../../../../../../images/logotype/di_gasell_180x194.png">
            </a>
          </div>
        </div>
    </div>
</footer>


    <script src="../../../../../../js/lib/jquery.min.js"></script>
    <script src="../../../../../../js/lib/owl.carousel.min.js"></script>
    <script src="../../../../../../js/lib/prismjs.min.js"></script>
    <script src="../../../../../../js/app.js"></script>
    <script src="../../../../../../js/analytics.js"></script>
    <script src="../../../../../../js/jobinterestsubmit.js"></script>

</body>
</html>
