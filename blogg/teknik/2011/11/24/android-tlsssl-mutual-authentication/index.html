<!DOCTYPE html>
<html lang="sv-se">
<head>
    <meta charset="utf-8">

    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="description" content="Callista Enterprise - seniora IT-arkitekter och systemutvecklare inom Java, öppen källkod, agil utveckling och systemintegration">
    <!--<meta name="viewport" content="width=device-width, initial-scale=1">-->
    <meta name="viewport" content="initial-scale=1.0001, minimum-scale=1.0001, maximum-scale=1.0001, user-scalable=no"/>

    <link rel="icon" href="../../../../../../images/icons/callista_favicon.svg" type="image/x-icon" />
    <link rel="shortcut icon" href="../../../../../../images/icons/callista_favicon.svg" type="image/x-icon" />
    <link rel="apple-touch-icon" href="../../../../../../images/icons/callista_favicon_160x160.png">

    <title>Android - TLS/SSL Mutual Authentication | Callista</title>

    <link rel="stylesheet" href="../../../../../../css/style.css%3Fv=1.css">
    <link rel="alternate" type="application/rss+xml" title="RSS Feed for callistaenterprise.se" href="../../../../../../feed.xml" />

    <!--[if lte IE 8]>
    <style>* { display: none !important; }</style>
    <meta http-equiv="refresh" content="0; url=/oldie/"/>
    <![endif]-->

    <script type="text/javascript" src="https://use.typekit.net/kig5egm.js"></script>
    <script type="text/javascript">
        try {
            Typekit.load({ async: true });
        } catch (e) {
        }
    </script>

    <!-- Facebook Pixel Code -->
    <script>
    !function(f,b,e,v,n,t,s)
    {if(f.fbq)return;n=f.fbq=function(){n.callMethod?
    n.callMethod.apply(n,arguments):n.queue.push(arguments)};
    if(!f._fbq)f._fbq=n;n.push=n;n.loaded=!0;n.version='2.0';
    n.queue=[];t=b.createElement(e);t.async=!0;
    t.src=v;s=b.getElementsByTagName(e)[0];
    s.parentNode.insertBefore(t,s)}(window,document,'script',
    'https://connect.facebook.net/en_US/fbevents.js');
     fbq('init', '804675599711872');
     fbq('track', 'PageView');
    </script>
    <noscript>
     <img height="1" width="1" src="https://www.facebook.com/tr?id=804675599711872&ev=PageView&noscript=1"/>
    </noscript>
    <!-- End Facebook Pixel Code -->

</head>
<body>

    <header class="ce-header" data-scroll="0">
    <nav>
        <img alt="menubg" class="ce-menu-icon" style="z-index:3; top: 0px; width: 50px; height: 100%;" src="../../../../../../images/icons/menu_background.png">
        <a class="ce-logotype" href="../../../../../../index.html" style="z-index: 2;">
            <img alt="Callista" style="max-width: 100%; height: auto;" src="../../../../../../images/logotype/callista_small2.svg">
        </a>
        <table>
            <tr>
                <td>
            <ul id="menu-primary" class="ce-menu-primary">
                
                    
                            <li><a href="../../../../../../om/index.html">Om oss</a></li>
                    
                
                    
                            <li><a href="../../../../../../erbjudanden.html">Erbjudanden</a></li>
                    
                
                    
                            <li><a href="../../../../../../event.html">Event</a></li>
                    
                
                    
                        
                            <li><a class="ce-active" href="../../../../../../blogg.html">Blogg</a></li>
                        
                    
                
                    
                            <li><a href="../../../../../../om/jobb/index.html">Jobba hos oss</a></li>
                    
                
            </ul>
                </td>

                <td>
            <ul class="ce-menu-secondary">
                
                <li><a href="../../../../../../english/index.html">English</a></li>
                
            </ul>
                </td>
            </tr>
        </table>
            <a id="menu" class="ce-menu-icon" href="index.html#" style="z-index: 4;">
                <img alt="Visa meny" src="../../../../../../images/icons/menu.png">
            </a>
            <a class="ce-search-icon" href="index.html#">
                <img alt="Sök" src="../../../../../../images/icons/search.png">
            </a>

        </table>
    </nav>
</header>


    <div class="ce-main">
        <section class="ce-start lazyImg">
    <article>
        <h1>Blogg</h1>
        <p class="ce-ingress">
            Här finns tekniska artiklar, presentationer och nyheter om arkitektur och systemutveckling. Håll dig uppdaterad, följ oss på <a class="ce-active" href="http://twitter.com/callistaent">Twitter</a>
        </p>
    </article>
</section>

<section class="ce-section">
    <div class="ce-content">
        
        

        
        

        <article class="ce-blog">
            <header>
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    <img alt="Callista medarbetare Marcus Krantz" src="../../../../../../assets/medarbetare/marcuskrantz_mini.png">
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    <h2>
        <a href="index.html">Android - TLS/SSL Mutual Authentication</a>
        
        
    </h2>
    <h3>
        <time datetime="2011-11-24T00:00:00+00:00">
            24 November 2011
        </time>
        //
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        

        
        
        Marcus Krantz
        

        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
    </h3>
    
</header>




<p>Due to the explosion of smart phones on the market, the need for exposing existing enterprise systems through the mobile channel is growing rapidly. One of the first questions that will come up is how we can establish a secure communication channel with the existing enterprise system.</p>

<p>In this article, I will cover both how to trust a server certificate for secure communication with the server, as well as providing a client certificate to the server for mutual authentication. The client certificate is bundled with the app and of course, the server needs to trust this certificate.</p>

<p></p>

<h2 id="setup">Setup</h2>
<p>Before we can start, keys and certificates need to be in place. My article <a href="../creating-self-signed-certificates-for-use-on-android/index.html">Creating self-signed certificates for use on Android</a> covers how to create keys and certificates as well as importing them into supported key stores. If you don’t have any keys or certificates, create the required files by reading that article.</p>

<h3 id="android-and-self-signed-certificates">Android and self-signed certificates</h3>
<p>I assume that you already figured out how to create a simple Android app. However, I do not assume that you have put <code class="language-plaintext highlighter-rouge">clienttruststore.bks</code> or <code class="language-plaintext highlighter-rouge">client.bks</code> in your Android project’s <code class="language-plaintext highlighter-rouge">res/raw</code> directory. Before you continue, make sure the two files are there. These files were created in <a href="../creating-self-signed-certificates-for-use-on-android/index.html">Creating self-signed certificates for use on Android</a> but you can replace them with your own, just make sure that your keystores uses the <a href="http://www.bouncycastle.org/latest_releases.html">Bouncy Castle Provider</a>.</p>

<h2 id="implementation">Implementation</h2>
<p>This section covers how you can implement a custom <code class="language-plaintext highlighter-rouge">HttpClient</code> by registering a scheme for https communication and load a keystore and a truststore into a <code class="language-plaintext highlighter-rouge">SSLSocketFactory</code>.</p>

<h3 id="extend-httpclient">Extend HttpClient</h3>
<p>Android uses Apache Commons HttpClient but since we want communicate securely we must extend the <code class="language-plaintext highlighter-rouge">DefaultHttpClient</code> with some custom behavior (load our keystores). Therefore, we start by creating <code class="language-plaintext highlighter-rouge">SecureHttpClient.java</code> and extend the <code class="language-plaintext highlighter-rouge">HttpClient</code>.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">SecureHttpClient</span> <span class="kd">extends</span> <span class="nc">DefaultHttpClient</span> <span class="o">{</span>
  <span class="kd">private</span> <span class="kt">int</span> <span class="n">securePort</span><span class="o">;</span>

  <span class="kd">public</span> <span class="nf">SecureHttpClient</span><span class="o">(</span><span class="kd">final</span> <span class="kt">int</span> <span class="n">port</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">this</span><span class="o">.</span><span class="na">securePort</span> <span class="o">=</span> <span class="n">port</span><span class="o">;</span>
  <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>Simply put, we need to do two things to get our mutual authentication to work. 1) Create an <code class="language-plaintext highlighter-rouge">SSLSocketFactory</code> where we load our keystores and 2) Register a scheme for https communication that uses our custom <code class="language-plaintext highlighter-rouge">SSLSocketFactory</code>. This method will load our keystores.</p>

<h3 id="create-sslsocketfactory-and-load-the-keystores">Create SSLSocketFactory and load the keystores</h3>
<p>Extend the <code class="language-plaintext highlighter-rouge">SecureHttpClient</code> with the two new methods found below. If you do not want to use mutual authentication you can just load the trust store in which the server’s certificate is. The resulting <code class="language-plaintext highlighter-rouge">SSLSocketFactory</code> will later be used when creating a scheme for https-communication.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">private</span> <span class="nc">SSLSocketFactory</span> <span class="nf">createSSLSocketFactory</span><span class="o">(</span><span class="kd">final</span> <span class="nc">Context</span> <span class="n">context</span><span class="o">)</span> <span class="o">{</span>
  <span class="nc">Log</span><span class="o">.</span><span class="na">d</span><span class="o">(</span><span class="no">TAG</span><span class="o">,</span> <span class="s">"Creating SSL socket factory"</span><span class="o">);</span>

  <span class="kd">final</span> <span class="nc">KeyStore</span> <span class="n">truststore</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">loadStore</span><span class="o">(</span><span class="n">context</span><span class="o">.</span><span class="na">getResources</span><span class="o">().</span>
      <span class="n">openRawResource</span><span class="o">(</span><span class="no">R</span><span class="o">.</span><span class="na">raw</span><span class="o">.</span><span class="na">clienttruststore</span><span class="o">,</span> <span class="s">"password"</span><span class="o">,</span> <span class="s">"BKS"</span><span class="o">);</span>
  <span class="kd">final</span> <span class="nc">KeyStore</span> <span class="n">keystore</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">loadStore</span><span class="o">(</span><span class="n">context</span><span class="o">.</span><span class="na">getResources</span><span class="o">().</span>
      <span class="n">openRawResource</span><span class="o">(</span><span class="no">R</span><span class="o">.</span><span class="na">raw</span><span class="o">.</span><span class="na">client</span><span class="o">,</span> <span class="s">"password"</span><span class="o">,</span> <span class="s">"BKS"</span><span class="o">);</span>

  <span class="k">return</span> <span class="k">this</span><span class="o">.</span><span class="na">createFactory</span><span class="o">(</span><span class="n">keystore</span><span class="o">,</span> <span class="k">this</span><span class="o">.</span><span class="na">keystorePassword</span><span class="o">,</span> <span class="n">truststore</span><span class="o">);</span>
<span class="o">}</span>

<span class="kd">private</span> <span class="nc">SSLSocketFactory</span> <span class="nf">createFactory</span><span class="o">(</span><span class="kd">final</span> <span class="nc">KeyStore</span> <span class="n">keystore</span><span class="o">,</span>
    <span class="kd">final</span> <span class="nc">String</span> <span class="n">keystorePassword</span><span class="o">,</span> <span class="kd">final</span> <span class="nc">KeyStore</span> <span class="n">truststore</span><span class="o">)</span> <span class="o">{</span>

  <span class="nc">SSLSocketFactory</span> <span class="n">factory</span><span class="o">;</span>
  <span class="k">try</span> <span class="o">{</span>
    <span class="n">factory</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">SSLSocketFactory</span><span class="o">(</span><span class="n">keystore</span><span class="o">,</span> <span class="k">this</span><span class="o">.</span><span class="na">getKeystorePassword</span><span class="o">(),</span> <span class="n">truststore</span><span class="o">);</span>
    <span class="n">factory</span><span class="o">.</span><span class="na">setHostnameVerifier</span><span class="o">(</span>
      <span class="o">(</span><span class="nc">X509HostnameVerifier</span><span class="o">)</span> <span class="nc">SSLSocketFactory</span><span class="o">.</span><span class="na">ALLOW_ALL_HOSTNAME_VERIFIER</span><span class="o">);</span>
  <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
    <span class="nc">Log</span><span class="o">.</span><span class="na">e</span><span class="o">(</span><span class="no">TAG</span><span class="o">,</span> <span class="s">"Caught exception when trying to create ssl socket factory. Reason: "</span> <span class="o">+</span>
        <span class="n">e</span><span class="o">.</span><span class="na">getMessage</span><span class="o">());</span>
    <span class="k">throw</span> <span class="k">new</span> <span class="nf">RuntimeException</span><span class="o">(</span><span class="n">e</span><span class="o">);</span>
  <span class="o">}</span>

  <span class="k">return</span> <span class="n">factory</span><span class="o">;</span>
<span class="o">}</span>
</code></pre></div></div>

<p>We now have a method that loads our keystores and return an SSLSocketFactory.</p>

<h3 id="register-a-scheme-for-https">Register a scheme for https</h3>
<p>Before we can communicate with our server, we must register a scheme for https communication that uses our <code class="language-plaintext highlighter-rouge">SSLSocketFactory</code>. The <code class="language-plaintext highlighter-rouge">createConnectionManager()</code> in <code class="language-plaintext highlighter-rouge">HttpClient</code> allows us to register our scheme. Override the <code class="language-plaintext highlighter-rouge">createConnectionManager()</code> method and provide the following implementation:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Override</span>
<span class="kd">protected</span> <span class="nc">ClientConnectionManager</span> <span class="nf">createClientConnectionManager</span><span class="o">()</span> <span class="o">{</span>
  <span class="nc">Log</span><span class="o">.</span><span class="na">d</span><span class="o">(</span><span class="no">TAG</span><span class="o">,</span> <span class="s">"Creating client connection manager"</span><span class="o">);</span>

  <span class="kd">final</span> <span class="nc">SchemeRegistry</span> <span class="n">registry</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">SchemeRegistry</span><span class="o">();</span>

  <span class="nc">Log</span><span class="o">.</span><span class="na">d</span><span class="o">(</span><span class="no">TAG</span><span class="o">,</span> <span class="s">"Adding https scheme for port "</span> <span class="o">+</span> <span class="n">securePort</span><span class="o">);</span>
  <span class="n">registry</span><span class="o">.</span><span class="na">register</span><span class="o">(</span><span class="k">new</span> <span class="nc">Scheme</span><span class="o">(</span><span class="s">"https"</span><span class="o">,</span> <span class="k">this</span><span class="o">.</span><span class="na">createSSLSocketFactory</span><span class="o">(),</span> <span class="k">this</span><span class="o">.</span><span class="na">securePort</span><span class="o">));</span>

  <span class="k">return</span> <span class="k">new</span> <span class="nf">SingleClientConnManager</span><span class="o">(</span><span class="n">getParams</span><span class="o">(),</span> <span class="n">registry</span><span class="o">);</span>
<span class="o">}</span>
</code></pre></div></div>

<p>That’s about it. We now have the <code class="language-plaintext highlighter-rouge">SecureHttpClient</code> class that we can use from our Android app to communicate over Https.</p>

<h2 id="using-the-secure-client">Using the Secure client</h2>
<p>It is time to use our <code class="language-plaintext highlighter-rouge">SecureHttpClient</code> and make a call to a web server. Since this is just a test, we can basically make the call from anywhere in the app and I choose to make it in an Activity’s <code class="language-plaintext highlighter-rouge">onCreate()</code>-method. The test server I used is a simple Jetty server (jetty-maven-plugin) where I added configuration for SSL containing a trust store and the server’s certificate. You can see how a simple server with SSL can be setup in the article: <a href="../quick-start-jettys-maven-plugin-with-ssl/index.html">Quick Start - Jetty, Maven and SSL</a>.</p>

<p>To make a https call to the server, simply provide an implementation like the one below:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Override</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">onCreate</span><span class="o">(</span><span class="nc">Bundle</span> <span class="n">savedInstanceState</span><span class="o">)</span> <span class="o">{</span>
  <span class="kd">final</span> <span class="nc">HttpClient</span> <span class="n">client</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">SecureHttpClient</span><span class="o">(</span><span class="mi">443</span><span class="o">);</span>

  <span class="c1">// Provide ip or address to where your test server is runnning</span>
  <span class="kd">final</span> <span class="nc">HttpGet</span> <span class="n">request</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">HttpGet</span><span class="o">(</span><span class="s">"https://192.168.0.10:8443/example-server"</span><span class="o">)</span>
  <span class="kd">final</span> <span class="nc">HttpResponse</span> <span class="n">response</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="na">execute</span><span class="o">(</span><span class="n">request</span><span class="o">);</span>

  <span class="nc">Log</span><span class="o">.</span><span class="na">d</span><span class="o">(</span><span class="s">"ExampleActivity"</span><span class="o">,</span> <span class="s">"Response code: "</span> <span class="o">+</span> <span class="n">response</span><span class="o">.</span><span class="na">getStatusLine</span><span class="o">().</span><span class="na">getStatusCode</span><span class="o">());</span>
<span class="o">}</span>
</code></pre></div></div>









            <div class="ce-blog-thanks">
              Tack för att du läser Callistas blogg. <br>
              Hjälp oss att nå ut med information genom att dela nyheter och artiklar i ditt nätverk.<br>
            </div>

            


    
<div class="ce-blog-share">
    <a class="ce-blog-share-element social-twitter" href="https://twitter.com/intent/tweet?text=Android Tlsssl Mutual Authentication&url=https://callistaenterprise.se/blogg/teknik/2011/11/24/android-tlsssl-mutual-authentication/&via=callistaent&hashtags=" target="_blank" title="Share this post on Twitter"></a>
    <a class="ce-blog-share-element social-facebook" href="https://www.facebook.com/sharer/sharer.php?t=Android Tlsssl Mutual Authentication&u=https://callistaenterprise.se/blogg/teknik/2011/11/24/android-tlsssl-mutual-authentication/" target="_blank" title="Share this post on Facebook"></a>
    <a class="ce-blog-share-element social-linkedin" href="http://www.linkedin.com/shareArticle?mini=true&title=Android Tlsssl Mutual Authentication&url=https://callistaenterprise.se/blogg/teknik/2011/11/24/android-tlsssl-mutual-authentication/&source=http%3a%2f%2fzhangwenli.com" target="_blank" title="Share this post on LinkedIn"></a>
</div>
    
        </article>
    </div>
</section>


<section class="ce-section">
    <heading>
        <h1>Kommentarer</h1>
    </heading>
    <div class="ce-content">
        <div id="disqus_thread"></div>
        <script src="../../../../../../js/disqus.js"></script>
    </div>
</section>


    </div>

    <footer class="ce-footer">
    <div class="ce-wrapper">
        <nav class="ce-menu-footer-primary">
            <h2><a href="../../../../../../index.html">Callista</a></h2>
            <ul>
                
                <li><a href="../../../../../../om/index.html">Om oss</a></li>
                
                <li><a href="../../../../../../erbjudanden.html">Erbjudanden</a></li>
                
                <li><a href="../../../../../../event.html">Event</a></li>
                
                <li><a href="../../../../../../blogg.html">Blogg</a></li>
                
                <li><a href="../../../../../../om/jobb/index.html">Jobba hos oss</a></li>
                

                
                    
                        <li><a href="../../../../../../english/index.html">English</a></li>
                    
                
            </ul>
        </nav>
        <div class="ce-addresses">
            <div class="ce-address">
                <h2>Stockholm</h2>
                <address>
                    Drottninggatan 55<br>
                    111 21 Stockholm<br>
                    Tel:
                    <a href="tel:+468212142">
                        +46 8 21 21 42
                    </a>
                </address>
            </div>
            <div class="ce-address">
                <h2>Göteborg</h2>
                <address>
                    Fabriksgatan 13<br>
                    412 50 Göteborg<br>
                    Tel:
                    <a href="tel:+4631201918">
                        +46 31 20 19 18
                    </a>
                </address>
            </div>
        </div>
        <div class="ce-social">
            <h2>Följ oss</h2>
            <ul>
                <li>
                    <a href="http://twitter.com/callistaent">
                        <img alt="Twitters logotype" src="../../../../../../images/icons/twitter.png">
                        <span>@callistaent</span>
                    </a>
                </li>
            </ul>
        </div>
        <small>&copy; 2021 Callista Enterprise AB</small>
        <hr style="margin: 1em 0 2em 0">
        <div class="ce-footer-images">
          <div class="ce-footer-image">
            <a class="ce-raddabarnen" href="http://www.raddabarnen.se/foretag">
                <img alt="Callista är Rädda Barnens företagsvän 2021" src="../../../../../../images/logotype/rb_vanforetag_2021_large-sv.png">
            </a>
          </div>
        </div>
        <br>
        <div class="ce-footer-images">
          <div class="ce-footer-image">
            <a class="ce-di-gasell" href="http://www.di.se/gasell/">
              <img alt="Callista utsett till DI Gasell tre år i rad" src="../../../../../../images/logotype/di_gasell_180x194.png">
            </a>
          </div>
        </div>
    </div>
</footer>


    <script src="../../../../../../js/lib/jquery.min.js"></script>
    <script src="../../../../../../js/lib/owl.carousel.min.js"></script>
    <script src="../../../../../../js/lib/prismjs.min.js"></script>
    <script src="../../../../../../js/app.js"></script>
    <script src="../../../../../../js/analytics.js"></script>
    <script src="../../../../../../js/jobinterestsubmit.js"></script>

</body>
</html>
