<!DOCTYPE html>
<html lang="sv-se">
<head>
    <meta charset="utf-8">

    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="description" content="Callista Enterprise - seniora IT-arkitekter och systemutvecklare inom Java, öppen källkod, agil utveckling och systemintegration">
    <!--<meta name="viewport" content="width=device-width, initial-scale=1">-->
    <meta name="viewport" content="initial-scale=1.0001, minimum-scale=1.0001, maximum-scale=1.0001, user-scalable=no"/>

    <link rel="icon" href="../../../../../../images/icons/callista_favicon.svg" type="image/x-icon" />
    <link rel="shortcut icon" href="../../../../../../images/icons/callista_favicon.svg" type="image/x-icon" />
    <link rel="apple-touch-icon" href="../../../../../../images/icons/callista_favicon_160x160.png">

    <title>Project Reactor - Reactive Programming with Spring, Part 2. | Callista</title>

    <link rel="stylesheet" href="../../../../../../css/style.css%3Fv=1.css">
    <link rel="alternate" type="application/rss+xml" title="RSS Feed for callistaenterprise.se" href="../../../../../../feed.xml" />

    <!--[if lte IE 8]>
    <style>* { display: none !important; }</style>
    <meta http-equiv="refresh" content="0; url=/oldie/"/>
    <![endif]-->

    <script type="text/javascript" src="https://use.typekit.net/kig5egm.js"></script>
    <script type="text/javascript">
        try {
            Typekit.load({ async: true });
        } catch (e) {
        }
    </script>

    <!-- Facebook Pixel Code -->
    <script>
    !function(f,b,e,v,n,t,s)
    {if(f.fbq)return;n=f.fbq=function(){n.callMethod?
    n.callMethod.apply(n,arguments):n.queue.push(arguments)};
    if(!f._fbq)f._fbq=n;n.push=n;n.loaded=!0;n.version='2.0';
    n.queue=[];t=b.createElement(e);t.async=!0;
    t.src=v;s=b.getElementsByTagName(e)[0];
    s.parentNode.insertBefore(t,s)}(window,document,'script',
    'https://connect.facebook.net/en_US/fbevents.js');
     fbq('init', '804675599711872');
     fbq('track', 'PageView');
    </script>
    <noscript>
     <img height="1" width="1" src="https://www.facebook.com/tr?id=804675599711872&ev=PageView&noscript=1"/>
    </noscript>
    <!-- End Facebook Pixel Code -->

</head>
<body>

    <header class="ce-header" data-scroll="0">
    <nav>
        <img alt="menubg" class="ce-menu-icon" style="z-index:3; top: 0px; width: 50px; height: 100%;" src="../../../../../../images/icons/menu_background.png">
        <a class="ce-logotype" href="../../../../../../index.html" style="z-index: 2;">
            <img alt="Callista" style="max-width: 100%; height: auto;" src="../../../../../../images/logotype/callista_small2.svg">
        </a>
        <table>
            <tr>
                <td>
            <ul id="menu-primary" class="ce-menu-primary">
                
                    
                            <li><a href="../../../../../../om/index.html">Om oss</a></li>
                    
                
                    
                            <li><a href="../../../../../../erbjudanden.html">Erbjudanden</a></li>
                    
                
                    
                            <li><a href="../../../../../../event.html">Event</a></li>
                    
                
                    
                        
                            <li><a class="ce-active" href="../../../../../../blogg.html">Blogg</a></li>
                        
                    
                
                    
                            <li><a href="../../../../../../om/jobb/index.html">Jobba hos oss</a></li>
                    
                
            </ul>
                </td>

                <td>
            <ul class="ce-menu-secondary">
                
                <li><a href="../../../../../../english/index.html">English</a></li>
                
            </ul>
                </td>
            </tr>
        </table>
            <a id="menu" class="ce-menu-icon" href="index.html#" style="z-index: 4;">
                <img alt="Visa meny" src="../../../../../../images/icons/menu.png">
            </a>
            <a class="ce-search-icon" href="index.html#">
                <img alt="Sök" src="../../../../../../images/icons/search.png">
            </a>

        </table>
    </nav>
</header>


    <div class="ce-main">
        <section class="ce-start lazyImg">
    <article>
        <h1>Blogg</h1>
        <p class="ce-ingress">
            Här finns tekniska artiklar, presentationer och nyheter om arkitektur och systemutveckling. Håll dig uppdaterad, följ oss på <a class="ce-active" href="http://twitter.com/callistaent">Twitter</a>
        </p>
    </article>
</section>

<section class="ce-section">
    <div class="ce-content">
        
        

        
        

        <article class="ce-blog">
            <header>
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    <img alt="Callista medarbetare Anna Eriksson" src="../../../../../../assets/medarbetare/annaeriksson_mini.png">
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    <h2>
        <a href="index.html">Project Reactor - Reactive Programming with Spring, Part 2.</a>
        
        
    </h2>
    <h3>
        <time datetime="2020-09-12T00:00:00+00:00">
            12 September 2020
        </time>
        //
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        

        
        
        <a href="../../../../../../om/medarbetare/annaeriksson/index.html">Anna Eriksson</a>
        

        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
    </h3>
    
</header>




<p>This is the second part of my <a href="../../../05/24/blog-series-reactive-programming/index.html">blog series on reactive programming</a>, providing an overview of Project Reactor, a reactive library based on the Reactive Streams specification. Part 1 covered <a href="../../../05/24/blog-series-reactive-programming-part-1/index.html">an introduction to reactive programming</a>.</p>

<p></p>

<h2 id="1-an-introduction-to-project-reactor">1. An introduction to Project Reactor</h2>

<p>Reactive programming is supported by Spring Framework since version 5. That support is built on top of Project Reactor.</p>

<p>Project Reactor (or just Reactor) is a Reactive library for building non-blocking applications on the JVM and is based on the Reactive Streams Specification. Reactor is the foundation of the reactive stack in the Spring ecosystem and it is being developed in close collaboration with Spring. WebFlux, Spring’s reactive-stack web framework, requires Reactor as a core dependency.</p>

<h3 id="11-reactor-modules">1.1 Reactor modules</h3>
<p>Project Reactor consist of a set of modules as listed in the <a href="https://projectreactor.io/docs">Reactor documentation</a>.
The modules are embeddable and interoperable. The main artifact is <code class="language-plaintext highlighter-rouge">Reactor Core</code> which holds the reactive types Flux and Mono, that implement the Reactive Stream’s Publisher interface (for details see <a href="../../../05/24/blog-series-reactive-programming-part-1/index.html">the first blog post of this series</a>) and a set of operators that can be applied on these.</p>

<p>Some other modules are:</p>
<ul>
  <li><code class="language-plaintext highlighter-rouge">Reactor Test</code> - which provides some utilities for testing reactive streams</li>
  <li><code class="language-plaintext highlighter-rouge">Reactor Extra</code> - that provides some additional Flux operators</li>
  <li><code class="language-plaintext highlighter-rouge">Reactor Netty</code> - non-blocking and backpressure-ready TCP, HTTP, and UDP clients and servers - based on the Netty framework</li>
  <li><code class="language-plaintext highlighter-rouge">Reactor Adapter</code> -  for adapting to/from other reactive libraries such as RxJava2 and Akka Streams</li>
  <li><code class="language-plaintext highlighter-rouge">Reactor Kafka</code> - a reactive API for Kafka which enables messages to be published to and consumed from Kafka</li>
</ul>

<h3 id="12-set-up-a-project">1.2 Set up a project</h3>
<p>Before we continue, if you want to set up a project and run some of the code samples below, generate a new Spring Boot application using <a href="https://start.spring.io">Spring Initializr</a>.
As dependency select Spring Reactive Web. After importing the project in your IDE have a look at the POM file and you will see that the spring-boot-starter-webflux dependency is added which will also bring in the reactor-core dependeny. Also reactor-test has been added as a dependency.
Now you are ready to run the coming code examples.</p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code>...	
        <span class="nt">&lt;dependencies&gt;</span>
		<span class="nt">&lt;dependency&gt;</span>
			<span class="nt">&lt;groupId&gt;</span>org.springframework.boot<span class="nt">&lt;/groupId&gt;</span>
			<span class="nt">&lt;artifactId&gt;</span>spring-boot-starter-webflux<span class="nt">&lt;/artifactId&gt;</span>
		<span class="nt">&lt;/dependency&gt;</span>

		<span class="nt">&lt;dependency&gt;</span>
			<span class="nt">&lt;groupId&gt;</span>org.springframework.boot<span class="nt">&lt;/groupId&gt;</span>
			<span class="nt">&lt;artifactId&gt;</span>spring-boot-starter-test<span class="nt">&lt;/artifactId&gt;</span>
			<span class="nt">&lt;scope&gt;</span>test<span class="nt">&lt;/scope&gt;</span>
			<span class="nt">&lt;exclusions&gt;</span>
				<span class="nt">&lt;exclusion&gt;</span>
					<span class="nt">&lt;groupId&gt;</span>org.junit.vintage<span class="nt">&lt;/groupId&gt;</span>
					<span class="nt">&lt;artifactId&gt;</span>junit-vintage-engine<span class="nt">&lt;/artifactId&gt;</span>
				<span class="nt">&lt;/exclusion&gt;</span>
			<span class="nt">&lt;/exclusions&gt;</span>
		<span class="nt">&lt;/dependency&gt;</span>
		<span class="nt">&lt;dependency&gt;</span>
			<span class="nt">&lt;groupId&gt;</span>io.projectreactor<span class="nt">&lt;/groupId&gt;</span>
			<span class="nt">&lt;artifactId&gt;</span>reactor-test<span class="nt">&lt;/artifactId&gt;</span>
			<span class="nt">&lt;scope&gt;</span>test<span class="nt">&lt;/scope&gt;</span>
		<span class="nt">&lt;/dependency&gt;</span>
	<span class="nt">&lt;/dependencies&gt;</span>
...
</code></pre></div></div>

<h2 id="2-reactor-core-features">2. Reactor Core features</h2>
<p>Reactor Core defines the reactive types Flux and Mono.</p>

<h3 id="21-flux-vs-mono">2.1 Flux vs Mono</h3>
<p>A Flux is a Publisher that can emit 0 to N elements, while a Mono can emit 0 to 1 element.
They are both terminated either by a completion signal or an error and they call a downstream Subscriber’s onNext, onComplete and onError methods. 
Besides implementing the functionality described by the Reactive Streams specification, Flux and Mono provide a set of operators to support transformations, filtering and error handling.</p>

<p>As a first exercise, go to the test class generated in your new project, add the following example and run it:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Test</span>
<span class="kt">void</span> <span class="nf">simpleFluxExample</span><span class="o">()</span> <span class="o">{</span>
    <span class="nc">Flux</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="n">fluxColors</span> <span class="o">=</span> <span class="nc">Flux</span><span class="o">.</span><span class="na">just</span><span class="o">(</span><span class="s">"red"</span><span class="o">,</span> <span class="s">"green"</span><span class="o">,</span> <span class="s">"blue"</span><span class="o">);</span>
    <span class="n">fluxColors</span><span class="o">.</span><span class="na">subscribe</span><span class="o">(</span><span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">::</span><span class="n">println</span><span class="o">);</span>
<span class="o">}</span>
</code></pre></div></div>
<p>The just method creates a Flux that emits the provided elements and then completes.
Nothing is emitted until someone subscribes to it. To subscribe to it, we invoke the subscribe method and in this case we just print out the emitted items. Creating a Mono can also be done with the just method, the only difference being that only one parameter is allowed.</p>

<h3 id="22-chaining-operators">2.2 Chaining operators</h3>
<p>Take a look at the <a href="https://projectreactor.io/docs/core/release/api/reactor/core/publisher/Flux.html">Flux API</a> and you will see that almost all methods return a Flux or a Mono, meaning that operators can be chained.
Each operator adds behavior to a Publisher (Flux or Mono) and wraps the previous step’s Publisher into a new instance. Data originates from the first Publisher and moves down the chain, transformed by each operator. Eventually, a Subscriber finishes the process. Note that nothing happens until a Subscriber actually subscribes to a Publisher.</p>

<p>There is an operator called log() which provides logging of all Reactive Streams signals taking place behind the scenes. 
Just change the last line of the above example to</p>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">fluxColors</span><span class="o">.</span><span class="na">log</span><span class="o">().</span><span class="na">subscribe</span><span class="o">(</span><span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">::</span><span class="n">println</span><span class="o">);</span>
</code></pre></div></div>

<p>and rerun the test. You will now see the following being added to the output:</p>

<div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>2020-09-12 16:16:39.779  INFO 6252 --- [           main] reactor.Flux.Array.1                     : | onSubscribe([Synchronous Fuseable] FluxArray.ArraySubscription)
2020-09-12 16:16:39.781  INFO 6252 --- [           main] reactor.Flux.Array.1                     : | request(unbounded)
2020-09-12 16:16:39.781  INFO 6252 --- [           main] reactor.Flux.Array.1                     : | onNext(red)
red
2020-09-12 16:16:39.781  INFO 6252 --- [           main] reactor.Flux.Array.1                     : | onNext(green)
green
2020-09-12 16:16:39.781  INFO 6252 --- [           main] reactor.Flux.Array.1                     : | onNext(blue)
blue
2020-09-12 16:16:39.782  INFO 6252 --- [           main] reactor.Flux.Array.1                     : | onComplete()
</code></pre></div></div>

<p>Now, to see what happens if you exclude the call to subscribe(), again modify the last code line to the following and rerun the test:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">fluxColors</span><span class="o">.</span><span class="na">log</span><span class="o">();</span>
</code></pre></div></div>
<p>As you will see from the log output, no items are now emitted - since there is no Subscriber initiating the process.</p>

<h3 id="23-finding-the-right-operator">2.3 Finding the right operator</h3>

<p>Reactor provides a long list of operators and as a help to find the right one for a given use case there is a dedicated <a href="https://projectreactor.io/docs/core/release/reference/index.html#which-operator">appendix</a>  in the Reactor reference documentation. 
It is divided into different categories as shown in the table below.</p>

<table>
  <thead>
    <tr>
      <th>Operator category</th>
      <th>Examples</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>Creating a new sequence</td>
      <td>just, fromArray, fromIterable, fromStream</td>
    </tr>
    <tr>
      <td>Transforming an existing sequence</td>
      <td>map, flatMap, startWith, concatWith</td>
    </tr>
    <tr>
      <td>Peeking into a sequence</td>
      <td>doOnNext, doOnComplete, doOnError, doOnCancel</td>
    </tr>
    <tr>
      <td>Filtering a sequence</td>
      <td>filter, ignoreElements, distinct, elementAt, takeLast</td>
    </tr>
    <tr>
      <td>Handling errors</td>
      <td>onErrorReturn, onErrorResume, retry</td>
    </tr>
    <tr>
      <td>Working with time</td>
      <td>elapsed, interval, timestamp, timeout</td>
    </tr>
    <tr>
      <td>Splitting a Flux</td>
      <td>buffer, groupBy, window</td>
    </tr>
    <tr>
      <td>Going back to the synchronous world</td>
      <td>block, blockFirst, blockLast, toIterable, toStream</td>
    </tr>
    <tr>
      <td>Multicasting a Flux to several Subscribers</td>
      <td>publish, cache, replay</td>
    </tr>
  </tbody>
</table>

<p>Now feel free to go ahead and create some small examples that use some of these operators and see what happens when you run them.
For example using the map operator (which transforms the items emitted by applying a synchronous function to each item):</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Test</span>
<span class="kt">void</span> <span class="nf">mapExample</span><span class="o">()</span> <span class="o">{</span>
    <span class="nc">Flux</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="n">fluxColors</span> <span class="o">=</span> <span class="nc">Flux</span><span class="o">.</span><span class="na">just</span><span class="o">(</span><span class="s">"red"</span><span class="o">,</span> <span class="s">"green"</span><span class="o">,</span> <span class="s">"blue"</span><span class="o">);</span>
    <span class="n">fluxColors</span><span class="o">.</span><span class="na">map</span><span class="o">(</span><span class="n">color</span> <span class="o">-&gt;</span> <span class="n">color</span><span class="o">.</span><span class="na">charAt</span><span class="o">(</span><span class="mi">0</span><span class="o">)).</span><span class="na">subscribe</span><span class="o">(</span><span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">::</span><span class="n">println</span><span class="o">);</span>
<span class="o">}</span>
</code></pre></div></div>

<p>Or the zip operator, which zips multiple sources togheter (waiting for all the sources to emit one element and combining them into a Tuple):</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Test</span>
<span class="kt">void</span> <span class="nf">zipExample</span><span class="o">()</span> <span class="o">{</span>
    <span class="nc">Flux</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="n">fluxFruits</span> <span class="o">=</span> <span class="nc">Flux</span><span class="o">.</span><span class="na">just</span><span class="o">(</span><span class="s">"apple"</span><span class="o">,</span> <span class="s">"pear"</span><span class="o">,</span> <span class="s">"plum"</span><span class="o">);</span>
    <span class="nc">Flux</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="n">fluxColors</span> <span class="o">=</span> <span class="nc">Flux</span><span class="o">.</span><span class="na">just</span><span class="o">(</span><span class="s">"red"</span><span class="o">,</span> <span class="s">"green"</span><span class="o">,</span> <span class="s">"blue"</span><span class="o">);</span>
    <span class="nc">Flux</span><span class="o">&lt;</span><span class="nc">Integer</span><span class="o">&gt;</span> <span class="n">fluxAmounts</span> <span class="o">=</span> <span class="nc">Flux</span><span class="o">.</span><span class="na">just</span><span class="o">(</span><span class="mi">10</span><span class="o">,</span> <span class="mi">20</span><span class="o">,</span> <span class="mi">30</span><span class="o">);</span>
    <span class="nc">Flux</span><span class="o">.</span><span class="na">zip</span><span class="o">(</span><span class="n">fluxFruits</span><span class="o">,</span> <span class="n">fluxColors</span><span class="o">,</span> <span class="n">fluxAmounts</span><span class="o">).</span><span class="na">subscribe</span><span class="o">(</span><span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">::</span><span class="n">println</span><span class="o">);</span>
<span class="o">}</span>
</code></pre></div></div>

<h2 id="3-error-handling">3. Error handling</h2>
<p>As described in my previous blog post, in Reactive Streams errors are terminal events. When an error occurs, it stops the whole sequence and the error gets propagated to the Subscriber’s onError method, which should always be defined. If not defined, onError will throw an UnsupportedOperationException.</p>

<p>As you see running the following example, the third value is never emitted, since the second value results in an error:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Test</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">onErrorExample</span><span class="o">()</span> <span class="o">{</span>
    <span class="nc">Flux</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="n">fluxCalc</span> <span class="o">=</span> <span class="nc">Flux</span><span class="o">.</span><span class="na">just</span><span class="o">(-</span><span class="mi">1</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="mi">1</span><span class="o">)</span>
        <span class="o">.</span><span class="na">map</span><span class="o">(</span><span class="n">i</span> <span class="o">-&gt;</span> <span class="s">"10 / "</span> <span class="o">+</span> <span class="n">i</span> <span class="o">+</span> <span class="s">" = "</span> <span class="o">+</span> <span class="o">(</span><span class="mi">10</span> <span class="o">/</span> <span class="n">i</span><span class="o">));</span>
    
    <span class="n">fluxCalc</span><span class="o">.</span><span class="na">subscribe</span><span class="o">(</span><span class="n">value</span> <span class="o">-&gt;</span> <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Next: "</span> <span class="o">+</span> <span class="n">value</span><span class="o">),</span>
        <span class="n">error</span> <span class="o">-&gt;</span> <span class="nc">System</span><span class="o">.</span><span class="na">err</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Error: "</span> <span class="o">+</span> <span class="n">error</span><span class="o">));</span>
<span class="o">}</span>
</code></pre></div></div>
<p>The output will look like:</p>

<div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Next: 10 / -1 = -10
Error: java.lang.ArithmeticException: / by zero
</code></pre></div></div>

<p>It is also possible to deal with errors in the middle of a reactive chain, using error-handling operators:</p>

<p>The <code class="language-plaintext highlighter-rouge">onErrorReturn</code> method will emit a fallback value when an error of the specified type is observed. 
It can be compared to catching an Exception and returning a static fallback value in imperative programming.
See the example below:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Test</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">onErrorReturnExample</span><span class="o">()</span> <span class="o">{</span>
    <span class="nc">Flux</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="n">fluxCalc</span> <span class="o">=</span> <span class="nc">Flux</span><span class="o">.</span><span class="na">just</span><span class="o">(-</span><span class="mi">1</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="mi">1</span><span class="o">)</span>
	    <span class="o">.</span><span class="na">map</span><span class="o">(</span><span class="n">i</span> <span class="o">-&gt;</span> <span class="s">"10 / "</span> <span class="o">+</span> <span class="n">i</span> <span class="o">+</span> <span class="s">" = "</span> <span class="o">+</span> <span class="o">(</span><span class="mi">10</span> <span class="o">/</span> <span class="n">i</span><span class="o">))</span>
		<span class="o">.</span><span class="na">onErrorReturn</span><span class="o">(</span><span class="nc">ArithmeticException</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="s">"Division by 0 not allowed"</span><span class="o">);</span>

    <span class="n">fluxCalc</span><span class="o">.</span><span class="na">subscribe</span><span class="o">(</span><span class="n">value</span> <span class="o">-&gt;</span> <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Next: "</span> <span class="o">+</span> <span class="n">value</span><span class="o">),</span>
	    <span class="n">error</span> <span class="o">-&gt;</span> <span class="nc">System</span><span class="o">.</span><span class="na">err</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Error: "</span> <span class="o">+</span> <span class="n">error</span><span class="o">));</span>

<span class="o">}</span>
</code></pre></div></div>

<p>and the resulting output:</p>
<div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Next: 10 / -1 = -10
Next: Division by 0 not allowed
</code></pre></div></div>

<p>As you can see, using an  error-handling operator this way still does not let the original reactive sequence continue (the third value is not emitted here either), it rather substitutes it. 
If it’s not enough to just return some default value, you can use the <code class="language-plaintext highlighter-rouge">onErrorResume</code> method, to subscribe to a fallback Publisher when an error occurs.
This could be compared to catching an exception and invoking a fallback method in imperative programming. 
If for example a call to an external service fails, the onErrorResume implementation could be to fetch the data from a local cache.</p>

<h2 id="4-testing">4. Testing</h2>
<p>The Reactor Test module provides utilities that are helpful in testing how your Flux or Mono behaves. There is an API called the StepVerifier API that helps out with this. You create a StepVerifier and pass it the Publisher to be tested. The StepVerifier will subscribe to the Publisher when the verify method is called and then it compares the emitted values to your defined expectations.</p>

<p>See the following example:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Test</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">stepVerifierTest</span><span class="o">()</span> <span class="o">{</span>
    <span class="nc">Flux</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="n">fluxCalc</span> <span class="o">=</span> <span class="nc">Flux</span><span class="o">.</span><span class="na">just</span><span class="o">(-</span><span class="mi">1</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="mi">1</span><span class="o">)</span>
        <span class="o">.</span><span class="na">map</span><span class="o">(</span><span class="n">i</span> <span class="o">-&gt;</span> <span class="s">"10 / "</span> <span class="o">+</span> <span class="n">i</span> <span class="o">+</span> <span class="s">" = "</span> <span class="o">+</span> <span class="o">(</span><span class="mi">10</span> <span class="o">/</span> <span class="n">i</span><span class="o">));</span>

    <span class="nc">StepVerifier</span><span class="o">.</span><span class="na">create</span><span class="o">(</span><span class="n">fluxCalc</span><span class="o">)</span>
        <span class="o">.</span><span class="na">expectNextCount</span><span class="o">(</span><span class="mi">1</span><span class="o">)</span>
        <span class="o">.</span><span class="na">expectError</span><span class="o">(</span><span class="nc">ArithmeticException</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
        <span class="o">.</span><span class="na">verify</span><span class="o">();</span>
<span class="o">}</span>
</code></pre></div></div>

<p>A StepVerifier is created for the <code class="language-plaintext highlighter-rouge">fluxCalc</code> and two expectations are defined - first one String is is expected to be emitted and then an error should be emitted with the type ArithmeticException. 
With the verify call, the StepVerifier starts subscribing to the Flux and the flow is initiated.</p>

<p>StepVerifier also has other features such as enabling post-execution assertions and support for virtual time to avoid long run times for tests related to time-based operators.</p>

<p>The Reactor Test module also provides another API, the <code class="language-plaintext highlighter-rouge">TestPublisher</code> which is a Publisher that you can directly manipulate, triggering onNext, onComplete and onError events, for testing purposes.</p>

<h2 id="5-concurrency-model">5. Concurrency model</h2>
<p>As you might already have noticed from the log output of the simpleFluxExample, so far our Publisher has been executing on the main thread, just as the Subscriber. This is because Reactor does not enforce a concurrency model. Instead, the execution will for most of the operators continue on the same thread, leaving the choice to the developer. The execution model is determined by the <code class="language-plaintext highlighter-rouge">Scheduler</code> that is being used.</p>

<p>There are two ways of switching the execution context in a reactive chain: publishOn and subscribeOn. 
What differs is the following:</p>
<ul>
  <li><code class="language-plaintext highlighter-rouge">publishOn(Scheduler scheduler)</code> affects the exeuction for all subsequent operators (as far as nothing else is specified)</li>
  <li><code class="language-plaintext highlighter-rouge">subscribeOn(Scheduler scheduler)</code> changes the thread from which the whole chain of operators subscribes, based on the earliest subscribeOn call in the chain. It does not affect the behavior of subsequent calls to publishOn</li>
</ul>

<p>The <code class="language-plaintext highlighter-rouge">Schedulers</code> class holds static methods to provide an execution context, such as:</p>
<ul>
  <li><code class="language-plaintext highlighter-rouge">parallel()</code>  -  A fixed pool of workers that is tuned for parallel work, creating as many workers as there are CPU cores.</li>
  <li><code class="language-plaintext highlighter-rouge">single()</code> -  A single, reusable thread. This method reuses the same thread for all callers, until the Scheduler is disposed. If you instead want a per-call dedicated thread, you can use Schedulers.newSingle() for each call.</li>
  <li><code class="language-plaintext highlighter-rouge">boundedElastic()</code> - Dynamically creates a bounded number of workers. It has a limit on the number of backing threads it can create and can enqueue tasks to be re-scheduled when a thread becomes available. This is a good choice for wrapping synchronous, blocking calls.</li>
  <li><code class="language-plaintext highlighter-rouge">immediate()</code> - immediately runs on the executing thread, not swithcing execution context</li>
  <li><code class="language-plaintext highlighter-rouge">fromExecutorService(ExecutorService)</code> -  can be used to create a Scheduler out of any existing ExecutorService</li>
</ul>

<p>Run the following example and observe the behavior:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Test</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">publishSubscribeExample</span><span class="o">()</span> <span class="o">{</span>
    <span class="nc">Scheduler</span> <span class="n">schedulerA</span> <span class="o">=</span> <span class="nc">Schedulers</span><span class="o">.</span><span class="na">newParallel</span><span class="o">(</span><span class="s">"Scheduler A"</span><span class="o">);</span>
    <span class="nc">Scheduler</span> <span class="n">schedulerB</span> <span class="o">=</span> <span class="nc">Schedulers</span><span class="o">.</span><span class="na">newParallel</span><span class="o">(</span><span class="s">"Scheduler B"</span><span class="o">);</span>
    <span class="nc">Scheduler</span> <span class="n">schedulerC</span> <span class="o">=</span> <span class="nc">Schedulers</span><span class="o">.</span><span class="na">newParallel</span><span class="o">(</span><span class="s">"Scheduler C"</span><span class="o">);</span>
        
    <span class="nc">Flux</span><span class="o">.</span><span class="na">just</span><span class="o">(</span><span class="mi">1</span><span class="o">)</span>
        <span class="o">.</span><span class="na">map</span><span class="o">(</span><span class="n">i</span> <span class="o">-&gt;</span> <span class="o">{</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"First map: "</span> <span class="o">+</span> <span class="nc">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">().</span><span class="na">getName</span><span class="o">());</span>
            <span class="k">return</span> <span class="n">i</span><span class="o">;</span>
        <span class="o">})</span>
        <span class="o">.</span><span class="na">subscribeOn</span><span class="o">(</span><span class="n">schedulerA</span><span class="o">)</span>
        <span class="o">.</span><span class="na">map</span><span class="o">(</span><span class="n">i</span> <span class="o">-&gt;</span> <span class="o">{</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Second map: "</span> <span class="o">+</span> <span class="nc">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">().</span><span class="na">getName</span><span class="o">());</span>
            <span class="k">return</span> <span class="n">i</span><span class="o">;</span>
        <span class="o">})</span>
        <span class="o">.</span><span class="na">publishOn</span><span class="o">(</span><span class="n">schedulerB</span><span class="o">)</span>
        <span class="o">.</span><span class="na">map</span><span class="o">(</span><span class="n">i</span> <span class="o">-&gt;</span> <span class="o">{</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Third map: "</span> <span class="o">+</span> <span class="nc">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">().</span><span class="na">getName</span><span class="o">());</span>
            <span class="k">return</span> <span class="n">i</span><span class="o">;</span>
        <span class="o">})</span>
        <span class="o">.</span><span class="na">subscribeOn</span><span class="o">(</span><span class="n">schedulerC</span><span class="o">)</span>
        <span class="o">.</span><span class="na">map</span><span class="o">(</span><span class="n">i</span> <span class="o">-&gt;</span> <span class="o">{</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Fourth map: "</span> <span class="o">+</span> <span class="nc">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">().</span><span class="na">getName</span><span class="o">());</span>
            <span class="k">return</span> <span class="n">i</span><span class="o">;</span>
        <span class="o">})</span>
        <span class="o">.</span><span class="na">publishOn</span><span class="o">(</span><span class="n">schedulerA</span><span class="o">)</span>
        <span class="o">.</span><span class="na">map</span><span class="o">(</span><span class="n">i</span> <span class="o">-&gt;</span> <span class="o">{</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Fifth map: "</span> <span class="o">+</span> <span class="nc">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">().</span><span class="na">getName</span><span class="o">());</span>
            <span class="k">return</span> <span class="n">i</span><span class="o">;</span>
        <span class="o">})</span>
        <span class="o">.</span><span class="na">blockLast</span><span class="o">();</span>
<span class="o">}</span>
</code></pre></div></div>
<p>Taking a look at the output (as below) you can see that the first and second map are executed in a thread from Scheduler A, since the first subscribeOn in the chain switches to this scheduler and it affects the whole chain.
Before the third map there is a publishOn switching the execution context to Scheduler B, making the third and fourth map being executed in this context (since the second subscribeOn will not have any effect). And finally there is a new publishOn switching back to Scheduler A before the last map operation.</p>
<div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>First map: Scheduler A-4
Second map: Scheduler A-4
Third map: Scheduler B-3
Fourth map: Scheduler B-3
Fifth map: Scheduler A-1
</code></pre></div></div>

<h2 id="6-backpressure">6. Backpressure</h2>
<p>As you might recall from the first part of this blog series, backpressure is the ability for the consumer to signal to the producer what rate of emission it can handle, so it does not get overwhelmed.</p>

<p>The example below demonstrates how the Subscriber can control the pace of emission by invoking the <code class="language-plaintext highlighter-rouge">request(n)</code> method on the Subscription.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Test</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">backpressureExample</span><span class="o">()</span> <span class="o">{</span>
    <span class="nc">Flux</span><span class="o">.</span><span class="na">range</span><span class="o">(</span><span class="mi">1</span><span class="o">,</span><span class="mi">5</span><span class="o">)</span>
        <span class="o">.</span><span class="na">subscribe</span><span class="o">(</span><span class="k">new</span> <span class="nc">Subscriber</span><span class="o">&lt;</span><span class="nc">Integer</span><span class="o">&gt;()</span> <span class="o">{</span>
            <span class="kd">private</span> <span class="nc">Subscription</span> <span class="n">s</span><span class="o">;</span>
            <span class="kt">int</span> <span class="n">counter</span><span class="o">;</span>
            
            <span class="nd">@Override</span>
            <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onSubscribe</span><span class="o">(</span><span class="nc">Subscription</span> <span class="n">s</span><span class="o">)</span> <span class="o">{</span>
                <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"onSubscribe"</span><span class="o">);</span>
                <span class="k">this</span><span class="o">.</span><span class="na">s</span> <span class="o">=</span> <span class="n">s</span><span class="o">;</span>
                <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Requesting 2 emissions"</span><span class="o">);</span>
                <span class="n">s</span><span class="o">.</span><span class="na">request</span><span class="o">(</span><span class="mi">2</span><span class="o">);</span>
            <span class="o">}</span>
            
            <span class="nd">@Override</span>
            <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onNext</span><span class="o">(</span><span class="nc">Integer</span> <span class="n">i</span><span class="o">)</span> <span class="o">{</span>
                <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"onNext "</span> <span class="o">+</span> <span class="n">i</span><span class="o">);</span>
                <span class="n">counter</span><span class="o">++;</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">counter</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">==</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
                    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Requesting 2 emissions"</span><span class="o">);</span>
                    <span class="n">s</span><span class="o">.</span><span class="na">request</span><span class="o">(</span><span class="mi">2</span><span class="o">);</span>
                <span class="o">}</span>
            <span class="o">}</span>

            <span class="nd">@Override</span>
            <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onError</span><span class="o">(</span><span class="nc">Throwable</span> <span class="n">t</span><span class="o">)</span> <span class="o">{</span>
                <span class="nc">System</span><span class="o">.</span><span class="na">err</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"onError"</span><span class="o">);</span>
            <span class="o">}</span>

            <span class="nd">@Override</span>
            <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onComplete</span><span class="o">()</span> <span class="o">{</span>
                <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"onComplete"</span><span class="o">);</span>
            <span class="o">}</span>
    <span class="o">});</span>
<span class="o">}</span>
</code></pre></div></div>

<p>Run it and you will see that two values are emitted at a time as requested:</p>

<div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>onSubscribe
Requesting 2 emissions
onNext 1
onNext 2
Requesting 2 emissions
onNext 3
onNext 4
Requesting 2 emissions
onNext 5
onComplete
</code></pre></div></div>

<p>The Subscription also has a <code class="language-plaintext highlighter-rouge">cancel</code> method available to request the Publisher to stop the emission and clean up resources.</p>

<h2 id="7-cold-vs-hot-publishers">7. Cold vs Hot Publishers</h2>
<p>There are two types of Publishers available - cold and hot Publishers.
So far we have focused on the cold Publishers.
As we stated earlier, nothing happens until we subscribe - but this is actually only true for the cold Publishers.</p>

<p>A cold Publisher generates new data for each subscription. If there is no subscription, data never gets generated.
On the contrary, a hot Publisher does not depend on having Subscribers. It can start publishing data without any Subscribers. If a Subscriber subscribes after the Publisher has started emitting values, it will only receive the values emitted after its subscription.</p>

<p>Publishers in Reactor are cold by default.
One way of creating a hot Publisher is by calling the <code class="language-plaintext highlighter-rouge">publish()</code> method on a Flux. This will return a <code class="language-plaintext highlighter-rouge">ConnectableFlux&lt;T&gt;</code> which has a connect() method to trigger the emission of values. The Subscribers should then subscribe to this ConnectableFlux instead of the original Flux.</p>

<p>Let’s have a look at a simple cold vs hot Publisher to observe the different behavior. In the coldPublisherExample below, the interval operator is used to create a Flux that emits long values starting at 0.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Test</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">coldPublisherExample</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">InterruptedException</span> <span class="o">{</span>
    <span class="nc">Flux</span><span class="o">&lt;</span><span class="nc">Long</span><span class="o">&gt;</span> <span class="n">intervalFlux</span> <span class="o">=</span> <span class="nc">Flux</span><span class="o">.</span><span class="na">interval</span><span class="o">(</span><span class="nc">Duration</span><span class="o">.</span><span class="na">ofSeconds</span><span class="o">(</span><span class="mi">1</span><span class="o">));</span>
    <span class="nc">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="mi">2000</span><span class="o">);</span>
    <span class="n">intervalFlux</span><span class="o">.</span><span class="na">subscribe</span><span class="o">(</span><span class="n">i</span> <span class="o">-&gt;</span> <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="nc">String</span><span class="o">.</span><span class="na">format</span><span class="o">(</span><span class="s">"Subscriber A, value: %d"</span><span class="o">,</span> <span class="n">i</span><span class="o">)));</span>
    <span class="nc">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="mi">2000</span><span class="o">);</span>
    <span class="n">intervalFlux</span><span class="o">.</span><span class="na">subscribe</span><span class="o">(</span><span class="n">i</span> <span class="o">-&gt;</span> <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="nc">String</span><span class="o">.</span><span class="na">format</span><span class="o">(</span><span class="s">"Subscriber B, value: %d"</span><span class="o">,</span> <span class="n">i</span><span class="o">)));</span>
    <span class="nc">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="mi">3000</span><span class="o">);</span>
<span class="o">}</span>

</code></pre></div></div>

<p>Running this will generate the following output:</p>

<div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Subscriber A, value: 0
Subscriber A, value: 1
Subscriber A, value: 2
Subscriber B, value: 0
Subscriber A, value: 3
Subscriber B, value: 1
Subscriber A, value: 4
Subscriber B, value: 2
</code></pre></div></div>

<p>Now you might wonder why anything happens when the main thread is asleep, but that is because the interval operator by default runs on the Schedulers.parallel() Scheduler.
As you can see both Subscribers will get the values starting from 0.</p>

<p>Now let’s look at what happens when we use a ConnectableFlux:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Test</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">hotPublisherExample</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">InterruptedException</span> <span class="o">{</span>
    <span class="nc">Flux</span><span class="o">&lt;</span><span class="nc">Long</span><span class="o">&gt;</span> <span class="n">intervalFlux</span> <span class="o">=</span> <span class="nc">Flux</span><span class="o">.</span><span class="na">interval</span><span class="o">(</span><span class="nc">Duration</span><span class="o">.</span><span class="na">ofSeconds</span><span class="o">(</span><span class="mi">1</span><span class="o">));</span>
    <span class="nc">ConnectableFlux</span><span class="o">&lt;</span><span class="nc">Long</span><span class="o">&gt;</span> <span class="n">intervalCF</span> <span class="o">=</span> <span class="n">intervalFlux</span><span class="o">.</span><span class="na">publish</span><span class="o">();</span>
    <span class="n">intervalCF</span><span class="o">.</span><span class="na">connect</span><span class="o">();</span>
    <span class="nc">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="mi">2000</span><span class="o">);</span>
    <span class="n">intervalCF</span><span class="o">.</span><span class="na">subscribe</span><span class="o">(</span><span class="n">i</span> <span class="o">-&gt;</span> <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="nc">String</span><span class="o">.</span><span class="na">format</span><span class="o">(</span><span class="s">"Subscriber A, value: %d"</span><span class="o">,</span> <span class="n">i</span><span class="o">)));</span>
    <span class="nc">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="mi">2000</span><span class="o">);</span>
    <span class="n">intervalCF</span><span class="o">.</span><span class="na">subscribe</span><span class="o">(</span><span class="n">i</span> <span class="o">-&gt;</span> <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="nc">String</span><span class="o">.</span><span class="na">format</span><span class="o">(</span><span class="s">"Subscriber B, value: %d"</span><span class="o">,</span> <span class="n">i</span><span class="o">)));</span>
    <span class="nc">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="mi">3000</span><span class="o">);</span>
<span class="o">}</span>
</code></pre></div></div>
<p>This time we get the following output:</p>
<div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Subscriber A, value: 2
Subscriber A, value: 3
Subscriber A, value: 4
Subscriber B, value: 4
Subscriber A, value: 5
Subscriber B, value: 5
Subscriber A, value: 6
Subscriber B, value: 6
</code></pre></div></div>
<p>As we can see, this time none of the Subscribers get the initially emitted values 0 and 1.
They get the values that are emitted after they subscribe.
Instead of manually triggering the publishing it is also possible to configure the ConnectableFlux so that it starts after n subscriptions have been made, using the <code class="language-plaintext highlighter-rouge">autoConnect(n)</code> method.</p>

<h2 id="8-other-features">8. Other features</h2>

<h3 id="81-wrapping-a-synchronous-blocking-call">8.1 Wrapping a synchronous, blocking call</h3>
<p>When there is a need to use a source of information that is synchronous and blocking, the recommended pattern to use in Reactor is as follows:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">Mono</span> <span class="n">blockingWrapper</span> <span class="o">=</span> <span class="nc">Mono</span><span class="o">.</span><span class="na">fromCallable</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="o">{</span> 
    <span class="k">return</span> <span class="cm">/* make a remote synchronous call */</span> 
<span class="o">});</span>
<span class="n">blockingWrapper</span> <span class="o">=</span> <span class="n">blockingWrapper</span><span class="o">.</span><span class="na">subscribeOn</span><span class="o">(</span><span class="nc">Schedulers</span><span class="o">.</span><span class="na">boundedElastic</span><span class="o">());</span> 
</code></pre></div></div>

<p>The <code class="language-plaintext highlighter-rouge">fromCallable</code> method creates a Mono that produces its value using the provided Callable.
By using the Schedulers.boundedElastic() we ensure that each subscription happens on a dedicated single-threaded worker, not impacting other non-blocking processing.</p>

<h3 id="82-context">8.2 Context</h3>
<p>Sometimes there is a need to propagate some additional, usually more technical data, through a reactive pipeline. Compare this to associating some state with a thread using ThreadLocal in the imperative world.</p>

<p>Reactor has a feature that is somewhat comparable to ThreadLocal but can be applied to a Flux or a Mono instead of a Thread, called a <code class="language-plaintext highlighter-rouge">Context</code>.
This is an interface similar to a Map, where you can store key-value pairs and fetch a value by its key. The Context is transparently propagated throughout the whole reactive pipeline and can be easily accessed at any moment by calling the Mono.subscriberContext() method.</p>

<p>The context can be populated at subscription time by adding either the <code class="language-plaintext highlighter-rouge">subscriberContext(Function)</code> or the <code class="language-plaintext highlighter-rouge">subscriberContext(Context)</code> method invocation at the end of your reactive pipeline, as shown in the test method below.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Test</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">contextTest</span><span class="o">()</span> <span class="o">{</span>
    <span class="nc">String</span> <span class="n">key</span> <span class="o">=</span> <span class="s">"key"</span><span class="o">;</span>
    <span class="nc">Mono</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="n">mono</span> <span class="o">=</span> <span class="nc">Mono</span><span class="o">.</span><span class="na">just</span><span class="o">(</span><span class="s">"anything"</span><span class="o">)</span>
	    <span class="o">.</span><span class="na">flatMap</span><span class="o">(</span><span class="n">s</span> <span class="o">-&gt;</span> <span class="nc">Mono</span><span class="o">.</span><span class="na">subscriberContext</span><span class="o">()</span>
                <span class="o">.</span><span class="na">map</span><span class="o">(</span><span class="n">ctx</span> <span class="o">-&gt;</span> <span class="s">"Value stored in context: "</span> <span class="o">+</span> <span class="n">ctx</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">key</span><span class="o">)))</span>
            <span class="o">.</span><span class="na">subscriberContext</span><span class="o">(</span><span class="n">ctx</span> <span class="o">-&gt;</span> <span class="n">ctx</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">key</span><span class="o">,</span> <span class="s">"myValue"</span><span class="o">));</span>
    
    <span class="nc">StepVerifier</span><span class="o">.</span><span class="na">create</span><span class="o">(</span><span class="n">mono</span><span class="o">)</span>
        <span class="o">.</span><span class="na">expectNext</span><span class="o">(</span><span class="s">"Value stored in context: myValue"</span><span class="o">)</span>
        <span class="o">.</span><span class="na">verifyComplete</span><span class="o">();</span>
<span class="o">}</span>
</code></pre></div></div>

<h3 id="83-sinks">8.3 Sinks</h3>
<p>Rector also offers a possibility to create a Flux or a Mono by programmatically defining the onNext, onError, and onComplete events. 
To do this a so called sink API is exposed to trigger the events. Some different sink variants exist, to learn more about it read further in the reference documentation:
<a href="https://projectreactor.io/docs/core/release/reference/#producing">Programmatically creating a sequence</a></p>

<h3 id="84-debugging">8.4 Debugging</h3>
<p>Debugging reactive code could become a challenge because of its functional, declarative style where the actual declaration (or “assembly”) and signal processing (“execution”) do not happen at the same time.
The regular Java stack trace that is generated from a Reactor application will not include any references to the assembly code which makes it hard to identify what was the actual root cause of a propagated error.</p>

<p>To get a more meaningful stack trace, that includes the assembly information (also called a traceback), you can add a call to <code class="language-plaintext highlighter-rouge">Hooks.onOperatorDebug()</code> in your application.
This cannot be used in a production environment though, because it involves a heavy-weight stack walking and would have a negative impact on performance.</p>

<p>For use in production, Project Reactor provides a separate Java Agent that instruments your code and adds debugging info without paying the cost of capturing the stacktrace on every operator call.
To use it you need to add the <code class="language-plaintext highlighter-rouge">reactor-tools</code> artifact to your dependencies and initialize it at the startup of your Spring Boot application:</p>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
    <span class="nc">ReactorDebugAgent</span><span class="o">.</span><span class="na">init</span><span class="o">();</span>
    <span class="nc">SpringApplication</span><span class="o">.</span><span class="na">run</span><span class="o">(</span><span class="nc">Application</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">args</span><span class="o">);</span>
<span class="o">}</span>
</code></pre></div></div>
<h3 id="85-metrics">8.5 Metrics</h3>
<p>Reactor provides built-in support to enable and expose metrics both for Schedulers and Publishers. For more details, take a look at the <a href="https://projectreactor.io/docs/core/release/reference/#metrics">Metrics</a> section of the Reference guide.</p>

<h2 id="9-to-summarize">9. To summarize…</h2>
<p>This blog post provided an overview to Project Reactor, mainly focusing on Reactor Core features. The next blog post in this series will be about WebFlux - Spring’s reactive web framework which uses Reactor as its reactive library!</p>

<h2 id="references">References</h2>

<p><a href="https://projectreactor.io">Project Reactor</a></p>

<p><a href="https://docs.spring.io/spring/docs/current/spring-framework-reference/web-reactive.html#webflux">Spring Web Reactive Framework</a></p>

<p><a href="https://spring.io/blog/2019/03/28/reactor-debugging-experience">Reactor Debugging Experience</a></p>

<p><a href="https://spring.io/blog/2019/03/06/flight-of-the-flux-1-assembly-vs-subscription">Flight of the Flux 1 - Assembly vs Subscription</a></p>









            <div class="ce-blog-thanks">
              Tack för att du läser Callistas blogg. <br>
              Hjälp oss att nå ut med information genom att dela nyheter och artiklar i ditt nätverk.<br>
            </div>

            


    
<div class="ce-blog-share">
    <a class="ce-blog-share-element social-twitter" href="https://twitter.com/intent/tweet?text=Blog Series Reactive Programming Part 2&url=https://callistaenterprise.se/blogg/teknik/2020/09/12/blog-series-reactive-programming-part-2/&via=callistaent&hashtags=" target="_blank" title="Share this post on Twitter"></a>
    <a class="ce-blog-share-element social-facebook" href="https://www.facebook.com/sharer/sharer.php?t=Blog Series Reactive Programming Part 2&u=https://callistaenterprise.se/blogg/teknik/2020/09/12/blog-series-reactive-programming-part-2/" target="_blank" title="Share this post on Facebook"></a>
    <a class="ce-blog-share-element social-linkedin" href="http://www.linkedin.com/shareArticle?mini=true&title=Blog Series Reactive Programming Part 2&url=https://callistaenterprise.se/blogg/teknik/2020/09/12/blog-series-reactive-programming-part-2/&source=http%3a%2f%2fzhangwenli.com" target="_blank" title="Share this post on LinkedIn"></a>
</div>
    
        </article>
    </div>
</section>


<section class="ce-section">
    <heading>
        <h1>Kommentarer</h1>
    </heading>
    <div class="ce-content">
        <div id="disqus_thread"></div>
        <script src="../../../../../../js/disqus.js"></script>
    </div>
</section>


    </div>

    <footer class="ce-footer">
    <div class="ce-wrapper">
        <nav class="ce-menu-footer-primary">
            <h2><a href="../../../../../../index.html">Callista</a></h2>
            <ul>
                
                <li><a href="../../../../../../om/index.html">Om oss</a></li>
                
                <li><a href="../../../../../../erbjudanden.html">Erbjudanden</a></li>
                
                <li><a href="../../../../../../event.html">Event</a></li>
                
                <li><a href="../../../../../../blogg.html">Blogg</a></li>
                
                <li><a href="../../../../../../om/jobb/index.html">Jobba hos oss</a></li>
                

                
                    
                        <li><a href="../../../../../../english/index.html">English</a></li>
                    
                
            </ul>
        </nav>
        <div class="ce-addresses">
            <div class="ce-address">
                <h2>Stockholm</h2>
                <address>
                    Drottninggatan 55<br>
                    111 21 Stockholm<br>
                    Tel:
                    <a href="tel:+468212142">
                        +46 8 21 21 42
                    </a>
                </address>
            </div>
            <div class="ce-address">
                <h2>Göteborg</h2>
                <address>
                    Fabriksgatan 13<br>
                    412 50 Göteborg<br>
                    Tel:
                    <a href="tel:+4631201918">
                        +46 31 20 19 18
                    </a>
                </address>
            </div>
        </div>
        <div class="ce-social">
            <h2>Följ oss</h2>
            <ul>
                <li>
                    <a href="http://twitter.com/callistaent">
                        <img alt="Twitters logotype" src="../../../../../../images/icons/twitter.png">
                        <span>@callistaent</span>
                    </a>
                </li>
            </ul>
        </div>
        <small>&copy; 2021 Callista Enterprise AB</small>
        <hr style="margin: 1em 0 2em 0">
        <div class="ce-footer-images">
          <div class="ce-footer-image">
            <a class="ce-raddabarnen" href="http://www.raddabarnen.se/foretag">
                <img alt="Callista är Rädda Barnens företagsvän 2021" src="../../../../../../images/logotype/rb_vanforetag_2021_large-sv.png">
            </a>
          </div>
        </div>
        <br>
        <div class="ce-footer-images">
          <div class="ce-footer-image">
            <a class="ce-di-gasell" href="http://www.di.se/gasell/">
              <img alt="Callista utsett till DI Gasell tre år i rad" src="../../../../../../images/logotype/di_gasell_180x194.png">
            </a>
          </div>
        </div>
    </div>
</footer>


    <script src="../../../../../../js/lib/jquery.min.js"></script>
    <script src="../../../../../../js/lib/owl.carousel.min.js"></script>
    <script src="../../../../../../js/lib/prismjs.min.js"></script>
    <script src="../../../../../../js/app.js"></script>
    <script src="../../../../../../js/analytics.js"></script>
    <script src="../../../../../../js/jobinterestsubmit.js"></script>

</body>
</html>
