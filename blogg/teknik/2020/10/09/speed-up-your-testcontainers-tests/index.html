<!DOCTYPE html>
<html lang="sv-se">
<head>
    <meta charset="utf-8">

    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="description" content="Callista Enterprise - seniora IT-arkitekter och systemutvecklare inom Java, öppen källkod, agil utveckling och systemintegration">
    <!--<meta name="viewport" content="width=device-width, initial-scale=1">-->
    <meta name="viewport" content="initial-scale=1.0001, minimum-scale=1.0001, maximum-scale=1.0001, user-scalable=no"/>

    <link rel="icon" href="../../../../../../images/icons/callista_favicon.svg" type="image/x-icon" />
    <link rel="shortcut icon" href="../../../../../../images/icons/callista_favicon.svg" type="image/x-icon" />
    <link rel="apple-touch-icon" href="../../../../../../images/icons/callista_favicon_160x160.png">

    <title>Speed-up your Testcontainers tests | Callista</title>

    <link rel="stylesheet" href="../../../../../../css/style.css%3Fv=1.css">
    <link rel="alternate" type="application/rss+xml" title="RSS Feed for callistaenterprise.se" href="../../../../../../feed.xml" />

    <!--[if lte IE 8]>
    <style>* { display: none !important; }</style>
    <meta http-equiv="refresh" content="0; url=/oldie/"/>
    <![endif]-->

    <script type="text/javascript" src="https://use.typekit.net/kig5egm.js"></script>
    <script type="text/javascript">
        try {
            Typekit.load({ async: true });
        } catch (e) {
        }
    </script>

    <!-- Facebook Pixel Code -->
    <script>
    !function(f,b,e,v,n,t,s)
    {if(f.fbq)return;n=f.fbq=function(){n.callMethod?
    n.callMethod.apply(n,arguments):n.queue.push(arguments)};
    if(!f._fbq)f._fbq=n;n.push=n;n.loaded=!0;n.version='2.0';
    n.queue=[];t=b.createElement(e);t.async=!0;
    t.src=v;s=b.getElementsByTagName(e)[0];
    s.parentNode.insertBefore(t,s)}(window,document,'script',
    'https://connect.facebook.net/en_US/fbevents.js');
     fbq('init', '804675599711872');
     fbq('track', 'PageView');
    </script>
    <noscript>
     <img height="1" width="1" src="https://www.facebook.com/tr?id=804675599711872&ev=PageView&noscript=1"/>
    </noscript>
    <!-- End Facebook Pixel Code -->

</head>
<body>

    <header class="ce-header" data-scroll="0">
    <nav>
        <img alt="menubg" class="ce-menu-icon" style="z-index:3; top: 0px; width: 50px; height: 100%;" src="../../../../../../images/icons/menu_background.png">
        <a class="ce-logotype" href="../../../../../../index.html" style="z-index: 2;">
            <img alt="Callista" style="max-width: 100%; height: auto;" src="../../../../../../images/logotype/callista_small2.svg">
        </a>
        <table>
            <tr>
                <td>
            <ul id="menu-primary" class="ce-menu-primary">
                
                    
                            <li><a href="../../../../../../om/index.html">Om oss</a></li>
                    
                
                    
                            <li><a href="../../../../../../erbjudanden.html">Erbjudanden</a></li>
                    
                
                    
                            <li><a href="../../../../../../event.html">Event</a></li>
                    
                
                    
                        
                            <li><a class="ce-active" href="../../../../../../blogg.html">Blogg</a></li>
                        
                    
                
                    
                            <li><a href="../../../../../../om/jobb/index.html">Jobba hos oss</a></li>
                    
                
            </ul>
                </td>

                <td>
            <ul class="ce-menu-secondary">
                
                <li><a href="../../../../../../english/index.html">English</a></li>
                
            </ul>
                </td>
            </tr>
        </table>
            <a id="menu" class="ce-menu-icon" href="index.html#" style="z-index: 4;">
                <img alt="Visa meny" src="../../../../../../images/icons/menu.png">
            </a>
            <a class="ce-search-icon" href="index.html#">
                <img alt="Sök" src="../../../../../../images/icons/search.png">
            </a>

        </table>
    </nav>
</header>


    <div class="ce-main">
        <section class="ce-start lazyImg">
    <article>
        <h1>Blogg</h1>
        <p class="ce-ingress">
            Här finns tekniska artiklar, presentationer och nyheter om arkitektur och systemutveckling. Håll dig uppdaterad, följ oss på <a class="ce-active" href="http://twitter.com/callistaent">Twitter</a>
        </p>
    </article>
</section>

<section class="ce-section">
    <div class="ce-content">
        
        

        
        

        <article class="ce-blog">
            <header>
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    <img alt="Callista medarbetare Peter Merikan" src="../../../../../../assets/medarbetare/petermerikan_mini.png">
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    <h2>
        <a href="index.html">Speed-up your Testcontainers tests</a>
        
        
    </h2>
    <h3>
        <time datetime="2020-10-09T00:00:00+00:00">
            09 October 2020
        </time>
        //
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        

        
        
        <a href="../../../../../../om/medarbetare/petermerikan/index.html">Peter Merikan</a>
        

        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
    </h3>
    
</header>




<p>This is the second part of a two part series about <a href="https://www.testcontainers.org/">Testcontainers</a>. In this part I will among other things show you some tricks to get your Testcontainers start much faster.</p>

<p></p>

<ul class="no_toc" id="markdown-toc">
  <li><a href="index.html#intro" id="markdown-toc-intro">Intro</a>    <ul>
      <li><a href="index.html#source-code" id="markdown-toc-source-code">Source code</a></li>
    </ul>
  </li>
  <li><a href="index.html#use-the-singleton-pattern" id="markdown-toc-use-the-singleton-pattern">Use the singleton pattern</a></li>
  <li><a href="index.html#speed-up-start-time-with-multiple-containers" id="markdown-toc-speed-up-start-time-with-multiple-containers">Speed-up start time with multiple containers</a></li>
  <li><a href="index.html#reuse-your-testcontainers" id="markdown-toc-reuse-your-testcontainers">Reuse your Testcontainers</a></li>
  <li><a href="index.html#runing-tests-in-a-docker-container" id="markdown-toc-runing-tests-in-a-docker-container">Runing tests in a docker container</a></li>
  <li><a href="index.html#summary" id="markdown-toc-summary">Summary</a>    <ul>
      <li><a href="index.html#resources" id="markdown-toc-resources">Resources</a></li>
    </ul>
  </li>
</ul>

<h1 id="intro">Intro</h1>
<p>In the previous blog post, <a href="../../08/getting-started-with-testcontainers/index.html">Getting Started with Testcontainers</a>, I described what the <a href="https://www.testcontainers.org/">Testcontainers</a> framework is and how to get started using it in your project. After using Testcontainers for a long time I learned that there are things that need to be adjusted to make it even better and faster. Below I will show some of the things that make a fantastic framework even better.</p>

<h2 id="source-code">Source code</h2>
<p>The full source code for my example project can be found here: <a href="https://github.com/merikan/testcontainers-demo">https://github.com/merikan/testcontainers-demo)</a> and the folder <code class="language-plaintext highlighter-rouge">faster</code>.</p>

<h1 id="use-the-singleton-pattern">Use the singleton pattern</h1>

<p>I described this in my <a href="https://callistaenterprise.se/blogg/teknik/2020/10/06/getting-started-with-testcontainers/">previous blog post</a> but it is well worth repeating. There may sometimes be a reason to use the <code class="language-plaintext highlighter-rouge">@Container</code> annotation to declare Testcontainers in our integration test classes. The disadvantage of this is that our Testcontainers will start and stop between each test class that is run, which can take a very long time. We can instead use the singleton pattern to make our Testcontainers start only once for all our test classes, and then be taken down when they are finished.</p>

<p>Keep in mind that you have to deal with any side effects caused by multiple tests using the same resource. For example, by making your tests unaffected by the state of the resource or by setting the resource in the desired state for each test.</p>

<p>To use the singleton pattern we can create an abstract class that handles the creation of Testcontainers.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@SpringBootTest</span><span class="o">(</span><span class="n">webEnvironment</span> <span class="o">=</span> <span class="no">RANDOM_PORT</span><span class="o">)</span>
<span class="nd">@ActiveProfiles</span><span class="o">(</span><span class="s">"integrationtest"</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">abstract</span> <span class="kd">class</span> <span class="nc">AbstractIntegrationTest</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">DockerImageName</span> <span class="no">MARIADB_IMAGE</span> <span class="o">=</span> <span class="nc">DockerImageName</span><span class="o">.</span><span class="na">parse</span><span class="o">(</span><span class="s">"mariadb:10.5.5"</span><span class="o">);</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">MariaDBContainer</span> <span class="n">mariadb</span><span class="o">;</span>

    <span class="kd">static</span> <span class="o">{</span>
        <span class="n">mariadb</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">MariaDBContainer</span><span class="o">&lt;&gt;(</span><span class="no">MARIADB_IMAGE</span><span class="o">)</span>
            <span class="o">.</span><span class="na">withCommand</span><span class="o">(</span><span class="s">"--character-set-server=utf8mb4"</span><span class="o">,</span> <span class="s">"--collation-server=utf8mb4_unicode_ci"</span><span class="o">);</span>
        <span class="n">mariadb</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="nd">@DynamicPropertySource</span>
    <span class="kd">static</span> <span class="kt">void</span> <span class="nf">properties</span><span class="o">(</span><span class="nc">DynamicPropertyRegistry</span> <span class="n">registry</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">registry</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="s">"spring.datasource.url"</span><span class="o">,</span> <span class="nl">mariadb:</span><span class="o">:</span><span class="n">getJdbcUrl</span><span class="o">);</span>
        <span class="n">registry</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="s">"spring.datasource.username"</span><span class="o">,</span> <span class="nl">mariadb:</span><span class="o">:</span><span class="n">getUsername</span><span class="o">);</span>
        <span class="n">registry</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="s">"spring.datasource.password"</span><span class="o">,</span> <span class="nl">mariadb:</span><span class="o">:</span><span class="n">getPassword</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>Each integration test class should then inherit from this abstract class to make use of Testcontainers.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">TodoServiceImplIT</span> <span class="kd">extends</span> <span class="nc">AbstractIntegrationTest</span> <span class="o">{</span>

    <span class="nd">@Autowired</span>
    <span class="kd">private</span> <span class="nc">TodoService</span> <span class="n">uut</span><span class="o">;</span>

    <span class="nd">@Autowired</span>
    <span class="kd">private</span> <span class="nc">TodoRepository</span> <span class="n">repository</span><span class="o">;</span>

    <span class="nd">@BeforeEach</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setUp</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
        <span class="n">repository</span><span class="o">.</span><span class="na">deleteAll</span><span class="o">();</span>
    <span class="o">}</span>
</code></pre></div></div>

<p>If we now run our tests, we will see that our Testcontainer is only started once, which means that we shorten the time to run our test suites significantly.</p>

<h1 id="speed-up-start-time-with-multiple-containers">Speed-up start time with multiple containers</h1>

<p>In my current projects I have multiple containers in my test suites and it will take some time to start, even if it’s only done once. But with some small changes we can reduce the startup time.</p>

<p>Let us first create an example where we start several Testcontainers and then make some changes to see if we can reduce the startup time. In order not to get misleading results, we need to run it once first to ensure that all images are pulled down and available locally. To keep the example clean and clear I am not using any properties from our started containers.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">static</span> <span class="o">{</span>
    <span class="nc">Instant</span> <span class="n">start</span> <span class="o">=</span> <span class="nc">Instant</span><span class="o">.</span><span class="na">now</span><span class="o">();</span>

    <span class="n">mariadb1</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">MariaDBContainer</span><span class="o">&lt;&gt;(</span><span class="no">MARIADB_IMAGE</span><span class="o">)</span>
        <span class="o">.</span><span class="na">withCommand</span><span class="o">(</span><span class="s">"--character-set-server=utf8mb4"</span><span class="o">,</span> <span class="s">"--collation-server=utf8mb4_unicode_ci"</span><span class="o">);</span>
    <span class="n">mariadb1</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
    <span class="n">mariadb2</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">MariaDBContainer</span><span class="o">&lt;&gt;(</span><span class="no">MARIADB_IMAGE</span><span class="o">)</span>
        <span class="o">.</span><span class="na">withCommand</span><span class="o">(</span><span class="s">"--character-set-server=utf8mb4"</span><span class="o">,</span> <span class="s">"--collation-server=utf8mb4_unicode_ci"</span><span class="o">);</span>
    <span class="n">mariadb2</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
    <span class="n">redis</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">GenericContainer</span><span class="o">&lt;&gt;(</span><span class="no">REDIS_IMAGE</span><span class="o">).</span><span class="na">withExposedPorts</span><span class="o">(</span><span class="mi">6379</span><span class="o">);</span>
    <span class="n">redis</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
    <span class="n">kafka</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">KafkaContainer</span><span class="o">(</span><span class="no">KAFKA_IMAGE</span><span class="o">);</span>
    <span class="n">kafka</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
    <span class="n">sftp</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">GenericContainer</span><span class="o">&lt;&gt;(</span><span class="no">SFTP_IMAGE</span><span class="o">)</span>
        <span class="o">.</span><span class="na">withCommand</span><span class="o">(</span><span class="nc">String</span><span class="o">.</span><span class="na">format</span><span class="o">(</span><span class="s">"%s:%s:::upload"</span><span class="o">,</span> <span class="s">"SFTP_USER"</span><span class="o">,</span> <span class="s">"SFTP_PASSWORD"</span><span class="o">));</span>
    <span class="n">sftp</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>

    <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">"🐳 TestContainers started in {}"</span><span class="o">,</span> <span class="nc">Duration</span><span class="o">.</span><span class="na">between</span><span class="o">(</span><span class="n">start</span><span class="o">,</span> <span class="nc">Instant</span><span class="o">.</span><span class="na">now</span><span class="o">()));</span>
    
<span class="o">}</span>
</code></pre></div></div>

<p>If we now run one test we can see that that it takes a little less than 30 seconds to start all five Testcontainers.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code> 🐳 TestContainers started in PT29.836S 
</code></pre></div></div>
<p>Ok, time to make some changes. As we can see in  the code above we are starting our testcontainers sequentially, what if we could start them in parallel instead? Let’s try that. 
We can use the Stream class for this and it will look like this.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">static</span> <span class="o">{</span>
    <span class="nc">Instant</span> <span class="n">start</span> <span class="o">=</span> <span class="nc">Instant</span><span class="o">.</span><span class="na">now</span><span class="o">();</span>

    <span class="n">mariadb1</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">MariaDBContainer</span><span class="o">&lt;&gt;(</span><span class="no">MARIADB_IMAGE</span><span class="o">)</span>
        <span class="o">.</span><span class="na">withCommand</span><span class="o">(</span><span class="s">"--character-set-server=utf8mb4"</span><span class="o">,</span> <span class="s">"--collation-server=utf8mb4_unicode_ci"</span><span class="o">);</span>
    <span class="n">mariadb2</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">MariaDBContainer</span><span class="o">&lt;&gt;(</span><span class="no">MARIADB_IMAGE</span><span class="o">)</span>
        <span class="o">.</span><span class="na">withCommand</span><span class="o">(</span><span class="s">"--character-set-server=utf8mb4"</span><span class="o">,</span> <span class="s">"--collation-server=utf8mb4_unicode_ci"</span><span class="o">);</span>
    <span class="n">redis</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">GenericContainer</span><span class="o">&lt;&gt;(</span><span class="no">REDIS_IMAGE</span><span class="o">).</span><span class="na">withExposedPorts</span><span class="o">(</span><span class="mi">6379</span><span class="o">);</span>
    <span class="n">kafka</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">KafkaContainer</span><span class="o">(</span><span class="no">KAFKA_IMAGE</span><span class="o">);</span>
    <span class="n">sftp</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">GenericContainer</span><span class="o">&lt;&gt;(</span><span class="no">SFTP_IMAGE</span><span class="o">)</span>
        <span class="o">.</span><span class="na">withCommand</span><span class="o">(</span><span class="nc">String</span><span class="o">.</span><span class="na">format</span><span class="o">(</span><span class="s">"%s:%s:::upload"</span><span class="o">,</span> <span class="s">"SFTP_USER"</span><span class="o">,</span> <span class="s">"SFTP_PASSWORD"</span><span class="o">));</span>
    <span class="nc">Stream</span><span class="o">.</span><span class="na">of</span><span class="o">(</span><span class="n">mariadb1</span><span class="o">,</span> <span class="n">mariadb2</span><span class="o">,</span> <span class="n">redis</span><span class="o">,</span> <span class="n">kafka</span><span class="o">,</span> <span class="n">sftp</span><span class="o">).</span><span class="na">parallel</span><span class="o">().</span><span class="na">forEach</span><span class="o">(</span><span class="nl">GenericContainer:</span><span class="o">:</span><span class="n">start</span><span class="o">);</span>

    <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">"🐳 TestContainers started in {}"</span><span class="o">,</span> <span class="nc">Duration</span><span class="o">.</span><span class="na">between</span><span class="o">(</span><span class="n">start</span><span class="o">,</span> <span class="nc">Instant</span><span class="o">.</span><span class="na">now</span><span class="o">()));</span>
<span class="o">}</span>
</code></pre></div></div>

<p>If we now run our test again we can see that it takes a little less than 12 seconds to start all five Testcontainers.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code> 🐳 TestContainers started in PT11.606S
</code></pre></div></div>
<p>So we saved 18 seconds in startup time, it wasn’t that bad, was it? Is there anything else we can do to make our tests faster? Yes there is, just keep reading and you will see yet another way.</p>

<h1 id="reuse-your-testcontainers">Reuse your Testcontainers</h1>

<p>One thing that repeatedly slows me down is when I work with one test and want to run it several times. It can take a long time and I want a fast feedback loop. So let’s dig deeper and see how we can solve that.</p>

<p>Testcontainers comes with a <a href="https://github.com/testcontainers/testcontainers-java/pull/1781">preview feature</a> that enables us to reuse an already started Testcontainer. In short, this means that Ryuk (the clean-up mechanism that is responsible for shutting down Testcontainers after a test run) will not be started, which in turn means that our Testcontainers will not be taken down after our tests are completed. This feature can really save time during the development process! All you have to remember is to manually stop all Testcontainers when you are done.</p>

<p>We have to do two things to enable this reuse. First we have to tell our Testcontainer that it should be reused,  using the <code class="language-plaintext highlighter-rouge">.withReuse(true)</code> method. Next we have to create a configuration file for Testcontainers (<code class="language-plaintext highlighter-rouge">~/.testcontainers.properties</code>) in our home directory and add the property <code class="language-plaintext highlighter-rouge">testcontainers.reuse.enable=true</code>. At the time of writing you can only have this property file in your home directory and not in the classpath, per project. But on the other hand, you probably do not want to impose such behavior on your team members or other environments, such as your CI / CD pipeline. This should definitely be optional and if it becomes possible to add it per project ,you should add it to <code class="language-plaintext highlighter-rouge">.gitignore</code> to prevent it from being propagated to your collegues and to the CI / CD pipeline.</p>

<p>This is how our abstract class will look like when enabling <code class="language-plaintext highlighter-rouge">reuse</code>:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">static</span> <span class="o">{</span>
    <span class="nc">Instant</span> <span class="n">start</span> <span class="o">=</span> <span class="nc">Instant</span><span class="o">.</span><span class="na">now</span><span class="o">();</span>

    <span class="n">mariadb1</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">MariaDBContainer</span><span class="o">&lt;&gt;(</span><span class="no">MARIADB_IMAGE</span><span class="o">)</span>
        <span class="o">.</span><span class="na">withCommand</span><span class="o">(</span><span class="s">"--character-set-server=utf8mb4"</span><span class="o">,</span> <span class="s">"--collation-server=utf8mb4_unicode_ci"</span><span class="o">)</span>
        <span class="o">.</span><span class="na">withReuse</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
    <span class="n">mariadb2</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">MariaDBContainer</span><span class="o">&lt;&gt;(</span><span class="no">MARIADB_IMAGE</span><span class="o">)</span>
        <span class="o">.</span><span class="na">withCommand</span><span class="o">(</span><span class="s">"--character-set-server=utf8mb4"</span><span class="o">,</span> <span class="s">"--collation-server=utf8mb4_unicode_ci"</span><span class="o">)</span>
        <span class="o">.</span><span class="na">withReuse</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
    <span class="n">redis</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">GenericContainer</span><span class="o">&lt;&gt;(</span><span class="no">REDIS_IMAGE</span><span class="o">)</span>
        <span class="o">.</span><span class="na">withExposedPorts</span><span class="o">(</span><span class="mi">6379</span><span class="o">)</span>
        <span class="o">.</span><span class="na">withReuse</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
    <span class="n">kafka</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">KafkaContainer</span><span class="o">(</span><span class="no">KAFKA_IMAGE</span><span class="o">)</span>
        <span class="o">.</span><span class="na">withReuse</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
    <span class="n">sftp</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">GenericContainer</span><span class="o">&lt;&gt;(</span><span class="no">SFTP_IMAGE</span><span class="o">)</span>
        <span class="o">.</span><span class="na">withCommand</span><span class="o">(</span><span class="nc">String</span><span class="o">.</span><span class="na">format</span><span class="o">(</span><span class="s">"%s:%s:::upload"</span><span class="o">,</span> <span class="s">"SFTP_USER"</span><span class="o">,</span> <span class="s">"SFTP_PASSWORD"</span><span class="o">))</span>
        <span class="o">.</span><span class="na">withReuse</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
    <span class="nc">Stream</span><span class="o">.</span><span class="na">of</span><span class="o">(</span><span class="n">mariadb1</span><span class="o">,</span> <span class="n">mariadb2</span><span class="o">,</span> <span class="n">redis</span><span class="o">,</span> <span class="n">kafka</span><span class="o">,</span> <span class="n">sftp</span><span class="o">).</span><span class="na">parallel</span><span class="o">().</span><span class="na">forEach</span><span class="o">(</span><span class="nl">GenericContainer:</span><span class="o">:</span><span class="n">start</span><span class="o">);</span>

    <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">"🐳 TestContainers started in {}"</span><span class="o">,</span> <span class="nc">Duration</span><span class="o">.</span><span class="na">between</span><span class="o">(</span><span class="n">start</span><span class="o">,</span> <span class="nc">Instant</span><span class="o">.</span><span class="na">now</span><span class="o">()));</span>
<span class="o">}</span>
</code></pre></div></div>

<p>One <a href="https://github.com/testcontainers/testcontainers-java/issues/2961">problem</a> that you probably will encounter is that the Testcontainer is not unique to this particular project. Since I have several Testcontainers with the same configuration in several projects, this posed a real problem for me. So let’s fix this.</p>

<p>If we take a look at the <a href="https://github.com/testcontainers/testcontainers-java/blob/17b4f6c136f6f2c7dc223bad407221f62a8f0088/core/src/main/java/org/testcontainers/containers/GenericContainer.java#L364-L412">source code</a>, the uniqueness of the started Testcontainer is calculated based on the actual configuration. Testcontainers will then search for the hash among all current running containers with label <code class="language-plaintext highlighter-rouge">org.testcontainers.hash</code> to see if a match is found, and if so reuse this container. An easy solution to this problem is to add something to the configuration that makes this particular container unique. I have chosen to add my own label with the name <code class="language-plaintext highlighter-rouge">reuse.UUID</code> with a <a href="https://www.uuidgenerator.net/">unique UUID</a> as the value.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">.</span><span class="na">withLabel</span><span class="o">(</span><span class="s">"reuse.UUID"</span><span class="o">,</span> <span class="s">"e06d7a87-7d7d-472e-a047-e6c81f61d2a4"</span><span class="o">);</span>
</code></pre></div></div>

<p>This is what it looks like in the abstract class when we activate reuse with a unique id to our Testcontainers.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">static</span> <span class="o">{</span>
    <span class="nc">Instant</span> <span class="n">start</span> <span class="o">=</span> <span class="nc">Instant</span><span class="o">.</span><span class="na">now</span><span class="o">();</span>

    <span class="n">mariadb1</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">MariaDBContainer</span><span class="o">&lt;&gt;(</span><span class="no">MARIADB_IMAGE</span><span class="o">)</span>
        <span class="o">.</span><span class="na">withCommand</span><span class="o">(</span><span class="s">"--character-set-server=utf8mb4"</span><span class="o">,</span> <span class="s">"--collation-server=utf8mb4_unicode_ci"</span><span class="o">)</span>
        <span class="o">.</span><span class="na">withReuse</span><span class="o">(</span><span class="kc">true</span><span class="o">)</span>
        <span class="o">.</span><span class="na">withLabel</span><span class="o">(</span><span class="s">"reuse.UUID"</span><span class="o">,</span> <span class="s">"e06d7a87-7d7d-472e-a047-e6c81f61d2a4"</span><span class="o">);</span>
    <span class="n">mariadb2</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">MariaDBContainer</span><span class="o">&lt;&gt;(</span><span class="no">MARIADB_IMAGE</span><span class="o">)</span>
        <span class="o">.</span><span class="na">withCommand</span><span class="o">(</span><span class="s">"--character-set-server=utf8mb4"</span><span class="o">,</span> <span class="s">"--collation-server=utf8mb4_unicode_ci"</span><span class="o">)</span>
        <span class="o">.</span><span class="na">withReuse</span><span class="o">(</span><span class="kc">true</span><span class="o">)</span>
        <span class="o">.</span><span class="na">withLabel</span><span class="o">(</span><span class="s">"reuse.UUID"</span><span class="o">,</span> <span class="s">"282b8993-097c-4fd4-98f1-94daf3466dd6"</span><span class="o">);</span>
    <span class="n">redis</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">GenericContainer</span><span class="o">&lt;&gt;(</span><span class="no">REDIS_IMAGE</span><span class="o">)</span>
        <span class="o">.</span><span class="na">withExposedPorts</span><span class="o">(</span><span class="mi">6379</span><span class="o">)</span>
        <span class="o">.</span><span class="na">withReuse</span><span class="o">(</span><span class="kc">true</span><span class="o">)</span>
        <span class="o">.</span><span class="na">withLabel</span><span class="o">(</span><span class="s">"reuse.UUID"</span><span class="o">,</span> <span class="s">"0429783b-c855-4b32-8239-258cba232b63"</span><span class="o">);</span>
    <span class="n">kafka</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">KafkaContainer</span><span class="o">(</span><span class="no">KAFKA_IMAGE</span><span class="o">)</span>
        <span class="o">.</span><span class="na">withReuse</span><span class="o">(</span><span class="kc">true</span><span class="o">)</span>
        <span class="o">.</span><span class="na">withLabel</span><span class="o">(</span><span class="s">"reuse.UUID"</span><span class="o">,</span> <span class="s">"f8724ec0-2f66-4684-80cd-1b24a7399366"</span><span class="o">);</span>
    <span class="n">sftp</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">GenericContainer</span><span class="o">&lt;&gt;(</span><span class="no">SFTP_IMAGE</span><span class="o">)</span>
        <span class="o">.</span><span class="na">withCommand</span><span class="o">(</span><span class="nc">String</span><span class="o">.</span><span class="na">format</span><span class="o">(</span><span class="s">"%s:%s:::upload"</span><span class="o">,</span> <span class="s">"SFTP_USER"</span><span class="o">,</span> <span class="s">"SFTP_PASSWORD"</span><span class="o">))</span>
        <span class="o">.</span><span class="na">withReuse</span><span class="o">(</span><span class="kc">true</span><span class="o">)</span>
        <span class="o">.</span><span class="na">withLabel</span><span class="o">(</span><span class="s">"reuse.UUID"</span><span class="o">,</span> <span class="s">"0293a405-e435-4f03-9e4b-b6160d9e60fe"</span><span class="o">);</span>
    <span class="nc">Stream</span><span class="o">.</span><span class="na">of</span><span class="o">(</span><span class="n">mariadb1</span><span class="o">,</span> <span class="n">mariadb2</span><span class="o">,</span> <span class="n">redis</span><span class="o">,</span> <span class="n">kafka</span><span class="o">,</span> <span class="n">sftp</span><span class="o">).</span><span class="na">parallel</span><span class="o">().</span><span class="na">forEach</span><span class="o">(</span><span class="nl">GenericContainer:</span><span class="o">:</span><span class="n">start</span><span class="o">);</span>

    <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">"🐳 TestContainers started in {}"</span><span class="o">,</span> <span class="nc">Duration</span><span class="o">.</span><span class="na">between</span><span class="o">(</span><span class="n">start</span><span class="o">,</span> <span class="nc">Instant</span><span class="o">.</span><span class="na">now</span><span class="o">()));</span>
<span class="o">}</span>
</code></pre></div></div>

<p>If we start our test again, it took about 11 seconds to start our containers the first time, our Testcontainers will now be reused and this time it will only take about 1 second. That’s not bad, is it?</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code> 🐳 TestContainers started in PT1.796S
</code></pre></div></div>

<p>This is really a performance boost to get faster feedback when running our tests. And now all we have to do, when we are done testing, is to stop our running Testcontainers.</p>

<p>To list all running Testcontainers:</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>docker ps <span class="nt">--filter</span> <span class="nv">label</span><span class="o">=</span>org.testcontainers
CONTAINER ID        IMAGE                         COMMAND                  CREATED             STATUS              PORTS                                                                       NAMES
e1ccf87be0f2        mariadb:10.5.5                <span class="s2">"docker-entrypoint.s…"</span>   3 minutes ago       Up 3 minutes        0.0.0.0:32969-&gt;3306/tcp                                                     adoring_pascal
bed6d13ccf33        atmoz/sftp                    <span class="s2">"/entrypoint SFTP_US…"</span>   3 minutes ago       Up 3 minutes        0.0.0.0:32967-&gt;22/tcp                                                       serene_driscoll
4732e1e5144b        confluentinc/cp-kafka:5.2.1   <span class="s2">"sh -c 'while [ ! -f…"</span>   3 minutes ago       Up 3 minutes        0.0.0.0:32968-&gt;2181/tcp, 0.0.0.0:32966-&gt;9092/tcp, 0.0.0.0:32965-&gt;9093/tcp   tender_wright
dae6f7e12707        redis:5.0.5                   <span class="s2">"docker-entrypoint.s…"</span>   3 minutes ago       Up 3 minutes        0.0.0.0:32964-&gt;6379/tcp                                                     epic_goldberg
58442bb5df71        mariadb:10.5.5                <span class="s2">"docker-entrypoint.s…"</span>   3 minutes ago       Up 3 minutes        0.0.0.0:32970-&gt;3306/tcp                                                     heuristic_varahamihira
</code></pre></div></div>
<p>and to stop all running Testcontainers:</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span> docker stop <span class="si">$(</span>docker ps <span class="nt">-q</span> <span class="nt">--filter</span> <span class="nv">label</span><span class="o">=</span>org.testcontainers<span class="si">)</span>
e1ccf87be0f2
bed6d13ccf33
4732e1e5144b
dae6f7e12707
58442bb5df71
</code></pre></div></div>

<h1 id="runing-tests-in-a-docker-container">Runing tests in a docker container</h1>

<p>One question that often comes up is this: If my tests now use docker containers, can the tests themselves run in a docker container? Yes they can, it is called <a href="https://jpetazzo.github.io/2015/09/03/do-not-use-docker-in-docker-for-ci/">Docker in Docker</a> aka. DinD. With docker in docker, there will be new challenges such as privileged mode etc., but that’s not something I intend to address here.</p>

<p>To run your tests locally in a docker container.</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>git clone https://github.com/merikan/testcontainers-demo.git
<span class="nv">$ </span><span class="nb">cd </span>testcontainers-demo/faster
faster <span class="nv">$ </span> docker run <span class="nt">-it</span> <span class="nt">--rm</span> <span class="nt">-v</span> <span class="nv">$PWD</span>:<span class="nv">$PWD</span> <span class="nt">-w</span> <span class="nv">$PWD</span> <span class="nt">-v</span> /var/run/docker.sock:/var/run/docker.sock maven:3 ./mvnw clean <span class="nb">test </span>verify
</code></pre></div></div>

<p>You  can read more about Testcontainers and Docker in Docker <a href="https://www.testcontainers.org/supported_docker_environment/continuous_integration/dind_patterns">here</a></p>

<h1 id="summary">Summary</h1>
<p>In this blog post I have showed you some ways to drastically reduce the time to run your tests using Testcontainers.</p>

<p>And finally;<br />
I’m just a human being, if you find any ambiguities, typos, errors or possible improvement, please let me know.<br />
If you like this blog post, please add a comment and feel free to share this blog post using your favorite social media platform! There should be a few icons below to get you started.</p>

<p>Until next time, keep coding and never stop learning new things!</p>

<h2 id="resources">Resources</h2>
<ul>
  <li>Testcontainers <a href="https://www.testcontainers.org/">home page</a>  and source code for the <a href="https://github.com/testcontainers/testcontainers-java/">Java project</a></li>
  <li>The full source code for my example project can be found here: <a href="https://github.com/merikan/testcontainers-demo">https://github.com/merikan/testcontainers-demo)</a> and the folder <code class="language-plaintext highlighter-rouge">faster</code>.</li>
</ul>









            <div class="ce-blog-thanks">
              Tack för att du läser Callistas blogg. <br>
              Hjälp oss att nå ut med information genom att dela nyheter och artiklar i ditt nätverk.<br>
            </div>

            


    
<div class="ce-blog-share">
    <a class="ce-blog-share-element social-twitter" href="https://twitter.com/intent/tweet?text=Speed Up Your Testcontainers Tests&url=https://callistaenterprise.se/blogg/teknik/2020/10/09/speed-up-your-testcontainers-tests/&via=callistaent&hashtags=" target="_blank" title="Share this post on Twitter"></a>
    <a class="ce-blog-share-element social-facebook" href="https://www.facebook.com/sharer/sharer.php?t=Speed Up Your Testcontainers Tests&u=https://callistaenterprise.se/blogg/teknik/2020/10/09/speed-up-your-testcontainers-tests/" target="_blank" title="Share this post on Facebook"></a>
    <a class="ce-blog-share-element social-linkedin" href="http://www.linkedin.com/shareArticle?mini=true&title=Speed Up Your Testcontainers Tests&url=https://callistaenterprise.se/blogg/teknik/2020/10/09/speed-up-your-testcontainers-tests/&source=http%3a%2f%2fzhangwenli.com" target="_blank" title="Share this post on LinkedIn"></a>
</div>
    
        </article>
    </div>
</section>


<section class="ce-section">
    <heading>
        <h1>Kommentarer</h1>
    </heading>
    <div class="ce-content">
        <div id="disqus_thread"></div>
        <script src="../../../../../../js/disqus.js"></script>
    </div>
</section>


    </div>

    <footer class="ce-footer">
    <div class="ce-wrapper">
        <nav class="ce-menu-footer-primary">
            <h2><a href="../../../../../../index.html">Callista</a></h2>
            <ul>
                
                <li><a href="../../../../../../om/index.html">Om oss</a></li>
                
                <li><a href="../../../../../../erbjudanden.html">Erbjudanden</a></li>
                
                <li><a href="../../../../../../event.html">Event</a></li>
                
                <li><a href="../../../../../../blogg.html">Blogg</a></li>
                
                <li><a href="../../../../../../om/jobb/index.html">Jobba hos oss</a></li>
                

                
                    
                        <li><a href="../../../../../../english/index.html">English</a></li>
                    
                
            </ul>
        </nav>
        <div class="ce-addresses">
            <div class="ce-address">
                <h2>Stockholm</h2>
                <address>
                    Drottninggatan 55<br>
                    111 21 Stockholm<br>
                    Tel:
                    <a href="tel:+468212142">
                        +46 8 21 21 42
                    </a>
                </address>
            </div>
            <div class="ce-address">
                <h2>Göteborg</h2>
                <address>
                    Fabriksgatan 13<br>
                    412 50 Göteborg<br>
                    Tel:
                    <a href="tel:+4631201918">
                        +46 31 20 19 18
                    </a>
                </address>
            </div>
        </div>
        <div class="ce-social">
            <h2>Följ oss</h2>
            <ul>
                <li>
                    <a href="http://twitter.com/callistaent">
                        <img alt="Twitters logotype" src="../../../../../../images/icons/twitter.png">
                        <span>@callistaent</span>
                    </a>
                </li>
            </ul>
        </div>
        <small>&copy; 2021 Callista Enterprise AB</small>
        <hr style="margin: 1em 0 2em 0">
        <div class="ce-footer-images">
          <div class="ce-footer-image">
            <a class="ce-raddabarnen" href="http://www.raddabarnen.se/foretag">
                <img alt="Callista är Rädda Barnens företagsvän 2021" src="../../../../../../images/logotype/rb_vanforetag_2021_large-sv.png">
            </a>
          </div>
        </div>
        <br>
        <div class="ce-footer-images">
          <div class="ce-footer-image">
            <a class="ce-di-gasell" href="http://www.di.se/gasell/">
              <img alt="Callista utsett till DI Gasell tre år i rad" src="../../../../../../images/logotype/di_gasell_180x194.png">
            </a>
          </div>
        </div>
    </div>
</footer>


    <script src="../../../../../../js/lib/jquery.min.js"></script>
    <script src="../../../../../../js/lib/owl.carousel.min.js"></script>
    <script src="../../../../../../js/lib/prismjs.min.js"></script>
    <script src="../../../../../../js/app.js"></script>
    <script src="../../../../../../js/analytics.js"></script>
    <script src="../../../../../../js/jobinterestsubmit.js"></script>

</body>
</html>
