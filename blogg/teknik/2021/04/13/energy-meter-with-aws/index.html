<!DOCTYPE html>
<html lang="sv-se">
<head>
    <meta charset="utf-8">

    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="description" content="Callista Enterprise - seniora IT-arkitekter och systemutvecklare inom Java, öppen källkod, agil utveckling och systemintegration">
    <!--<meta name="viewport" content="width=device-width, initial-scale=1">-->
    <meta name="viewport" content="initial-scale=1.0001, minimum-scale=1.0001, maximum-scale=1.0001, user-scalable=no"/>

    <link rel="icon" href="../../../../../../images/icons/callista_favicon.svg" type="image/x-icon" />
    <link rel="shortcut icon" href="../../../../../../images/icons/callista_favicon.svg" type="image/x-icon" />
    <link rel="apple-touch-icon" href="../../../../../../images/icons/callista_favicon_160x160.png">

    <title>Home electricity usage monitoring with AWS services and Go, part 1. | Callista</title>

    <link rel="stylesheet" href="../../../../../../css/style.css%3Fv=1.css">
    <link rel="alternate" type="application/rss+xml" title="RSS Feed for callistaenterprise.se" href="../../../../../../feed.xml" />

    <!--[if lte IE 8]>
    <style>* { display: none !important; }</style>
    <meta http-equiv="refresh" content="0; url=/oldie/"/>
    <![endif]-->

    <script type="text/javascript" src="https://use.typekit.net/kig5egm.js"></script>
    <script type="text/javascript">
        try {
            Typekit.load({ async: true });
        } catch (e) {
        }
    </script>

    <!-- Facebook Pixel Code -->
    <script>
    !function(f,b,e,v,n,t,s)
    {if(f.fbq)return;n=f.fbq=function(){n.callMethod?
    n.callMethod.apply(n,arguments):n.queue.push(arguments)};
    if(!f._fbq)f._fbq=n;n.push=n;n.loaded=!0;n.version='2.0';
    n.queue=[];t=b.createElement(e);t.async=!0;
    t.src=v;s=b.getElementsByTagName(e)[0];
    s.parentNode.insertBefore(t,s)}(window,document,'script',
    'https://connect.facebook.net/en_US/fbevents.js');
     fbq('init', '804675599711872');
     fbq('track', 'PageView');
    </script>
    <noscript>
     <img height="1" width="1" src="https://www.facebook.com/tr?id=804675599711872&ev=PageView&noscript=1"/>
    </noscript>
    <!-- End Facebook Pixel Code -->

</head>
<body>

    <header class="ce-header" data-scroll="0">
    <nav>
        <img alt="menubg" class="ce-menu-icon" style="z-index:3; top: 0px; width: 50px; height: 100%;" src="../../../../../../images/icons/menu_background.png">
        <a class="ce-logotype" href="../../../../../../index.html" style="z-index: 2;">
            <img alt="Callista" style="max-width: 100%; height: auto;" src="../../../../../../images/logotype/callista_small2.svg">
        </a>
        <table>
            <tr>
                <td>
            <ul id="menu-primary" class="ce-menu-primary">
                
                    
                            <li><a href="../../../../../../om/index.html">Om oss</a></li>
                    
                
                    
                            <li><a href="../../../../../../erbjudanden.html">Erbjudanden</a></li>
                    
                
                    
                            <li><a href="../../../../../../event.html">Event</a></li>
                    
                
                    
                        
                            <li><a class="ce-active" href="../../../../../../blogg.html">Blogg</a></li>
                        
                    
                
                    
                            <li><a href="../../../../../../om/jobb/index.html">Jobba hos oss</a></li>
                    
                
            </ul>
                </td>

                <td>
            <ul class="ce-menu-secondary">
                
                <li><a href="../../../../../../english/index.html">English</a></li>
                
            </ul>
                </td>
            </tr>
        </table>
            <a id="menu" class="ce-menu-icon" href="index.html#" style="z-index: 4;">
                <img alt="Visa meny" src="../../../../../../images/icons/menu.png">
            </a>
            <a class="ce-search-icon" href="index.html#">
                <img alt="Sök" src="../../../../../../images/icons/search.png">
            </a>

        </table>
    </nav>
</header>


    <div class="ce-main">
        <section class="ce-start lazyImg">
    <article>
        <h1>Blogg</h1>
        <p class="ce-ingress">
            Här finns tekniska artiklar, presentationer och nyheter om arkitektur och systemutveckling. Håll dig uppdaterad, följ oss på <a class="ce-active" href="http://twitter.com/callistaent">Twitter</a>
        </p>
    </article>
</section>

<section class="ce-section">
    <div class="ce-content">
        
        

        
        

        <article class="ce-blog">
            <header>
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    <img alt="Callista medarbetare Erik Lupander" src="../../../../../../assets/medarbetare/eriklupander_mini.png">
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    <h2>
        <a href="index.html">Home electricity usage monitoring with AWS services and Go, part 1.</a>
        
        
    </h2>
    <h3>
        <time datetime="2021-04-13T00:00:00+00:00">
            13 April 2021
        </time>
        //
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        

        
        
        <a href="../../../../../../om/medarbetare/eriklupander/index.html">Erik Lupander</a>
        

        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
    </h3>
    
</header>




<p>As a personal exercise learning AWS Lambda and CDK, I developed a solution that helps me monitor how much electricity my house uses.</p>

<p>The solution is built around the <a href="https://tibber.com/se/store/produkt/watty-smart-energimatare">Watty</a> energy monitor, the <a href="https://developer.tibber.com/">Tibber API</a> and various <a href="https://aws.amazon.com/">AWS services</a>.</p>

<p></p>

<ul class="no_toc" id="markdown-toc">
  <li><a href="index.html#1-solution-overview" id="markdown-toc-1-solution-overview">1. Solution overview</a></li>
  <li><a href="index.html#2-aws-cdk" id="markdown-toc-2-aws-cdk">2. AWS CDK</a></li>
  <li><a href="index.html#3-setting-up-the-timestream-db" id="markdown-toc-3-setting-up-the-timestream-db">3 Setting up the Timestream DB</a></li>
  <li><a href="index.html#4-powerrecorder-golang-lambda-with-eventbridge" id="markdown-toc-4-powerrecorder-golang-lambda-with-eventbridge">4. PowerRecorder Golang lambda with EventBridge</a></li>
  <li><a href="index.html#5-exporter-api-with-api-gateway" id="markdown-toc-5-exporter-api-with-api-gateway">5. Exporter API with API Gateway</a></li>
  <li><a href="index.html#6-deploying" id="markdown-toc-6-deploying">6. Deploying</a></li>
  <li><a href="index.html#7-part-1-summary" id="markdown-toc-7-part-1-summary">7. Part 1 summary</a></li>
</ul>

<p>The full CDK and Go source code for this project can be found here: <a href="https://github.com/eriklupander/powertracker">https://github.com/eriklupander/powertracker</a></p>

<p>You can skip ahead to part 2 <a href="https://github.com/callistaenterprise/callistaenterprise.github.io/blob/master/_posts/teknik/2021-04-15-energy-meter-with-aws-part-2.md">right here</a>.</p>

<p><em>Note: I am in no way affiliated with or working for Tibber, Easee, AWS or any other company or service provider mentioned in this blog post. I’m only doing this for educational purposes and personal enjoyment.</em></p>

<h1 id="1-solution-overview">1. Solution overview</h1>
<p><img src="../../../../../../assets/blogg/powertracker/powertracker.png" alt="img alt" /></p>

<p>The heart of the solution is the <a href="https://tibber.com/se/store/produkt/watty-smart-energimatare">Watty</a> energy meter, which continuously transmits my house’s current electricity usage (per phase) to a cloud service in Sweden called Tibber. Tibber then uses the data to control the max output power of my EV charger from Easee, so none of the 3 phases draw more than the maximum 20A of current the main circuit breaker allows per phase.</p>

<p>I plan to return to the actual EV charging in an upcoming blog post - this one’s about how I used various AWS services to connect to Tibber’s API, take snapshots every 5 minutes of how much electricity (kWh) my house has used and store that information in a suitable format for keeping track of when and how much electricity my house uses. The final output looks like this:</p>

<p><img src="../../../../../../assets/blogg/powertracker/histogram-1h-multiday-2.png" alt="output" /></p>

<p>This blog post is definitely one of those where “the journey is the reward”, so the rest of the blog post will focus mostly on how I used CDK (Cloud Development Toolkit) and a number of AWS services to wire everything up in order to produce graphs such as the one above. In <a href="https://github.com/callistaenterprise/callistaenterprise.github.io/blob/master/_posts/teknik/2021-04-15-energy-meter-with-aws-part-2.md">part 2</a> of this blog series, we’ll take a closer look at the <a href="https://golang.org">golang</a>-based AWS Lambdas I’ve developed.</p>

<p>Overall, the solution works like this:</p>

<h3 id="11-data-ingestion">1.1 Data ingestion</h3>
<ol>
  <li>The EventBridge invokes the <code class="language-plaintext highlighter-rouge">PowerRecorder</code> <a href="https://aws.amazon.com/lambda/">AWS Lambda</a> every 5 minutes.</li>
  <li>The <code class="language-plaintext highlighter-rouge">PowerRecorder</code> lambda fetches the pre-stored Tibber API key from <a href="https://aws.amazon.com/secrets-manager/">AWS Secrets Manager</a>.</li>
  <li><code class="language-plaintext highlighter-rouge">PowerRecorder</code> creates a <a href="https://spec.graphql.org/draft/#sec-Subscription">GraphQL subscription</a> against <a href="https://developer.tibber.com/">Tibber’s API</a> using the API key, where a number of metrics are made available in real-time from the Watty device in my house as a <code class="language-plaintext highlighter-rouge">liveMeasurement</code>. I haven’t looked into how Tibber is communicating with my Watty device, but I suspect the solution is also based around Web Sockets or a similar mechanism for continuously serving telemetry to a cloud service.</li>
  <li>The <code class="language-plaintext highlighter-rouge">PowerRecorder</code> collects exactly <strong>one</strong> <code class="language-plaintext highlighter-rouge">liveMeasurement</code> before closing the subscription.</li>
  <li><code class="language-plaintext highlighter-rouge">PowerRecorder</code> opens a connection to a <a href="https://aws.amazon.com/timestream/">AWS Timestream</a> time-series database (using the Go AWS SDK) and writes a single entry with <code class="language-plaintext highlighter-rouge">homeId</code>, <code class="language-plaintext highlighter-rouge">accumulatedUsage</code> (of day) and the current timestamp.</li>
  <li><code class="language-plaintext highlighter-rouge">PowerRecorder</code> is now finished, and the lambda exits.</li>
</ol>

<h3 id="12-data-export">1.2 Data export</h3>
<ol>
  <li>The <code class="language-plaintext highlighter-rouge">exporter</code> lambda receives a HTTP request through the provisioned <a href="https://aws.amazon.com/api-gateway/">AWS API Gateway</a>.</li>
  <li><code class="language-plaintext highlighter-rouge">exporter</code> looks at a number of query parameters in order to determine <code class="language-plaintext highlighter-rouge">from</code> date, <code class="language-plaintext highlighter-rouge">to</code> date, output format (<code class="language-plaintext highlighter-rouge">csv</code> or <code class="language-plaintext highlighter-rouge">png</code>), aggregation level (per 5 min, per hour, per day, per month) and if png - type of graph (<code class="language-plaintext highlighter-rouge">hist</code> or <code class="language-plaintext highlighter-rouge">lineplot</code>)</li>
  <li><code class="language-plaintext highlighter-rouge">exporter</code> uses the <a href="https://docs.aws.amazon.com/sdk-for-go/api/service/timestreamquery/">timestreamquery</a> to execute a simple SQL-like query to get all records between the two dates.</li>
  <li><code class="language-plaintext highlighter-rouge">exporter</code> optionally aggregates the 5-minute records into hourly, daily or monthly entries and outputs the result as <code class="language-plaintext highlighter-rouge">csv</code> or as a <code class="language-plaintext highlighter-rouge">png</code> rendered by <a href="https://github.com/gonum/plot">go-num plots</a>.</li>
</ol>

<h1 id="2-aws-cdk">2. AWS CDK</h1>
<p>One of the major objectives was to try out the provisioning of AWS resources using Amazon’s <a href="https://aws.amazon.com/cdk/">Cloud Development Kit</a> (CDK). I’m by no means an expert on DevOps practices, but I’ve used various tools over the years such as Ansible, CloudFormation, Terraform, shell-scripts - and in all honesty - most of those solutions kind of suck in one way or another. All have their pros and cons of course. I’m not saying CDK is the magic silver bullet - especially since it’s not provider agnostic - but for someone more rooted in imperative programming and general software architecture, CDK is by far the smoothest experience I’ve had when it comes to working with provisioning of AWS services from a local developer laptop as well as building the code that makes up the solution with a few keystrokes. Being able to express resources, dependencies, IAM stuff etc as plain code with good editor support and even unit tests may very well be a game-changer.</p>

<p>As for getting started with CDK, there’s a lot of good guides for that. CDK currently supports several programming languages. While Go is my daily driver, Go support in CDK is not (<a href="https://github.com/aws/aws-cdk/issues/547">yet anyway</a>) available, so I chose to use <a href="https://www.typescriptlang.org/">Typescript</a> which also seems to be commonly used in CDK examples and tutorials found online.</p>

<p>I bootstrapped my project using the standard <code class="language-plaintext highlighter-rouge">cdk init app --language typescript</code> and defined my “Powertracker” (slightly cheesy name, but what the heck…) <a href="https://docs.aws.amazon.com/cdk/latest/guide/stacks.html">stack</a> in <code class="language-plaintext highlighter-rouge">/bin/powertracker.ts</code>:</p>

<div class="language-typescript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="o">*</span> <span class="k">as</span> <span class="nx">cdk</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">@aws-cdk/core</span><span class="dl">'</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span> <span class="nx">PowertrackerStack</span> <span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">../lib/powertracker-stack</span><span class="dl">'</span><span class="p">;</span>

<span class="kd">const</span> <span class="nx">app</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">cdk</span><span class="p">.</span><span class="nx">App</span><span class="p">();</span>
<span class="k">new</span> <span class="nx">PowertrackerStack</span><span class="p">(</span><span class="nx">app</span><span class="p">,</span> <span class="dl">'</span><span class="s1">PowertrackerStack</span><span class="dl">'</span><span class="p">);</span>
</code></pre></div></div>
<p>This file is deliberately kept very simple as the most common pattern seems to be to put the actual resource provisioning of a stack in the <code class="language-plaintext highlighter-rouge">/lib</code> folder - in my case <code class="language-plaintext highlighter-rouge">/lib/powertracker-stack.ts</code>.</p>

<p>Defining the stack in .ts code is naturally somewhat more complex than the snippet above.</p>

<p>Given that CDK is a very powerful tool, outlining all the possibilities of CDK is way out of scope of this blog post. I’ll focus on <em>this</em> particular solutions and since I’m developing my AWS lambdas in Golang, I’ll spend a little extra time explaining the Go-specific parts of using CDK to build Go-based lambdas.</p>

<h3 id="21-basics">2.1 Basics</h3>
<div class="language-typescript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// imports above, omitted for brevity</span>
<span class="k">export</span> <span class="kd">class</span> <span class="nx">PowertrackerStack</span> <span class="kd">extends</span> <span class="nx">cdk</span><span class="p">.</span><span class="nx">Stack</span> <span class="p">{</span>
 <span class="kd">constructor</span><span class="p">(</span><span class="nx">scope</span><span class="p">:</span> <span class="nx">cdk</span><span class="p">.</span><span class="nx">Construct</span><span class="p">,</span> <span class="nx">id</span><span class="p">:</span> <span class="kr">string</span><span class="p">,</span> <span class="nx">props</span><span class="p">?:</span> <span class="nx">cdk</span><span class="p">.</span><span class="nx">StackProps</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">super</span><span class="p">(</span><span class="nx">scope</span><span class="p">,</span> <span class="nx">id</span><span class="p">,</span> <span class="nx">props</span><span class="p">);</span>
  <span class="c1">// rest of provisioning goes below here</span>
 <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>
<p>It’s really neat that the provisioning is performed using a (typed) programming language where one will find the various constructs familiar - in this case defining a typescript class extending a base-class from the <code class="language-plaintext highlighter-rouge">cdk</code> package and a constructor which we’ll shortly fill with the stuff that actually provisions something.</p>

<h3 id="22-iam-policies">2.2 IAM policies</h3>
<div class="language-typescript highlighter-rouge"><div class="highlight"><pre class="highlight"><code>        <span class="c1">// IAM policies</span>
        <span class="kd">const</span> <span class="nx">timeStreamPolicy</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">iam</span><span class="p">.</span><span class="nx">PolicyStatement</span><span class="p">({</span>
            <span class="na">actions</span><span class="p">:</span> <span class="p">[</span><span class="dl">"</span><span class="s2">timestream:*</span><span class="dl">"</span><span class="p">],</span>
            <span class="na">resources</span><span class="p">:</span> <span class="p">[</span><span class="dl">"</span><span class="s2">*</span><span class="dl">"</span><span class="p">]</span>
        <span class="p">})</span>
        <span class="kd">const</span> <span class="nx">secretsPolicy</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">iam</span><span class="p">.</span><span class="nx">PolicyStatement</span><span class="p">({</span>
            <span class="na">actions</span><span class="p">:</span> <span class="p">[</span><span class="dl">"</span><span class="s2">secretsmanager:GetSecretValue</span><span class="dl">"</span><span class="p">],</span>
            <span class="na">resources</span><span class="p">:</span> <span class="p">[</span><span class="dl">"</span><span class="s2">arn:aws:secretsmanager:*:secret:prod/tibber_config-*</span><span class="dl">"</span><span class="p">]</span>
        <span class="p">})</span>
</code></pre></div></div>
<p>Our lambda functions will need some IAM permissions in order to access secrets and/or read/write to the Timestream DB. We define these permissions as two <code class="language-plaintext highlighter-rouge">iam.PolicyStatement</code>s we can attach to our lambdas further down.</p>

<h1 id="3-setting-up-the-timestream-db">3 Setting up the Timestream DB</h1>
<p>First off, we’ll look at the code that provisions the AWS Timestream database and table.</p>
<div class="language-typescript highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="kd">const</span> <span class="nx">timeStreamDB</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">PowerTrackerTimestreamConstruct</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="dl">"</span><span class="s2">powertracker_timestream</span><span class="dl">"</span><span class="p">,</span> <span class="p">{</span>
        <span class="na">databaseName</span><span class="p">:</span> <span class="dl">"</span><span class="s2">powertracker</span><span class="dl">"</span><span class="p">,</span>
        <span class="na">tableName</span><span class="p">:</span> <span class="dl">"</span><span class="s2">power_record</span><span class="dl">"</span>
    <span class="p">})</span>
</code></pre></div></div>
<p>The <code class="language-plaintext highlighter-rouge">PowerTrackerTimestreamConstruct</code> is defined in its own file <code class="language-plaintext highlighter-rouge">/lib/powertracker-timestream.ts</code>:</p>
<div class="language-typescript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="p">{</span><span class="nx">Construct</span><span class="p">,</span> <span class="nx">RemovalPolicy</span><span class="p">}</span> <span class="k">from</span> <span class="dl">"</span><span class="s2">@aws-cdk/core</span><span class="dl">"</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span><span class="nx">CfnDatabase</span><span class="p">,</span> <span class="nx">CfnTable</span><span class="p">}</span> <span class="k">from</span> <span class="dl">"</span><span class="s2">@aws-cdk/aws-timestream</span><span class="dl">"</span><span class="p">;</span>

<span class="k">export</span> <span class="kr">interface</span> <span class="nx">PowerTrackerTimestreamConstructProps</span> <span class="p">{</span>
    <span class="nl">databaseName</span><span class="p">:</span> <span class="kr">string</span><span class="p">;</span>
    <span class="nl">tableName</span><span class="p">:</span> <span class="kr">string</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">export</span> <span class="kd">class</span> <span class="nx">PowerTrackerTimestreamConstruct</span> <span class="kd">extends</span> <span class="nx">Construct</span> <span class="p">{</span>
    <span class="k">public</span> <span class="k">readonly</span> <span class="nx">database</span><span class="p">:</span> <span class="nx">CfnDatabase</span><span class="p">;</span>
    <span class="k">public</span> <span class="k">readonly</span> <span class="nx">table</span><span class="p">:</span> <span class="nx">CfnTable</span><span class="p">;</span>

    <span class="kd">constructor</span><span class="p">(</span><span class="nx">scope</span><span class="p">:</span> <span class="nx">Construct</span><span class="p">,</span> <span class="nx">id</span><span class="p">:</span> <span class="kr">string</span><span class="p">,</span> <span class="nx">props</span><span class="p">:</span> <span class="nx">PowerTrackerTimestreamConstructProps</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">super</span><span class="p">(</span><span class="nx">scope</span><span class="p">,</span> <span class="nx">id</span><span class="p">);</span>
        <span class="c1">// Define the database using the databaseName passed from props</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">database</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">CfnDatabase</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="dl">'</span><span class="s1">PowerTracker database</span><span class="dl">'</span><span class="p">,</span> <span class="p">{</span>
            <span class="na">databaseName</span><span class="p">:</span> <span class="nx">props</span><span class="p">.</span><span class="nx">databaseName</span><span class="p">,</span>
        <span class="p">});</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">database</span><span class="p">.</span><span class="nx">applyRemovalPolicy</span><span class="p">(</span><span class="nx">RemovalPolicy</span><span class="p">.</span><span class="nx">RETAIN</span><span class="p">);</span>  <span class="c1">// make sure DB is not deleted when stack is destroyed.</span>

        <span class="c1">// Then the table is created in the database which we'll write our electricity usage metrics to.</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">table</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">CfnTable</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="dl">'</span><span class="s1">Metrics table</span><span class="dl">'</span><span class="p">,</span> <span class="p">{</span>        
            <span class="na">tableName</span><span class="p">:</span> <span class="nx">props</span><span class="p">.</span><span class="nx">tableName</span><span class="p">,</span>
            <span class="na">databaseName</span><span class="p">:</span> <span class="nx">props</span><span class="p">.</span><span class="nx">databaseName</span><span class="p">,</span>
            <span class="na">retentionProperties</span><span class="p">:</span> <span class="p">{</span>
                <span class="na">memoryStoreRetentionPeriodInHours</span><span class="p">:</span> <span class="p">(</span><span class="mi">48</span><span class="p">).</span><span class="nx">toString</span><span class="p">(</span><span class="mi">10</span><span class="p">),</span>      <span class="c1">// Keep data for 48 in-mem</span>
                <span class="na">magneticStoreRetentionPeriodInDays</span><span class="p">:</span> <span class="p">(</span><span class="mi">365</span> <span class="o">*</span> <span class="mi">2</span><span class="p">).</span><span class="nx">toString</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span> <span class="c1">// Keep data on disk for 2 years</span>
            <span class="p">}</span>
        <span class="p">});</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">table</span><span class="p">.</span><span class="nx">node</span><span class="p">.</span><span class="nx">addDependency</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">database</span><span class="p">);</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">table</span><span class="p">.</span><span class="nx">applyRemovalPolicy</span><span class="p">(</span><span class="nx">RemovalPolicy</span><span class="p">.</span><span class="nx">RETAIN</span><span class="p">);</span> <span class="c1">// make sure Table is not deleted when stack is destroyed.</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>
<p>As seen above, the AWS Timestream DB provisioning is <em>very</em> straightforward using the <code class="language-plaintext highlighter-rouge">CfnDatabase</code> and <code class="language-plaintext highlighter-rouge">CfnTable</code> classes imported from the <code class="language-plaintext highlighter-rouge">aws-cdk/aws-timestream</code> dependency. Note the <code class="language-plaintext highlighter-rouge">RemovalPolicy.RETAIN</code> which makes sure we don’t lose any data when if we, for some reason, execute <code class="language-plaintext highlighter-rouge">cdk destroy</code> or similar. It does however entail that, once the Timestream DB and table has been set up, the code in <code class="language-plaintext highlighter-rouge">powertracker-stack.ts</code> has to be commented out as the creation code isn’t idempotent, i.e. it will fail on some kind of “resource is already present” error. It’s hopefully possible to code around this issue, though it’s not something I’ve spent time figuring out yet.</p>

<h1 id="4-powerrecorder-golang-lambda-with-eventbridge">4. PowerRecorder Golang lambda with EventBridge</h1>
<p>Go lambdas can either be packaged as ZIP bundles or as docker images. I’ve picked the latter. Packaging one’s Go code in a lambda is very easy with a bit of typescript code:</p>
<div class="language-typescript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">buildGolangLambda</span><span class="p">(</span><span class="nx">id</span><span class="p">:</span> <span class="kr">string</span><span class="p">,</span> <span class="nx">lambdaPath</span><span class="p">:</span> <span class="kr">string</span><span class="p">,</span> <span class="nx">timeout</span><span class="p">:</span> <span class="kr">number</span><span class="p">):</span> <span class="nx">lambda</span><span class="p">.</span><span class="nb">Function</span> <span class="p">{</span>
        <span class="k">return</span> <span class="k">new</span> <span class="nx">lambda</span><span class="p">.</span><span class="nb">Function</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">id</span><span class="p">,</span> <span class="p">{</span>
            <span class="na">code</span><span class="p">:</span> <span class="nx">lambda</span><span class="p">.</span><span class="nx">Code</span><span class="p">.</span><span class="nx">fromAsset</span><span class="p">(</span><span class="nx">lambdaPath</span><span class="p">,</span> <span class="p">{</span>       <span class="c1">// lambdaPath is the relative path to the root of the go lambda code</span>
                <span class="na">bundling</span><span class="p">:</span> <span class="p">{</span>
                    <span class="na">image</span><span class="p">:</span> <span class="nx">lambda</span><span class="p">.</span><span class="nx">Runtime</span><span class="p">.</span><span class="nx">GO_1_X</span><span class="p">.</span><span class="nx">bundlingDockerImage</span><span class="p">,</span>  <span class="c1">// use standard AWS lambda golang builder image</span>
                    <span class="na">user</span><span class="p">:</span> <span class="dl">"</span><span class="s2">root</span><span class="dl">"</span><span class="p">,</span>                                      <span class="c1">// build as root</span>
                    <span class="na">environment</span><span class="p">:</span> <span class="p">{</span><span class="na">CGO_ENABLED</span><span class="p">:</span> <span class="dl">'</span><span class="s1">0</span><span class="dl">'</span><span class="p">,</span> <span class="na">GOOS</span><span class="p">:</span> <span class="dl">'</span><span class="s1">linux</span><span class="dl">'</span><span class="p">,</span> <span class="na">GOARCH</span><span class="p">:</span> <span class="dl">'</span><span class="s1">amd64</span><span class="dl">'</span><span class="p">},</span> <span class="c1">// build env vars so we build for Linux/AMD64</span>
                    <span class="na">command</span><span class="p">:</span> <span class="p">[</span>                   <span class="c1">// This is the actual build commands that executes my own `lambda-build` make target.</span>
                        <span class="dl">'</span><span class="s1">bash</span><span class="dl">'</span><span class="p">,</span> <span class="dl">'</span><span class="s1">-c</span><span class="dl">'</span><span class="p">,</span> <span class="p">[</span>
                            <span class="dl">'</span><span class="s1">make lambda-build</span><span class="dl">'</span><span class="p">,</span>
                        <span class="p">].</span><span class="nx">join</span><span class="p">(</span><span class="dl">'</span><span class="s1"> &amp;&amp; </span><span class="dl">'</span><span class="p">)</span>
                    <span class="p">]</span>
                <span class="p">}</span>
            <span class="p">}),</span>
            <span class="na">handler</span><span class="p">:</span> <span class="dl">'</span><span class="s1">main</span><span class="dl">'</span><span class="p">,</span>
            <span class="na">runtime</span><span class="p">:</span> <span class="nx">lambda</span><span class="p">.</span><span class="nx">Runtime</span><span class="p">.</span><span class="nx">GO_1_X</span><span class="p">,</span>         <span class="c1">// standard AWS lambda golang runtime image</span>
            <span class="na">timeout</span><span class="p">:</span> <span class="nx">cdk</span><span class="p">.</span><span class="nx">Duration</span><span class="p">.</span><span class="nx">seconds</span><span class="p">(</span><span class="nx">timeout</span><span class="p">),</span> <span class="c1">// specify timeout in seconds. Default is 3, we want a bit more in some cases.</span>
        <span class="p">});</span>
    <span class="p">}</span>
</code></pre></div></div>
<p>The <a href="https://www.gnu.org/software/make/">make</a> task is actually very simple:</p>
<div class="language-makefile highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nl">lambda-build</span><span class="o">:</span>
	<span class="nv">GOOS</span><span class="o">=</span>linux go build <span class="nt">-o</span> /asset-output/main
</code></pre></div></div>
<p>The make target is executed by the builder-image which places the resulting binary in the builder’s <code class="language-plaintext highlighter-rouge">/assets-output</code> folder as <code class="language-plaintext highlighter-rouge">main</code>, from where the AWS builder can move it to the final runtime image. For more details on building/running Golang lambdas see https://aws.amazon.com/blogs/devops/building-apps-with-aws-cdk/.</p>

<p>Moving on to the CDK code to provision this Golang-based lambda, we see how we pass the <em>relative</em> path to the <code class="language-plaintext highlighter-rouge">powerRecorder</code> lambda function using <code class="language-plaintext highlighter-rouge">path.join</code> in order to create the CDK <code class="language-plaintext highlighter-rouge">lambda.Function</code> object.</p>
<div class="language-typescript highlighter-rouge"><div class="highlight"><pre class="highlight"><code>        <span class="c1">// Build PowerRecorder lambda that reads data from Tibber and stores in Timestream DB</span>
        <span class="kd">const</span> <span class="nx">powerRecorderFunction</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">buildGolangLambda</span><span class="p">(</span><span class="dl">'</span><span class="s1">powerRecorder</span><span class="dl">'</span><span class="p">,</span> <span class="nx">path</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="nx">__dirname</span><span class="p">,</span> <span class="dl">'</span><span class="s1">../functions/powerRecorder</span><span class="dl">'</span><span class="p">),</span> <span class="mi">10</span><span class="p">);</span>

        <span class="c1">// Build EventBridge rule with cron expression and bind to lambda to trigger powerRecorder lambda</span>
        <span class="kd">const</span> <span class="nx">rule</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">ruleCdk</span><span class="p">.</span><span class="nx">Rule</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="dl">"</span><span class="s2">collect_power_rule</span><span class="dl">"</span><span class="p">,</span> <span class="p">{</span>
            <span class="na">description</span><span class="p">:</span> <span class="dl">"</span><span class="s2">Invoked every minute to collect current power state</span><span class="dl">"</span><span class="p">,</span>
            <span class="na">schedule</span><span class="p">:</span> <span class="nx">Schedule</span><span class="p">.</span><span class="nx">expression</span><span class="p">(</span><span class="dl">"</span><span class="s2">cron(0/5 * * * ? *)</span><span class="dl">"</span><span class="p">)</span>
        <span class="p">});</span>
        <span class="nx">rule</span><span class="p">.</span><span class="nx">addTarget</span><span class="p">(</span><span class="k">new</span> <span class="nx">targets</span><span class="p">.</span><span class="nx">LambdaFunction</span><span class="p">(</span><span class="nx">powerRecorderFunction</span><span class="p">))</span>

        <span class="c1">// Add IAM for powerrecorder</span>
        <span class="nx">powerRecorderFunction</span><span class="p">.</span><span class="nx">addToRolePolicy</span><span class="p">(</span><span class="nx">timeStreamPolicy</span><span class="p">)</span>
        <span class="nx">powerRecorderFunction</span><span class="p">.</span><span class="nx">addToRolePolicy</span><span class="p">(</span><span class="nx">secretsPolicy</span><span class="p">)</span>
</code></pre></div></div>
<p>We also see how we declare an [EventBridge rule] which designates our <code class="language-plaintext highlighter-rouge">powerRecorder</code> lambda as target. The last two lines binds our two IAM <code class="language-plaintext highlighter-rouge">PolicyStatements</code> so the lambda has the necessary permissions.</p>

<h1 id="5-exporter-api-with-api-gateway">5. Exporter API with API Gateway</h1>
<p>Next, we use very similar code to create our <code class="language-plaintext highlighter-rouge">exporter</code> lambda which gets access to the <code class="language-plaintext highlighter-rouge">AWS timestream</code> database and which then is bound to a <a href="https://aws.amazon.com/api-gateway/">AWS API Gateway</a> running in <a href="https://docs.aws.amazon.com/apigateway/latest/developerguide/http-api.html">HTTP API</a> mode.</p>
<div class="language-typescript highlighter-rouge"><div class="highlight"><pre class="highlight"><code>        <span class="c1">// Build Exporter API lambda and bind IAM for timestream access</span>
        <span class="kd">const</span> <span class="nx">exporterLambdaFn</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">buildGolangLambda</span><span class="p">(</span><span class="dl">'</span><span class="s1">exporter-api</span><span class="dl">'</span><span class="p">,</span> <span class="nx">path</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="nx">__dirname</span><span class="p">,</span> <span class="dl">'</span><span class="s1">../functions/exporter</span><span class="dl">'</span><span class="p">),</span> <span class="mi">30</span><span class="p">);</span>
        <span class="nx">exporterLambdaFn</span><span class="p">.</span><span class="nx">addToRolePolicy</span><span class="p">(</span><span class="nx">timeStreamPolicy</span><span class="p">)</span>

        <span class="c1">// Create HTTP API Gateway in front of the lambda</span>
        <span class="kd">const</span> <span class="nx">apiGtw</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">createApiGatewayForLambda</span><span class="p">(</span><span class="dl">"</span><span class="s2">exporter-api-endpoint</span><span class="dl">"</span><span class="p">,</span> <span class="nx">exporterLambdaFn</span><span class="p">,</span> <span class="dl">'</span><span class="s1">Powertracker endpoints</span><span class="dl">'</span><span class="p">)</span>

        <span class="c1">// Output the hostname of your the API gateway</span>
        <span class="k">new</span> <span class="nx">cdk</span><span class="p">.</span><span class="nx">CfnOutput</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="dl">'</span><span class="s1">lambda-url</span><span class="dl">'</span><span class="p">,</span> <span class="p">{</span><span class="na">value</span><span class="p">:</span> <span class="nx">apiGtw</span><span class="p">.</span><span class="nx">url</span><span class="o">!</span><span class="p">})</span>
</code></pre></div></div>
<p>The <code class="language-plaintext highlighter-rouge">createApiGatewayForLambda</code> looks like this:</p>
<div class="language-typescript highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
    <span class="nx">createApiGatewayForLambda</span><span class="p">(</span><span class="nx">id</span><span class="p">:</span> <span class="kr">string</span><span class="p">,</span> <span class="nx">handler</span><span class="p">:</span> <span class="nx">lambda</span><span class="p">.</span><span class="nb">Function</span><span class="p">,</span> <span class="nx">desc</span><span class="p">:</span> <span class="kr">string</span><span class="p">):</span> <span class="nx">HttpApi</span> <span class="p">{</span>

        <span class="kd">const</span> <span class="nx">httpApi</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">HttpApi</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">id</span><span class="p">,</span> <span class="p">{</span><span class="na">description</span><span class="p">:</span> <span class="nx">desc</span><span class="p">})</span>
        <span class="kd">const</span> <span class="nx">lambdaProxyIntegration</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">LambdaProxyIntegration</span><span class="p">({</span><span class="na">handler</span><span class="p">:</span> <span class="nx">handler</span><span class="p">})</span>
        <span class="nx">httpApi</span><span class="p">.</span><span class="nx">addRoutes</span><span class="p">({</span>
            <span class="na">integration</span><span class="p">:</span> <span class="nx">lambdaProxyIntegration</span><span class="p">,</span>
            <span class="na">methods</span><span class="p">:</span> <span class="p">[</span><span class="nx">HttpMethod</span><span class="p">.</span><span class="nx">GET</span><span class="p">],</span>
            <span class="na">path</span><span class="p">:</span> <span class="dl">'</span><span class="s1">/</span><span class="dl">'</span><span class="p">,</span>
        <span class="p">})</span>
        <span class="k">return</span> <span class="nx">httpApi</span>
    <span class="p">}</span>
</code></pre></div></div>
<p>The code above will create an API gateway which will forward GET requests for / to the <code class="language-plaintext highlighter-rouge">exporter</code> lambda. A real such URL looks something like:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>https://some-random-id.execute-api.eu-west-1.amazonaws.com/
</code></pre></div></div>

<p>As seen, we’re using the <a href="https://docs.aws.amazon.com/apigateway/latest/developerguide/http-api.html">HTTP API</a> flavour of AWS API Gateway. Aside from costing a lot less, it gives us much better control of content encoding, especially for binary-type data such as PNG images. In my first iteration of this solution, I used the <a href="https://docs.aws.amazon.com/apigateway/latest/developerguide/apigateway-rest-api.html">REST API</a> flavor for the exporter lambda. This worked fine for my initial CSV-export, but once I tried to write <code class="language-plaintext highlighter-rouge">image/png</code> or <code class="language-plaintext highlighter-rouge">application/octet-stream</code>, the API gateway kept Base64-encoding my response data which wasn’t what I wanted. While I believe this <em>may</em> be possibly to remedy, it was a lot easier to just switch to using the HTTP API. Do note that HTTP vs REST APIs treats inbound requests somewhat differently when it comes to accepting subpaths etc, but that’s a topic for another time.</p>

<h1 id="6-deploying">6. Deploying</h1>
<p>CDK is wonderfully easy to work with from the command-line. After running <code class="language-plaintext highlighter-rouge">aws configure</code> with your AWS account’s API tokens and <code class="language-plaintext highlighter-rouge">cdk bootstrap</code> in order to deploy the necessary CDK Bootstrap <a href="https://aws.amazon.com/cloudformation/">CloudFormation</a> stack in your account, we’re ready to deploy!</p>

<p>However, it’s always a good idea to use <code class="language-plaintext highlighter-rouge">cdk synth</code> first in order to make sure your CDK code is sound. <code class="language-plaintext highlighter-rouge">cdk synth</code> actually outputs the CloudFormation template your CDK code results in, so it’s of course possible to use the CF template using the AWS console or aws CLI as well as using <code class="language-plaintext highlighter-rouge">cdk deploy</code>.</p>

<p>When running <code class="language-plaintext highlighter-rouge">cdk deploy</code>, CDK will compile and build our lambda’s as well as preparing the CloudFormation document that gets deployed to your account. By default, one needs to manually inspect and approve any changes involving IAM so you may need to answer a Yes/No prompt. For details on each <code class="language-plaintext highlighter-rouge">cdk</code> command such as <code class="language-plaintext highlighter-rouge">deploy</code>, run <code class="language-plaintext highlighter-rouge">cdk deploy --help</code> or refer to the official documentation.</p>

<p>Once we’ve executed <code class="language-plaintext highlighter-rouge">cdk deploy</code>, the <code class="language-plaintext highlighter-rouge">new cdk.CfnOutput(this, 'lambda-url', {value: apiGtw.url!})</code> line of code will output the URL to the API Gateway that has been created and that should be ready to accept requests!</p>

<p><img src="../../../../../../assets/blogg/powertracker/power-5m-lineplot.png" alt="lineplot" /></p>

<h1 id="7-part-1-summary">7. Part 1 summary</h1>
<p>In this part we focused on the overall solution and how to use CDK to build Go-based lambdas and provision AWS resources.  In the <a href="https://github.com/callistaenterprise/callistaenterprise.github.io/blob/master/_posts/teknik/2021-04-15-energy-meter-with-aws-part-2.md">next part</a> we’ll look closer at how we used Golang to implement our <code class="language-plaintext highlighter-rouge">PowerRecorder</code> and <code class="language-plaintext highlighter-rouge">exporter</code> lambdas.</p>









            <div class="ce-blog-thanks">
              Tack för att du läser Callistas blogg. <br>
              Hjälp oss att nå ut med information genom att dela nyheter och artiklar i ditt nätverk.<br>
            </div>

            


    
<div class="ce-blog-share">
    <a class="ce-blog-share-element social-twitter" href="https://twitter.com/intent/tweet?text=Energy Meter With Aws&url=https://callistaenterprise.se/blogg/teknik/2021/04/13/energy-meter-with-aws/&via=callistaent&hashtags=" target="_blank" title="Share this post on Twitter"></a>
    <a class="ce-blog-share-element social-facebook" href="https://www.facebook.com/sharer/sharer.php?t=Energy Meter With Aws&u=https://callistaenterprise.se/blogg/teknik/2021/04/13/energy-meter-with-aws/" target="_blank" title="Share this post on Facebook"></a>
    <a class="ce-blog-share-element social-linkedin" href="http://www.linkedin.com/shareArticle?mini=true&title=Energy Meter With Aws&url=https://callistaenterprise.se/blogg/teknik/2021/04/13/energy-meter-with-aws/&source=http%3a%2f%2fzhangwenli.com" target="_blank" title="Share this post on LinkedIn"></a>
</div>
    
        </article>
    </div>
</section>


<section class="ce-section">
    <heading>
        <h1>Kommentarer</h1>
    </heading>
    <div class="ce-content">
        <div id="disqus_thread"></div>
        <script src="../../../../../../js/disqus.js"></script>
    </div>
</section>


    </div>

    <footer class="ce-footer">
    <div class="ce-wrapper">
        <nav class="ce-menu-footer-primary">
            <h2><a href="../../../../../../index.html">Callista</a></h2>
            <ul>
                
                <li><a href="../../../../../../om/index.html">Om oss</a></li>
                
                <li><a href="../../../../../../erbjudanden.html">Erbjudanden</a></li>
                
                <li><a href="../../../../../../event.html">Event</a></li>
                
                <li><a href="../../../../../../blogg.html">Blogg</a></li>
                
                <li><a href="../../../../../../om/jobb/index.html">Jobba hos oss</a></li>
                

                
                    
                        <li><a href="../../../../../../english/index.html">English</a></li>
                    
                
            </ul>
        </nav>
        <div class="ce-addresses">
            <div class="ce-address">
                <h2>Stockholm</h2>
                <address>
                    Drottninggatan 55<br>
                    111 21 Stockholm<br>
                    Tel:
                    <a href="tel:+468212142">
                        +46 8 21 21 42
                    </a>
                </address>
            </div>
            <div class="ce-address">
                <h2>Göteborg</h2>
                <address>
                    Fabriksgatan 13<br>
                    412 50 Göteborg<br>
                    Tel:
                    <a href="tel:+4631201918">
                        +46 31 20 19 18
                    </a>
                </address>
            </div>
        </div>
        <div class="ce-social">
            <h2>Följ oss</h2>
            <ul>
                <li>
                    <a href="http://twitter.com/callistaent">
                        <img alt="Twitters logotype" src="../../../../../../images/icons/twitter.png">
                        <span>@callistaent</span>
                    </a>
                </li>
            </ul>
        </div>
        <small>&copy; 2021 Callista Enterprise AB</small>
        <hr style="margin: 1em 0 2em 0">
        <div class="ce-footer-images">
          <div class="ce-footer-image">
            <a class="ce-raddabarnen" href="http://www.raddabarnen.se/foretag">
                <img alt="Callista är Rädda Barnens företagsvän 2021" src="../../../../../../images/logotype/rb_vanforetag_2021_large-sv.png">
            </a>
          </div>
        </div>
        <br>
        <div class="ce-footer-images">
          <div class="ce-footer-image">
            <a class="ce-di-gasell" href="http://www.di.se/gasell/">
              <img alt="Callista utsett till DI Gasell tre år i rad" src="../../../../../../images/logotype/di_gasell_180x194.png">
            </a>
          </div>
        </div>
    </div>
</footer>


    <script src="../../../../../../js/lib/jquery.min.js"></script>
    <script src="../../../../../../js/lib/owl.carousel.min.js"></script>
    <script src="../../../../../../js/lib/prismjs.min.js"></script>
    <script src="../../../../../../js/app.js"></script>
    <script src="../../../../../../js/analytics.js"></script>
    <script src="../../../../../../js/jobinterestsubmit.js"></script>

</body>
</html>
