<!DOCTYPE html>
<html lang="sv-se">
<head>
    <meta charset="utf-8">

    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="description" content="Callista Enterprise - seniora IT-arkitekter och systemutvecklare inom Java, öppen källkod, agil utveckling och systemintegration">
    <!--<meta name="viewport" content="width=device-width, initial-scale=1">-->
    <meta name="viewport" content="initial-scale=1.0001, minimum-scale=1.0001, maximum-scale=1.0001, user-scalable=no"/>

    <link rel="icon" href="../../../../../../images/icons/callista_favicon.svg" type="image/x-icon" />
    <link rel="shortcut icon" href="../../../../../../images/icons/callista_favicon.svg" type="image/x-icon" />
    <link rel="apple-touch-icon" href="../../../../../../images/icons/callista_favicon_160x160.png">

    <title>WebFlux - Reactive Programming with Spring, Part 3. | Callista</title>

    <link rel="stylesheet" href="../../../../../../css/style.css%3Fv=1.css">
    <link rel="alternate" type="application/rss+xml" title="RSS Feed for callistaenterprise.se" href="../../../../../../feed.xml" />

    <!--[if lte IE 8]>
    <style>* { display: none !important; }</style>
    <meta http-equiv="refresh" content="0; url=/oldie/"/>
    <![endif]-->

    <script type="text/javascript" src="https://use.typekit.net/kig5egm.js"></script>
    <script type="text/javascript">
        try {
            Typekit.load({ async: true });
        } catch (e) {
        }
    </script>

    <!-- Facebook Pixel Code -->
    <script>
    !function(f,b,e,v,n,t,s)
    {if(f.fbq)return;n=f.fbq=function(){n.callMethod?
    n.callMethod.apply(n,arguments):n.queue.push(arguments)};
    if(!f._fbq)f._fbq=n;n.push=n;n.loaded=!0;n.version='2.0';
    n.queue=[];t=b.createElement(e);t.async=!0;
    t.src=v;s=b.getElementsByTagName(e)[0];
    s.parentNode.insertBefore(t,s)}(window,document,'script',
    'https://connect.facebook.net/en_US/fbevents.js');
     fbq('init', '804675599711872');
     fbq('track', 'PageView');
    </script>
    <noscript>
     <img height="1" width="1" src="https://www.facebook.com/tr?id=804675599711872&ev=PageView&noscript=1"/>
    </noscript>
    <!-- End Facebook Pixel Code -->

</head>
<body>

    <header class="ce-header" data-scroll="0">
    <nav>
        <img alt="menubg" class="ce-menu-icon" style="z-index:3; top: 0px; width: 50px; height: 100%;" src="../../../../../../images/icons/menu_background.png">
        <a class="ce-logotype" href="../../../../../../index.html" style="z-index: 2;">
            <img alt="Callista" style="max-width: 100%; height: auto;" src="../../../../../../images/logotype/callista_small2.svg">
        </a>
        <table>
            <tr>
                <td>
            <ul id="menu-primary" class="ce-menu-primary">
                
                    
                            <li><a href="../../../../../../om/index.html">Om oss</a></li>
                    
                
                    
                            <li><a href="../../../../../../erbjudanden.html">Erbjudanden</a></li>
                    
                
                    
                            <li><a href="../../../../../../event.html">Event</a></li>
                    
                
                    
                        
                            <li><a class="ce-active" href="../../../../../../blogg.html">Blogg</a></li>
                        
                    
                
                    
                            <li><a href="../../../../../../om/jobb/index.html">Jobba hos oss</a></li>
                    
                
            </ul>
                </td>

                <td>
            <ul class="ce-menu-secondary">
                
                <li><a href="../../../../../../english/index.html">English</a></li>
                
            </ul>
                </td>
            </tr>
        </table>
            <a id="menu" class="ce-menu-icon" href="index.html#" style="z-index: 4;">
                <img alt="Visa meny" src="../../../../../../images/icons/menu.png">
            </a>
            <a class="ce-search-icon" href="index.html#">
                <img alt="Sök" src="../../../../../../images/icons/search.png">
            </a>

        </table>
    </nav>
</header>


    <div class="ce-main">
        <section class="ce-start lazyImg">
    <article>
        <h1>Blogg</h1>
        <p class="ce-ingress">
            Här finns tekniska artiklar, presentationer och nyheter om arkitektur och systemutveckling. Håll dig uppdaterad, följ oss på <a class="ce-active" href="http://twitter.com/callistaent">Twitter</a>
        </p>
    </article>
</section>

<section class="ce-section">
    <div class="ce-content">
        
        

        
        

        <article class="ce-blog">
            <header>
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    <img alt="Callista medarbetare Anna Eriksson" src="../../../../../../assets/medarbetare/annaeriksson_mini.png">
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    <h2>
        <a href="index.html">WebFlux - Reactive Programming with Spring, Part 3.</a>
        
        
    </h2>
    <h3>
        <time datetime="2021-03-28T00:00:00+00:00">
            28 March 2021
        </time>
        //
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        

        
        
        <a href="../../../../../../om/medarbetare/annaeriksson/index.html">Anna Eriksson</a>
        

        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
    </h3>
    
</header>




<p>This is the third part of my <a href="../../../../2020/05/24/blog-series-reactive-programming/index.html">blog series on reactive programming</a>, which will give an introduction to WebFlux - Spring’s reactive web framework.</p>

<p></p>

<h2 id="1-an-introduction-to-spring-webflux">1. An introduction to Spring WebFlux</h2>

<p>The original web framework for Spring - Spring Web MVC - was built for the Servlet API and Servlet containers.</p>

<p>WebFlux was introduced as part of Spring Framework 5.0. Unlike Spring MVC, it does not require the Servlet API. It is fully asynchronous and non-blocking, implementing the Reactive Streams specification through the Reactor project (see my <a href="../../../../2020/09/12/blog-series-reactive-programming-part-2/index.html">previous blog post</a>).</p>

<p>WebFlux requires Reactor as a core dependency but it is also interoperable with other reactive libraries via Reactive Streams.</p>

<h3 id="11-programming-models">1.1 Programming models</h3>

<p>Spring WebFlux supports two different programming models: annotation-based and functional.</p>

<h4 id="111-annotated-controllers">1.1.1 Annotated controllers</h4>

<p>If you have worked with Spring MVC, the annotation-based model will look quite familiar since it is using the same 
 annotations from the Spring Web module as are being used with Spring MVC. The major difference being that the methods
 now return the reactive types Mono and Flux. See the following example of a RestController using the annotation-based model:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@RestController</span>
<span class="nd">@RequestMapping</span><span class="o">(</span><span class="s">"/students"</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">StudentController</span> <span class="o">{</span>

    <span class="nd">@Autowired</span>
    <span class="kd">private</span> <span class="nc">StudentService</span> <span class="n">studentService</span><span class="o">;</span>


    <span class="kd">public</span> <span class="nf">StudentController</span><span class="o">()</span> <span class="o">{</span>
    <span class="o">}</span>

    <span class="nd">@GetMapping</span><span class="o">(</span><span class="s">"/{id}"</span><span class="o">)</span>
    <span class="kd">public</span> <span class="nc">Mono</span><span class="o">&lt;</span><span class="nc">ResponseEntity</span><span class="o">&lt;</span><span class="nc">Student</span><span class="o">&gt;&gt;</span> <span class="nf">getStudent</span><span class="o">(</span><span class="nd">@PathVariable</span> <span class="kt">long</span> <span class="n">id</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">studentService</span><span class="o">.</span><span class="na">findStudentById</span><span class="o">(</span><span class="n">id</span><span class="o">)</span>
                <span class="o">.</span><span class="na">map</span><span class="o">(</span><span class="nl">ResponseEntity:</span><span class="o">:</span><span class="n">ok</span><span class="o">)</span>
                <span class="o">.</span><span class="na">defaultIfEmpty</span><span class="o">(</span><span class="nc">ResponseEntity</span><span class="o">.</span><span class="na">notFound</span><span class="o">().</span><span class="na">build</span><span class="o">());</span>
    <span class="o">}</span>

    <span class="nd">@GetMapping</span>
    <span class="kd">public</span> <span class="nc">Flux</span><span class="o">&lt;</span><span class="nc">Student</span><span class="o">&gt;</span> <span class="nf">listStudents</span><span class="o">(</span><span class="nd">@RequestParam</span><span class="o">(</span><span class="n">name</span> <span class="o">=</span> <span class="s">"name"</span><span class="o">,</span> <span class="n">required</span> <span class="o">=</span> <span class="kc">false</span><span class="o">)</span> <span class="nc">String</span> <span class="n">name</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">studentService</span><span class="o">.</span><span class="na">findStudentsByName</span><span class="o">(</span><span class="n">name</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@PostMapping</span>
    <span class="kd">public</span> <span class="nc">Mono</span><span class="o">&lt;</span><span class="nc">Student</span><span class="o">&gt;</span> <span class="nf">addNewStudent</span><span class="o">(</span><span class="nd">@RequestBody</span> <span class="nc">Student</span> <span class="n">student</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">studentService</span><span class="o">.</span><span class="na">addNewStudent</span><span class="o">(</span><span class="n">student</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@PutMapping</span><span class="o">(</span><span class="s">"/{id}"</span><span class="o">)</span>
    <span class="kd">public</span> <span class="nc">Mono</span><span class="o">&lt;</span><span class="nc">ResponseEntity</span><span class="o">&lt;</span><span class="nc">Student</span><span class="o">&gt;&gt;</span> <span class="nf">updateStudent</span><span class="o">(</span><span class="nd">@PathVariable</span> <span class="kt">long</span> <span class="n">id</span><span class="o">,</span> <span class="nd">@RequestBody</span> <span class="nc">Student</span> <span class="n">student</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">studentService</span><span class="o">.</span><span class="na">updateStudent</span><span class="o">(</span><span class="n">id</span><span class="o">,</span> <span class="n">student</span><span class="o">)</span>
                <span class="o">.</span><span class="na">map</span><span class="o">(</span><span class="nl">ResponseEntity:</span><span class="o">:</span><span class="n">ok</span><span class="o">)</span>
                <span class="o">.</span><span class="na">defaultIfEmpty</span><span class="o">(</span><span class="nc">ResponseEntity</span><span class="o">.</span><span class="na">notFound</span><span class="o">().</span><span class="na">build</span><span class="o">());</span>
    <span class="o">}</span>

    <span class="nd">@DeleteMapping</span><span class="o">(</span><span class="s">"/{id}"</span><span class="o">)</span>
    <span class="kd">public</span> <span class="nc">Mono</span><span class="o">&lt;</span><span class="nc">ResponseEntity</span><span class="o">&lt;</span><span class="nc">Void</span><span class="o">&gt;&gt;</span> <span class="nf">deleteStudent</span><span class="o">(</span><span class="nd">@PathVariable</span> <span class="kt">long</span> <span class="n">id</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">studentService</span><span class="o">.</span><span class="na">findStudentById</span><span class="o">(</span><span class="n">id</span><span class="o">)</span>
                <span class="o">.</span><span class="na">flatMap</span><span class="o">(</span><span class="n">s</span> <span class="o">-&gt;</span>
                        <span class="n">studentService</span><span class="o">.</span><span class="na">deleteStudent</span><span class="o">(</span><span class="n">s</span><span class="o">)</span>
                                <span class="o">.</span><span class="na">then</span><span class="o">(</span><span class="nc">Mono</span><span class="o">.</span><span class="na">just</span><span class="o">(</span><span class="k">new</span> <span class="nc">ResponseEntity</span><span class="o">&lt;</span><span class="nc">Void</span><span class="o">&gt;(</span><span class="nc">HttpStatus</span><span class="o">.</span><span class="na">OK</span><span class="o">)))</span>
                <span class="o">)</span>
                <span class="o">.</span><span class="na">defaultIfEmpty</span><span class="o">(</span><span class="k">new</span> <span class="nc">ResponseEntity</span><span class="o">&lt;&gt;(</span><span class="nc">HttpStatus</span><span class="o">.</span><span class="na">NOT_FOUND</span><span class="o">));</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>Some explanations about the functions used in the example:</p>
<ul>
  <li>The <code class="language-plaintext highlighter-rouge">map</code> function is used to transform the item emitted by a Mono by applying a synchronous function to it.</li>
  <li>The <code class="language-plaintext highlighter-rouge">flatMap</code> function is used to transform the item emitted by the Mono asynchronously,
returning the value emitted by another Mono.</li>
  <li>The <code class="language-plaintext highlighter-rouge">defaultIfEmpty</code> function provides a default value if a Mono is completed without any data.</li>
</ul>

<h4 id="112-functional-endpoints">1.1.2 Functional endpoints</h4>

<p>The functional programming model is lambda-based and leaves the application in charge of the full request handling.
It is based on the concepts of <code class="language-plaintext highlighter-rouge">HandlerFunctions</code> and <code class="language-plaintext highlighter-rouge">RouterFunctions</code>.</p>

<p>HandlerFunctions are used to generate a response for a given request:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@FunctionalInterface</span>
<span class="kd">public</span> <span class="kd">interface</span> <span class="nc">HandlerFunction</span><span class="o">&lt;</span><span class="no">T</span> <span class="kd">extends</span> <span class="nc">ServerResponse</span><span class="o">&gt;</span> <span class="o">{</span>
    <span class="nc">Mono</span><span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;</span> <span class="nf">handle</span><span class="o">(</span><span class="nc">ServerRequest</span> <span class="n">request</span><span class="o">);</span>
<span class="o">}</span>
</code></pre></div></div>

<p>The RouterFunction is used to route the requests to the HandlerFunctions:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@FunctionalInterface</span>
<span class="kd">public</span> <span class="kd">interface</span> <span class="nc">RouterFunction</span><span class="o">&lt;</span><span class="no">T</span> <span class="kd">extends</span> <span class="nc">ServerResponse</span><span class="o">&gt;</span> <span class="o">{</span>
    <span class="nc">Mono</span><span class="o">&lt;</span><span class="nc">HandlerFunction</span><span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;&gt;</span> <span class="nf">route</span><span class="o">(</span><span class="nc">ServerRequest</span> <span class="n">request</span><span class="o">);</span>
    <span class="o">...</span>
<span class="o">}</span>
</code></pre></div></div>

<p>Continuing with the same student example we would get something like the following using the functional style.</p>

<p>A StudentRouter:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Configuration</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">StudentRouter</span> <span class="o">{</span>

    <span class="nd">@Bean</span>
    <span class="kd">public</span> <span class="nc">RouterFunction</span><span class="o">&lt;</span><span class="nc">ServerResponse</span><span class="o">&gt;</span> <span class="nf">route</span><span class="o">(</span><span class="nc">StudentHandler</span> <span class="n">studentHandler</span><span class="o">){</span>
        <span class="k">return</span> <span class="nc">RouterFunctions</span>
            <span class="o">.</span><span class="na">route</span><span class="o">(</span>
                <span class="no">GET</span><span class="o">(</span><span class="s">"/students/{id:[0-9]+}"</span><span class="o">)</span>
                    <span class="o">.</span><span class="na">and</span><span class="o">(</span><span class="n">accept</span><span class="o">(</span><span class="no">APPLICATION_JSON</span><span class="o">)),</span> <span class="nl">studentHandler:</span><span class="o">:</span><span class="n">getStudent</span><span class="o">)</span>
            <span class="o">.</span><span class="na">andRoute</span><span class="o">(</span>
                <span class="no">GET</span><span class="o">(</span><span class="s">"/students"</span><span class="o">)</span>
                    <span class="o">.</span><span class="na">and</span><span class="o">(</span><span class="n">accept</span><span class="o">(</span><span class="no">APPLICATION_JSON</span><span class="o">)),</span> <span class="nl">studentHandler:</span><span class="o">:</span><span class="n">listStudents</span><span class="o">)</span>
            <span class="o">.</span><span class="na">andRoute</span><span class="o">(</span>
                <span class="no">POST</span><span class="o">(</span><span class="s">"/students"</span><span class="o">)</span>
                    <span class="o">.</span><span class="na">and</span><span class="o">(</span><span class="n">accept</span><span class="o">(</span><span class="no">APPLICATION_JSON</span><span class="o">)),</span><span class="nl">studentHandler:</span><span class="o">:</span><span class="n">addNewStudent</span><span class="o">)</span>
            <span class="o">.</span><span class="na">andRoute</span><span class="o">(</span>
                <span class="no">PUT</span><span class="o">(</span><span class="s">"students/{id:[0-9]+}"</span><span class="o">)</span>
                    <span class="o">.</span><span class="na">and</span><span class="o">(</span><span class="n">accept</span><span class="o">(</span><span class="no">APPLICATION_JSON</span><span class="o">)),</span> <span class="nl">studentHandler:</span><span class="o">:</span><span class="n">updateStudent</span><span class="o">)</span>
            <span class="o">.</span><span class="na">andRoute</span><span class="o">(</span>
                <span class="no">DELETE</span><span class="o">(</span><span class="s">"/students/{id:[0-9]+}"</span><span class="o">)</span>
                    <span class="o">.</span><span class="na">and</span><span class="o">(</span><span class="n">accept</span><span class="o">(</span><span class="no">APPLICATION_JSON</span><span class="o">)),</span> <span class="nl">studentHandler:</span><span class="o">:</span><span class="n">deleteStudent</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>

</code></pre></div></div>

<p>And a StudentHandler:</p>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Component</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">StudentHandler</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="nc">StudentService</span> <span class="n">studentService</span><span class="o">;</span>

    <span class="kd">public</span> <span class="nf">StudentHandler</span><span class="o">(</span><span class="nc">StudentService</span> <span class="n">studentService</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">studentService</span> <span class="o">=</span> <span class="n">studentService</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="nc">Mono</span><span class="o">&lt;</span><span class="nc">ServerResponse</span><span class="o">&gt;</span> <span class="nf">getStudent</span><span class="o">(</span><span class="nc">ServerRequest</span> <span class="n">serverRequest</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">Mono</span><span class="o">&lt;</span><span class="nc">Student</span><span class="o">&gt;</span> <span class="n">studentMono</span> <span class="o">=</span> <span class="n">studentService</span><span class="o">.</span><span class="na">findStudentById</span><span class="o">(</span>
                <span class="nc">Long</span><span class="o">.</span><span class="na">parseLong</span><span class="o">(</span><span class="n">serverRequest</span><span class="o">.</span><span class="na">pathVariable</span><span class="o">(</span><span class="s">"id"</span><span class="o">)));</span>
        <span class="k">return</span> <span class="n">studentMono</span><span class="o">.</span><span class="na">flatMap</span><span class="o">(</span><span class="n">student</span> <span class="o">-&gt;</span> <span class="nc">ServerResponse</span><span class="o">.</span><span class="na">ok</span><span class="o">()</span>
                <span class="o">.</span><span class="na">body</span><span class="o">(</span><span class="n">fromValue</span><span class="o">(</span><span class="n">student</span><span class="o">)))</span>
                <span class="o">.</span><span class="na">switchIfEmpty</span><span class="o">(</span><span class="nc">ServerResponse</span><span class="o">.</span><span class="na">notFound</span><span class="o">().</span><span class="na">build</span><span class="o">());</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="nc">Mono</span><span class="o">&lt;</span><span class="nc">ServerResponse</span><span class="o">&gt;</span> <span class="nf">listStudents</span><span class="o">(</span><span class="nc">ServerRequest</span> <span class="n">serverRequest</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">String</span> <span class="n">name</span> <span class="o">=</span> <span class="n">serverRequest</span><span class="o">.</span><span class="na">queryParam</span><span class="o">(</span><span class="s">"name"</span><span class="o">).</span><span class="na">orElse</span><span class="o">(</span><span class="kc">null</span><span class="o">);</span>
        <span class="k">return</span> <span class="nc">ServerResponse</span><span class="o">.</span><span class="na">ok</span><span class="o">()</span>
                <span class="o">.</span><span class="na">contentType</span><span class="o">(</span><span class="nc">MediaType</span><span class="o">.</span><span class="na">APPLICATION_JSON</span><span class="o">)</span>
                <span class="o">.</span><span class="na">body</span><span class="o">(</span><span class="n">studentService</span><span class="o">.</span><span class="na">findStudentsByName</span><span class="o">(</span><span class="n">name</span><span class="o">),</span> <span class="nc">Student</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="nc">Mono</span><span class="o">&lt;</span><span class="nc">ServerResponse</span><span class="o">&gt;</span> <span class="nf">addNewStudent</span><span class="o">(</span><span class="nc">ServerRequest</span> <span class="n">serverRequest</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">Mono</span><span class="o">&lt;</span><span class="nc">Student</span><span class="o">&gt;</span> <span class="n">studentMono</span> <span class="o">=</span> <span class="n">serverRequest</span><span class="o">.</span><span class="na">bodyToMono</span><span class="o">(</span><span class="nc">Student</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
        <span class="k">return</span> <span class="n">studentMono</span><span class="o">.</span><span class="na">flatMap</span><span class="o">(</span><span class="n">student</span> <span class="o">-&gt;</span>
                <span class="nc">ServerResponse</span><span class="o">.</span><span class="na">status</span><span class="o">(</span><span class="nc">HttpStatus</span><span class="o">.</span><span class="na">OK</span><span class="o">)</span>
                        <span class="o">.</span><span class="na">contentType</span><span class="o">(</span><span class="nc">MediaType</span><span class="o">.</span><span class="na">APPLICATION_JSON</span><span class="o">)</span>
                        <span class="o">.</span><span class="na">body</span><span class="o">(</span><span class="n">studentService</span><span class="o">.</span><span class="na">addNewStudent</span><span class="o">(</span><span class="n">student</span><span class="o">),</span> <span class="nc">Student</span><span class="o">.</span><span class="na">class</span><span class="o">));</span>

    <span class="o">}</span>

    <span class="kd">public</span> <span class="nc">Mono</span><span class="o">&lt;</span><span class="nc">ServerResponse</span><span class="o">&gt;</span> <span class="nf">updateStudent</span><span class="o">(</span><span class="nc">ServerRequest</span> <span class="n">serverRequest</span><span class="o">)</span> <span class="o">{</span>
        <span class="kd">final</span> <span class="kt">long</span> <span class="n">studentId</span> <span class="o">=</span> <span class="nc">Long</span><span class="o">.</span><span class="na">parseLong</span><span class="o">(</span><span class="n">serverRequest</span><span class="o">.</span><span class="na">pathVariable</span><span class="o">(</span><span class="s">"id"</span><span class="o">));</span>
        <span class="nc">Mono</span><span class="o">&lt;</span><span class="nc">Student</span><span class="o">&gt;</span> <span class="n">studentMono</span> <span class="o">=</span> <span class="n">serverRequest</span><span class="o">.</span><span class="na">bodyToMono</span><span class="o">(</span><span class="nc">Student</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>

        <span class="k">return</span> <span class="n">studentMono</span><span class="o">.</span><span class="na">flatMap</span><span class="o">(</span><span class="n">student</span> <span class="o">-&gt;</span>
                <span class="nc">ServerResponse</span><span class="o">.</span><span class="na">status</span><span class="o">(</span><span class="nc">HttpStatus</span><span class="o">.</span><span class="na">OK</span><span class="o">)</span>
                        <span class="o">.</span><span class="na">contentType</span><span class="o">(</span><span class="nc">MediaType</span><span class="o">.</span><span class="na">APPLICATION_JSON</span><span class="o">)</span>
                        <span class="o">.</span><span class="na">body</span><span class="o">(</span><span class="n">studentService</span><span class="o">.</span><span class="na">updateStudent</span><span class="o">(</span><span class="n">studentId</span><span class="o">,</span> <span class="n">student</span><span class="o">),</span> <span class="nc">Student</span><span class="o">.</span><span class="na">class</span><span class="o">));</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="nc">Mono</span><span class="o">&lt;</span><span class="nc">ServerResponse</span><span class="o">&gt;</span> <span class="nf">deleteStudent</span><span class="o">(</span><span class="nc">ServerRequest</span> <span class="n">serverRequest</span><span class="o">)</span> <span class="o">{</span>
        <span class="kd">final</span> <span class="kt">long</span> <span class="n">studentId</span> <span class="o">=</span> <span class="nc">Long</span><span class="o">.</span><span class="na">parseLong</span><span class="o">(</span><span class="n">serverRequest</span><span class="o">.</span><span class="na">pathVariable</span><span class="o">(</span><span class="s">"id"</span><span class="o">));</span>
        <span class="k">return</span> <span class="n">studentService</span>
                <span class="o">.</span><span class="na">findStudentById</span><span class="o">(</span><span class="n">studentId</span><span class="o">)</span>
                <span class="o">.</span><span class="na">flatMap</span><span class="o">(</span><span class="n">s</span> <span class="o">-&gt;</span> <span class="nc">ServerResponse</span><span class="o">.</span><span class="na">noContent</span><span class="o">().</span><span class="na">build</span><span class="o">(</span><span class="n">studentService</span><span class="o">.</span><span class="na">deleteStudent</span><span class="o">(</span><span class="n">s</span><span class="o">)))</span>
                <span class="o">.</span><span class="na">switchIfEmpty</span><span class="o">(</span><span class="nc">ServerResponse</span><span class="o">.</span><span class="na">notFound</span><span class="o">().</span><span class="na">build</span><span class="o">());</span>
    <span class="o">}</span>
<span class="o">}</span>

</code></pre></div></div>
<p>Some explanations about the functions used in the example:</p>
<ul>
  <li>The <code class="language-plaintext highlighter-rouge">switchIfEmpty</code> function has the same purpose as <code class="language-plaintext highlighter-rouge">defaultIfEmpty</code>, but instead of providing
a default value, it is used for providing an alternative Mono.</li>
</ul>

<p>Comparing the two models we can see that:</p>
<ul>
  <li>Using the functional variant requires some more code for things such as
retrieving input parameters and parsing to the expected type.</li>
  <li>Not relying on annotations, but writing explicit code does offer some more flexibility
and could be a better choice if we for example need to implement more complex routing.</li>
</ul>

<h3 id="12-server-support">1.2 Server support</h3>

<p>WebFlux runs on non-Servlet runtimes such as Netty and Undertow (non-blocking mode) as well as Servlet 3.1+ runtimes such as Tomcat and Jetty.</p>

<p>The Spring Boot WebFlux starter defaults to use Netty, but it is easy to switch by changing your Maven or Gradle dependencies.</p>

<p>For example, to switch to Tomcat, just exclude spring-boot-starter-netty from the spring-boot-starter-webflux
dependency and add spring-boot-starter-tomcat:</p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;dependency&gt;</span>
	<span class="nt">&lt;groupId&gt;</span>org.springframework.boot<span class="nt">&lt;/groupId&gt;</span>
	<span class="nt">&lt;artifactId&gt;</span>spring-boot-starter-webflux<span class="nt">&lt;/artifactId&gt;</span>
	<span class="nt">&lt;exclusions&gt;</span>
		<span class="nt">&lt;exclusion&gt;</span>
			<span class="nt">&lt;groupId&gt;</span>org.springframework.boot<span class="nt">&lt;/groupId&gt;</span>
			<span class="nt">&lt;artifactId&gt;</span>spring-boot-starter-netty<span class="nt">&lt;/artifactId&gt;</span>
		<span class="nt">&lt;/exclusion&gt;</span>
	<span class="nt">&lt;/exclusions&gt;</span>
<span class="nt">&lt;/dependency&gt;</span>

<span class="nt">&lt;dependency&gt;</span>
	<span class="nt">&lt;groupId&gt;</span>org.springframework.boot<span class="nt">&lt;/groupId&gt;</span>
	<span class="nt">&lt;artifactId&gt;</span>spring-boot-starter-tomcat<span class="nt">&lt;/artifactId&gt;</span>
<span class="nt">&lt;/dependency&gt;</span>
</code></pre></div></div>

<h3 id="13-configuration">1.3 Configuration</h3>

<p>Spring Boot provides auto-configuration for Spring WebFlux that works well for the common cases.
If you want full control of the WebFlux configuration, the <code class="language-plaintext highlighter-rouge">@EnableWebFlux</code> annotation can be used 
(this annotation would also be needed in a plain Spring application to import the Spring WebFlux configuration).</p>

<p>If you want to keep the Spring Boot WebFlux config and just add some additional WebFlux configuration, 
you can add your own @Configuration class of type WebFluxConfigurer (but without @EnableWebFlux).</p>

<p>For details and examples, read the <a href="https://docs.spring.io/spring-framework/docs/current/reference/html/web-reactive.html#webflux-config">WebFlux config</a> documentation.</p>

<h2 id="2--securing-your-endpoints">2.  Securing your endpoints</h2>
<p>To get Spring Security WebFlux support, first add the spring-boot-starter-security dependency to your project.
Now you can enable it by adding the <code class="language-plaintext highlighter-rouge">@EnableWebFluxSecurity</code> annotation to your Configuration class (available since Spring Security 5.0)</p>

<p>The following simplified example would add support
for two users, one with a USER role and one with an ADMIN role, 
enforce HTTP basic authentication and require the ADMIN role for any access to the path /students/admin:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@EnableWebFluxSecurity</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">SecurityConfig</span> <span class="o">{</span>

    <span class="nd">@Bean</span>
    <span class="kd">public</span> <span class="nc">MapReactiveUserDetailsService</span> <span class="nf">userDetailsService</span><span class="o">()</span> <span class="o">{</span>

        <span class="nc">UserDetails</span> <span class="n">user</span> <span class="o">=</span> <span class="nc">User</span>
                <span class="o">.</span><span class="na">withUsername</span><span class="o">(</span><span class="s">"user"</span><span class="o">)</span>
                <span class="o">.</span><span class="na">password</span><span class="o">(</span><span class="n">passwordEncoder</span><span class="o">().</span><span class="na">encode</span><span class="o">(</span><span class="s">"userpwd"</span><span class="o">))</span>
                <span class="o">.</span><span class="na">roles</span><span class="o">(</span><span class="s">"USER"</span><span class="o">)</span>
                <span class="o">.</span><span class="na">build</span><span class="o">();</span>

        <span class="nc">UserDetails</span> <span class="n">admin</span> <span class="o">=</span> <span class="nc">User</span>
                <span class="o">.</span><span class="na">withUsername</span><span class="o">(</span><span class="s">"admin"</span><span class="o">)</span>
                <span class="o">.</span><span class="na">password</span><span class="o">(</span><span class="n">passwordEncoder</span><span class="o">().</span><span class="na">encode</span><span class="o">(</span><span class="s">"adminpwd"</span><span class="o">))</span>
                <span class="o">.</span><span class="na">roles</span><span class="o">(</span><span class="s">"ADMIN"</span><span class="o">)</span>
                <span class="o">.</span><span class="na">build</span><span class="o">();</span>

        <span class="k">return</span> <span class="k">new</span> <span class="nf">MapReactiveUserDetailsService</span><span class="o">(</span><span class="n">user</span><span class="o">,</span> <span class="n">admin</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@Bean</span>
    <span class="kd">public</span> <span class="nc">SecurityWebFilterChain</span> <span class="nf">securityWebFilterChain</span><span class="o">(</span><span class="nc">ServerHttpSecurity</span> <span class="n">http</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">http</span><span class="o">.</span><span class="na">authorizeExchange</span><span class="o">()</span>
                <span class="o">.</span><span class="na">pathMatchers</span><span class="o">(</span><span class="s">"/students/admin"</span><span class="o">)</span>
                <span class="o">.</span><span class="na">hasAuthority</span><span class="o">(</span><span class="s">"ROLE_ADMIN"</span><span class="o">)</span>
                <span class="o">.</span><span class="na">anyExchange</span><span class="o">()</span>
                <span class="o">.</span><span class="na">authenticated</span><span class="o">()</span>
                <span class="o">.</span><span class="na">and</span><span class="o">().</span><span class="na">httpBasic</span><span class="o">()</span>
                <span class="o">.</span><span class="na">and</span><span class="o">().</span><span class="na">build</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="nd">@Bean</span>
    <span class="kd">public</span> <span class="nc">PasswordEncoder</span> <span class="nf">passwordEncoder</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="k">new</span> <span class="nf">BCryptPasswordEncoder</span><span class="o">();</span>
    <span class="o">}</span>

<span class="o">}</span>
</code></pre></div></div>

<p>It is also possible to secure a method rather than a path, by first adding the annotation <code class="language-plaintext highlighter-rouge">@EnableReactiveMethodSecurity</code>
to your config:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@EnableWebFluxSecurity</span>
<span class="nd">@EnableReactiveMethodSecurity</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">SecurityConfig</span> <span class="o">{</span>
    <span class="o">...</span>
<span class="o">}</span>
</code></pre></div></div>

<p>And then adding the <code class="language-plaintext highlighter-rouge">@PreAuthorize</code> annotation to the methods to be secured.
We might for example want our POST, PUT and DELETE methods only to be accessible by the
ADMIN role. Then the PreAuthorize annotation could be applied to those methods, like:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@DeleteMapping</span><span class="o">(</span><span class="s">"/{id}"</span><span class="o">)</span>
<span class="nd">@PreAuthorize</span><span class="o">(</span><span class="s">"hasRole('ADMIN')"</span><span class="o">)</span>
<span class="kd">public</span> <span class="nc">Mono</span><span class="o">&lt;</span><span class="nc">ResponseEntity</span><span class="o">&lt;</span><span class="nc">Void</span><span class="o">&gt;&gt;</span> <span class="nf">deleteStudent</span><span class="o">(</span><span class="nd">@PathVariable</span> <span class="kt">long</span> <span class="n">id</span><span class="o">)</span> <span class="o">{</span>
    <span class="o">...</span>
<span class="o">}</span>
</code></pre></div></div>

<p>Spring Security offers more support related to WebFlux applications, such as CSRF protection, 
OAuth2 integration and reactive X.509 authentication. For more details, read the followig section
in the Spring Security documentation: <a href="https://docs.spring.io/spring-security/site/docs/current/reference/html5/#reactive-applications">Reactive Applications</a></p>

<h2 id="3-webclient">3. WebClient</h2>

<p>Spring WebFlux also includes a reactive, fully non-blocking web client. 
It has a functional, fluent API based on Reactor.</p>

<p>Let’s take a look at a (once again) simplified example, 
how the WebClient can be used to query our StudentController:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">StudentWebClient</span> <span class="o">{</span>

    <span class="nc">WebClient</span> <span class="n">client</span> <span class="o">=</span> <span class="nc">WebClient</span><span class="o">.</span><span class="na">create</span><span class="o">(</span><span class="s">"http://localhost:8080"</span><span class="o">);</span>

        <span class="kd">public</span> <span class="nc">Mono</span><span class="o">&lt;</span><span class="nc">Student</span><span class="o">&gt;</span> <span class="nf">get</span><span class="o">(</span><span class="kt">long</span> <span class="n">id</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">return</span> <span class="n">client</span>
                    <span class="o">.</span><span class="na">get</span><span class="o">()</span>
                    <span class="o">.</span><span class="na">uri</span><span class="o">(</span><span class="s">"/students/"</span> <span class="o">+</span> <span class="n">id</span><span class="o">)</span>
                    <span class="o">.</span><span class="na">headers</span><span class="o">(</span><span class="n">headers</span> <span class="o">-&gt;</span> <span class="n">headers</span><span class="o">.</span><span class="na">setBasicAuth</span><span class="o">(</span><span class="s">"user"</span><span class="o">,</span> <span class="s">"userpwd"</span><span class="o">))</span>
                    <span class="o">.</span><span class="na">retrieve</span><span class="o">()</span>
                    <span class="o">.</span><span class="na">bodyToMono</span><span class="o">(</span><span class="nc">Student</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
        <span class="o">}</span>
    
        <span class="kd">public</span> <span class="nc">Flux</span><span class="o">&lt;</span><span class="nc">Student</span><span class="o">&gt;</span> <span class="nf">getAll</span><span class="o">()</span> <span class="o">{</span>
            <span class="k">return</span> <span class="n">client</span><span class="o">.</span><span class="na">get</span><span class="o">()</span>
                    <span class="o">.</span><span class="na">uri</span><span class="o">(</span><span class="s">"/students"</span><span class="o">)</span>
                    <span class="o">.</span><span class="na">headers</span><span class="o">(</span><span class="n">headers</span> <span class="o">-&gt;</span> <span class="n">headers</span><span class="o">.</span><span class="na">setBasicAuth</span><span class="o">(</span><span class="s">"user"</span><span class="o">,</span> <span class="s">"userpwd"</span><span class="o">))</span>
                    <span class="o">.</span><span class="na">retrieve</span><span class="o">()</span>
                    <span class="o">.</span><span class="na">bodyToFlux</span><span class="o">(</span><span class="nc">Student</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
        <span class="o">}</span>
    
        <span class="kd">public</span> <span class="nc">Flux</span><span class="o">&lt;</span><span class="nc">Student</span><span class="o">&gt;</span> <span class="nf">findByName</span><span class="o">(</span><span class="nc">String</span> <span class="n">name</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">return</span> <span class="n">client</span><span class="o">.</span><span class="na">get</span><span class="o">()</span>
                    <span class="o">.</span><span class="na">uri</span><span class="o">(</span><span class="n">uriBuilder</span> <span class="o">-&gt;</span> <span class="n">uriBuilder</span><span class="o">.</span><span class="na">path</span><span class="o">(</span><span class="s">"/students"</span><span class="o">)</span>
                    <span class="o">.</span><span class="na">queryParam</span><span class="o">(</span><span class="s">"name"</span><span class="o">,</span> <span class="n">name</span><span class="o">)</span>
                    <span class="o">.</span><span class="na">build</span><span class="o">())</span>
                    <span class="o">.</span><span class="na">headers</span><span class="o">(</span><span class="n">headers</span> <span class="o">-&gt;</span> <span class="n">headers</span><span class="o">.</span><span class="na">setBasicAuth</span><span class="o">(</span><span class="s">"user"</span><span class="o">,</span> <span class="s">"userpwd"</span><span class="o">))</span>
                    <span class="o">.</span><span class="na">retrieve</span><span class="o">()</span>
                    <span class="o">.</span><span class="na">bodyToFlux</span><span class="o">(</span><span class="nc">Student</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
        <span class="o">}</span>
    
        <span class="kd">public</span> <span class="nc">Mono</span><span class="o">&lt;</span><span class="nc">Student</span><span class="o">&gt;</span> <span class="nf">create</span><span class="o">(</span><span class="nc">Student</span> <span class="n">s</span><span class="o">)</span>  <span class="o">{</span>
            <span class="k">return</span> <span class="n">client</span><span class="o">.</span><span class="na">post</span><span class="o">()</span>
                    <span class="o">.</span><span class="na">uri</span><span class="o">(</span><span class="s">"/students"</span><span class="o">)</span>
                    <span class="o">.</span><span class="na">headers</span><span class="o">(</span><span class="n">headers</span> <span class="o">-&gt;</span> <span class="n">headers</span><span class="o">.</span><span class="na">setBasicAuth</span><span class="o">(</span><span class="s">"admin"</span><span class="o">,</span> <span class="s">"adminpwd"</span><span class="o">))</span>
                    <span class="o">.</span><span class="na">body</span><span class="o">(</span><span class="nc">Mono</span><span class="o">.</span><span class="na">just</span><span class="o">(</span><span class="n">s</span><span class="o">),</span> <span class="nc">Student</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
                    <span class="o">.</span><span class="na">retrieve</span><span class="o">()</span>
                    <span class="o">.</span><span class="na">bodyToMono</span><span class="o">(</span><span class="nc">Student</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
        <span class="o">}</span>
    
        <span class="kd">public</span> <span class="nc">Mono</span><span class="o">&lt;</span><span class="nc">Student</span><span class="o">&gt;</span> <span class="nf">update</span><span class="o">(</span><span class="nc">Student</span> <span class="n">student</span><span class="o">)</span>  <span class="o">{</span>
            <span class="k">return</span> <span class="n">client</span>
                    <span class="o">.</span><span class="na">put</span><span class="o">()</span>
                    <span class="o">.</span><span class="na">uri</span><span class="o">(</span><span class="s">"/students/"</span> <span class="o">+</span> <span class="n">student</span><span class="o">.</span><span class="na">getId</span><span class="o">())</span>
                    <span class="o">.</span><span class="na">headers</span><span class="o">(</span><span class="n">headers</span> <span class="o">-&gt;</span> <span class="n">headers</span><span class="o">.</span><span class="na">setBasicAuth</span><span class="o">(</span><span class="s">"admin"</span><span class="o">,</span> <span class="s">"adminpwd"</span><span class="o">))</span>
                    <span class="o">.</span><span class="na">body</span><span class="o">(</span><span class="nc">Mono</span><span class="o">.</span><span class="na">just</span><span class="o">(</span><span class="n">student</span><span class="o">),</span> <span class="nc">Student</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
                    <span class="o">.</span><span class="na">retrieve</span><span class="o">()</span>
                    <span class="o">.</span><span class="na">bodyToMono</span><span class="o">(</span><span class="nc">Student</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
        <span class="o">}</span>
    
        <span class="kd">public</span> <span class="nc">Mono</span><span class="o">&lt;</span><span class="nc">Void</span><span class="o">&gt;</span> <span class="nf">delete</span><span class="o">(</span><span class="kt">long</span> <span class="n">id</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">return</span> <span class="n">client</span>
                    <span class="o">.</span><span class="na">delete</span><span class="o">()</span>
                    <span class="o">.</span><span class="na">uri</span><span class="o">(</span><span class="s">"/students/"</span> <span class="o">+</span> <span class="n">id</span><span class="o">)</span>
                    <span class="o">.</span><span class="na">headers</span><span class="o">(</span><span class="n">headers</span> <span class="o">-&gt;</span> <span class="n">headers</span><span class="o">.</span><span class="na">setBasicAuth</span><span class="o">(</span><span class="s">"admin"</span><span class="o">,</span> <span class="s">"adminpwd"</span><span class="o">))</span>
                    <span class="o">.</span><span class="na">retrieve</span><span class="o">()</span>
                    <span class="o">.</span><span class="na">bodyToMono</span><span class="o">(</span><span class="nc">Void</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
        <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<h2 id="4-testing">4. Testing</h2>
<p>For testing your reactive web application, WebFlux offers the WebTestClient, that comes with
a similar API as the WebClient.</p>

<p>Let’s have a look at how we can test our StudentController using the WebTestClient:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@ExtendWith</span><span class="o">(</span><span class="nc">SpringExtension</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
<span class="nd">@SpringBootTest</span><span class="o">(</span><span class="n">webEnvironment</span> <span class="o">=</span> <span class="nc">SpringBootTest</span><span class="o">.</span><span class="na">WebEnvironment</span><span class="o">.</span><span class="na">RANDOM_PORT</span><span class="o">)</span>
<span class="kd">class</span> <span class="nc">StudentControllerTest</span> <span class="o">{</span>
    <span class="nd">@Autowired</span>
    <span class="nc">WebTestClient</span> <span class="n">webClient</span><span class="o">;</span>

    <span class="nd">@Test</span>
    <span class="nd">@WithMockUser</span><span class="o">(</span><span class="n">roles</span> <span class="o">=</span> <span class="s">"USER"</span><span class="o">)</span>
    <span class="kt">void</span> <span class="nf">test_getStudents</span><span class="o">()</span> <span class="o">{</span>
        <span class="n">webClient</span><span class="o">.</span><span class="na">get</span><span class="o">().</span><span class="na">uri</span><span class="o">(</span><span class="s">"/students"</span><span class="o">)</span>
                <span class="o">.</span><span class="na">header</span><span class="o">(</span><span class="nc">HttpHeaders</span><span class="o">.</span><span class="na">ACCEPT</span><span class="o">,</span> <span class="s">"application/json"</span><span class="o">)</span>
                <span class="o">.</span><span class="na">exchange</span><span class="o">()</span>
                <span class="o">.</span><span class="na">expectStatus</span><span class="o">().</span><span class="na">isOk</span><span class="o">()</span>
                <span class="o">.</span><span class="na">expectHeader</span><span class="o">().</span><span class="na">contentType</span><span class="o">(</span><span class="nc">MediaType</span><span class="o">.</span><span class="na">APPLICATION_JSON</span><span class="o">)</span>
                <span class="o">.</span><span class="na">expectBodyList</span><span class="o">(</span><span class="nc">Student</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>

    <span class="o">}</span>

    <span class="nd">@Test</span>
    <span class="nd">@WithMockUser</span><span class="o">(</span><span class="n">roles</span> <span class="o">=</span> <span class="s">"ADMIN"</span><span class="o">)</span>
    <span class="kt">void</span> <span class="nf">testAddNewStudent</span><span class="o">()</span> <span class="o">{</span>
        <span class="nc">Student</span> <span class="n">newStudent</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Student</span><span class="o">();</span>
        <span class="n">newStudent</span><span class="o">.</span><span class="na">setName</span><span class="o">(</span><span class="s">"some name"</span><span class="o">);</span>
        <span class="n">newStudent</span><span class="o">.</span><span class="na">setAddress</span><span class="o">(</span><span class="s">"an address"</span><span class="o">);</span>

        <span class="n">webClient</span><span class="o">.</span><span class="na">post</span><span class="o">().</span><span class="na">uri</span><span class="o">(</span><span class="s">"/students"</span><span class="o">)</span>
                <span class="o">.</span><span class="na">contentType</span><span class="o">(</span><span class="nc">MediaType</span><span class="o">.</span><span class="na">APPLICATION_JSON</span><span class="o">)</span>
                <span class="o">.</span><span class="na">accept</span><span class="o">(</span><span class="nc">MediaType</span><span class="o">.</span><span class="na">APPLICATION_JSON</span><span class="o">)</span>
                <span class="o">.</span><span class="na">body</span><span class="o">(</span><span class="nc">Mono</span><span class="o">.</span><span class="na">just</span><span class="o">(</span><span class="n">newStudent</span><span class="o">),</span> <span class="nc">Student</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
                <span class="o">.</span><span class="na">exchange</span><span class="o">()</span>
                <span class="o">.</span><span class="na">expectStatus</span><span class="o">().</span><span class="na">isOk</span><span class="o">()</span>
                <span class="o">.</span><span class="na">expectHeader</span><span class="o">().</span><span class="na">contentType</span><span class="o">(</span><span class="nc">MediaType</span><span class="o">.</span><span class="na">APPLICATION_JSON</span><span class="o">)</span>
                <span class="o">.</span><span class="na">expectBody</span><span class="o">()</span>
                <span class="o">.</span><span class="na">jsonPath</span><span class="o">(</span><span class="s">"$.id"</span><span class="o">).</span><span class="na">isNotEmpty</span><span class="o">()</span>
                <span class="o">.</span><span class="na">jsonPath</span><span class="o">(</span><span class="s">"$.name"</span><span class="o">).</span><span class="na">isEqualTo</span><span class="o">(</span><span class="n">newStudent</span><span class="o">.</span><span class="na">getName</span><span class="o">())</span>
                <span class="o">.</span><span class="na">jsonPath</span><span class="o">(</span><span class="s">"$.address"</span><span class="o">).</span><span class="na">isEqualTo</span><span class="o">(</span><span class="n">newStudent</span><span class="o">.</span><span class="na">getAddress</span><span class="o">());</span>
    <span class="o">}</span>

    <span class="o">...</span>
<span class="o">}</span>
</code></pre></div></div>

<h2 id="5-websockets-and-rsocket">5. WebSockets and RSocket</h2>

<h3 id="51-websockets">5.1 WebSockets</h3>
<p>With Spring 5, WebSockets also gets added reactive capabilities.
To create a WebSocket server, you can create an implementation of the <code class="language-plaintext highlighter-rouge">WebSocketHandler</code> interface,
which holds the following method:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">Mono</span><span class="o">&lt;</span><span class="nc">Void</span><span class="o">&gt;</span> <span class="nf">handle</span><span class="o">(</span><span class="nc">WebSocketSession</span> <span class="n">session</span><span class="o">)</span>
</code></pre></div></div>

<p>This method is invoked when a new WebSocket connection is established,
and allows handling of the session. 
It take a <code class="language-plaintext highlighter-rouge">WebSocketSession</code> as input and returns Mono&lt;Void&gt; to signal when application handling of the session is complete.</p>

<p>The WebSocketSession has methods defined for handling the inbound and outbound streams:</p>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">Flux</span><span class="o">&lt;</span><span class="nc">WebSocketMessage</span><span class="o">&gt;</span> <span class="nf">receive</span><span class="o">()</span>
<span class="nc">Mono</span><span class="o">&lt;</span><span class="nc">Void</span><span class="o">&gt;</span> <span class="nf">send</span><span class="o">(</span><span class="nc">Publisher</span><span class="o">&lt;</span><span class="nc">WebSocketMessage</span><span class="o">&gt;</span> <span class="n">messages</span><span class="o">)</span>
</code></pre></div></div>
<p>Spring WebFlux also provides a <code class="language-plaintext highlighter-rouge">WebSocketClient</code> with implementations for Reactor Netty, Tomcat, Jetty, Undertow, and standard Java.</p>

<p>For more details, read the following chapter in Spring’s Web on Reactive Stack documentation:
<a href="https://docs.spring.io/spring-framework/docs/current/reference/html/web-reactive.html#webflux-websocket">WebSockets</a></p>

<h3 id="52-rsocket">5.2 RSocket</h3>
<p>RSocket is a protocol that models Reactive Streams semantics over a network. 
It is a binary protocol for use on byte stream transports such as TCP, WebSockets, and Aeron.
For an introduction to this topic, I recommend the following blog post that my 
colleague Pär has written: 
<a href="../../../../2020/06/05/rsocket-part-1/index.html">An introduction to RSocket</a></p>

<p>And for more details on Spring Framework’s support for the RSocket protocol:
<a href="https://docs.spring.io/spring-framework/docs/current/reference/html/web-reactive.html#rsocket">RSocket</a></p>

<h2 id="6-to-summarize">6. To summarize…</h2>
<p>This blog post demonstrated how WebFlux can be used to build a reactive web application.
The next and final blog post in this series will show how we can make our 
entire application stack fully non-blocking by also implementing non-blocking 
database communication - using R2DBC (Reactive Relational Database Connectivity)!</p>

<h2 id="references">References</h2>

<p><a href="https://docs.spring.io/spring-framework/docs/current/reference/html/web-reactive.html">Spring Framework documentation - Web on Reactive Stack</a></p>

<p><a href="https://docs.spring.io/spring-boot/docs/current/reference/html/spring-boot-features.html#boot-features-webflux">Spring Boot Features - The Spring WebFlux framework</a></p>

<p><a href="https://docs.spring.io/spring-security/site/docs/current/reference/html5/#reactive-applications">Spring Security - Reactive Applications</a></p>









            <div class="ce-blog-thanks">
              Tack för att du läser Callistas blogg. <br>
              Hjälp oss att nå ut med information genom att dela nyheter och artiklar i ditt nätverk.<br>
            </div>

            


    
<div class="ce-blog-share">
    <a class="ce-blog-share-element social-twitter" href="https://twitter.com/intent/tweet?text=Blog Series Reactive Programming Part 3&url=https://callistaenterprise.se/blogg/teknik/2021/03/28/blog-series-reactive-programming-part-3/&via=callistaent&hashtags=" target="_blank" title="Share this post on Twitter"></a>
    <a class="ce-blog-share-element social-facebook" href="https://www.facebook.com/sharer/sharer.php?t=Blog Series Reactive Programming Part 3&u=https://callistaenterprise.se/blogg/teknik/2021/03/28/blog-series-reactive-programming-part-3/" target="_blank" title="Share this post on Facebook"></a>
    <a class="ce-blog-share-element social-linkedin" href="http://www.linkedin.com/shareArticle?mini=true&title=Blog Series Reactive Programming Part 3&url=https://callistaenterprise.se/blogg/teknik/2021/03/28/blog-series-reactive-programming-part-3/&source=http%3a%2f%2fzhangwenli.com" target="_blank" title="Share this post on LinkedIn"></a>
</div>
    
        </article>
    </div>
</section>


<section class="ce-section">
    <heading>
        <h1>Kommentarer</h1>
    </heading>
    <div class="ce-content">
        <div id="disqus_thread"></div>
        <script src="../../../../../../js/disqus.js"></script>
    </div>
</section>


    </div>

    <footer class="ce-footer">
    <div class="ce-wrapper">
        <nav class="ce-menu-footer-primary">
            <h2><a href="../../../../../../index.html">Callista</a></h2>
            <ul>
                
                <li><a href="../../../../../../om/index.html">Om oss</a></li>
                
                <li><a href="../../../../../../erbjudanden.html">Erbjudanden</a></li>
                
                <li><a href="../../../../../../event.html">Event</a></li>
                
                <li><a href="../../../../../../blogg.html">Blogg</a></li>
                
                <li><a href="../../../../../../om/jobb/index.html">Jobba hos oss</a></li>
                

                
                    
                        <li><a href="../../../../../../english/index.html">English</a></li>
                    
                
            </ul>
        </nav>
        <div class="ce-addresses">
            <div class="ce-address">
                <h2>Stockholm</h2>
                <address>
                    Drottninggatan 55<br>
                    111 21 Stockholm<br>
                    Tel:
                    <a href="tel:+468212142">
                        +46 8 21 21 42
                    </a>
                </address>
            </div>
            <div class="ce-address">
                <h2>Göteborg</h2>
                <address>
                    Fabriksgatan 13<br>
                    412 50 Göteborg<br>
                    Tel:
                    <a href="tel:+4631201918">
                        +46 31 20 19 18
                    </a>
                </address>
            </div>
        </div>
        <div class="ce-social">
            <h2>Följ oss</h2>
            <ul>
                <li>
                    <a href="http://twitter.com/callistaent">
                        <img alt="Twitters logotype" src="../../../../../../images/icons/twitter.png">
                        <span>@callistaent</span>
                    </a>
                </li>
            </ul>
        </div>
        <small>&copy; 2021 Callista Enterprise AB</small>
        <hr style="margin: 1em 0 2em 0">
        <div class="ce-footer-images">
          <div class="ce-footer-image">
            <a class="ce-raddabarnen" href="http://www.raddabarnen.se/foretag">
                <img alt="Callista är Rädda Barnens företagsvän 2021" src="../../../../../../images/logotype/rb_vanforetag_2021_large-sv.png">
            </a>
          </div>
        </div>
        <br>
        <div class="ce-footer-images">
          <div class="ce-footer-image">
            <a class="ce-di-gasell" href="http://www.di.se/gasell/">
              <img alt="Callista utsett till DI Gasell tre år i rad" src="../../../../../../images/logotype/di_gasell_180x194.png">
            </a>
          </div>
        </div>
    </div>
</footer>


    <script src="../../../../../../js/lib/jquery.min.js"></script>
    <script src="../../../../../../js/lib/owl.carousel.min.js"></script>
    <script src="../../../../../../js/lib/prismjs.min.js"></script>
    <script src="../../../../../../js/app.js"></script>
    <script src="../../../../../../js/analytics.js"></script>
    <script src="../../../../../../js/jobinterestsubmit.js"></script>

</body>
</html>
