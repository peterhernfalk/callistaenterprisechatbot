<!DOCTYPE html>
<html lang="sv-se">
<head>
    <meta charset="utf-8">

    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="description" content="Callista Enterprise - seniora IT-arkitekter och systemutvecklare inom Java, öppen källkod, agil utveckling och systemintegration">
    <!--<meta name="viewport" content="width=device-width, initial-scale=1">-->
    <meta name="viewport" content="initial-scale=1.0001, minimum-scale=1.0001, maximum-scale=1.0001, user-scalable=no"/>

    <link rel="icon" href="../../../../../../images/icons/callista_favicon.svg" type="image/x-icon" />
    <link rel="shortcut icon" href="../../../../../../images/icons/callista_favicon.svg" type="image/x-icon" />
    <link rel="apple-touch-icon" href="../../../../../../images/icons/callista_favicon_160x160.png">

    <title>Building Microservices, part 8. Centralized logging with the ELK stack | Callista</title>

    <link rel="stylesheet" href="../../../../../../css/style.css%3Fv=1.css">
    <link rel="alternate" type="application/rss+xml" title="RSS Feed for callistaenterprise.se" href="../../../../../../feed.xml" />

    <!--[if lte IE 8]>
    <style>* { display: none !important; }</style>
    <meta http-equiv="refresh" content="0; url=/oldie/"/>
    <![endif]-->

    <script type="text/javascript" src="https://use.typekit.net/kig5egm.js"></script>
    <script type="text/javascript">
        try {
            Typekit.load({ async: true });
        } catch (e) {
        }
    </script>

    <!-- Facebook Pixel Code -->
    <script>
    !function(f,b,e,v,n,t,s)
    {if(f.fbq)return;n=f.fbq=function(){n.callMethod?
    n.callMethod.apply(n,arguments):n.queue.push(arguments)};
    if(!f._fbq)f._fbq=n;n.push=n;n.loaded=!0;n.version='2.0';
    n.queue=[];t=b.createElement(e);t.async=!0;
    t.src=v;s=b.getElementsByTagName(e)[0];
    s.parentNode.insertBefore(t,s)}(window,document,'script',
    'https://connect.facebook.net/en_US/fbevents.js');
     fbq('init', '804675599711872');
     fbq('track', 'PageView');
    </script>
    <noscript>
     <img height="1" width="1" src="https://www.facebook.com/tr?id=804675599711872&ev=PageView&noscript=1"/>
    </noscript>
    <!-- End Facebook Pixel Code -->

</head>
<body>

    <header class="ce-header" data-scroll="0">
    <nav>
        <img alt="menubg" class="ce-menu-icon" style="z-index:3; top: 0px; width: 50px; height: 100%;" src="../../../../../../images/icons/menu_background.png">
        <a class="ce-logotype" href="../../../../../../index.html" style="z-index: 2;">
            <img alt="Callista" style="max-width: 100%; height: auto;" src="../../../../../../images/logotype/callista_small2.svg">
        </a>
        <table>
            <tr>
                <td>
            <ul id="menu-primary" class="ce-menu-primary">
                
                    
                            <li><a href="../../../../../../om/index.html">Om oss</a></li>
                    
                
                    
                            <li><a href="../../../../../../erbjudanden.html">Erbjudanden</a></li>
                    
                
                    
                            <li><a href="../../../../../../event.html">Event</a></li>
                    
                
                    
                        
                            <li><a class="ce-active" href="../../../../../../blogg.html">Blogg</a></li>
                        
                    
                
                    
                            <li><a href="../../../../../../om/jobb/index.html">Jobba hos oss</a></li>
                    
                
            </ul>
                </td>

                <td>
            <ul class="ce-menu-secondary">
                
                <li><a href="../../../../../../english/index.html">English</a></li>
                
            </ul>
                </td>
            </tr>
        </table>
            <a id="menu" class="ce-menu-icon" href="index.html#" style="z-index: 4;">
                <img alt="Visa meny" src="../../../../../../images/icons/menu.png">
            </a>
            <a class="ce-search-icon" href="index.html#">
                <img alt="Sök" src="../../../../../../images/icons/search.png">
            </a>

        </table>
    </nav>
</header>


    <div class="ce-main">
        <section class="ce-start lazyImg">
    <article>
        <h1>Blogg</h1>
        <p class="ce-ingress">
            Här finns tekniska artiklar, presentationer och nyheter om arkitektur och systemutveckling. Håll dig uppdaterad, följ oss på <a class="ce-active" href="http://twitter.com/callistaent">Twitter</a>
        </p>
    </article>
</section>

<section class="ce-section">
    <div class="ce-content">
        
        

        
        

        <article class="ce-blog">
            <header>
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    <img alt="Callista medarbetare Magnus Larsson" src="../../../../../../assets/medarbetare/magnuslarsson_mini.png">
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    <h2>
        <a href="index.html">Building Microservices, part 8. Centralized logging with the ELK stack</a>
        
        
    </h2>
    <h3>
        <time datetime="2017-09-13T00:00:00+00:00">
            13 September 2017
        </time>
        //
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        

        
        
        <a href="../../../../../../om/medarbetare/magnuslarsson/index.html">Magnus Larsson</a>
        

        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
    </h3>
    
</header>




<p>A major challenge in a distributed system (e.g. a system landscape of microservices) is to understand what is going on and even more importantly – what is going wrong, where and why. In this blog post we will see how we can use the <strong>ELK</strong> stack (i.e. <a href="https://www.elastic.co/products/elasticsearch"><strong>E</strong>lasticsearch</a>, <a href="https://www.elastic.co/products/logstash"><strong>L</strong>ogstash</a> and <a href="https://www.elastic.co/products/kibana"><strong>K</strong>ibana</a>, ) from <a href="https://www.elastic.co">Elastic</a> to aggregate log events from our microservices in the <a href="../../../../2015/05/20/blog-series-building-microservices.html">blog series - Building Microservices</a> into a centralized database for analysis and visualization.</p>

<p></p>

<p>New components in our test landscape are marked with red borders:</p>

<p><img src="../../../../../../assets/blogg/build-microservices-part-8/adding-the-elk-stack.png" alt="ELK Stack" /></p>

<h1 id="table-of-contents">Table of Contents</h1>

<ol>
  <li>Introduction</li>
  <li>Code walkthrough</li>
  <li>Build and Run</li>
  <li>Try out centralized logging with the ELK stack</li>
  <li>Next up…</li>
</ol>

<h1 id="1-introduction">1. Introduction</h1>

<p>Let’s start with a short description of the new components and some new challenges!</p>

<h2 id="11-the-elk-stack">1.1 The ELK stack</h2>

<p>The ELK stack from <a href="https://www.elastic.co">Elastic</a> consist of:</p>

<ul>
  <li>
    <p><strong><a href="https://www.elastic.co/products/logstash">Logstash</a></strong><br />
Logstash can collect log events from multiple types of sources using  <a href="https://www.elastic.co/guide/en/logstash/current/input-plugins.html"><em>input</em></a> plug-ins, transform it to a format you prefer using <a href="https://www.elastic.co/guide/en/logstash/current/filter-plugins.html"><em>filter</em></a> and <a href="https://www.elastic.co/guide/en/logstash/current/codec-plugins.html"><em>codec</em></a> plug-ins and send it to a number of destinations using <a href="https://www.elastic.co/guide/en/logstash/current/output-plugins.html"><em>output</em></a> plug-ins.</p>
  </li>
  <li>
    <p><strong><a href="https://www.elastic.co/products/elasticsearch">Elasticsearch</a></strong><br />
Elasticsearch is a distributed and scalable full-text search database, that allows you to store and search large volumes of log events.</p>
  </li>
  <li>
    <p><strong><a href="https://www.elastic.co/products/kibana">Kibana</a></strong><br />
Kibana lets you visualize and analyze your log events stored in Elasticsearch.</p>
  </li>
</ul>

<p>Elastic provides official Docker images for <a href="https://www.elastic.co/guide/en/logstash/current/docker.html">Logstash</a>, <a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/docker.html">Elasticsearch</a> and <a href="https://www.elastic.co/guide/en/kibana/current/docker.html">Kibana</a>.</p>

<h2 id="12-collecting-log-events-in-a-containerized-world">1.2 Collecting log events in a containerized world</h2>

<p>Collecting log events in a container world is not the same as before when we were used to collect log events by <a href="https://en.wikipedia.org/wiki/Tail_(Unix)">tailing</a> log files. That does not work in a containerized world where a container’s file system is ephemeral by default, i.e. it is destroyed if the container crashes. So, for example, after a restart there will be no log file to read log events from to understand what caused the restart. Instead we need to handle log events from containers as an event stream. For more information on the subject see <a href="https://12factor.net/logs">the twelve factor app - treat logs as event streams</a>.</p>

<h2 id="13-docker-log-drivers">1.3 Docker Log Drivers</h2>

<p>In <a href="https://github.com/moby/moby/blob/master/CHANGELOG.md#160-2015-04-07">Docker v1.6.0</a> (released 2015-04-07) a logging mechanisms called <em>Log Drivers</em> was introduced to handle log events as a stream. A number of formats are today supported out of the box, see <a href="https://docs.docker.com/engine/admin/logging/overview/#supported-logging-drivers">supported logging drivers</a>.</p>

<h2 id="14-selecting-a-log-driver">1.4 Selecting a log driver</h2>

<p>When selecting a log driver, we have to match the supported log drivers from Docker with the supported input plugins from Logstash. Both Gelf and Syslog formats are supported by Docker and Logstash. <a href="https://en.wikipedia.org/wiki/Syslog">Syslog</a> is an old and restricted standard for log events, something that the newer Gelf format aims to overcome. See <a href="http://docs.graylog.org/en/2.3/pages/gelf.html">Gelf docs</a> for further explanations. Gelf is clearly preferred over Syslog. When using the Gelf format, Logstash does unfortunately not support (from my understanding) multiline log events, e.g. log events with stack traces. For details see discussions <a href="https://github.com/elastic/logstash/issues/4308">here</a> and <a href="https://github.com/logstash-plugins/logstash-input-gelf/issues/37">here</a>. Therefore, we will use the old Syslog format in this blog post.</p>

<h1 id="2-code-walkthrough">2. Code walkthrough</h1>

<p>There are two source code files of interest for enabling the ELK stack:</p>

<ol>
  <li>The <strong>Docker Compose file</strong>, where we bring in the ELK stack plus configure use of the selected Docker Log Driver, i.e. Syslog, for each microservice</li>
  <li>The <strong>Logstash configuration file</strong>, where we specify and configure what <em>input</em>, <em>codec</em>, <em>filter</em> and <em>output</em> elements we want to use.</li>
</ol>

<p>The source code contains two Docker Compose files:</p>

<ol>
  <li>One with the ELK stack, <code class="language-plaintext highlighter-rouge">docker-compose-with-elk.yml</code>,</li>
  <li>One without the ELK stack, <code class="language-plaintext highlighter-rouge">docker-compose-without-elk.yml</code> <br />
(i.e. same compose file as in the previous blog post, but with a new name).</li>
</ol>

<p>The shell script <code class="language-plaintext highlighter-rouge">setup-env.sh</code> is used to control which Docker Compose file that is in use by setting up the environment variable <code class="language-plaintext highlighter-rouge">COMPOSE_FILE</code>:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>export COMPOSE_FILE=docker-compose-with-elk.yml
#export COMPOSE_FILE=docker-compose-without-elk.yml
</code></pre></div></div>

<h2 id="21-docker-compose-configuration">2.1 Docker Compose configuration</h2>

<p>The most interesting new parts of the compose file <code class="language-plaintext highlighter-rouge">docker-compose-with-elk.yml</code> are the following:</p>

<h3 id="211-bring-in-the-elk-stack">2.1.1 Bring in the ELK stack</h3>

<p>Adding the ELK stack can, as mentioned above, be done by using official Docker images from Elastic like:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  elasticsearch:
    image: docker.elastic.co/elasticsearch/elasticsearch:5.2.2
    ports:
      - "9200:9200"
    environment:
      - "xpack.security.enabled=false"
      - "ES_JAVA_OPTS=-Xms512m -Xmx512m"
	
  kibana:
    image: docker.elastic.co/kibana/kibana:5.2.2
    ports:
      - "5601:5601"
    environment:
      - "xpack.security.enabled=false"
	
  logstash:
    image: docker.elastic.co/logstash/logstash:5.2.2
    ports:
      - "25826:25826"
    volumes:
      - $PWD/elk-config:/elk-config
    command: logstash -f /elk-config/logstash.config
</code></pre></div></div>

<blockquote>
  <p><strong>Note #1:</strong> The Docker images comes with a commercial, non free, extension called <a href="https://www.elastic.co/products/x-pack">X-Pack</a>. X-Pack bundles security, alerting, monitoring, reporting, and graph capabilities into one package. X-Pack includes a trial license for 30 days. To avoid dependencies to non-free extensions of the ELK stack we have disabled the X-Pack by setting the environment variable <code class="language-plaintext highlighter-rouge">xpack.security.enabled</code> to <code class="language-plaintext highlighter-rouge">false</code> for Elasticsearch and Kibana.</p>

  <p><strong>Note #2:</strong> To reduce the memory used for our test purposes, we have limited the memory usage for Elasticsearch by setting the environment variable <code class="language-plaintext highlighter-rouge">ES_JAVA_OPTS</code> to <code class="language-plaintext highlighter-rouge">-Xms512m -Xmx512m</code>.</p>
</blockquote>

<h3 id="212-startup-dependencies">2.1.2 Startup dependencies</h3>

<p>To be able to capture log events from the startup of our microservices it is important that they don’t start before Logstash is ready to receive log events. In the same way Elasticsearch needs to be up and running before Logstash can start to send log events to Elasticsearch.</p>

<blockquote>
  <p><strong>Note:</strong> In a production environment, we are probably using a container orchestrator like Docker in Swarm mode or Kubernetes. Using a container orchestrator, we can set up Logstash and Elasticsearch as services that, at least conceptually, always are up.</p>
</blockquote>

<p>During development, we want to use Docker Compose to start up all containers (both for the ELK Stack and our own microservices) with one command. This leads to that we need to instruct Docker Compose to not start depending containers until the containers they depend on are started and ready to receive requests.</p>

<p>To achieve this we can use:</p>

<ol>
  <li><code class="language-plaintext highlighter-rouge">healthcheck</code> - instructions, to tell Docker runtime how to monitor a container and ensure that it is ok and ready to receive requests.</li>
  <li><code class="language-plaintext highlighter-rouge">depends_on</code> - instructions, to tell Docker to not start a container until the container it depends on is started. By also specifying the condition <code class="language-plaintext highlighter-rouge">service_healthy</code> we ask Docker runtime to wait to start the container until the container it depends on not only is started but also reports that it is healthy (through its health check described above).</li>
</ol>

<p>For the Elasticsearch container we have specified the following health check:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  elasticsearch:
    ...
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9200"]
      interval: 10s
      timeout: 5s
      retries: 10
</code></pre></div></div>

<p>For Kibana and Logstash we have added a dependency to the Elasticsearch container (to ensure that they are not started until Elasticsearch is ready):</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  kibana:
    ...
    depends_on:
      elasticsearch:
        condition: service_healthy

  logstash:
    ...
    depends_on:
      elasticsearch:
        condition: service_healthy
</code></pre></div></div>

<p>For Logstash we have also specified a health check:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  logstash:
    ...
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080"]
      interval: 10s
      timeout: 5s
      retries: 10
</code></pre></div></div>

<p>All microservices that wants to send log events to Logstash defines a dependency to Logstash like:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  pro:
    depends_on:
      logstash:
        condition: service_healthy
</code></pre></div></div>

<h3 id="213-configure-the-syslog-log-driver">2.1.3 Configure the Syslog log driver</h3>

<p>As described above we have decided to use the Syslog driver.</p>

<p>To configure a container to send its log events using Syslog in Docker you can specify something like the following in the Docker Compose file:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>logging:
  driver: syslog
  options:
    syslog-address: "tcp://host:port"
</code></pre></div></div>

<p>Since we gave the Logstash container the name <code class="language-plaintext highlighter-rouge">logstash</code> and published the port <code class="language-plaintext highlighter-rouge">25826</code> you might think that the <code class="language-plaintext highlighter-rouge">syslog-address</code> should be set to: <code class="language-plaintext highlighter-rouge">"tcp://logstash:25826"</code>, but that does not work :-(</p>

<p>The reason for this is that the the Syslog driver is running in the Docker daemon and the Docker daemon can’t access our application’s specific network where the hostname <code class="language-plaintext highlighter-rouge">logstash</code> is defined. Instead we can use port-mapping, i.e. expose the Syslog port in the Logstash container in the Docker host. This means that the Docker daemon can address the Logstash Syslog port using the local IP address <code class="language-plaintext highlighter-rouge">127.0.0.1</code>.</p>

<p>So, the configuration looks like this:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>logging:
  driver: syslog
  options:
    syslog-address: "tcp://127.0.0.1:25826"
</code></pre></div></div>

<p>For further details see the following <a href="https://github.com/docker/docker/issues/20370#issuecomment-185229591">GitHub issue</a>.</p>

<h2 id="22-logstash-configuration">2.2 Logstash configuration</h2>

<p>Let’s go through the <em>input</em>, <em>codec</em>, <em>filter</em> and <em>output</em> elements in the Logstash configuration file. The source code can be found at <code class="language-plaintext highlighter-rouge">elk-config/logstash.config</code>.</p>

<ol>
  <li>
    <p><strong><code class="language-plaintext highlighter-rouge">Input</code> and <code class="language-plaintext highlighter-rouge">codec</code></strong></p>

    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code> input {
	
   http {
     port =&gt; 8080
     type =&gt; "healthcheck"
   }
	
   syslog {
     type =&gt; syslog
     port =&gt; 25826
	
     codec =&gt; multiline {
       pattern =&gt; "^&lt;%{POSINT}&gt;%{SYSLOGTIMESTAMP} %{SYSLOGHOST}\[%{POSINT}\]: %{TIMESTAMP_ISO8601}"
       negate =&gt; true
       what =&gt; previous
     }
   }
	
 }
</code></pre></div>    </div>

    <p>We accept input from <code class="language-plaintext highlighter-rouge">http</code> for the health check declared for Logstash in the Docker Compose file (see §2.1.2 Startup dependencies) and from <code class="language-plaintext highlighter-rouge">syslog</code> for the log events. We apply a multiline codec for the log events. The multiline codec is setup to find log events that does not start with a timestamp and consider them as a part of the previous log event. This means that all lines in a stack trace are merged into the log event for the actual error. For details see the <a href="https://www.elastic.co/guide/en/logstash/current/plugins-codecs-multiline.html">Reference Documentation</a>.</p>
  </li>
  <li>
    <p><strong><code class="language-plaintext highlighter-rouge">Filter</code></strong></p>

    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>     filter {
		
       if [type] == "healthcheck" {
         drop {}
       }
		
       mutate {
         strip =&gt; "message"
       }
		
       grok {
         match =&gt; {
           "message" =&gt; "&lt;%{POSINT:syslog_pri}&gt;%{SYSLOGTIMESTAMP:syslog_timestamp} %{SYSLOGHOST:syslog_hostname}\[%{POSINT:syslog_pid}\]: %{TIMESTAMP_ISO8601:ml_date}(%{SPACE})? %{LOGLEVEL:ml_level} \[%{DATA:ml_service},%{DATA:ml_traceId},%{DATA:ml_spanId},%{DATA:ml_zipkin}\] %{INT} --- \[%{DATA:ml_thread}\] %{DATA:ml_classname} : %{GREEDYDATA:ml_message}"
         }
       }
		
       if "multiline" in [tags] {
         mutate {
             gsub =&gt; [ "message", "&lt;\d+&gt;.*?:\s", ""]
         }
       }
		
       mutate {
         strip =&gt; "ml_thread"
         remove_field =&gt; [ "level", "version", "command", "created", "message", "tag", "image_id", "severity", "priority", "facility", "severity_label", "facility_label", "syslog_pri"]
       }
		
     }
</code></pre></div>    </div>

    <p>The filter processing does the following:</p>

    <ol>
      <li>First, we start with dropping any input from the <code class="language-plaintext highlighter-rouge">http</code> input, i.e. health checks.</li>
      <li>Next, we remove any leading or trailing whitespace from the message field to make it easier to parse.</li>
      <li>
        <p>Using a <a href="https://www.elastic.co/guide/en/logstash/current/plugins-filters-grok.html">Grok filter</a> we extract and name the parts we are interested in from the log event. Fields in the log event created by syslog are prefixed with <code class="language-plaintext highlighter-rouge">syslog_</code> and fields coming from our microservices are prefixed with <code class="language-plaintext highlighter-rouge">ml_</code>.</p>

        <blockquote>
          <p><strong>Note:</strong> If you find it hard to get your Grok patterns set up correctly I suggest you try out the <a href="https://grokdebug.herokuapp.com">Grok debugger</a>!</p>
        </blockquote>

        <p>We collect the following <code class="language-plaintext highlighter-rouge">syslog</code> fields (see <a href="https://www.ietf.org/rfc/rfc3164.txt">RFC 3164</a> for details):</p>

        <ol>
          <li><code class="language-plaintext highlighter-rouge">syslog_pri</code>: the <code class="language-plaintext highlighter-rouge">PRI</code> part of a syslog message</li>
          <li><code class="language-plaintext highlighter-rouge">syslog_timestamp</code>: the <code class="language-plaintext highlighter-rouge">TIMESTAMP</code> part of a syslog message</li>
          <li><code class="language-plaintext highlighter-rouge">syslog_hostname</code>: the <code class="language-plaintext highlighter-rouge">HOSTNAME</code> part of a syslog message</li>
          <li><code class="language-plaintext highlighter-rouge">syslog_pid</code>: the <code class="language-plaintext highlighter-rouge">PID</code> part of a syslog message</li>
        </ol>

        <p>We collect the following fields from the Java logging framework, <a href="https://logback.qos.ch">Logback</a>:</p>

        <ol>
          <li><code class="language-plaintext highlighter-rouge">ml_date</code>: timestamp</li>
          <li><code class="language-plaintext highlighter-rouge">ml_level</code>: log level</li>
          <li><code class="language-plaintext highlighter-rouge">ml_thread</code>: thread id</li>
          <li><code class="language-plaintext highlighter-rouge">ml_classname</code>: name of the logging Java class</li>
          <li><code class="language-plaintext highlighter-rouge">ml_message</code>: the actual message in the log event</li>
        </ol>

        <p>We also collect the following trace information from Spring Cloud Sleuth (see the <a href="../../../07/29/building-microservices-part-7-distributed-tracing/index.html#51-trace-information-injected-in-log-events-by-spring-cloud-sleuth">previous blog post</a> for details):</p>

        <ol>
          <li><code class="language-plaintext highlighter-rouge">ml_service</code>: name of the microservice</li>
          <li><code class="language-plaintext highlighter-rouge">ml_traceId</code>: the trace id</li>
          <li><code class="language-plaintext highlighter-rouge">ml_spanId</code>: the span id</li>
          <li><code class="language-plaintext highlighter-rouge">ml_zipkin</code>: boolean indicating if the span was reported to Zipkin or not</li>
        </ol>
      </li>
      <li>If the log event is a multiline event we have to strip of some leading text on each line added by syslog, e.g.: <code class="language-plaintext highlighter-rouge">&lt;30&gt;Sep  9 06:32:08 89f30c64f36a[1966]: </code></li>
      <li>Finally, we get rid of some fields in the log event that we don’t want to store in Elasticsearch.</li>
    </ol>
  </li>
  <li>
    <p><strong><code class="language-plaintext highlighter-rouge">Output</code></strong></p>

    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code> output {
   elasticsearch {
       hosts =&gt; "elasticsearch"
       ssl =&gt; "false"
       user =&gt; "logstash_system"
       password =&gt; "changeme"
     }
   stdout {
     codec =&gt; rubydebug
   }
 }
</code></pre></div>    </div>

    <p>Log events are sent to:</p>

    <ol>
      <li><code class="language-plaintext highlighter-rouge">elasticsearch</code> for storage, to be picked up by Kibana</li>
      <li><code class="language-plaintext highlighter-rouge">stdout</code> for debugging purposes, using the <code class="language-plaintext highlighter-rouge">docker compose logs</code> command</li>
    </ol>
  </li>
</ol>

<h1 id="3-build-and-run">3. Build and Run</h1>

<p>For details on how to build and run the microservice landscape in this blog post series, see the <a href="../../../../2016/09/30/building-microservices-part-5-springcloud11-docker4mac/index.html">blog post #5</a>.</p>

<blockquote>
  <p><strong>Note #1:</strong> To be able to run some of the commands used below you need to have the tools <a href="http://curl.haxx.se">cURL</a> and <a href="http://stedolan.github.io/jq/">jq</a> installed.</p>

  <p><strong>Note #2:</strong> Since <em>blog post #5</em> this blog series is based on <a href="https://www.docker.com/docker-mac">Docker for Mac</a> and no longer <a href="https://www.docker.com/products/docker-toolbox">Docker Toolbox</a> and <a href="https://docs.docker.com/machine/">Docker Machine</a>, that was used in earlier blog posts. If you have Docker Machine installed be sure to run the following command to direct your Docker client tools to work with Docker for Mac:</p>

  <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>	$ eval $(docker-machine env -u)
</code></pre></div>  </div>
</blockquote>

<p>In summary:</p>

<ol>
  <li>
    <p>Open a terminal, create a folder of your choice and <code class="language-plaintext highlighter-rouge">cd</code> into it:</p>

    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code> $ mkdir a-folder-of-your-choice
 $ cd a-folder-of-your-choice
</code></pre></div>    </div>
  </li>
  <li>
    <p>Since we have externalized our configuration into a configuration repository we first need to get it from GitHub:</p>

    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code> $ git clone https://github.com/callistaenterprise/blog-microservices-config.git
</code></pre></div>    </div>
  </li>
  <li>
    <p>Next, we get the source code from GitHub and checkout the branch used for this blog post:</p>

    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code> $ git clone https://github.com/callistaenterprise/blog-microservices.git
 $ cd blog-microservices
 $ git checkout -b B11 M11
</code></pre></div>    </div>
  </li>
  <li>
    <p>Now, we can build our microservices with:</p>

    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code> $ ./build-all.sh
</code></pre></div>    </div>
  </li>
  <li>
    <p>Finally, we can bring up the dockerized microservice landscape and run a test:</p>

    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code> $ . ./test-all.sh start
</code></pre></div>    </div>

    <blockquote>
      <p><strong>Note #1:</strong> We will not shut down the microservice landscape (can be done by adding the parameter: <code class="language-plaintext highlighter-rouge">stop</code>), since we will use it in the next section.</p>
    </blockquote>

    <blockquote>
      <p><strong>Note #2:</strong> The first <code class="language-plaintext highlighter-rouge">.</code> in the command above is essential. It allows us to reuse the <code class="language-plaintext highlighter-rouge">TOKEN</code> environment variable that the script creates to store an OAuth Access Token, i.e. we don’t need to acquire one ourselves.</p>
    </blockquote>

    <p>After a while, the processing should end with the response from a API request like:</p>

    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code> $ curl -ks https://localhost:443/api/product/123 -H "Authorization: Bearer $TOKEN" | jq .
 {
   "productId": 123,
   "name": "name",
   "weight": 123,
   "recommendations": [	...  ],
   "reviews": [ ... ],
   "serviceAddresses": { ... }
 }
 End: Sun Sep 1 13:33:25 CEST 2017	
</code></pre></div>    </div>
  </li>
  <li>
    <p>Try a manual call like:</p>

    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code> $ curl -ks https://localhost/api/product/456 -H "Authorization: Bearer $TOKEN" | jq .
</code></pre></div>    </div>
  </li>
</ol>

<h1 id="4-try-out-centralized-logging-with-the-elk-stack">4. Try out centralized logging with the ELK stack</h1>

<h2 id="41-verify-and-configure-the-elk-stack">4.1. Verify and configure the ELK stack</h2>

<ol>
  <li>
    <p>First verify that Elasticsearch is up and running:</p>

    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code> $ curl http://localhost:9200 | jq .
 {
   "name" : "hK0W3cd",
   "cluster_name" : "docker-cluster",
   "cluster_uuid" : "KauuQNszTXKOoOdhwgZK6Q",
   "version" : {
     "number" : "5.2.2",
     "build_hash" : "f9d9b74",
     "build_date" : "2017-02-24T17:26:45.835Z",
     "build_snapshot" : false,
     "lucene_version" : "6.4.1"
   },
   "tagline" : "You Know, for Search"
 }
</code></pre></div>    </div>
  </li>
  <li>
    <p>Next verify that we have some indices in Elasticsearch containing data from Logstash:</p>

    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code> $ curl http://localhost:9200/_cat/indices?v
 health status index                             uuid                   pri rep docs.count docs.deleted store.size pri.store.size
 yellow open   logstash-2017.09.01               Sv3K6CEyQ2GEl6HtjU3zKQ   5   1        544            3      1.2mb          1.2mb
 yellow open   .monitoring-kibana-2-2017.09.01   -WfBYJJETTm2qRshojGHBw   1   1         30            0     46.7kb         46.7kb
 yellow open   .kibana                           tjoLGboOQxOIpsXPQAiV6g   1   1          1            0      3.1kb          3.1kb
 yellow open   .monitoring-logstash-2-2017.09.01 NZVw7B7aRjGh4_Pk1Q_hGw   1   1         30            0       51kb           51kb
 yellow open   .monitoring-es-2-2017.09.01       x7JK10GNRwSqJyq63-Padw   1   1        440            0    709.7kb        709.7kb
 yellow open   .monitoring-data-2                75Uv2spMTGiz_-qzjfx3dg   1   1          4            0      9.7kb          9.7kb
</code></pre></div>    </div>
  </li>
  <li>
    <p>Finally, we need to configure Kibana a bit:</p>

    <ol>
      <li>
        <p>Open <a href="http://localhost:5601">http://localhost:5601</a> i your web browser. You should see something like:</p>

        <p><img src="../../../../../../assets/blogg/build-microservices-part-8/kibana-1.png" alt="kibana-1" /></p>
      </li>
      <li>
        <p>Accept the default values for what index to use and click on the Create button.</p>

        <p><img src="../../../../../../assets/blogg/build-microservices-part-8/kibana-2.png" alt="kibana-2" /></p>
      </li>
      <li>
        <p>Kibana will now display the fields in the Logstash index. Click on the “<em>Discover</em>” tab in the blue menu to the left.</p>

        <p><img src="../../../../../../assets/blogg/build-microservices-part-8/kibana-3.png" alt="kibana-3" /></p>
      </li>
      <li>
        <p>Kibana will now show log events. Select and add the following fields: <code class="language-plaintext highlighter-rouge">ml_level</code>, <code class="language-plaintext highlighter-rouge">ml_service</code>, <code class="language-plaintext highlighter-rouge">ml_traceId</code>, <code class="language-plaintext highlighter-rouge">ml_message</code> and <code class="language-plaintext highlighter-rouge">syslog_hostname</code>.</p>

        <p><img src="../../../../../../assets/blogg/build-microservices-part-8/kibana-4.png" alt="kibana-4" /></p>
      </li>
      <li>
        <p>Finally configure the time range and refresh rate to be used by Kibana:</p>
        <ol>
          <li>Click on the display of the current time window in the upper right corner, i.e. “<em>Last 15 minutes</em>”</li>
          <li>A setting dialog for the “<em>Time Range</em>” is displayed</li>
          <li>Click on the “<em>Auto-refresh</em>” tab in the top level menu</li>
          <li>A setting dialog for the “<em>Refresh Interval</em>” is displayed</li>
          <li>Change the default value “<em>Off</em>” to “<em>5 seconds</em>” (eager, we are ;-)</li>
          <li>Click on the collapse button “^” in the upper right corner to get rid of the setup dialog</li>
        </ol>

        <p><img src="../../../../../../assets/blogg/build-microservices-part-8/kibana-5.png" width="600" /></p>
      </li>
    </ol>
  </li>
</ol>

<h2 id="42-run-some-tests">4.2. Run some tests</h2>

<p>Start to make a request using a unique product number, e.g. <code class="language-plaintext highlighter-rouge">123456</code>:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ curl -ks https://localhost/api/product/123456 -H "Authorization: Bearer $TOKEN" | jq .
</code></pre></div></div>

<p>Search for a business key, i.e. the Product Id <code class="language-plaintext highlighter-rouge">123456</code> in our case:</p>

<p><img src="../../../../../../assets/blogg/build-microservices-part-8/kibana-6.png" alt="kibana-6" /></p>

<p>You will find two log events related to this business key. To find all other log events (from all microservices) related to the processing of this business key pick up the value of the <code class="language-plaintext highlighter-rouge">ml_traceId</code> (<code class="language-plaintext highlighter-rouge">8dd7ae480348194d</code> in my case) and make a new search based on that:</p>

<p><img src="../../../../../../assets/blogg/build-microservices-part-8/kibana-7.png" alt="kibana-7" /></p>

<p>Voila, here are all the log events for the processing of the request!</p>

<p><strong>Nice, isn’t it!</strong></p>

<blockquote>
  <p><strong>Note:</strong> If you wonder from where the very useful traceId’s came, you can take a look into the previous blog post <a href="../../../07/29/building-microservices-part-7-distributed-tracing/index.html">blog post #7</a> about <a href="http://cloud.spring.io/spring-cloud-sleuth/">spring-cloud-sleuth</a>!</p>
</blockquote>

<h2 id="43-scale-test">4.3. Scale test</h2>

<p>Remove the search criteria (the trace id) from the search dialog in Kibana.</p>

<p>Next, scale the Recommendation Service to two instances:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ docker-compose scale rec=2
</code></pre></div></div>

<p>After a while you should see a log event in Kibana from the <code class="language-plaintext highlighter-rouge">recommendation-service</code> with a message like:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Started RecommendationServiceApplication in 13.863 seconds (JVM running for 14.756)
</code></pre></div></div>

<p>Now, filter log events in Kibana so that you only will see log events from the Recommendation Service. Click on the “<em>ml</em><em>_service</em>” field in the list of selected fields to the left, then click on the magnifying glass with a “+” - sign after the <code class="language-plaintext highlighter-rouge">recommendation-service</code>.</p>

<p><img src="../../../../../../assets/blogg/build-microservices-part-8/kibana-8.png" width="300" /></p>

<p>A filter for the recommendation service is now displayed under the search field:</p>

<p><img src="../../../../../../assets/blogg/build-microservices-part-8/kibana-9.png" width="300" /></p>

<p>Now, only events from the “<em>recommendation-service</em>” should be visible!</p>

<p>Make a few new calls and see how the value of the “<em>syslog</em><em>_hostname</em>” varies as requests are load balanced over the two instances:</p>

<p><img src="../../../../../../assets/blogg/build-microservices-part-8/kibana-10.png" alt="kibana-10" /></p>

<p>There is much more to say about the ELK stack but this is as far we get in this blog post. We have, at least, seen how to get started using the ELK stack in a containerized world :-)</p>

<h1 id="5-next-up">5. Next up…</h1>

<p>Now we have seen how we can use the ELK stack to capture, search and visualize log events. In the <a href="../../../07/29/building-microservices-part-7-distributed-tracing/index.html">previous blog post</a> we saw how we could use Zipkin together with Spring Cloud Sleuth to understand the response times in a request that is processed by multiple microservices. One piece of important information is still missing though, i.e. how much hardware resources are utilized by our microservices on an individual level. For example, how much CPU, memory, disk and network capacity is each microservice instance consuming?</p>

<p>This is a question that I will try to answer in the next blog post in the <a href="../../../../2015/05/20/blog-series-building-microservices.html">blog series - Building Microservices</a>, where we will meet <a href="https://prometheus.io">Prometheus</a> with friends, stay tuned :-)</p>










            <div class="ce-blog-thanks">
              Tack för att du läser Callistas blogg. <br>
              Hjälp oss att nå ut med information genom att dela nyheter och artiklar i ditt nätverk.<br>
            </div>

            


    
<div class="ce-blog-share">
    <a class="ce-blog-share-element social-twitter" href="https://twitter.com/intent/tweet?text=Building Microservices Part 8 Logging With Elk&url=https://callistaenterprise.se/blogg/teknik/2017/09/13/building-microservices-part-8-logging-with-ELK/&via=callistaent&hashtags=" target="_blank" title="Share this post on Twitter"></a>
    <a class="ce-blog-share-element social-facebook" href="https://www.facebook.com/sharer/sharer.php?t=Building Microservices Part 8 Logging With Elk&u=https://callistaenterprise.se/blogg/teknik/2017/09/13/building-microservices-part-8-logging-with-ELK/" target="_blank" title="Share this post on Facebook"></a>
    <a class="ce-blog-share-element social-linkedin" href="http://www.linkedin.com/shareArticle?mini=true&title=Building Microservices Part 8 Logging With Elk&url=https://callistaenterprise.se/blogg/teknik/2017/09/13/building-microservices-part-8-logging-with-ELK/&source=http%3a%2f%2fzhangwenli.com" target="_blank" title="Share this post on LinkedIn"></a>
</div>
    
        </article>
    </div>
</section>


<section class="ce-section">
    <heading>
        <h1>Kommentarer</h1>
    </heading>
    <div class="ce-content">
        <div id="disqus_thread"></div>
        <script src="../../../../../../js/disqus.js"></script>
    </div>
</section>


    </div>

    <footer class="ce-footer">
    <div class="ce-wrapper">
        <nav class="ce-menu-footer-primary">
            <h2><a href="../../../../../../index.html">Callista</a></h2>
            <ul>
                
                <li><a href="../../../../../../om/index.html">Om oss</a></li>
                
                <li><a href="../../../../../../erbjudanden.html">Erbjudanden</a></li>
                
                <li><a href="../../../../../../event.html">Event</a></li>
                
                <li><a href="../../../../../../blogg.html">Blogg</a></li>
                
                <li><a href="../../../../../../om/jobb/index.html">Jobba hos oss</a></li>
                

                
                    
                        <li><a href="../../../../../../english/index.html">English</a></li>
                    
                
            </ul>
        </nav>
        <div class="ce-addresses">
            <div class="ce-address">
                <h2>Stockholm</h2>
                <address>
                    Drottninggatan 55<br>
                    111 21 Stockholm<br>
                    Tel:
                    <a href="tel:+468212142">
                        +46 8 21 21 42
                    </a>
                </address>
            </div>
            <div class="ce-address">
                <h2>Göteborg</h2>
                <address>
                    Fabriksgatan 13<br>
                    412 50 Göteborg<br>
                    Tel:
                    <a href="tel:+4631201918">
                        +46 31 20 19 18
                    </a>
                </address>
            </div>
        </div>
        <div class="ce-social">
            <h2>Följ oss</h2>
            <ul>
                <li>
                    <a href="http://twitter.com/callistaent">
                        <img alt="Twitters logotype" src="../../../../../../images/icons/twitter.png">
                        <span>@callistaent</span>
                    </a>
                </li>
            </ul>
        </div>
        <small>&copy; 2021 Callista Enterprise AB</small>
        <hr style="margin: 1em 0 2em 0">
        <div class="ce-footer-images">
          <div class="ce-footer-image">
            <a class="ce-raddabarnen" href="http://www.raddabarnen.se/foretag">
                <img alt="Callista är Rädda Barnens företagsvän 2021" src="../../../../../../images/logotype/rb_vanforetag_2021_large-sv.png">
            </a>
          </div>
        </div>
        <br>
        <div class="ce-footer-images">
          <div class="ce-footer-image">
            <a class="ce-di-gasell" href="http://www.di.se/gasell/">
              <img alt="Callista utsett till DI Gasell tre år i rad" src="../../../../../../images/logotype/di_gasell_180x194.png">
            </a>
          </div>
        </div>
    </div>
</footer>


    <script src="../../../../../../js/lib/jquery.min.js"></script>
    <script src="../../../../../../js/lib/owl.carousel.min.js"></script>
    <script src="../../../../../../js/lib/prismjs.min.js"></script>
    <script src="../../../../../../js/app.js"></script>
    <script src="../../../../../../js/analytics.js"></script>
    <script src="../../../../../../js/jobinterestsubmit.js"></script>

</body>
</html>
