<!DOCTYPE html>
<html lang="sv-se">
<head>
    <meta charset="utf-8">

    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="description" content="Callista Enterprise - seniora IT-arkitekter och systemutvecklare inom Java, öppen källkod, agil utveckling och systemintegration">
    <!--<meta name="viewport" content="width=device-width, initial-scale=1">-->
    <meta name="viewport" content="initial-scale=1.0001, minimum-scale=1.0001, maximum-scale=1.0001, user-scalable=no"/>

    <link rel="icon" href="../../../../../../images/icons/callista_favicon.svg" type="image/x-icon" />
    <link rel="shortcut icon" href="../../../../../../images/icons/callista_favicon.svg" type="image/x-icon" />
    <link rel="apple-touch-icon" href="../../../../../../images/icons/callista_favicon_160x160.png">

    <title>ArchConf 2017 - en sammanfattning av Spring Cloud Contract och Spring REST docs | Callista</title>

    <link rel="stylesheet" href="../../../../../../css/style.css%3Fv=1.css">
    <link rel="alternate" type="application/rss+xml" title="RSS Feed for callistaenterprise.se" href="../../../../../../feed.xml" />

    <!--[if lte IE 8]>
    <style>* { display: none !important; }</style>
    <meta http-equiv="refresh" content="0; url=/oldie/"/>
    <![endif]-->

    <script type="text/javascript" src="https://use.typekit.net/kig5egm.js"></script>
    <script type="text/javascript">
        try {
            Typekit.load({ async: true });
        } catch (e) {
        }
    </script>

    <!-- Facebook Pixel Code -->
    <script>
    !function(f,b,e,v,n,t,s)
    {if(f.fbq)return;n=f.fbq=function(){n.callMethod?
    n.callMethod.apply(n,arguments):n.queue.push(arguments)};
    if(!f._fbq)f._fbq=n;n.push=n;n.loaded=!0;n.version='2.0';
    n.queue=[];t=b.createElement(e);t.async=!0;
    t.src=v;s=b.getElementsByTagName(e)[0];
    s.parentNode.insertBefore(t,s)}(window,document,'script',
    'https://connect.facebook.net/en_US/fbevents.js');
     fbq('init', '804675599711872');
     fbq('track', 'PageView');
    </script>
    <noscript>
     <img height="1" width="1" src="https://www.facebook.com/tr?id=804675599711872&ev=PageView&noscript=1"/>
    </noscript>
    <!-- End Facebook Pixel Code -->

</head>
<body>

    <header class="ce-header" data-scroll="0">
    <nav>
        <img alt="menubg" class="ce-menu-icon" style="z-index:3; top: 0px; width: 50px; height: 100%;" src="../../../../../../images/icons/menu_background.png">
        <a class="ce-logotype" href="../../../../../../index.html" style="z-index: 2;">
            <img alt="Callista" style="max-width: 100%; height: auto;" src="../../../../../../images/logotype/callista_small2.svg">
        </a>
        <table>
            <tr>
                <td>
            <ul id="menu-primary" class="ce-menu-primary">
                
                    
                            <li><a href="../../../../../../om/index.html">Om oss</a></li>
                    
                
                    
                            <li><a href="../../../../../../erbjudanden.html">Erbjudanden</a></li>
                    
                
                    
                            <li><a href="../../../../../../event.html">Event</a></li>
                    
                
                    
                        
                            <li><a class="ce-active" href="../../../../../../blogg.html">Blogg</a></li>
                        
                    
                
                    
                            <li><a href="../../../../../../om/jobb/index.html">Jobba hos oss</a></li>
                    
                
            </ul>
                </td>

                <td>
            <ul class="ce-menu-secondary">
                
                <li><a href="../../../../../../english/index.html">English</a></li>
                
            </ul>
                </td>
            </tr>
        </table>
            <a id="menu" class="ce-menu-icon" href="index.html#" style="z-index: 4;">
                <img alt="Visa meny" src="../../../../../../images/icons/menu.png">
            </a>
            <a class="ce-search-icon" href="index.html#">
                <img alt="Sök" src="../../../../../../images/icons/search.png">
            </a>

        </table>
    </nav>
</header>


    <div class="ce-main">
        <section class="ce-start lazyImg">
    <article>
        <h1>Blogg</h1>
        <p class="ce-ingress">
            Här finns tekniska artiklar, presentationer och nyheter om arkitektur och systemutveckling. Håll dig uppdaterad, följ oss på <a class="ce-active" href="http://twitter.com/callistaent">Twitter</a>
        </p>
    </article>
</section>

<section class="ce-section">
    <div class="ce-content">
        
        

        
        

        <article class="ce-blog">
            <header>
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    <img alt="Callista medarbetare Erik Lupander" src="../../../../../../assets/medarbetare/eriklupander_mini.png">
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    <h2>
        <a href="index.html">ArchConf 2017 - en sammanfattning av Spring Cloud Contract och Spring REST docs</a>
        
        
    </h2>
    <h3>
        <time datetime="2017-12-19T00:00:00+00:00">
            19 December 2017
        </time>
        //
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        

        
        
        <a href="../../../../../../om/medarbetare/eriklupander/index.html">Erik Lupander</a>
        

        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
    </h3>
    
</header>




<p>Här följer en kondenserad redogörelse över ett par föredrag jag lyssnade på under sista dagen på <a href="https://archconf.com/conference/clearwater/2017/12/home">ArchConf</a> i förra veckan.</p>

<h3 id="testing-microservices-with-spring-cloud-contract">Testing Microservices with Spring Cloud Contract</h3>

<p>Utifrån premissen att det är klurigt att på ett tillförlitligt sätt integrationstesta ett komplett microserviceslandskap, så berättade <a href="https://archconf.com/conference/clearwater/2017/12/speakers/craig_walls">Craig Walls</a> från Pivotal om hur man gärna skriver tester på en viss microservice och sedan stubbar ut dess anrop mha ramverk såsom <a href="https://docs.spring.io/spring-security/site/docs/current/reference/html/test-mockmvc.html">MockMVC</a>. I ännu högre grad vill man rimligen stubba ut anrop till helt externa API:er också.</p>

<p><img src="../../../../../../assets/blogg/archconf2017/el-craigwalls.jpg" alt="Craig Walls" />
<em>Craig Walls från Pivotal höll ett antal föredrag relaterade till Spring under konferensen</em></p>

<p><a href="https://cloud.spring.io/spring-cloud-contract/">Spring Cloud Contract</a> är ett försök från Springs håll att “vända lite” på hur man deklarerar och ger stubbar ett visst beteende genom att låta tjänsten som <em>skall anropas</em> vara den som publicerar färdiga stubbar i form av Maven-artefakter. Kallas mer formellt för “Consumer-Driven-Contracts”.</p>

<p>Ansatsen att låta producentsystemet tillhandahålla en stubbe är visserligen inte unik, men oftast så brukar man ju i sina tester själv ansvara för att stubba ut en tjänst som man indirekt beror på snarare än att dra in ett test-beroende där tjänsten själv har tillsett att <em>du</em> skall kunna testa mot den. Om API-producenten därtill täckt in de vanligaste fallen en konsument kan tänkas vilja ha med i sina testfall så kan ju mycket vara vunnet.</p>

<p>Stubbarna och deras beteenden deklareras med en Groovy-DSL, i princip “givet en request som ser ut så här så svara med en response som ser ut så här”. Ett vanligt mönster man kan känna igen från t.ex. <a href="https://github.com/node-nock/nock">nock</a> från NodeJS-världen.</p>

<p>Exempel:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>request {
    description("User is not old enough to buy beer")
    method 'POST'
    url '/check'
    body(age: value(consumer(regex('[0-1][0-9]'))))
    headers {
        header 'Content-Type', 'application/json'
    }
}
response {
    status 200
    body( "{"status": "NOT_OK"}")
    headers {
      header(
         'Content-Type', value(consumer('application/json'),producer(regex('application/json.*')))
      )
    }
}
</code></pre></div></div>

<p>Ganska tydligt? Notera regexpen som kollar om “age” är 0-19 år - dvs ingen öl.</p>

<p>Det som gör det extra intressant är att när du släpper en ny version av ditt API så kan du samtidigt släppa en kompletterande jar-fil med stubbar för den nya versionen. Föreläsaren drog ett exempel med Facebook. Facebook har massvis med API:er som ändras ofta, där deras API-ändringar kommuniceras mha release notes. Man skulle kunna tänka sig att Facebook säger - <em>“Ok, version 6.0 av annons-API:et släpps om tre månader. Här har ni stubbarna för den versionen så ni kan utveckla och skriva era tester god tid i förväg.”</em>. Det skulle säkerligen kunna underlätta för många utvecklare.</p>

<p>I testkod kör man JUnit eller motsvarande precis som vanligt, man pekar ut maven-artefakten med stubklasser man vill ha med mha <em>@AutoConfigureStubRunner</em>.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>@RunWith(SpringRunner.class)
@SpringBootTest
@AutoConfigureStubRunner(ids = {"com.example:http-server:+:stubs:8080"})
public class BeerApplicationServiceTests {
</code></pre></div></div>

<p>Personligen tycker jag tanken bakom Spring Cloud Contracts är ganska intressant och definitivt något jag skulle överväga att tillhandahålla om jag jobbade med API:er inom den förvisso något snäva teknikstack (Spring, MockMVC, RestAssuredMockMvc etc) som detta berör. Jag leker också med tanken att applicera detta som ett mönster mellan mina <a href="../../../02/17/go-blog-series-part1.html">Go-microservices</a> där man enkelt kan dra in källkod från andra microservices i landskapet i form av <a href="https://github.com/h2non/gock">gock</a>-mockar för HTTP-trafik.</p>

<h3 id="spring-rest-docs">Spring REST docs</h3>

<p>Även här var det <a href="https://archconf.com/conference/clearwater/2017/12/speakers/craig_walls">Craig Walls</a> som föreläste om dokumentation av REST-api:er. <a href="https://github.com/spring-projects/spring-restdocs/">Spring REST docs</a> är en ansats för att generera REST-dokumentation som härstammar från att någon icke namngiven person på Spring-teamet tycker att Swagger är bedrövligt - för mycket annoteringar, svårt att generera vettig dokumentation osv.</p>

<p>Jag lägger mig inte i påståendet i sig, men konstaterar att detta rör sig om “Test-driven documentation”. Ja, ni läste rätt - man skall alltså låta tester generera dokumentationen. Det intressanta i sammanhanget är att man faktiskt kommer få failande test om dokumentationen som genereras <em>inte</em> överensstämmer med den request/response som testet ifråga exekverar. Man behöver en plug-in i sitt bygge, exemplifierat med Maven, som instrumenterar ens kod utifrån den DSL som hör till projektet och som spottar ur sig olika snippets i formatet <a href="http://asciidoc.org/">asciidoc</a>.</p>

<p>Tanken är att man sedan inkluderar dessa snippets (exempelvis utseende för request/response, curl-kommando för att köra request osv), som man kan använda i ett annan asciidoc dokument som är den handskrivna dokumentationen av API:et, där man alltså länkar in en massa snippets. 
I ett test med MockMvc inkluderar man extra DSL, se från <em>“.andDo(document(…..)”</em> nedan:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>this.mockMvc.perform(
    post("/notes").contentType(MediaTypes.HAL_JSON).content(
	    this.objectMapper.writeValueAsString(note)))
	    .andExpect(
		    status().isCreated()
		)
		.andDo(document("notes-create-example",
		    requestFields(
			fieldWithPath("title").description("The title of the note"),
			fieldWithPath("body").description("The body of the note"),
			fieldWithPath("tags").description("An array of tag resource URIs")
		)
	)
); 
</code></pre></div></div>

<p>Man chainar på saker mha DSL:en - länkar (<a href="https://spring.io/understanding/HATEOAS">HATEOAS</a>-style), beskrivningar osv. Man kan även återanvända saker mellan tester genom att deklarera exempelvis ett uttryck för headers man alltid förväntar sig skall finnas.</p>

<p>Jag ser ett tydligt värde i att koppla doc-genereringen till tester även om det kan kännas lite bakvänt. Om jag förstod det hela rätt är man inte strikt kopplad till just MockMVC utan detta går att göra även med exempelvis RestAssured.</p>

<p>Sedan skall man ha klart för sig att Spring REST docs på intet sätt ersätter Swagger som helhet - Spring REST docs är enbart till för dokumentation och ingenting annat. Dessutom ser jag ett visst jobb med att själv länka in genererade snippets i .adoc-filerna man har som bas för sin API-dokumentation, även om det rimligen bör finnas templates att återanvända.</p>

<p>Om du är nyfiken på mer detaljer så titta gärna på Sylvain Lemoines <a href="http://www.sylvainlemoine.com/2017/07/29/spring-rest-docs-tutorial/">bloggpost</a> som går genom det hela ordentligt.</p>









            <div class="ce-blog-thanks">
              Tack för att du läser Callistas blogg. <br>
              Hjälp oss att nå ut med information genom att dela nyheter och artiklar i ditt nätverk.<br>
            </div>

            


    
<div class="ce-blog-share">
    <a class="ce-blog-share-element social-twitter" href="https://twitter.com/intent/tweet?text=Archconf Spring Cloud Contract&url=https://callistaenterprise.se/blogg/teknik/2017/12/19/archconf-spring-cloud-contract/&via=callistaent&hashtags=" target="_blank" title="Share this post on Twitter"></a>
    <a class="ce-blog-share-element social-facebook" href="https://www.facebook.com/sharer/sharer.php?t=Archconf Spring Cloud Contract&u=https://callistaenterprise.se/blogg/teknik/2017/12/19/archconf-spring-cloud-contract/" target="_blank" title="Share this post on Facebook"></a>
    <a class="ce-blog-share-element social-linkedin" href="http://www.linkedin.com/shareArticle?mini=true&title=Archconf Spring Cloud Contract&url=https://callistaenterprise.se/blogg/teknik/2017/12/19/archconf-spring-cloud-contract/&source=http%3a%2f%2fzhangwenli.com" target="_blank" title="Share this post on LinkedIn"></a>
</div>
    
        </article>
    </div>
</section>


<section class="ce-section">
    <heading>
        <h1>Kommentarer</h1>
    </heading>
    <div class="ce-content">
        <div id="disqus_thread"></div>
        <script src="../../../../../../js/disqus.js"></script>
    </div>
</section>


    </div>

    <footer class="ce-footer">
    <div class="ce-wrapper">
        <nav class="ce-menu-footer-primary">
            <h2><a href="../../../../../../index.html">Callista</a></h2>
            <ul>
                
                <li><a href="../../../../../../om/index.html">Om oss</a></li>
                
                <li><a href="../../../../../../erbjudanden.html">Erbjudanden</a></li>
                
                <li><a href="../../../../../../event.html">Event</a></li>
                
                <li><a href="../../../../../../blogg.html">Blogg</a></li>
                
                <li><a href="../../../../../../om/jobb/index.html">Jobba hos oss</a></li>
                

                
                    
                        <li><a href="../../../../../../english/index.html">English</a></li>
                    
                
            </ul>
        </nav>
        <div class="ce-addresses">
            <div class="ce-address">
                <h2>Stockholm</h2>
                <address>
                    Drottninggatan 55<br>
                    111 21 Stockholm<br>
                    Tel:
                    <a href="tel:+468212142">
                        +46 8 21 21 42
                    </a>
                </address>
            </div>
            <div class="ce-address">
                <h2>Göteborg</h2>
                <address>
                    Fabriksgatan 13<br>
                    412 50 Göteborg<br>
                    Tel:
                    <a href="tel:+4631201918">
                        +46 31 20 19 18
                    </a>
                </address>
            </div>
        </div>
        <div class="ce-social">
            <h2>Följ oss</h2>
            <ul>
                <li>
                    <a href="http://twitter.com/callistaent">
                        <img alt="Twitters logotype" src="../../../../../../images/icons/twitter.png">
                        <span>@callistaent</span>
                    </a>
                </li>
            </ul>
        </div>
        <small>&copy; 2021 Callista Enterprise AB</small>
        <hr style="margin: 1em 0 2em 0">
        <div class="ce-footer-images">
          <div class="ce-footer-image">
            <a class="ce-raddabarnen" href="http://www.raddabarnen.se/foretag">
                <img alt="Callista är Rädda Barnens företagsvän 2021" src="../../../../../../images/logotype/rb_vanforetag_2021_large-sv.png">
            </a>
          </div>
        </div>
        <br>
        <div class="ce-footer-images">
          <div class="ce-footer-image">
            <a class="ce-di-gasell" href="http://www.di.se/gasell/">
              <img alt="Callista utsett till DI Gasell tre år i rad" src="../../../../../../images/logotype/di_gasell_180x194.png">
            </a>
          </div>
        </div>
    </div>
</footer>


    <script src="../../../../../../js/lib/jquery.min.js"></script>
    <script src="../../../../../../js/lib/owl.carousel.min.js"></script>
    <script src="../../../../../../js/lib/prismjs.min.js"></script>
    <script src="../../../../../../js/app.js"></script>
    <script src="../../../../../../js/analytics.js"></script>
    <script src="../../../../../../js/jobinterestsubmit.js"></script>

</body>
</html>
